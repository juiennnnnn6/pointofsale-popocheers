<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>波波聚 歐洲家居/波蘭陶食器-進銷存系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="database.js"></script>
    <script src="employee-auth.js"></script>
    <style>
        /* 蘋果風格自定義樣式 */
        .apple-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .apple-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #17225e 0%, #1a2a6e 100%);
        }
        
        /* 權限控制樣式 */
        .menu-item {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .menu-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .menu-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            filter: grayscale(50%);
        }
        
        .menu-item.disabled:hover {
            transform: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .menu-item.disabled .text-gray-800 {
            color: #9ca3af !important;
        }
        
        .menu-item.disabled .text-gray-600 {
            color: #d1d5db !important;
        }
        
        .menu-item.disabled .text-red-500:not(.keep-original) {
            color: #fca5a5 !important;
        }
        
        /* 讓提示文字完全不受 disabled 影響 */
        .status-label {
            opacity: 1 !important;
            color: #ef4444 !important;
            background-color: white !important;
            position: relative;
            z-index: 20;
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .menu-item.disabled .menu-text {
            color: #9ca3af !important;
        }
        
        .menu-item.disabled i {
            opacity: 0.5;
        }
        
        /* 定義主題顏色類 */
        .menu-text {
            color: #17225e;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 頂部導航 -->
    <nav class="gradient-bg text-white p-4 apple-shadow sticky top-0 z-50">
        <div class="container mx-auto">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-store-alt text-2xl"></i>
                    <h1 class="text-xl font-semibold">歡迎回來，波波 聚</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm opacity-90">ver2.7</span>
                    <div id="dataStatus" class="text-xs opacity-75">
                        <i class="fas fa-database mr-1"></i><span id="dataSource">載入中...</span>
                    </div>
                    <button onclick="showVersionHistory()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded-lg text-sm transition-colors">
                        <i class="fas fa-code-branch mr-1"></i>版本紀錄
                    </button>
                    <button onclick="showEmployeeLogin()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded-lg text-sm transition-colors">
                        <i class="fas fa-user mr-1"></i>員工登入
                    </button>
                    <div id="employeeInfo" class="hidden bg-white bg-opacity-20 px-3 py-1 rounded-lg text-sm">
                        <i class="fas fa-user-check mr-1"></i><span id="employeeName">員工</span>
                        <a href="mailto:your.email@example.com?subject=聯絡我們[波波聚 歐洲家居/波蘭陶食器-進銷存系統]" 
                            class="ml-2 text-xs bg-[#17225e] hover:bg-[#1a2a6e] px-2 py-1 rounded transition-colors">
                             <i class="fas fa-key mr-1"></i>聯絡我們
                        </a>
                        <button onclick="logoutEmployee()" class="ml-2 text-xs bg-red-500 hover:bg-red-600 px-2 py-1 rounded transition-colors">
                            <i class="fas fa-sign-out-alt mr-1"></i>登出
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要內容區域 -->
    <div class="container mx-auto p-6">
        <!-- 登入提示 -->
        <div id="loginRequired" class="apple-card rounded-xl p-8 text-center apple-shadow">
            <i class="fas fa-lock text-6xl text-gray-400 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">請先登入</h2>
            <p class="text-gray-600 mb-6">您需要登入才能使用系統功能</p>
                            <button onclick="showEmployeeLogin()" class="bg-[#17225e] text-white px-6 py-3 rounded-lg hover:bg-[#1a2a6e] transition-colors">
                <i class="fas fa-sign-in-alt mr-2"></i>員工登入
            </button>
        </div>

        <!-- 主功能選單 -->
        <div id="mainMenu" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 hidden">
            


            <!-- 銷售作業 -->
            <div class="relative">
                <div id="menu-sales" class="menu-item apple-card rounded-xl p-6 apple-shadow transition-all duration-300" data-permissions="['sales']" data-page="sales">
                    <div class="text-center">
                        <i class="fas fa-cash-register text-4xl menu-text mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">銷售作業</h3>
                        <p class="text-sm text-gray-600">進行商品銷售和結帳</p>
                    </div>
                </div>
                <span class="permission-notice absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow-md z-30 hidden">需要銷售權限</span>
            </div>

            <!-- 商品管理 -->
            <div class="relative">
                <div id="menu-products" class="menu-item apple-card rounded-xl p-6 apple-shadow transition-all duration-300" data-permissions="['products', 'purchase']" data-page="products">
                    <div class="text-center">
                        <i class="fas fa-box text-4xl menu-text mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">商品管理</h3>
                        <p class="text-sm text-gray-600">管理商品資料、庫存和分類</p>
                    </div>
                </div>
                <span class="permission-notice absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow-md z-30 hidden">需要商品管理權限</span>
            </div>

            <!-- 進貨作業 -->
            <div class="relative">
                <div id="menu-purchase" class="menu-item apple-card rounded-xl p-6 apple-shadow transition-all duration-300" data-permissions="['purchase']" data-page="purchase">
                    <div class="text-center">
                        <i class="fas fa-truck text-4xl menu-text mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">進貨作業</h3>
                        <p class="text-sm text-gray-600">處理商品進貨、匯入進貨資料和供應商管理</p>
                    </div>
                </div>
                <span class="permission-notice absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow-md z-30 hidden">需要進貨管理權限</span>
            </div>

            <!-- 會員管理 -->
            <div class="relative">
                <div id="menu-members" class="menu-item apple-card rounded-xl p-6 apple-shadow transition-all duration-300" data-permissions="['members']" data-page="members">
                    <div class="text-center">
                        <i class="fas fa-users text-4xl menu-text mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">會員管理</h3>
                        <p class="text-sm text-gray-600">管理會員資料和積分</p>
                    </div>
                </div>
                <span class="permission-notice absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow-md z-30 hidden">需要會員管理權限</span>
            </div>

            <!-- 員工管理 -->
            <div class="relative">
                <div id="menu-employees" class="menu-item apple-card rounded-xl p-6 apple-shadow transition-all duration-300" data-permissions="['employees']" data-page="employees">
                    <div class="text-center">
                        <i class="fas fa-user-tie text-4xl menu-text mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">員工管理</h3>
                        <p class="text-sm text-gray-600">管理員工資料和權限</p>
                    </div>
                </div>
                <span class="permission-notice absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow-md z-30 hidden">需要員工管理權限</span>
            </div>

            <!-- 報表中心 -->
            <div class="relative">
                <div id="menu-reports" class="menu-item apple-card rounded-xl p-6 apple-shadow transition-all duration-300" data-permissions="['reports']" data-page="reports">
                    <div class="text-center">
                        <i class="fas fa-chart-pie text-4xl menu-text mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">報表中心</h3>
                        <p class="text-sm text-gray-600">查看各類統計報表</p>
                    </div>
                </div>
                <span class="permission-notice absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow-md z-30 hidden">需要報表查看權限</span>
            </div>

            <!-- 資料匯出/入 -->
            <div class="relative">
                <div id="menu-import-export" class="menu-item apple-card rounded-xl p-6 apple-shadow transition-all duration-300" data-permissions="['import-export']" data-page="import-export">
                    <div class="text-center">
                        <i class="fas fa-file-import text-4xl menu-text mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">資料匯出/入</h3>
                        <p class="text-sm text-gray-600">匯入匯出商品和會員資料</p>
                    </div>
                </div>
                <span class="permission-notice absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow-md z-30 hidden">需要資料匯出入權限</span>
            </div>

            <!-- 優惠券管理 -->
            <div class="relative">
                <div id="menu-coupons" class="menu-item disabled apple-card rounded-xl p-6 apple-shadow transition-all duration-300" data-permissions="['disabled']" data-page="coupons">
                    <div class="text-center">
                        <i class="fas fa-ticket-alt text-4xl menu-text mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">優惠券管理</h3>
                        <p class="text-sm text-gray-600">管理優惠券和促銷活動</p>
                    </div>
                </div>
                <span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow-md z-30">需要系統管理員開通</span>
            </div>

            <!-- 供應商管理 -->
            <div class="relative">
                <div id="menu-suppliers" class="menu-item apple-card rounded-xl p-6 apple-shadow transition-all duration-300" data-permissions="['suppliers']" data-page="suppliers">
                    <div class="text-center">
                        <i class="fas fa-truck text-4xl menu-text mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">供應商管理</h3>
                        <p class="text-sm text-gray-600">管理供應商資料</p>
                    </div>
                </div>
                <span class="permission-notice absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow-md z-30 hidden">需要供應商管理權限</span>
            </div>



        </div>


    </div>

    <!-- 版本紀錄彈出視窗 -->
    <div id="versionHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="text-center mb-6">
                <i class="fas fa-code-branch text-4xl menu-text mb-4"></i>
                <h3 class="text-xl font-bold text-gray-800">版本紀錄</h3>
                <p class="text-gray-600 text-sm">系統更新歷程</p>
            </div>
            
            <div id="versionHistoryContent" class="space-y-6">
                <!-- 版本內容將動態載入 -->
            </div>
            
            <div class="mt-6 flex justify-end">
                <button onclick="closeVersionHistory()" class="px-6 py-2 bg-[#17225e] text-white rounded-lg hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-times mr-1"></i>關閉
                </button>
            </div>
        </div>
    </div>

    <!-- 員工登入彈出視窗 -->
    <div id="employeeLoginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <i class="fas fa-user-tie text-4xl menu-text mb-4"></i>
                <h3 class="text-xl font-bold text-gray-800">員工登入</h3>
                <p class="text-gray-600 text-sm">請輸入員工編號</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">員工編號</label>
                    <input type="text" id="employeeId" placeholder="例：E001" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-[#17225e]">
                </div>
                

            </div>
            
            <div class="mt-6 flex space-x-3">
                <button onclick="closeEmployeeLogin()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                    取消
                </button>
                <button onclick="loginEmployee()" class="flex-1 px-4 py-2 bg-[#17225e] text-white rounded-lg hover:bg-[#1a2a6e] transition-colors">
                    登入
                </button>
            </div>
        </div>
    </div>


    
    <script>
        // 頁面導航功能
        function navigateToPage(page) {
            // 直接跳轉到對應頁面
            window.location.href = `pages/${page}.html`;
        }
        
        
        // 員工登入功能
        let employees = {};

        // 從 Supabase 載入員工資料
        async function loadEmployees() {
            try {
                // 初始化資料庫連接
                await DatabaseManager.initialize();
                
                if (!DatabaseManager.isConnected()) {
                    console.error('資料庫連接失敗');
                    return;
                }

                // 從 Supabase 獲取員工資料
                const employeeData = await BusinessAPI.getEmployees();
                
                if (employeeData && employeeData.length > 0) {
                    // 轉換為以ID為key的物件
                    employees = {};
                    employeeData.forEach(emp => {
                        // 處理 Supabase 的資料結構
                        const employeeId = emp.employee_id || emp.username || emp.id;
                        const employeeName = emp.name || '未知員工';
                        const employeeRole = emp.position || emp.role || '員工';
                        
                        // 解析權限
                        let permissions = [];
                        try {
                            if (emp.permissions) {
                                if (typeof emp.permissions === 'string') {
                                    permissions = JSON.parse(emp.permissions);
                                } else if (Array.isArray(emp.permissions)) {
                                    permissions = emp.permissions;
                                }
                            }
                        } catch (parseError) {
                            console.error('解析權限失敗:', parseError);
                            permissions = [];
                        }
                        
                        // 不再自動根據職位分配權限，保持原始權限狀態
                        
                        employees[employeeId] = {
                            name: employeeName,
                            role: employeeRole,
                            id: employeeId,
                            permissions: permissions
                        };
                    });
                    console.log('成功從 Supabase 載入員工資料:', employeeData.length, '筆');
                    document.getElementById('dataSource').textContent = `Supabase (${employeeData.length} 筆員工資料)`;
                } else {
                    console.log('資料庫中無員工資料');
                    document.getElementById('dataSource').textContent = '無員工資料 - 請聯繫系統管理員';
                    // 如果沒有員工資料，系統無法使用
                    employees = {};
                }
            } catch (error) {
                console.error('載入員工資料失敗:', error);
                document.getElementById('dataSource').textContent = '資料庫連接失敗 - 系統無法使用';
                // 如果資料庫連接失敗，系統無法使用
                employees = {};
            }
        }

        // 根據職位獲取權限（已廢棄 - 不再自動分配權限）
        function getPermissionsByRole(position) {
            // 所有職位都不自動分配權限，需要管理員手動設定
            return [];
        }

        // 生成會話ID
        function generateSessionId() {
            return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // 獲取設備資訊
        function getDeviceInfo() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                timestamp: Date.now()
            };
        }

        // 記錄員工登入到session表
        async function recordEmployeeLogin(employeeId) {
            try {
                console.log('開始記錄員工登入:', employeeId);
                
                // 初始化資料庫連接
                await DatabaseManager.initialize();
                
                if (DatabaseManager.isConnected()) {
                    // 使用台灣時間 (UTC+8)
                    const loginTime = new Date().toISOString(); // 統一使用UTC時間
                    const sessionId = generateSessionId();
                    const deviceInfo = getDeviceInfo();
                    
                    console.log('準備插入會話記錄:', {
                        session_id: sessionId,
                        employee_id: employeeId,
                        login_time: loginTime,
                        is_active: true
                    });
                    
                    // 檢查 supabase 是否可用
                    console.log('檢查 window.supabase 變數:', typeof window.supabase, window.supabase);
                    
                    if (!window.supabase) {
                        console.error('❌ window.supabase 客戶端不可用');
                        return;
                    }
                    
                    // 創建新的會話記錄（包含last_activity欄位）
                    const { data, error } = await window.supabase
                        .from('employee_sessions')
                        .insert([{
                            session_id: sessionId,
                            employee_id: employeeId,
                            login_time: loginTime,
                            is_active: true,
                            device_info: deviceInfo,
                            last_activity: loginTime
                        }])
                        .select();
                    
                    if (error) {
                        console.error('❌ 創建會話記錄失敗:', error);
                        console.error('錯誤詳情:', error.message);
                        console.error('錯誤代碼:', error.code);
                        console.error('錯誤提示:', error.hint);
                        
                        if (error.message && (error.message.includes('last_activity') || error.message.includes('column'))) {
                            console.error('❌ last_activity 欄位不存在！請在Supabase執行SQL:');
                            console.error('ALTER TABLE employee_sessions ADD COLUMN last_activity TIMESTAMPTZ;');
                            console.error('然後執行:');
                            console.error('UPDATE employee_sessions SET last_activity = login_time WHERE last_activity IS NULL;');
                        }
                        
                        // 如果會話創建失敗，不要儲存會話ID
                        console.error('❌ 會話創建失敗，不儲存會話ID');
                        return;
                    } else {
                        console.log('✅ 會話記錄已成功創建:', data);
                        console.log('員工ID:', employeeId, '會話ID:', sessionId);
                        // 只有成功創建會話記錄後才儲存會話ID到localStorage
                        localStorage.setItem('currentSessionId', sessionId);
                        console.log('✅ 會話ID已儲存到localStorage:', sessionId);
                    }
                } else {
                    console.log('❌ 資料庫未連接，無法記錄登入');
                }
            } catch (error) {
                console.error('❌ 記錄登入時發生錯誤:', error);
            }
        }

        // 記錄員工登出到session表
        async function recordEmployeeLogout(employeeId) {
            try {
                // 初始化資料庫連接
                await DatabaseManager.initialize();
                
                if (DatabaseManager.isConnected()) {
                    const currentSessionId = localStorage.getItem('currentSessionId');
                    const logoutTime = new Date().toISOString();
                    
                    if (currentSessionId) {
                        // 更新會話為非活躍狀態
                        const { error } = await window.supabase
                            .from('employee_sessions')
                            .update({ 
                                is_active: false,
                                logout_time: logoutTime
                            })
                            .eq('session_id', currentSessionId)
                            .eq('employee_id', employeeId);
                        
                        if (error) {
                            console.error('更新會話登出記錄失敗:', error);
                        } else {
                            console.log('會話登出記錄已更新:', employeeId, currentSessionId);
                        }
                        
                        // 清除本地會話ID
                        localStorage.removeItem('currentSessionId');
                    } else {
                        // 如果沒有會話ID，嘗試更新該員工的所有活躍會話
                        const { error } = await window.supabase
                            .from('employee_sessions')
                            .update({ 
                                is_active: false,
                                logout_time: logoutTime
                            })
                            .eq('employee_id', employeeId)
                            .eq('is_active', true);
                        
                        if (error) {
                            console.error('更新員工活躍會話失敗:', error);
                        } else {
                            console.log('員工活躍會話已全部登出:', employeeId);
                        }
                    }
                } else {
                    console.log('資料庫未連接，無法記錄登出');
                }
            } catch (error) {
                console.error('記錄登出時發生錯誤:', error);
            }
        }

        let currentEmployee = null;
        let heartbeatInterval = null;

        // 心跳機制：每10秒更新一次在線狀態
        function startHeartbeat(employeeId) {
            // 清除舊的心跳
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
            }
            
            console.log('🔄 啟動心跳機制，每10秒更新一次在線狀態');
            
            // 每10秒更新一次
            heartbeatInterval = setInterval(async () => {
                await updateHeartbeat(employeeId);
            }, 10000); // 10秒
            
            // 立即執行一次
            updateHeartbeat(employeeId);
        }
        
        // 停止心跳機制
        function stopHeartbeat() {
            if (heartbeatInterval) {
                console.log('⏹️ 停止心跳機制');
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }
        
        // 更新心跳
        async function updateHeartbeat(employeeId) {
            try {
                const currentSessionId = localStorage.getItem('currentSessionId');
                if (!currentSessionId) {
                    console.log('❌ 沒有會話ID，停止心跳');
                    stopHeartbeat();
                    return;
                }
                
                const now = new Date().toISOString(); // 統一使用UTC時間
                
                console.log('🔍 準備更新心跳，會話ID:', currentSessionId);
                console.log('🔍 更新時間:', now);
                
                // 嘗試更新會話，如果會話被標記為非活躍，則重新激活它
                const { data, error } = await window.supabase
                    .from('employee_sessions')
                    .update({ 
                        last_activity: now,
                        is_active: true,  // 重新激活會話
                        logout_time: null  // 清除登出時間
                    })
                    .eq('session_id', currentSessionId)
                    .select();
                
                console.log('🔍 Supabase回應:', { data, error });
                
                if (error) {
                    console.error('❌ 心跳更新失敗:', error);
                    console.error('錯誤代碼:', error.code);
                    console.error('錯誤詳情:', error.message);
                    console.error('錯誤詳情:', error.details);
                    console.error('錯誤提示:', error.hint);
                    
                    if (error.message && (error.message.includes('last_activity') || error.message.includes('column'))) {
                        console.error('❌ last_activity 欄位不存在！請在Supabase執行SQL:');
                        console.error('ALTER TABLE employee_sessions ADD COLUMN last_activity TIMESTAMPTZ;');
                        console.error('然後執行:');
                        console.error('UPDATE employee_sessions SET last_activity = login_time WHERE last_activity IS NULL;');
                        stopHeartbeat();
                    }
                } else {
                    console.log('💓 心跳更新成功:', now);
                    console.log('💓 更新的資料:', data);
                }
            } catch (error) {
                console.error('❌ 心跳更新錯誤:', error);
            }
        }

        // 版本紀錄功能
        const versionData = [
            {
                "version": "v2.7",
                "date": "2025年10月",
                "title": "折扣系統全面升級與會話管理優化",
                "isLatest": true,
                "color": "blue",
                "changes": [
                    {
                        "icon": "fas fa-percentage",
                        "color": "blue",
                        "category": "折扣系統革新",
                        "description": "全新多折扣管理系統，支援多個折扣同時套用與自訂折扣名稱"
                    },
                    {
                        "icon": "fas fa-heartbeat",
                        "color": "green",
                        "category": "會話管理優化",
                        "description": "修復心跳機制，調整離線檢測為5分鐘，啟用會話自動恢復"
                    },
                    {
                        "icon": "fas fa-calculator",
                        "color": "red",
                        "category": "計算邏輯修復",
                        "description": "修復指定品項固定金額折扣計算問題，防止總計變為負數"
                    },
                    {
                        "icon": "fas fa-palette",
                        "color": "purple",
                        "category": "介面美化",
                        "description": "重新設計快速功能區域，採用現代化漸層設計與互動效果"
                    },
                    {
                        "icon": "fas fa-tools",
                        "color": "orange",
                        "category": "功能修復",
                        "description": "修復供應商資料修改刪除功能，簡化選取商品折扣操作流程"
                    },
                    {
                        "icon": "fas fa-trash",
                        "color": "gray",
                        "category": "系統清理",
                        "description": "移除舊版折扣功能，清理調試文件和測試檔案"
                    }
                ]
            },
            {
                "version": "v2.6",
                "date": "2025年09月",
                "title": "真實登入狀態追蹤系統",
                "isLatest": false,
                "color": "green",
                "changes": [
                    {
                        "icon": "fas fa-database",
                        "color": "green",
                        "category": "資料庫架構優化",
                        "description": "改用現有employee_sessions表追蹤登入狀態，不再修改employees表結構"
                    },
                    {
                        "icon": "fas fa-users",
                        "color": "blue",
                        "category": "真實狀態追蹤",
                        "description": "實作基於會話表的真實員工登入狀態追蹤系統"
                    },
                    {
                        "icon": "fas fa-clock",
                        "color": "orange",
                        "category": "智慧會話管理",
                        "description": "30分鐘無活動自動登出機制，確保會話安全性"
                    },
                    {
                        "icon": "fas fa-sync-alt",
                        "color": "purple",
                        "category": "即時同步",
                        "description": "跨瀏覽器即時登入狀態同步，管理員可看到真實使用情況"
                    },
                    {
                        "icon": "fas fa-keyboard",
                        "color": "teal",
                        "category": "用戶體驗",
                        "description": "員工登入視窗支援Enter鍵快速登入和Escape鍵取消"
                    }
                ]
            },
            {
                "version": "v2.5",
                "date": "2025年09月",
                "title": "權限系統安全性強化",
                "isLatest": false,
                "color": "red",
                "changes": [
                    {
                        "icon": "fas fa-shield-alt",
                        "color": "red",
                        "category": "重大安全修復",
                        "description": "修復權限自動回填漏洞 - 移除所有自動權限分配邏輯"
                    },
                    {
                        "icon": "fas fa-trash-alt",
                        "color": "orange",
                        "category": "安全清理",
                        "description": "移除所有備用員工資料，徹底杜絕預設權限的可能性"
                    },
                    {
                        "icon": "fas fa-database",
                        "color": "blue",
                        "category": "資料來源控制",
                        "description": "強制依賴Supabase員工資料，無資料庫連接時系統無法使用"
                    },
                    {
                        "icon": "fas fa-spell-check",
                        "color": "green",
                        "category": "內容修正",
                        "description": "修復標題錯字：波瀾陶 → 波蘭陶食器"
                    }
                ]
            },
            {
                "version": "v2.4",
                "date": "2025年09月",
                "title": "員工權限系統全面改進",
                "isLatest": false,
                "color": "green",
                "changes": [
                    {
                        "icon": "fas fa-user-cog",
                        "color": "green",
                        "category": "權限革新",
                        "description": "職位選擇不再自動賦予權限，需管理員手動分配所有功能權限"
                    },
                    {
                        "icon": "fas fa-plus-circle",
                        "color": "blue",
                        "category": "功能擴展",
                        "description": "新增「供應商管理」和「資料匯出/入」權限選項，涵蓋全部8個系統功能"
                    },
                    {
                        "icon": "fas fa-th",
                        "color": "purple",
                        "category": "介面優化",
                        "description": "權限設定採用2欄網格布局，提升選擇效率和視覺體驗"
                    },
                    {
                        "icon": "fas fa-exclamation-triangle",
                        "color": "orange",
                        "category": "安全提醒",
                        "description": "添加明確的警告提示，說明權限分配方式和管理員責任"
                    }
                ]
            },
            {
                "version": "v2.3",
                "date": "2025年09月",
                "title": "動態版本紀錄系統",
                "isLatest": false,
                "color": "blue",
                "changes": [
                    {
                        "icon": "fas fa-code-branch",
                        "color": "blue",
                        "category": "新功能",
                        "description": "新增動態版本紀錄按鈕，支援JSON資料載入"
                    },
                    {
                        "icon": "fas fa-rocket",
                        "color": "green",
                        "category": "效能優化",
                        "description": "智能緩存機制，提升版本資料載入速度"
                    },
                    {
                        "icon": "fas fa-paint-brush",
                        "color": "purple",
                        "category": "視覺改進",
                        "description": "美觀的載入動畫和錯誤處理介面"
                    }
                ]
            },
            {
                "version": "v2.2",
                "date": "2025年09月",
                "title": "重大安全更新與系統優化",
                "isLatest": false,
                "color": "green",
                "changes": [
                    {
                        "icon": "fas fa-shield-alt",
                        "color": "green",
                        "category": "安全增強",
                        "description": "修復URL繞過權限檢查的安全漏洞，為所有頁面添加完整的權限驗證"
                    },
                    {
                        "icon": "fas fa-bug",
                        "color": "orange",
                        "category": "錯誤修復",
                        "description": "修復員工管理頁面phone欄位儲存問題"
                    },
                    {
                        "icon": "fas fa-broom",
                        "color": "blue",
                        "category": "系統清理",
                        "description": "清理不必要的console輸出和冗餘檔案"
                    },
                    {
                        "icon": "fas fa-file-alt",
                        "color": "purple",
                        "category": "文檔更新",
                        "description": "更新README.md反映當前系統狀態"
                    }
                ]
            },
            {
                "version": "v2.1",
                "date": "2025年09月",
                "title": "權限系統改進與介面優化",
                "isLatest": false,
                "color": "yellow",
                "changes": [
                    {
                        "icon": "fas fa-user-shield",
                        "color": "green",
                        "category": "權限優化",
                        "description": "改進員工權限視覺化提示"
                    },
                    {
                        "icon": "fas fa-ban",
                        "color": "red",
                        "category": "功能控制",
                        "description": "優惠券管理永久禁用"
                    },
                    {
                        "icon": "fas fa-eye",
                        "color": "blue",
                        "category": "介面改進",
                        "description": "移除不必要的權限提示文字"
                    }
                ]
            },
            {
                "version": "v2.0",
                "date": "2025年08月",
                "title": "核心功能完善",
                "isLatest": false,
                "color": "gray",
                "changes": [
                    {
                        "icon": "fas fa-database",
                        "color": "green",
                        "category": "資料庫整合",
                        "description": "完整的Supabase資料庫整合"
                    },
                    {
                        "icon": "fas fa-users",
                        "color": "blue",
                        "category": "員工管理",
                        "description": "完整的員工CRUD功能"
                    },
                    {
                        "icon": "fas fa-box",
                        "color": "orange",
                        "category": "商品管理",
                        "description": "商品、分類、供應商管理"
                    }
                ]
            },
            {
                "version": "v1.0",
                "date": "2025年07月",
                "title": "初始版本發布",
                "isLatest": false,
                "color": "gray",
                "changes": [
                    {
                        "icon": "fas fa-rocket",
                        "color": "green",
                        "category": "系統啟動",
                        "description": "基礎進銷存系統架構"
                    },
                    {
                        "icon": "fas fa-cash-register",
                        "color": "blue",
                        "category": "銷售功能",
                        "description": "基本的POS銷售作業"
                    },
                    {
                        "icon": "fas fa-chart-pie",
                        "color": "purple",
                        "category": "報表系統",
                        "description": "基礎數據統計功能"
                    }
                ]
            }
        ];

        function showVersionHistory() {
            document.getElementById('versionHistoryModal').classList.remove('hidden');
            renderVersionHistory(versionData);
        }

        function renderVersionHistory(versions) {
            const container = document.getElementById('versionHistoryContent');
            container.innerHTML = '';

            versions.forEach(version => {
                const versionElement = createVersionElement(version);
                container.appendChild(versionElement);
            });
        }

        function createVersionElement(version) {
            const colorClasses = {
                blue: { border: 'border-blue-500', bg: 'bg-blue-50' },
                green: { border: 'border-green-500', bg: 'bg-green-50' },
                yellow: { border: 'border-yellow-500', bg: 'bg-yellow-50' },
                gray: { border: 'border-gray-500', bg: 'bg-gray-50' }
            };

            const iconColors = {
                green: 'text-green-500',
                blue: 'text-blue-500',
                orange: 'text-orange-500',
                purple: 'text-purple-500',
                red: 'text-red-500'
            };

            const colors = colorClasses[version.color] || colorClasses.gray;
            
            const versionDiv = document.createElement('div');
            versionDiv.className = `border-l-4 ${colors.border} pl-4 ${colors.bg} p-4 rounded-lg`;

            let badgeHtml = '';
            if (version.isLatest) {
                badgeHtml = `<span class="bg-blue-500 text-white px-2 py-1 rounded-full text-xs">最新版本</span>`;
            } else {
                badgeHtml = `<span class="text-xs text-gray-500">${version.date}</span>`;
            }

            let changesHtml = '';
            version.changes.forEach(change => {
                const iconColor = iconColors[change.color] || 'text-gray-500';
                changesHtml += `
                    <div class="flex items-start">
                        <i class="${change.icon} ${iconColor} mr-2 mt-0.5"></i>
                        <span><strong>${change.category}：</strong>${change.description}</span>
                    </div>
                `;
            });

            versionDiv.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-lg font-semibold text-gray-800">${version.version}</h4>
                    ${badgeHtml}
                </div>
                <p class="text-sm text-gray-600 mb-3">${version.date} - ${version.title}</p>
                <div class="space-y-2 text-sm">
                    ${changesHtml}
                </div>
            `;

            return versionDiv;
        }


        function closeVersionHistory() {
            document.getElementById('versionHistoryModal').classList.add('hidden');
        }

        // 點擊模態視窗外部關閉
        document.addEventListener('click', function(event) {
            const versionModal = document.getElementById('versionHistoryModal');
            if (event.target === versionModal) {
                closeVersionHistory();
            }
        });

        function showEmployeeLogin() {
            document.getElementById('employeeLoginModal').classList.remove('hidden');
            const employeeIdInput = document.getElementById('employeeId');
            employeeIdInput.focus();
            
            // 添加Enter鍵事件監聽器
            employeeIdInput.addEventListener('keydown', handleEmployeeLoginKeydown);
        }
        
        // 處理員工登入視窗的鍵盤事件
        function handleEmployeeLoginKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                loginEmployee();
            } else if (event.key === 'Escape') {
                event.preventDefault();
                closeEmployeeLogin();
            }
        }

        function closeEmployeeLogin() {
            document.getElementById('employeeLoginModal').classList.add('hidden');
            const employeeIdInput = document.getElementById('employeeId');
            employeeIdInput.value = '';
            
            // 移除Enter鍵事件監聽器，避免重複添加
            employeeIdInput.removeEventListener('keydown', handleEmployeeLoginKeydown);
        }

        async function loginEmployee() {
            const employeeId = document.getElementById('employeeId').value.trim();
            
            if (!employeeId) {
                alert('請輸入員工編號');
                return;
            }

            console.log('嘗試登入...');

            try {
                // 檢查員工是否存在於 Supabase 資料中
                if (employees[employeeId]) {
                    const employee = employees[employeeId];
                    console.log('登入驗證成功');
                    
                    // 記錄登入時間到資料庫
                    await recordEmployeeLogin(employeeId);
                    
                    // 更新UI
                    document.getElementById('employeeName').textContent = employee.name;
                    document.querySelector('[onclick="showEmployeeLogin()"]').classList.add('hidden');
                    document.getElementById('employeeInfo').classList.remove('hidden');
                    
                    // 顯示主選單
                    document.getElementById('loginRequired').classList.add('hidden');
                    document.getElementById('mainMenu').classList.remove('hidden');
                    
                    // 關閉登入視窗
                    closeEmployeeLogin();
                    
                    // 儲存當前員工資訊
                    currentEmployee = employee;
                    localStorage.setItem('currentEmployee', JSON.stringify(employee));
                    
                    // 啟動心跳機制
                    startHeartbeat(employeeId);
                    
                    // 確保 currentEmployee 設定完成後再更新選單權限
                    setTimeout(() => {
                        console.log('更新選單權限');
                        updateMenuPermissions();
                    }, 100);
                    
                    // 顯示歡迎訊息
                    alert(`歡迎 ${employee.name} (${employee.role})！\n\n您已成功登入系統。`);
                } else {
                    console.log('登入失敗：員工編號不存在');
                    alert(`員工編號不存在：${employeeId}\n\n請檢查後重新輸入`);
                }
                
            } catch (error) {
                console.error('登入錯誤:', error);
                alert(`登入失敗：${error.message}`);
            }
        }

        // 檢查是否已登入
        async function checkEmployeeLogin() {
            // 檢查是否有儲存的員工資訊
            const savedEmployee = localStorage.getItem('currentEmployee');
            if (savedEmployee) {
                try {
                    currentEmployee = JSON.parse(savedEmployee);
                    console.log('載入已儲存的登入狀態');
                    
                    // 更新UI元素
                    document.getElementById('employeeName').textContent = currentEmployee.name;
                    document.querySelector('[onclick="showEmployeeLogin()"]').classList.add('hidden');
                    document.getElementById('employeeInfo').classList.remove('hidden');
                    
                    // 顯示主選單
                    document.getElementById('loginRequired').classList.add('hidden');
                    document.getElementById('mainMenu').classList.remove('hidden');
                    
                    // 重新啟動心跳機制
                    startHeartbeat(currentEmployee.id);
                    
                    // 確保 currentEmployee 設定完成後再更新選單權限
                    setTimeout(() => {
                        console.log('執行選單權限更新');
                        updateMenuPermissions();
                    }, 100);
                    
                    return true;
                } catch (error) {
                    console.error('解析儲存的員工資訊失敗:', error);
                    localStorage.removeItem('currentEmployee');
                    currentEmployee = null;
                }
            }
            
            // 未登入時顯示登入提示
            document.getElementById('loginRequired').classList.remove('hidden');
            document.getElementById('mainMenu').classList.add('hidden');
            
            // 確保當前員工為 null 後更新選單權限（禁用所有按鈕）
            currentEmployee = null;
            setTimeout(() => {
                console.log('執行選單權限更新（未登入狀態）');
                updateMenuPermissions();
            }, 100);
            
            return false;
        }

        // 權限檢查和導航
        function checkPermissionAndNavigate(page, requiredRoles) {
            if (!currentEmployee) {
                alert('請先登入！');
                return;
            }

            // 檢查權限
            if (hasPermission(currentEmployee, requiredRoles)) {
                navigateToPage(page);
            } else {
                alert(`權限不足！\n\n此功能需要以下權限：${requiredRoles.join(' 或 ')}\n\n您的權限：${currentEmployee.role}`);
            }
        }



        // 更新選單按鈕狀態
        function updateMenuPermissions() {
            console.log('=== 更新選單權限開始 ===');
            
            const menuItems = document.querySelectorAll('.menu-item');
            console.log('找到選單項目數量:', menuItems.length);
            
            if (!currentEmployee) {
                console.log('未登入狀態，禁用所有按鈕');
                // 未登入時，所有按鈕都禁用並顯示權限提示
                menuItems.forEach(item => {
                    item.classList.add('disabled');
                    item.onclick = null;
                    
                    // 顯示權限提示
                    const permissionNotice = item.parentElement.querySelector('.permission-notice');
                    if (permissionNotice && item.dataset.page !== 'coupons') {
                        permissionNotice.classList.remove('hidden');
                    }
                    
                    console.log(`禁用按鈕: ${item.dataset.page}`);
                });
                console.log('=== 更新選單權限完成（未登入） ===');
                return;
            }

            // 首先確保優惠券管理在任何情況下都保持禁用
            const couponsItem = document.getElementById('menu-coupons');
            if (couponsItem) {
                couponsItem.classList.add('disabled');
                couponsItem.onclick = null;
                console.log('🚫 優惠券管理永久禁用');
            }

            console.log('已登入狀態，開始檢查個別權限');
            
            // 遍歷所有選單項目
            menuItems.forEach((item, index) => {
                try {
                    const page = item.dataset.page;
                    const permissionsData = item.dataset.permissions;
                    
                    console.log(`檢查第 ${index + 1} 個項目: ${page}`);
                    console.log(`原始權限字串: ${permissionsData}`);
                    
                    // 特殊處理：優惠券管理永遠禁用
                    if (page === 'coupons') {
                        item.classList.add('disabled');
                        item.onclick = null;
                        console.log(`🚫 強制禁用按鈕: ${page} (系統管理員功能)`);
                        return;
                    }
                    
                    // 修正 JSON 格式：將單引號替換為雙引號
                    const permissionsStr = permissionsData.replace(/'/g, '"');
                    const requiredPermissions = JSON.parse(permissionsStr);
                    
                    console.log(`檢查權限要求:`, requiredPermissions.length, '項');
                    
                    // 檢查權限
                    const hasAccess = hasPermission(currentEmployee, requiredPermissions);
                    
                    console.log(`項目 ${page} 權限檢查結果: ${hasAccess}`);
                    
                    // 找到對應的權限提示元素
                    const permissionNotice = item.parentElement.querySelector('.permission-notice');
                    
                    if (hasAccess) {
                        // 有權限：啟用按鈕，隱藏權限提示
                        item.classList.remove('disabled');
                        item.onclick = () => {
                            console.log(`點擊導航到: ${page}`);
                            navigateToPage(page);
                        };
                        if (permissionNotice) {
                            permissionNotice.classList.add('hidden');
                        }
                        console.log(`✅ 啟用按鈕: ${page}`);
                    } else {
                        // 無權限：禁用按鈕，顯示權限提示
                        item.classList.add('disabled');
                        item.onclick = null;
                        if (permissionNotice) {
                            permissionNotice.classList.remove('hidden');
                        }
                        console.log(`❌ 禁用按鈕: ${page}`);
                    }
                } catch (error) {
                    console.error(`❗ 解析權限失敗 (${item.dataset.page}):`, error);
                    console.log('原始權限字串:', item.dataset.permissions);
                    // 解析失敗時禁用按鈕
                    item.classList.add('disabled');
                    item.onclick = null;
                }
            });
            
            console.log('=== 更新選單權限完成 ===');
        }

        // 檢查權限（新版本，支援字串權限）
        function hasPermission(employee, requiredPermissions) {
            console.log('權限檢查:', {
                employee: employee,
                requiredPermissions: requiredPermissions,
                employeePermissions: employee?.permissions
            });
            
            // 如果沒有權限要求（空陣列），表示所有人都可以訪問
            if (!requiredPermissions || requiredPermissions.length === 0) {
                console.log('無權限要求，所有人可訪問');
                return true;
            }
            
            if (!employee || !employee.permissions) {
                console.log('權限檢查失敗：無效用戶');
                return false;
            }

            // 如果員工有 'all' 權限，直接返回 true
            if (employee.permissions.includes('all')) {
                console.log('擁有完整權限，允許訪問');
                return true;
            }

            // 檢查是否包含所需的任何一個權限
            const hasRequiredPermission = requiredPermissions.some(permission => 
                employee.permissions.includes(permission)
            );
            
            console.log('權限檢查結果:', hasRequiredPermission);
            return hasRequiredPermission;
        }

        // 顯示當前員工權限
        function showPermissions() {
            if (!currentEmployee) {
                alert('請先登入！');
                return;
            }

            const permissions = currentEmployee.permissions || [];
            const permissionNames = {
                'all': '所有權限',

                'sales': '銷售作業',
                'products': '商品管理',
                'purchase': '進貨管理',
                'members': '會員管理',
                'employees': '員工管理',
                'reports': '報表查看',
                'coupons': '優惠券管理',
                'suppliers': '供應商管理',
                'import-export': '資料匯出入',
                '': '無權限要求（所有人可訪問）'
            };

            const permissionList = permissions.map(p => permissionNames[p] || p).join('\n• ');
            
            alert(`🔑 權限資訊\n\n員工：${currentEmployee.name}\n職位：${currentEmployee.role}\n\n擁有權限：\n• ${permissionList || '無特殊權限'}`);
        }

        // 員工登出功能
        async function logoutEmployee() {
            if (!confirm('確定要登出嗎？')) return;
            
            try {
                // 停止心跳機制
                stopHeartbeat();
                
                // 記錄登出到資料庫
                if (currentEmployee && currentEmployee.id) {
                    await recordEmployeeLogout(currentEmployee.id);
                }
                
                // 清除當前員工資訊
                currentEmployee = null;
                localStorage.removeItem('currentEmployee');
                
                // 更新UI
                document.getElementById('employeeName').textContent = '員工';
                document.querySelector('[onclick="showEmployeeLogin()"]').classList.remove('hidden');
                document.getElementById('employeeInfo').classList.add('hidden');
                
                // 更新選單權限（禁用所有按鈕）
                updateMenuPermissions();
                
                // 顯示登入提示
                document.getElementById('loginRequired').classList.remove('hidden');
                document.getElementById('mainMenu').classList.add('hidden');
                
                alert('已成功登出！');
            } catch (error) {
                alert(`登出失敗：${error.message}`);
            }
        }


        // 頁面載入時的初始化
        document.addEventListener('DOMContentLoaded', async function() {
            // 載入員工資料
            await loadEmployees();
            await checkEmployeeLogin();
        });
    </script>
    
</body>
</html>