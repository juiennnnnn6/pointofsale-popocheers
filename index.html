<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¢æ³¢èš æ­æ´²å®¶å±…/æ³¢è˜­é™¶é£Ÿå™¨-é€²éŠ·å­˜ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="database.js"></script>
    <script src="employee-auth.js"></script>
    <style>
        /* è˜‹æœé¢¨æ ¼è‡ªå®šç¾©æ¨£å¼ */
        .apple-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .apple-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #17225e 0%, #1a2a6e 100%);
        }
        
        /* æ¬Šé™æ§åˆ¶æ¨£å¼ */
        .menu-item {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .menu-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .menu-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            filter: grayscale(50%);
        }
        
        .menu-item.disabled:hover {
            transform: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .menu-item.disabled .text-gray-800 {
            color: #9ca3af !important;
        }
        
        .menu-item.disabled .text-gray-600 {
            color: #d1d5db !important;
        }
        
        .menu-item.disabled .text-red-500:not(.keep-original) {
            color: #fca5a5 !important;
        }
        
        /* è®“æç¤ºæ–‡å­—å®Œå…¨ä¸å— disabled å½±éŸ¿ */
        .status-label {
            opacity: 1 !important;
            color: #ef4444 !important;
            background-color: white !important;
            position: relative;
            z-index: 20;
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .menu-item.disabled .menu-text {
            color: #9ca3af !important;
        }
        
        .menu-item.disabled i {
            opacity: 0.5;
        }
        
        /* å®šç¾©ä¸»é¡Œé¡è‰²é¡ */
        .menu-text {
            color: #17225e;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="gradient-bg text-white p-4 apple-shadow sticky top-0 z-50">
        <div class="container mx-auto">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-store-alt text-2xl"></i>
                    <h1 class="text-xl font-semibold">æ­¡è¿å›ä¾†ï¼Œæ³¢æ³¢ èš</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm opacity-90">ver2.7</span>
                    <div id="dataStatus" class="text-xs opacity-75">
                        <i class="fas fa-database mr-1"></i><span id="dataSource">è¼‰å…¥ä¸­...</span>
                    </div>
                    <button onclick="showVersionHistory()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded-lg text-sm transition-colors">
                        <i class="fas fa-code-branch mr-1"></i>ç‰ˆæœ¬ç´€éŒ„
                    </button>
                    <button onclick="showEmployeeLogin()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded-lg text-sm transition-colors">
                        <i class="fas fa-user mr-1"></i>å“¡å·¥ç™»å…¥
                    </button>
                    <div id="employeeInfo" class="hidden bg-white bg-opacity-20 px-3 py-1 rounded-lg text-sm">
                        <i class="fas fa-user-check mr-1"></i><span id="employeeName">å“¡å·¥</span>
                        <a href="mailto:your.email@example.com?subject=è¯çµ¡æˆ‘å€‘[æ³¢æ³¢èš æ­æ´²å®¶å±…/æ³¢è˜­é™¶é£Ÿå™¨-é€²éŠ·å­˜ç³»çµ±]" 
                            class="ml-2 text-xs bg-[#17225e] hover:bg-[#1a2a6e] px-2 py-1 rounded transition-colors">
                             <i class="fas fa-key mr-1"></i>è¯çµ¡æˆ‘å€‘
                        </a>
                        <button onclick="logoutEmployee()" class="ml-2 text-xs bg-red-500 hover:bg-red-600 px-2 py-1 rounded transition-colors">
                            <i class="fas fa-sign-out-alt mr-1"></i>ç™»å‡º
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
    <div class="container mx-auto p-6">
        <!-- ç™»å…¥æç¤º -->
        <div id="loginRequired" class="apple-card rounded-xl p-8 text-center apple-shadow">
            <i class="fas fa-lock text-6xl text-gray-400 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">è«‹å…ˆç™»å…¥</h2>
            <p class="text-gray-600 mb-6">æ‚¨éœ€è¦ç™»å…¥æ‰èƒ½ä½¿ç”¨ç³»çµ±åŠŸèƒ½</p>
                            <button onclick="showEmployeeLogin()" class="bg-[#17225e] text-white px-6 py-3 rounded-lg hover:bg-[#1a2a6e] transition-colors">
                <i class="fas fa-sign-in-alt mr-2"></i>å“¡å·¥ç™»å…¥
            </button>
        </div>

        <!-- ä¸»åŠŸèƒ½é¸å–® -->
        <div id="mainMenu" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 hidden">
            


            <!-- éŠ·å”®ä½œæ¥­ -->
            <div class="relative">
                <div id="menu-sales" class="menu-item apple-card rounded-xl p-6 apple-shadow transition-all duration-300" data-permissions="['sales']" data-page="sales">
                    <div class="text-center">
                        <i class="fas fa-cash-register text-4xl menu-text mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">éŠ·å”®ä½œæ¥­</h3>
                        <p class="text-sm text-gray-600">é€²è¡Œå•†å“éŠ·å”®å’Œçµå¸³</p>
                    </div>
                </div>
                <span class="permission-notice absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow-md z-30 hidden">éœ€è¦éŠ·å”®æ¬Šé™</span>
            </div>

            <!-- å•†å“ç®¡ç† -->
            <div class="relative">
                <div id="menu-products" class="menu-item apple-card rounded-xl p-6 apple-shadow transition-all duration-300" data-permissions="['products', 'purchase']" data-page="products">
                    <div class="text-center">
                        <i class="fas fa-box text-4xl menu-text mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">å•†å“ç®¡ç†</h3>
                        <p class="text-sm text-gray-600">ç®¡ç†å•†å“è³‡æ–™ã€åº«å­˜å’Œåˆ†é¡</p>
                    </div>
                </div>
                <span class="permission-notice absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow-md z-30 hidden">éœ€è¦å•†å“ç®¡ç†æ¬Šé™</span>
            </div>

            <!-- é€²è²¨ä½œæ¥­ -->
            <div class="relative">
                <div id="menu-purchase" class="menu-item apple-card rounded-xl p-6 apple-shadow transition-all duration-300" data-permissions="['purchase']" data-page="purchase">
                    <div class="text-center">
                        <i class="fas fa-truck text-4xl menu-text mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">é€²è²¨ä½œæ¥­</h3>
                        <p class="text-sm text-gray-600">è™•ç†å•†å“é€²è²¨ã€åŒ¯å…¥é€²è²¨è³‡æ–™å’Œä¾›æ‡‰å•†ç®¡ç†</p>
                    </div>
                </div>
                <span class="permission-notice absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow-md z-30 hidden">éœ€è¦é€²è²¨ç®¡ç†æ¬Šé™</span>
            </div>

            <!-- æœƒå“¡ç®¡ç† -->
            <div class="relative">
                <div id="menu-members" class="menu-item apple-card rounded-xl p-6 apple-shadow transition-all duration-300" data-permissions="['members']" data-page="members">
                    <div class="text-center">
                        <i class="fas fa-users text-4xl menu-text mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">æœƒå“¡ç®¡ç†</h3>
                        <p class="text-sm text-gray-600">ç®¡ç†æœƒå“¡è³‡æ–™å’Œç©åˆ†</p>
                    </div>
                </div>
                <span class="permission-notice absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow-md z-30 hidden">éœ€è¦æœƒå“¡ç®¡ç†æ¬Šé™</span>
            </div>

            <!-- å“¡å·¥ç®¡ç† -->
            <div class="relative">
                <div id="menu-employees" class="menu-item apple-card rounded-xl p-6 apple-shadow transition-all duration-300" data-permissions="['employees']" data-page="employees">
                    <div class="text-center">
                        <i class="fas fa-user-tie text-4xl menu-text mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">å“¡å·¥ç®¡ç†</h3>
                        <p class="text-sm text-gray-600">ç®¡ç†å“¡å·¥è³‡æ–™å’Œæ¬Šé™</p>
                    </div>
                </div>
                <span class="permission-notice absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow-md z-30 hidden">éœ€è¦å“¡å·¥ç®¡ç†æ¬Šé™</span>
            </div>

            <!-- å ±è¡¨ä¸­å¿ƒ -->
            <div class="relative">
                <div id="menu-reports" class="menu-item apple-card rounded-xl p-6 apple-shadow transition-all duration-300" data-permissions="['reports']" data-page="reports">
                    <div class="text-center">
                        <i class="fas fa-chart-pie text-4xl menu-text mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">å ±è¡¨ä¸­å¿ƒ</h3>
                        <p class="text-sm text-gray-600">æŸ¥çœ‹å„é¡çµ±è¨ˆå ±è¡¨</p>
                    </div>
                </div>
                <span class="permission-notice absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow-md z-30 hidden">éœ€è¦å ±è¡¨æŸ¥çœ‹æ¬Šé™</span>
            </div>

            <!-- è³‡æ–™åŒ¯å‡º/å…¥ -->
            <div class="relative">
                <div id="menu-import-export" class="menu-item apple-card rounded-xl p-6 apple-shadow transition-all duration-300" data-permissions="['import-export']" data-page="import-export">
                    <div class="text-center">
                        <i class="fas fa-file-import text-4xl menu-text mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">è³‡æ–™åŒ¯å‡º/å…¥</h3>
                        <p class="text-sm text-gray-600">åŒ¯å…¥åŒ¯å‡ºå•†å“å’Œæœƒå“¡è³‡æ–™</p>
                    </div>
                </div>
                <span class="permission-notice absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow-md z-30 hidden">éœ€è¦è³‡æ–™åŒ¯å‡ºå…¥æ¬Šé™</span>
            </div>

            <!-- å„ªæƒ åˆ¸ç®¡ç† -->
            <div class="relative">
                <div id="menu-coupons" class="menu-item disabled apple-card rounded-xl p-6 apple-shadow transition-all duration-300" data-permissions="['disabled']" data-page="coupons">
                    <div class="text-center">
                        <i class="fas fa-ticket-alt text-4xl menu-text mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">å„ªæƒ åˆ¸ç®¡ç†</h3>
                        <p class="text-sm text-gray-600">ç®¡ç†å„ªæƒ åˆ¸å’Œä¿ƒéŠ·æ´»å‹•</p>
                    </div>
                </div>
                <span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow-md z-30">éœ€è¦ç³»çµ±ç®¡ç†å“¡é–‹é€š</span>
            </div>

            <!-- ä¾›æ‡‰å•†ç®¡ç† -->
            <div class="relative">
                <div id="menu-suppliers" class="menu-item apple-card rounded-xl p-6 apple-shadow transition-all duration-300" data-permissions="['suppliers']" data-page="suppliers">
                    <div class="text-center">
                        <i class="fas fa-truck text-4xl menu-text mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">ä¾›æ‡‰å•†ç®¡ç†</h3>
                        <p class="text-sm text-gray-600">ç®¡ç†ä¾›æ‡‰å•†è³‡æ–™</p>
                    </div>
                </div>
                <span class="permission-notice absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow-md z-30 hidden">éœ€è¦ä¾›æ‡‰å•†ç®¡ç†æ¬Šé™</span>
            </div>



        </div>


    </div>

    <!-- ç‰ˆæœ¬ç´€éŒ„å½ˆå‡ºè¦–çª— -->
    <div id="versionHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="text-center mb-6">
                <i class="fas fa-code-branch text-4xl menu-text mb-4"></i>
                <h3 class="text-xl font-bold text-gray-800">ç‰ˆæœ¬ç´€éŒ„</h3>
                <p class="text-gray-600 text-sm">ç³»çµ±æ›´æ–°æ­·ç¨‹</p>
            </div>
            
            <div id="versionHistoryContent" class="space-y-6">
                <!-- ç‰ˆæœ¬å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
            </div>
            
            <div class="mt-6 flex justify-end">
                <button onclick="closeVersionHistory()" class="px-6 py-2 bg-[#17225e] text-white rounded-lg hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-times mr-1"></i>é—œé–‰
                </button>
            </div>
        </div>
    </div>

    <!-- å“¡å·¥ç™»å…¥å½ˆå‡ºè¦–çª— -->
    <div id="employeeLoginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <i class="fas fa-user-tie text-4xl menu-text mb-4"></i>
                <h3 class="text-xl font-bold text-gray-800">å“¡å·¥ç™»å…¥</h3>
                <p class="text-gray-600 text-sm">è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿ</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å“¡å·¥ç·¨è™Ÿ</label>
                    <input type="text" id="employeeId" placeholder="ä¾‹ï¼šE001" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-[#17225e]">
                </div>
                

            </div>
            
            <div class="mt-6 flex space-x-3">
                <button onclick="closeEmployeeLogin()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                    å–æ¶ˆ
                </button>
                <button onclick="loginEmployee()" class="flex-1 px-4 py-2 bg-[#17225e] text-white rounded-lg hover:bg-[#1a2a6e] transition-colors">
                    ç™»å…¥
                </button>
            </div>
        </div>
    </div>


    
    <script>
        // é é¢å°èˆªåŠŸèƒ½
        function navigateToPage(page) {
            // ç›´æ¥è·³è½‰åˆ°å°æ‡‰é é¢
            window.location.href = `pages/${page}.html`;
        }
        
        
        // å“¡å·¥ç™»å…¥åŠŸèƒ½
        let employees = {};

        // å¾ Supabase è¼‰å…¥å“¡å·¥è³‡æ–™
        async function loadEmployees() {
            try {
                // åˆå§‹åŒ–è³‡æ–™åº«é€£æ¥
                await DatabaseManager.initialize();
                
                if (!DatabaseManager.isConnected()) {
                    console.error('è³‡æ–™åº«é€£æ¥å¤±æ•—');
                    return;
                }

                // å¾ Supabase ç²å–å“¡å·¥è³‡æ–™
                const employeeData = await BusinessAPI.getEmployees();
                
                if (employeeData && employeeData.length > 0) {
                    // è½‰æ›ç‚ºä»¥IDç‚ºkeyçš„ç‰©ä»¶
                    employees = {};
                    employeeData.forEach(emp => {
                        // è™•ç† Supabase çš„è³‡æ–™çµæ§‹
                        const employeeId = emp.employee_id || emp.username || emp.id;
                        const employeeName = emp.name || 'æœªçŸ¥å“¡å·¥';
                        const employeeRole = emp.position || emp.role || 'å“¡å·¥';
                        
                        // è§£ææ¬Šé™
                        let permissions = [];
                        try {
                            if (emp.permissions) {
                                if (typeof emp.permissions === 'string') {
                                    permissions = JSON.parse(emp.permissions);
                                } else if (Array.isArray(emp.permissions)) {
                                    permissions = emp.permissions;
                                }
                            }
                        } catch (parseError) {
                            console.error('è§£ææ¬Šé™å¤±æ•—:', parseError);
                            permissions = [];
                        }
                        
                        // ä¸å†è‡ªå‹•æ ¹æ“šè·ä½åˆ†é…æ¬Šé™ï¼Œä¿æŒåŸå§‹æ¬Šé™ç‹€æ…‹
                        
                        employees[employeeId] = {
                            name: employeeName,
                            role: employeeRole,
                            id: employeeId,
                            permissions: permissions
                        };
                    });
                    console.log('æˆåŠŸå¾ Supabase è¼‰å…¥å“¡å·¥è³‡æ–™:', employeeData.length, 'ç­†');
                    document.getElementById('dataSource').textContent = `Supabase (${employeeData.length} ç­†å“¡å·¥è³‡æ–™)`;
                } else {
                    console.log('è³‡æ–™åº«ä¸­ç„¡å“¡å·¥è³‡æ–™');
                    document.getElementById('dataSource').textContent = 'ç„¡å“¡å·¥è³‡æ–™ - è«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡';
                    // å¦‚æœæ²’æœ‰å“¡å·¥è³‡æ–™ï¼Œç³»çµ±ç„¡æ³•ä½¿ç”¨
                    employees = {};
                }
            } catch (error) {
                console.error('è¼‰å…¥å“¡å·¥è³‡æ–™å¤±æ•—:', error);
                document.getElementById('dataSource').textContent = 'è³‡æ–™åº«é€£æ¥å¤±æ•— - ç³»çµ±ç„¡æ³•ä½¿ç”¨';
                // å¦‚æœè³‡æ–™åº«é€£æ¥å¤±æ•—ï¼Œç³»çµ±ç„¡æ³•ä½¿ç”¨
                employees = {};
            }
        }

        // æ ¹æ“šè·ä½ç²å–æ¬Šé™ï¼ˆå·²å»¢æ£„ - ä¸å†è‡ªå‹•åˆ†é…æ¬Šé™ï¼‰
        function getPermissionsByRole(position) {
            // æ‰€æœ‰è·ä½éƒ½ä¸è‡ªå‹•åˆ†é…æ¬Šé™ï¼Œéœ€è¦ç®¡ç†å“¡æ‰‹å‹•è¨­å®š
            return [];
        }

        // ç”Ÿæˆæœƒè©±ID
        function generateSessionId() {
            return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // ç²å–è¨­å‚™è³‡è¨Š
        function getDeviceInfo() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                timestamp: Date.now()
            };
        }

        // è¨˜éŒ„å“¡å·¥ç™»å…¥åˆ°sessionè¡¨
        async function recordEmployeeLogin(employeeId) {
            try {
                console.log('é–‹å§‹è¨˜éŒ„å“¡å·¥ç™»å…¥:', employeeId);
                
                // åˆå§‹åŒ–è³‡æ–™åº«é€£æ¥
                await DatabaseManager.initialize();
                
                if (DatabaseManager.isConnected()) {
                    // ä½¿ç”¨å°ç£æ™‚é–“ (UTC+8)
                    const loginTime = new Date().toISOString(); // çµ±ä¸€ä½¿ç”¨UTCæ™‚é–“
                    const sessionId = generateSessionId();
                    const deviceInfo = getDeviceInfo();
                    
                    console.log('æº–å‚™æ’å…¥æœƒè©±è¨˜éŒ„:', {
                        session_id: sessionId,
                        employee_id: employeeId,
                        login_time: loginTime,
                        is_active: true
                    });
                    
                    // æª¢æŸ¥ supabase æ˜¯å¦å¯ç”¨
                    console.log('æª¢æŸ¥ window.supabase è®Šæ•¸:', typeof window.supabase, window.supabase);
                    
                    if (!window.supabase) {
                        console.error('âŒ window.supabase å®¢æˆ¶ç«¯ä¸å¯ç”¨');
                        return;
                    }
                    
                    // å‰µå»ºæ–°çš„æœƒè©±è¨˜éŒ„ï¼ˆåŒ…å«last_activityæ¬„ä½ï¼‰
                    const { data, error } = await window.supabase
                        .from('employee_sessions')
                        .insert([{
                            session_id: sessionId,
                            employee_id: employeeId,
                            login_time: loginTime,
                            is_active: true,
                            device_info: deviceInfo,
                            last_activity: loginTime
                        }])
                        .select();
                    
                    if (error) {
                        console.error('âŒ å‰µå»ºæœƒè©±è¨˜éŒ„å¤±æ•—:', error);
                        console.error('éŒ¯èª¤è©³æƒ…:', error.message);
                        console.error('éŒ¯èª¤ä»£ç¢¼:', error.code);
                        console.error('éŒ¯èª¤æç¤º:', error.hint);
                        
                        if (error.message && (error.message.includes('last_activity') || error.message.includes('column'))) {
                            console.error('âŒ last_activity æ¬„ä½ä¸å­˜åœ¨ï¼è«‹åœ¨SupabaseåŸ·è¡ŒSQL:');
                            console.error('ALTER TABLE employee_sessions ADD COLUMN last_activity TIMESTAMPTZ;');
                            console.error('ç„¶å¾ŒåŸ·è¡Œ:');
                            console.error('UPDATE employee_sessions SET last_activity = login_time WHERE last_activity IS NULL;');
                        }
                        
                        // å¦‚æœæœƒè©±å‰µå»ºå¤±æ•—ï¼Œä¸è¦å„²å­˜æœƒè©±ID
                        console.error('âŒ æœƒè©±å‰µå»ºå¤±æ•—ï¼Œä¸å„²å­˜æœƒè©±ID');
                        return;
                    } else {
                        console.log('âœ… æœƒè©±è¨˜éŒ„å·²æˆåŠŸå‰µå»º:', data);
                        console.log('å“¡å·¥ID:', employeeId, 'æœƒè©±ID:', sessionId);
                        // åªæœ‰æˆåŠŸå‰µå»ºæœƒè©±è¨˜éŒ„å¾Œæ‰å„²å­˜æœƒè©±IDåˆ°localStorage
                        localStorage.setItem('currentSessionId', sessionId);
                        console.log('âœ… æœƒè©±IDå·²å„²å­˜åˆ°localStorage:', sessionId);
                    }
                } else {
                    console.log('âŒ è³‡æ–™åº«æœªé€£æ¥ï¼Œç„¡æ³•è¨˜éŒ„ç™»å…¥');
                }
            } catch (error) {
                console.error('âŒ è¨˜éŒ„ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // è¨˜éŒ„å“¡å·¥ç™»å‡ºåˆ°sessionè¡¨
        async function recordEmployeeLogout(employeeId) {
            try {
                // åˆå§‹åŒ–è³‡æ–™åº«é€£æ¥
                await DatabaseManager.initialize();
                
                if (DatabaseManager.isConnected()) {
                    const currentSessionId = localStorage.getItem('currentSessionId');
                    const logoutTime = new Date().toISOString();
                    
                    if (currentSessionId) {
                        // æ›´æ–°æœƒè©±ç‚ºéæ´»èºç‹€æ…‹
                        const { error } = await window.supabase
                            .from('employee_sessions')
                            .update({ 
                                is_active: false,
                                logout_time: logoutTime
                            })
                            .eq('session_id', currentSessionId)
                            .eq('employee_id', employeeId);
                        
                        if (error) {
                            console.error('æ›´æ–°æœƒè©±ç™»å‡ºè¨˜éŒ„å¤±æ•—:', error);
                        } else {
                            console.log('æœƒè©±ç™»å‡ºè¨˜éŒ„å·²æ›´æ–°:', employeeId, currentSessionId);
                        }
                        
                        // æ¸…é™¤æœ¬åœ°æœƒè©±ID
                        localStorage.removeItem('currentSessionId');
                    } else {
                        // å¦‚æœæ²’æœ‰æœƒè©±IDï¼Œå˜—è©¦æ›´æ–°è©²å“¡å·¥çš„æ‰€æœ‰æ´»èºæœƒè©±
                        const { error } = await window.supabase
                            .from('employee_sessions')
                            .update({ 
                                is_active: false,
                                logout_time: logoutTime
                            })
                            .eq('employee_id', employeeId)
                            .eq('is_active', true);
                        
                        if (error) {
                            console.error('æ›´æ–°å“¡å·¥æ´»èºæœƒè©±å¤±æ•—:', error);
                        } else {
                            console.log('å“¡å·¥æ´»èºæœƒè©±å·²å…¨éƒ¨ç™»å‡º:', employeeId);
                        }
                    }
                } else {
                    console.log('è³‡æ–™åº«æœªé€£æ¥ï¼Œç„¡æ³•è¨˜éŒ„ç™»å‡º');
                }
            } catch (error) {
                console.error('è¨˜éŒ„ç™»å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        let currentEmployee = null;
        let heartbeatInterval = null;

        // å¿ƒè·³æ©Ÿåˆ¶ï¼šæ¯10ç§’æ›´æ–°ä¸€æ¬¡åœ¨ç·šç‹€æ…‹
        function startHeartbeat(employeeId) {
            // æ¸…é™¤èˆŠçš„å¿ƒè·³
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
            }
            
            console.log('ğŸ”„ å•Ÿå‹•å¿ƒè·³æ©Ÿåˆ¶ï¼Œæ¯10ç§’æ›´æ–°ä¸€æ¬¡åœ¨ç·šç‹€æ…‹');
            
            // æ¯10ç§’æ›´æ–°ä¸€æ¬¡
            heartbeatInterval = setInterval(async () => {
                await updateHeartbeat(employeeId);
            }, 10000); // 10ç§’
            
            // ç«‹å³åŸ·è¡Œä¸€æ¬¡
            updateHeartbeat(employeeId);
        }
        
        // åœæ­¢å¿ƒè·³æ©Ÿåˆ¶
        function stopHeartbeat() {
            if (heartbeatInterval) {
                console.log('â¹ï¸ åœæ­¢å¿ƒè·³æ©Ÿåˆ¶');
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }
        
        // æ›´æ–°å¿ƒè·³
        async function updateHeartbeat(employeeId) {
            try {
                const currentSessionId = localStorage.getItem('currentSessionId');
                if (!currentSessionId) {
                    console.log('âŒ æ²’æœ‰æœƒè©±IDï¼Œåœæ­¢å¿ƒè·³');
                    stopHeartbeat();
                    return;
                }
                
                const now = new Date().toISOString(); // çµ±ä¸€ä½¿ç”¨UTCæ™‚é–“
                
                console.log('ğŸ” æº–å‚™æ›´æ–°å¿ƒè·³ï¼Œæœƒè©±ID:', currentSessionId);
                console.log('ğŸ” æ›´æ–°æ™‚é–“:', now);
                
                // å˜—è©¦æ›´æ–°æœƒè©±ï¼Œå¦‚æœæœƒè©±è¢«æ¨™è¨˜ç‚ºéæ´»èºï¼Œå‰‡é‡æ–°æ¿€æ´»å®ƒ
                const { data, error } = await window.supabase
                    .from('employee_sessions')
                    .update({ 
                        last_activity: now,
                        is_active: true,  // é‡æ–°æ¿€æ´»æœƒè©±
                        logout_time: null  // æ¸…é™¤ç™»å‡ºæ™‚é–“
                    })
                    .eq('session_id', currentSessionId)
                    .select();
                
                console.log('ğŸ” Supabaseå›æ‡‰:', { data, error });
                
                if (error) {
                    console.error('âŒ å¿ƒè·³æ›´æ–°å¤±æ•—:', error);
                    console.error('éŒ¯èª¤ä»£ç¢¼:', error.code);
                    console.error('éŒ¯èª¤è©³æƒ…:', error.message);
                    console.error('éŒ¯èª¤è©³æƒ…:', error.details);
                    console.error('éŒ¯èª¤æç¤º:', error.hint);
                    
                    if (error.message && (error.message.includes('last_activity') || error.message.includes('column'))) {
                        console.error('âŒ last_activity æ¬„ä½ä¸å­˜åœ¨ï¼è«‹åœ¨SupabaseåŸ·è¡ŒSQL:');
                        console.error('ALTER TABLE employee_sessions ADD COLUMN last_activity TIMESTAMPTZ;');
                        console.error('ç„¶å¾ŒåŸ·è¡Œ:');
                        console.error('UPDATE employee_sessions SET last_activity = login_time WHERE last_activity IS NULL;');
                        stopHeartbeat();
                    }
                } else {
                    console.log('ğŸ’“ å¿ƒè·³æ›´æ–°æˆåŠŸ:', now);
                    console.log('ğŸ’“ æ›´æ–°çš„è³‡æ–™:', data);
                }
            } catch (error) {
                console.error('âŒ å¿ƒè·³æ›´æ–°éŒ¯èª¤:', error);
            }
        }

        // ç‰ˆæœ¬ç´€éŒ„åŠŸèƒ½
        const versionData = [
            {
                "version": "v2.7",
                "date": "2025å¹´10æœˆ",
                "title": "æŠ˜æ‰£ç³»çµ±å…¨é¢å‡ç´šèˆ‡æœƒè©±ç®¡ç†å„ªåŒ–",
                "isLatest": true,
                "color": "blue",
                "changes": [
                    {
                        "icon": "fas fa-percentage",
                        "color": "blue",
                        "category": "æŠ˜æ‰£ç³»çµ±é©æ–°",
                        "description": "å…¨æ–°å¤šæŠ˜æ‰£ç®¡ç†ç³»çµ±ï¼Œæ”¯æ´å¤šå€‹æŠ˜æ‰£åŒæ™‚å¥—ç”¨èˆ‡è‡ªè¨‚æŠ˜æ‰£åç¨±"
                    },
                    {
                        "icon": "fas fa-heartbeat",
                        "color": "green",
                        "category": "æœƒè©±ç®¡ç†å„ªåŒ–",
                        "description": "ä¿®å¾©å¿ƒè·³æ©Ÿåˆ¶ï¼Œèª¿æ•´é›¢ç·šæª¢æ¸¬ç‚º5åˆ†é˜ï¼Œå•Ÿç”¨æœƒè©±è‡ªå‹•æ¢å¾©"
                    },
                    {
                        "icon": "fas fa-calculator",
                        "color": "red",
                        "category": "è¨ˆç®—é‚è¼¯ä¿®å¾©",
                        "description": "ä¿®å¾©æŒ‡å®šå“é …å›ºå®šé‡‘é¡æŠ˜æ‰£è¨ˆç®—å•é¡Œï¼Œé˜²æ­¢ç¸½è¨ˆè®Šç‚ºè² æ•¸"
                    },
                    {
                        "icon": "fas fa-palette",
                        "color": "purple",
                        "category": "ä»‹é¢ç¾åŒ–",
                        "description": "é‡æ–°è¨­è¨ˆå¿«é€ŸåŠŸèƒ½å€åŸŸï¼Œæ¡ç”¨ç¾ä»£åŒ–æ¼¸å±¤è¨­è¨ˆèˆ‡äº’å‹•æ•ˆæœ"
                    },
                    {
                        "icon": "fas fa-tools",
                        "color": "orange",
                        "category": "åŠŸèƒ½ä¿®å¾©",
                        "description": "ä¿®å¾©ä¾›æ‡‰å•†è³‡æ–™ä¿®æ”¹åˆªé™¤åŠŸèƒ½ï¼Œç°¡åŒ–é¸å–å•†å“æŠ˜æ‰£æ“ä½œæµç¨‹"
                    },
                    {
                        "icon": "fas fa-trash",
                        "color": "gray",
                        "category": "ç³»çµ±æ¸…ç†",
                        "description": "ç§»é™¤èˆŠç‰ˆæŠ˜æ‰£åŠŸèƒ½ï¼Œæ¸…ç†èª¿è©¦æ–‡ä»¶å’Œæ¸¬è©¦æª”æ¡ˆ"
                    }
                ]
            },
            {
                "version": "v2.6",
                "date": "2025å¹´09æœˆ",
                "title": "çœŸå¯¦ç™»å…¥ç‹€æ…‹è¿½è¹¤ç³»çµ±",
                "isLatest": false,
                "color": "green",
                "changes": [
                    {
                        "icon": "fas fa-database",
                        "color": "green",
                        "category": "è³‡æ–™åº«æ¶æ§‹å„ªåŒ–",
                        "description": "æ”¹ç”¨ç¾æœ‰employee_sessionsè¡¨è¿½è¹¤ç™»å…¥ç‹€æ…‹ï¼Œä¸å†ä¿®æ”¹employeesè¡¨çµæ§‹"
                    },
                    {
                        "icon": "fas fa-users",
                        "color": "blue",
                        "category": "çœŸå¯¦ç‹€æ…‹è¿½è¹¤",
                        "description": "å¯¦ä½œåŸºæ–¼æœƒè©±è¡¨çš„çœŸå¯¦å“¡å·¥ç™»å…¥ç‹€æ…‹è¿½è¹¤ç³»çµ±"
                    },
                    {
                        "icon": "fas fa-clock",
                        "color": "orange",
                        "category": "æ™ºæ…§æœƒè©±ç®¡ç†",
                        "description": "30åˆ†é˜ç„¡æ´»å‹•è‡ªå‹•ç™»å‡ºæ©Ÿåˆ¶ï¼Œç¢ºä¿æœƒè©±å®‰å…¨æ€§"
                    },
                    {
                        "icon": "fas fa-sync-alt",
                        "color": "purple",
                        "category": "å³æ™‚åŒæ­¥",
                        "description": "è·¨ç€è¦½å™¨å³æ™‚ç™»å…¥ç‹€æ…‹åŒæ­¥ï¼Œç®¡ç†å“¡å¯çœ‹åˆ°çœŸå¯¦ä½¿ç”¨æƒ…æ³"
                    },
                    {
                        "icon": "fas fa-keyboard",
                        "color": "teal",
                        "category": "ç”¨æˆ¶é«”é©—",
                        "description": "å“¡å·¥ç™»å…¥è¦–çª—æ”¯æ´Enteréµå¿«é€Ÿç™»å…¥å’ŒEscapeéµå–æ¶ˆ"
                    }
                ]
            },
            {
                "version": "v2.5",
                "date": "2025å¹´09æœˆ",
                "title": "æ¬Šé™ç³»çµ±å®‰å…¨æ€§å¼·åŒ–",
                "isLatest": false,
                "color": "red",
                "changes": [
                    {
                        "icon": "fas fa-shield-alt",
                        "color": "red",
                        "category": "é‡å¤§å®‰å…¨ä¿®å¾©",
                        "description": "ä¿®å¾©æ¬Šé™è‡ªå‹•å›å¡«æ¼æ´ - ç§»é™¤æ‰€æœ‰è‡ªå‹•æ¬Šé™åˆ†é…é‚è¼¯"
                    },
                    {
                        "icon": "fas fa-trash-alt",
                        "color": "orange",
                        "category": "å®‰å…¨æ¸…ç†",
                        "description": "ç§»é™¤æ‰€æœ‰å‚™ç”¨å“¡å·¥è³‡æ–™ï¼Œå¾¹åº•æœçµ•é è¨­æ¬Šé™çš„å¯èƒ½æ€§"
                    },
                    {
                        "icon": "fas fa-database",
                        "color": "blue",
                        "category": "è³‡æ–™ä¾†æºæ§åˆ¶",
                        "description": "å¼·åˆ¶ä¾è³´Supabaseå“¡å·¥è³‡æ–™ï¼Œç„¡è³‡æ–™åº«é€£æ¥æ™‚ç³»çµ±ç„¡æ³•ä½¿ç”¨"
                    },
                    {
                        "icon": "fas fa-spell-check",
                        "color": "green",
                        "category": "å…§å®¹ä¿®æ­£",
                        "description": "ä¿®å¾©æ¨™é¡ŒéŒ¯å­—ï¼šæ³¢ç€¾é™¶ â†’ æ³¢è˜­é™¶é£Ÿå™¨"
                    }
                ]
            },
            {
                "version": "v2.4",
                "date": "2025å¹´09æœˆ",
                "title": "å“¡å·¥æ¬Šé™ç³»çµ±å…¨é¢æ”¹é€²",
                "isLatest": false,
                "color": "green",
                "changes": [
                    {
                        "icon": "fas fa-user-cog",
                        "color": "green",
                        "category": "æ¬Šé™é©æ–°",
                        "description": "è·ä½é¸æ“‡ä¸å†è‡ªå‹•è³¦äºˆæ¬Šé™ï¼Œéœ€ç®¡ç†å“¡æ‰‹å‹•åˆ†é…æ‰€æœ‰åŠŸèƒ½æ¬Šé™"
                    },
                    {
                        "icon": "fas fa-plus-circle",
                        "color": "blue",
                        "category": "åŠŸèƒ½æ“´å±•",
                        "description": "æ–°å¢ã€Œä¾›æ‡‰å•†ç®¡ç†ã€å’Œã€Œè³‡æ–™åŒ¯å‡º/å…¥ã€æ¬Šé™é¸é …ï¼Œæ¶µè“‹å…¨éƒ¨8å€‹ç³»çµ±åŠŸèƒ½"
                    },
                    {
                        "icon": "fas fa-th",
                        "color": "purple",
                        "category": "ä»‹é¢å„ªåŒ–",
                        "description": "æ¬Šé™è¨­å®šæ¡ç”¨2æ¬„ç¶²æ ¼å¸ƒå±€ï¼Œæå‡é¸æ“‡æ•ˆç‡å’Œè¦–è¦ºé«”é©—"
                    },
                    {
                        "icon": "fas fa-exclamation-triangle",
                        "color": "orange",
                        "category": "å®‰å…¨æé†’",
                        "description": "æ·»åŠ æ˜ç¢ºçš„è­¦å‘Šæç¤ºï¼Œèªªæ˜æ¬Šé™åˆ†é…æ–¹å¼å’Œç®¡ç†å“¡è²¬ä»»"
                    }
                ]
            },
            {
                "version": "v2.3",
                "date": "2025å¹´09æœˆ",
                "title": "å‹•æ…‹ç‰ˆæœ¬ç´€éŒ„ç³»çµ±",
                "isLatest": false,
                "color": "blue",
                "changes": [
                    {
                        "icon": "fas fa-code-branch",
                        "color": "blue",
                        "category": "æ–°åŠŸèƒ½",
                        "description": "æ–°å¢å‹•æ…‹ç‰ˆæœ¬ç´€éŒ„æŒ‰éˆ•ï¼Œæ”¯æ´JSONè³‡æ–™è¼‰å…¥"
                    },
                    {
                        "icon": "fas fa-rocket",
                        "color": "green",
                        "category": "æ•ˆèƒ½å„ªåŒ–",
                        "description": "æ™ºèƒ½ç·©å­˜æ©Ÿåˆ¶ï¼Œæå‡ç‰ˆæœ¬è³‡æ–™è¼‰å…¥é€Ÿåº¦"
                    },
                    {
                        "icon": "fas fa-paint-brush",
                        "color": "purple",
                        "category": "è¦–è¦ºæ”¹é€²",
                        "description": "ç¾è§€çš„è¼‰å…¥å‹•ç•«å’ŒéŒ¯èª¤è™•ç†ä»‹é¢"
                    }
                ]
            },
            {
                "version": "v2.2",
                "date": "2025å¹´09æœˆ",
                "title": "é‡å¤§å®‰å…¨æ›´æ–°èˆ‡ç³»çµ±å„ªåŒ–",
                "isLatest": false,
                "color": "green",
                "changes": [
                    {
                        "icon": "fas fa-shield-alt",
                        "color": "green",
                        "category": "å®‰å…¨å¢å¼·",
                        "description": "ä¿®å¾©URLç¹éæ¬Šé™æª¢æŸ¥çš„å®‰å…¨æ¼æ´ï¼Œç‚ºæ‰€æœ‰é é¢æ·»åŠ å®Œæ•´çš„æ¬Šé™é©—è­‰"
                    },
                    {
                        "icon": "fas fa-bug",
                        "color": "orange",
                        "category": "éŒ¯èª¤ä¿®å¾©",
                        "description": "ä¿®å¾©å“¡å·¥ç®¡ç†é é¢phoneæ¬„ä½å„²å­˜å•é¡Œ"
                    },
                    {
                        "icon": "fas fa-broom",
                        "color": "blue",
                        "category": "ç³»çµ±æ¸…ç†",
                        "description": "æ¸…ç†ä¸å¿…è¦çš„consoleè¼¸å‡ºå’Œå†—é¤˜æª”æ¡ˆ"
                    },
                    {
                        "icon": "fas fa-file-alt",
                        "color": "purple",
                        "category": "æ–‡æª”æ›´æ–°",
                        "description": "æ›´æ–°README.mdåæ˜ ç•¶å‰ç³»çµ±ç‹€æ…‹"
                    }
                ]
            },
            {
                "version": "v2.1",
                "date": "2025å¹´09æœˆ",
                "title": "æ¬Šé™ç³»çµ±æ”¹é€²èˆ‡ä»‹é¢å„ªåŒ–",
                "isLatest": false,
                "color": "yellow",
                "changes": [
                    {
                        "icon": "fas fa-user-shield",
                        "color": "green",
                        "category": "æ¬Šé™å„ªåŒ–",
                        "description": "æ”¹é€²å“¡å·¥æ¬Šé™è¦–è¦ºåŒ–æç¤º"
                    },
                    {
                        "icon": "fas fa-ban",
                        "color": "red",
                        "category": "åŠŸèƒ½æ§åˆ¶",
                        "description": "å„ªæƒ åˆ¸ç®¡ç†æ°¸ä¹…ç¦ç”¨"
                    },
                    {
                        "icon": "fas fa-eye",
                        "color": "blue",
                        "category": "ä»‹é¢æ”¹é€²",
                        "description": "ç§»é™¤ä¸å¿…è¦çš„æ¬Šé™æç¤ºæ–‡å­—"
                    }
                ]
            },
            {
                "version": "v2.0",
                "date": "2025å¹´08æœˆ",
                "title": "æ ¸å¿ƒåŠŸèƒ½å®Œå–„",
                "isLatest": false,
                "color": "gray",
                "changes": [
                    {
                        "icon": "fas fa-database",
                        "color": "green",
                        "category": "è³‡æ–™åº«æ•´åˆ",
                        "description": "å®Œæ•´çš„Supabaseè³‡æ–™åº«æ•´åˆ"
                    },
                    {
                        "icon": "fas fa-users",
                        "color": "blue",
                        "category": "å“¡å·¥ç®¡ç†",
                        "description": "å®Œæ•´çš„å“¡å·¥CRUDåŠŸèƒ½"
                    },
                    {
                        "icon": "fas fa-box",
                        "color": "orange",
                        "category": "å•†å“ç®¡ç†",
                        "description": "å•†å“ã€åˆ†é¡ã€ä¾›æ‡‰å•†ç®¡ç†"
                    }
                ]
            },
            {
                "version": "v1.0",
                "date": "2025å¹´07æœˆ",
                "title": "åˆå§‹ç‰ˆæœ¬ç™¼å¸ƒ",
                "isLatest": false,
                "color": "gray",
                "changes": [
                    {
                        "icon": "fas fa-rocket",
                        "color": "green",
                        "category": "ç³»çµ±å•Ÿå‹•",
                        "description": "åŸºç¤é€²éŠ·å­˜ç³»çµ±æ¶æ§‹"
                    },
                    {
                        "icon": "fas fa-cash-register",
                        "color": "blue",
                        "category": "éŠ·å”®åŠŸèƒ½",
                        "description": "åŸºæœ¬çš„POSéŠ·å”®ä½œæ¥­"
                    },
                    {
                        "icon": "fas fa-chart-pie",
                        "color": "purple",
                        "category": "å ±è¡¨ç³»çµ±",
                        "description": "åŸºç¤æ•¸æ“šçµ±è¨ˆåŠŸèƒ½"
                    }
                ]
            }
        ];

        function showVersionHistory() {
            document.getElementById('versionHistoryModal').classList.remove('hidden');
            renderVersionHistory(versionData);
        }

        function renderVersionHistory(versions) {
            const container = document.getElementById('versionHistoryContent');
            container.innerHTML = '';

            versions.forEach(version => {
                const versionElement = createVersionElement(version);
                container.appendChild(versionElement);
            });
        }

        function createVersionElement(version) {
            const colorClasses = {
                blue: { border: 'border-blue-500', bg: 'bg-blue-50' },
                green: { border: 'border-green-500', bg: 'bg-green-50' },
                yellow: { border: 'border-yellow-500', bg: 'bg-yellow-50' },
                gray: { border: 'border-gray-500', bg: 'bg-gray-50' }
            };

            const iconColors = {
                green: 'text-green-500',
                blue: 'text-blue-500',
                orange: 'text-orange-500',
                purple: 'text-purple-500',
                red: 'text-red-500'
            };

            const colors = colorClasses[version.color] || colorClasses.gray;
            
            const versionDiv = document.createElement('div');
            versionDiv.className = `border-l-4 ${colors.border} pl-4 ${colors.bg} p-4 rounded-lg`;

            let badgeHtml = '';
            if (version.isLatest) {
                badgeHtml = `<span class="bg-blue-500 text-white px-2 py-1 rounded-full text-xs">æœ€æ–°ç‰ˆæœ¬</span>`;
            } else {
                badgeHtml = `<span class="text-xs text-gray-500">${version.date}</span>`;
            }

            let changesHtml = '';
            version.changes.forEach(change => {
                const iconColor = iconColors[change.color] || 'text-gray-500';
                changesHtml += `
                    <div class="flex items-start">
                        <i class="${change.icon} ${iconColor} mr-2 mt-0.5"></i>
                        <span><strong>${change.category}ï¼š</strong>${change.description}</span>
                    </div>
                `;
            });

            versionDiv.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-lg font-semibold text-gray-800">${version.version}</h4>
                    ${badgeHtml}
                </div>
                <p class="text-sm text-gray-600 mb-3">${version.date} - ${version.title}</p>
                <div class="space-y-2 text-sm">
                    ${changesHtml}
                </div>
            `;

            return versionDiv;
        }


        function closeVersionHistory() {
            document.getElementById('versionHistoryModal').classList.add('hidden');
        }

        // é»æ“Šæ¨¡æ…‹è¦–çª—å¤–éƒ¨é—œé–‰
        document.addEventListener('click', function(event) {
            const versionModal = document.getElementById('versionHistoryModal');
            if (event.target === versionModal) {
                closeVersionHistory();
            }
        });

        function showEmployeeLogin() {
            document.getElementById('employeeLoginModal').classList.remove('hidden');
            const employeeIdInput = document.getElementById('employeeId');
            employeeIdInput.focus();
            
            // æ·»åŠ Enteréµäº‹ä»¶ç›£è½å™¨
            employeeIdInput.addEventListener('keydown', handleEmployeeLoginKeydown);
        }
        
        // è™•ç†å“¡å·¥ç™»å…¥è¦–çª—çš„éµç›¤äº‹ä»¶
        function handleEmployeeLoginKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                loginEmployee();
            } else if (event.key === 'Escape') {
                event.preventDefault();
                closeEmployeeLogin();
            }
        }

        function closeEmployeeLogin() {
            document.getElementById('employeeLoginModal').classList.add('hidden');
            const employeeIdInput = document.getElementById('employeeId');
            employeeIdInput.value = '';
            
            // ç§»é™¤Enteréµäº‹ä»¶ç›£è½å™¨ï¼Œé¿å…é‡è¤‡æ·»åŠ 
            employeeIdInput.removeEventListener('keydown', handleEmployeeLoginKeydown);
        }

        async function loginEmployee() {
            const employeeId = document.getElementById('employeeId').value.trim();
            
            if (!employeeId) {
                alert('è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿ');
                return;
            }

            console.log('å˜—è©¦ç™»å…¥...');

            try {
                // æª¢æŸ¥å“¡å·¥æ˜¯å¦å­˜åœ¨æ–¼ Supabase è³‡æ–™ä¸­
                if (employees[employeeId]) {
                    const employee = employees[employeeId];
                    console.log('ç™»å…¥é©—è­‰æˆåŠŸ');
                    
                    // è¨˜éŒ„ç™»å…¥æ™‚é–“åˆ°è³‡æ–™åº«
                    await recordEmployeeLogin(employeeId);
                    
                    // æ›´æ–°UI
                    document.getElementById('employeeName').textContent = employee.name;
                    document.querySelector('[onclick="showEmployeeLogin()"]').classList.add('hidden');
                    document.getElementById('employeeInfo').classList.remove('hidden');
                    
                    // é¡¯ç¤ºä¸»é¸å–®
                    document.getElementById('loginRequired').classList.add('hidden');
                    document.getElementById('mainMenu').classList.remove('hidden');
                    
                    // é—œé–‰ç™»å…¥è¦–çª—
                    closeEmployeeLogin();
                    
                    // å„²å­˜ç•¶å‰å“¡å·¥è³‡è¨Š
                    currentEmployee = employee;
                    localStorage.setItem('currentEmployee', JSON.stringify(employee));
                    
                    // å•Ÿå‹•å¿ƒè·³æ©Ÿåˆ¶
                    startHeartbeat(employeeId);
                    
                    // ç¢ºä¿ currentEmployee è¨­å®šå®Œæˆå¾Œå†æ›´æ–°é¸å–®æ¬Šé™
                    setTimeout(() => {
                        console.log('æ›´æ–°é¸å–®æ¬Šé™');
                        updateMenuPermissions();
                    }, 100);
                    
                    // é¡¯ç¤ºæ­¡è¿è¨Šæ¯
                    alert(`æ­¡è¿ ${employee.name} (${employee.role})ï¼\n\næ‚¨å·²æˆåŠŸç™»å…¥ç³»çµ±ã€‚`);
                } else {
                    console.log('ç™»å…¥å¤±æ•—ï¼šå“¡å·¥ç·¨è™Ÿä¸å­˜åœ¨');
                    alert(`å“¡å·¥ç·¨è™Ÿä¸å­˜åœ¨ï¼š${employeeId}\n\nè«‹æª¢æŸ¥å¾Œé‡æ–°è¼¸å…¥`);
                }
                
            } catch (error) {
                console.error('ç™»å…¥éŒ¯èª¤:', error);
                alert(`ç™»å…¥å¤±æ•—ï¼š${error.message}`);
            }
        }

        // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
        async function checkEmployeeLogin() {
            // æª¢æŸ¥æ˜¯å¦æœ‰å„²å­˜çš„å“¡å·¥è³‡è¨Š
            const savedEmployee = localStorage.getItem('currentEmployee');
            if (savedEmployee) {
                try {
                    currentEmployee = JSON.parse(savedEmployee);
                    console.log('è¼‰å…¥å·²å„²å­˜çš„ç™»å…¥ç‹€æ…‹');
                    
                    // æ›´æ–°UIå…ƒç´ 
                    document.getElementById('employeeName').textContent = currentEmployee.name;
                    document.querySelector('[onclick="showEmployeeLogin()"]').classList.add('hidden');
                    document.getElementById('employeeInfo').classList.remove('hidden');
                    
                    // é¡¯ç¤ºä¸»é¸å–®
                    document.getElementById('loginRequired').classList.add('hidden');
                    document.getElementById('mainMenu').classList.remove('hidden');
                    
                    // é‡æ–°å•Ÿå‹•å¿ƒè·³æ©Ÿåˆ¶
                    startHeartbeat(currentEmployee.id);
                    
                    // ç¢ºä¿ currentEmployee è¨­å®šå®Œæˆå¾Œå†æ›´æ–°é¸å–®æ¬Šé™
                    setTimeout(() => {
                        console.log('åŸ·è¡Œé¸å–®æ¬Šé™æ›´æ–°');
                        updateMenuPermissions();
                    }, 100);
                    
                    return true;
                } catch (error) {
                    console.error('è§£æå„²å­˜çš„å“¡å·¥è³‡è¨Šå¤±æ•—:', error);
                    localStorage.removeItem('currentEmployee');
                    currentEmployee = null;
                }
            }
            
            // æœªç™»å…¥æ™‚é¡¯ç¤ºç™»å…¥æç¤º
            document.getElementById('loginRequired').classList.remove('hidden');
            document.getElementById('mainMenu').classList.add('hidden');
            
            // ç¢ºä¿ç•¶å‰å“¡å·¥ç‚º null å¾Œæ›´æ–°é¸å–®æ¬Šé™ï¼ˆç¦ç”¨æ‰€æœ‰æŒ‰éˆ•ï¼‰
            currentEmployee = null;
            setTimeout(() => {
                console.log('åŸ·è¡Œé¸å–®æ¬Šé™æ›´æ–°ï¼ˆæœªç™»å…¥ç‹€æ…‹ï¼‰');
                updateMenuPermissions();
            }, 100);
            
            return false;
        }

        // æ¬Šé™æª¢æŸ¥å’Œå°èˆª
        function checkPermissionAndNavigate(page, requiredRoles) {
            if (!currentEmployee) {
                alert('è«‹å…ˆç™»å…¥ï¼');
                return;
            }

            // æª¢æŸ¥æ¬Šé™
            if (hasPermission(currentEmployee, requiredRoles)) {
                navigateToPage(page);
            } else {
                alert(`æ¬Šé™ä¸è¶³ï¼\n\næ­¤åŠŸèƒ½éœ€è¦ä»¥ä¸‹æ¬Šé™ï¼š${requiredRoles.join(' æˆ– ')}\n\næ‚¨çš„æ¬Šé™ï¼š${currentEmployee.role}`);
            }
        }



        // æ›´æ–°é¸å–®æŒ‰éˆ•ç‹€æ…‹
        function updateMenuPermissions() {
            console.log('=== æ›´æ–°é¸å–®æ¬Šé™é–‹å§‹ ===');
            
            const menuItems = document.querySelectorAll('.menu-item');
            console.log('æ‰¾åˆ°é¸å–®é …ç›®æ•¸é‡:', menuItems.length);
            
            if (!currentEmployee) {
                console.log('æœªç™»å…¥ç‹€æ…‹ï¼Œç¦ç”¨æ‰€æœ‰æŒ‰éˆ•');
                // æœªç™»å…¥æ™‚ï¼Œæ‰€æœ‰æŒ‰éˆ•éƒ½ç¦ç”¨ä¸¦é¡¯ç¤ºæ¬Šé™æç¤º
                menuItems.forEach(item => {
                    item.classList.add('disabled');
                    item.onclick = null;
                    
                    // é¡¯ç¤ºæ¬Šé™æç¤º
                    const permissionNotice = item.parentElement.querySelector('.permission-notice');
                    if (permissionNotice && item.dataset.page !== 'coupons') {
                        permissionNotice.classList.remove('hidden');
                    }
                    
                    console.log(`ç¦ç”¨æŒ‰éˆ•: ${item.dataset.page}`);
                });
                console.log('=== æ›´æ–°é¸å–®æ¬Šé™å®Œæˆï¼ˆæœªç™»å…¥ï¼‰ ===');
                return;
            }

            // é¦–å…ˆç¢ºä¿å„ªæƒ åˆ¸ç®¡ç†åœ¨ä»»ä½•æƒ…æ³ä¸‹éƒ½ä¿æŒç¦ç”¨
            const couponsItem = document.getElementById('menu-coupons');
            if (couponsItem) {
                couponsItem.classList.add('disabled');
                couponsItem.onclick = null;
                console.log('ğŸš« å„ªæƒ åˆ¸ç®¡ç†æ°¸ä¹…ç¦ç”¨');
            }

            console.log('å·²ç™»å…¥ç‹€æ…‹ï¼Œé–‹å§‹æª¢æŸ¥å€‹åˆ¥æ¬Šé™');
            
            // éæ­·æ‰€æœ‰é¸å–®é …ç›®
            menuItems.forEach((item, index) => {
                try {
                    const page = item.dataset.page;
                    const permissionsData = item.dataset.permissions;
                    
                    console.log(`æª¢æŸ¥ç¬¬ ${index + 1} å€‹é …ç›®: ${page}`);
                    console.log(`åŸå§‹æ¬Šé™å­—ä¸²: ${permissionsData}`);
                    
                    // ç‰¹æ®Šè™•ç†ï¼šå„ªæƒ åˆ¸ç®¡ç†æ°¸é ç¦ç”¨
                    if (page === 'coupons') {
                        item.classList.add('disabled');
                        item.onclick = null;
                        console.log(`ğŸš« å¼·åˆ¶ç¦ç”¨æŒ‰éˆ•: ${page} (ç³»çµ±ç®¡ç†å“¡åŠŸèƒ½)`);
                        return;
                    }
                    
                    // ä¿®æ­£ JSON æ ¼å¼ï¼šå°‡å–®å¼•è™Ÿæ›¿æ›ç‚ºé›™å¼•è™Ÿ
                    const permissionsStr = permissionsData.replace(/'/g, '"');
                    const requiredPermissions = JSON.parse(permissionsStr);
                    
                    console.log(`æª¢æŸ¥æ¬Šé™è¦æ±‚:`, requiredPermissions.length, 'é …');
                    
                    // æª¢æŸ¥æ¬Šé™
                    const hasAccess = hasPermission(currentEmployee, requiredPermissions);
                    
                    console.log(`é …ç›® ${page} æ¬Šé™æª¢æŸ¥çµæœ: ${hasAccess}`);
                    
                    // æ‰¾åˆ°å°æ‡‰çš„æ¬Šé™æç¤ºå…ƒç´ 
                    const permissionNotice = item.parentElement.querySelector('.permission-notice');
                    
                    if (hasAccess) {
                        // æœ‰æ¬Šé™ï¼šå•Ÿç”¨æŒ‰éˆ•ï¼Œéš±è—æ¬Šé™æç¤º
                        item.classList.remove('disabled');
                        item.onclick = () => {
                            console.log(`é»æ“Šå°èˆªåˆ°: ${page}`);
                            navigateToPage(page);
                        };
                        if (permissionNotice) {
                            permissionNotice.classList.add('hidden');
                        }
                        console.log(`âœ… å•Ÿç”¨æŒ‰éˆ•: ${page}`);
                    } else {
                        // ç„¡æ¬Šé™ï¼šç¦ç”¨æŒ‰éˆ•ï¼Œé¡¯ç¤ºæ¬Šé™æç¤º
                        item.classList.add('disabled');
                        item.onclick = null;
                        if (permissionNotice) {
                            permissionNotice.classList.remove('hidden');
                        }
                        console.log(`âŒ ç¦ç”¨æŒ‰éˆ•: ${page}`);
                    }
                } catch (error) {
                    console.error(`â— è§£ææ¬Šé™å¤±æ•— (${item.dataset.page}):`, error);
                    console.log('åŸå§‹æ¬Šé™å­—ä¸²:', item.dataset.permissions);
                    // è§£æå¤±æ•—æ™‚ç¦ç”¨æŒ‰éˆ•
                    item.classList.add('disabled');
                    item.onclick = null;
                }
            });
            
            console.log('=== æ›´æ–°é¸å–®æ¬Šé™å®Œæˆ ===');
        }

        // æª¢æŸ¥æ¬Šé™ï¼ˆæ–°ç‰ˆæœ¬ï¼Œæ”¯æ´å­—ä¸²æ¬Šé™ï¼‰
        function hasPermission(employee, requiredPermissions) {
            console.log('æ¬Šé™æª¢æŸ¥:', {
                employee: employee,
                requiredPermissions: requiredPermissions,
                employeePermissions: employee?.permissions
            });
            
            // å¦‚æœæ²’æœ‰æ¬Šé™è¦æ±‚ï¼ˆç©ºé™£åˆ—ï¼‰ï¼Œè¡¨ç¤ºæ‰€æœ‰äººéƒ½å¯ä»¥è¨ªå•
            if (!requiredPermissions || requiredPermissions.length === 0) {
                console.log('ç„¡æ¬Šé™è¦æ±‚ï¼Œæ‰€æœ‰äººå¯è¨ªå•');
                return true;
            }
            
            if (!employee || !employee.permissions) {
                console.log('æ¬Šé™æª¢æŸ¥å¤±æ•—ï¼šç„¡æ•ˆç”¨æˆ¶');
                return false;
            }

            // å¦‚æœå“¡å·¥æœ‰ 'all' æ¬Šé™ï¼Œç›´æ¥è¿”å› true
            if (employee.permissions.includes('all')) {
                console.log('æ“æœ‰å®Œæ•´æ¬Šé™ï¼Œå…è¨±è¨ªå•');
                return true;
            }

            // æª¢æŸ¥æ˜¯å¦åŒ…å«æ‰€éœ€çš„ä»»ä½•ä¸€å€‹æ¬Šé™
            const hasRequiredPermission = requiredPermissions.some(permission => 
                employee.permissions.includes(permission)
            );
            
            console.log('æ¬Šé™æª¢æŸ¥çµæœ:', hasRequiredPermission);
            return hasRequiredPermission;
        }

        // é¡¯ç¤ºç•¶å‰å“¡å·¥æ¬Šé™
        function showPermissions() {
            if (!currentEmployee) {
                alert('è«‹å…ˆç™»å…¥ï¼');
                return;
            }

            const permissions = currentEmployee.permissions || [];
            const permissionNames = {
                'all': 'æ‰€æœ‰æ¬Šé™',

                'sales': 'éŠ·å”®ä½œæ¥­',
                'products': 'å•†å“ç®¡ç†',
                'purchase': 'é€²è²¨ç®¡ç†',
                'members': 'æœƒå“¡ç®¡ç†',
                'employees': 'å“¡å·¥ç®¡ç†',
                'reports': 'å ±è¡¨æŸ¥çœ‹',
                'coupons': 'å„ªæƒ åˆ¸ç®¡ç†',
                'suppliers': 'ä¾›æ‡‰å•†ç®¡ç†',
                'import-export': 'è³‡æ–™åŒ¯å‡ºå…¥',
                '': 'ç„¡æ¬Šé™è¦æ±‚ï¼ˆæ‰€æœ‰äººå¯è¨ªå•ï¼‰'
            };

            const permissionList = permissions.map(p => permissionNames[p] || p).join('\nâ€¢ ');
            
            alert(`ğŸ”‘ æ¬Šé™è³‡è¨Š\n\nå“¡å·¥ï¼š${currentEmployee.name}\nè·ä½ï¼š${currentEmployee.role}\n\næ“æœ‰æ¬Šé™ï¼š\nâ€¢ ${permissionList || 'ç„¡ç‰¹æ®Šæ¬Šé™'}`);
        }

        // å“¡å·¥ç™»å‡ºåŠŸèƒ½
        async function logoutEmployee() {
            if (!confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) return;
            
            try {
                // åœæ­¢å¿ƒè·³æ©Ÿåˆ¶
                stopHeartbeat();
                
                // è¨˜éŒ„ç™»å‡ºåˆ°è³‡æ–™åº«
                if (currentEmployee && currentEmployee.id) {
                    await recordEmployeeLogout(currentEmployee.id);
                }
                
                // æ¸…é™¤ç•¶å‰å“¡å·¥è³‡è¨Š
                currentEmployee = null;
                localStorage.removeItem('currentEmployee');
                
                // æ›´æ–°UI
                document.getElementById('employeeName').textContent = 'å“¡å·¥';
                document.querySelector('[onclick="showEmployeeLogin()"]').classList.remove('hidden');
                document.getElementById('employeeInfo').classList.add('hidden');
                
                // æ›´æ–°é¸å–®æ¬Šé™ï¼ˆç¦ç”¨æ‰€æœ‰æŒ‰éˆ•ï¼‰
                updateMenuPermissions();
                
                // é¡¯ç¤ºç™»å…¥æç¤º
                document.getElementById('loginRequired').classList.remove('hidden');
                document.getElementById('mainMenu').classList.add('hidden');
                
                alert('å·²æˆåŠŸç™»å‡ºï¼');
            } catch (error) {
                alert(`ç™»å‡ºå¤±æ•—ï¼š${error.message}`);
            }
        }


        // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // è¼‰å…¥å“¡å·¥è³‡æ–™
            await loadEmployees();
            await checkEmployeeLogin();
        });
    </script>
    
</body>
</html>