<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>員工時間調試工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="database.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">員工時間調試工具</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 控制按鈕 -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">操作</h2>
                <div class="space-y-3">
                    <button onclick="checkEmployeeTimes()" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        檢查員工時間資料
                    </button>
                    <button onclick="testFormatFunction()" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        測試格式化函數
                    </button>
                    <button onclick="clearResults()" class="w-full bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                        清除結果
                    </button>
                </div>
            </div>
            
            <!-- 當前狀態 -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">員工時間狀態</h2>
                <div id="employeeStatus" class="space-y-2 text-sm">
                    <div class="text-gray-500">等待檢查...</div>
                </div>
            </div>
        </div>
        
        <!-- 詳細資料 -->
        <div class="mt-6 bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">詳細時間資料</h2>
            <div id="detailedData" class="bg-gray-50 p-4 rounded font-mono text-sm overflow-x-auto">
                等待檢查...
            </div>
        </div>
        
        <!-- 格式化測試 -->
        <div class="mt-6 bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">格式化測試結果</h2>
            <div id="formatTest" class="bg-gray-50 p-4 rounded text-sm">
                等待測試...
            </div>
        </div>
    </div>

    <script>
        function addStatus(message) {
            const statusDiv = document.getElementById('employeeStatus');
            statusDiv.innerHTML += `<div class="p-2 bg-blue-50 rounded mb-2">${message}</div>`;
        }
        
        function clearResults() {
            document.getElementById('employeeStatus').innerHTML = '<div class="text-gray-500">等待檢查...</div>';
            document.getElementById('detailedData').innerHTML = '等待檢查...';
            document.getElementById('formatTest').innerHTML = '等待測試...';
        }
        
        // 複製員工頁面的格式化函數
        function formatLoginTime(loginTime) {
            if (!loginTime) return '從未登入';
            
            try {
                // 處理不同的時間格式
                let loginDate;
                
                if (typeof loginTime === 'string') {
                    // 如果是我們自定義的台灣時間格式 (2025-09-19T22:04:00+08:00)
                    if (loginTime.includes('+08:00')) {
                        // 直接解析，JavaScript 應該能正確處理時區
                        loginDate = new Date(loginTime);
                    } 
                    // 如果是 ISO 格式 (UTC 時間)
                    else if (loginTime.includes('T') && loginTime.includes('Z')) {
                        loginDate = new Date(loginTime);
                    }
                    // 其他格式
                    else {
                        loginDate = new Date(loginTime);
                    }
                } else {
                    loginDate = new Date(loginTime);
                }
                
                // 檢查日期是否有效
                if (isNaN(loginDate.getTime())) {
                    console.error('無效的登入時間格式:', loginTime);
                    return '時間格式錯誤';
                }
                
                const now = new Date();
                const diffMs = now - loginDate;
                const diffMins = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);
                
                // 調試信息
                console.log('時間格式化調試:', {
                    原始時間: loginTime,
                    解析後: loginDate.toISOString(),
                    本地時間: loginDate.toLocaleString('zh-TW'),
                    時間差分鐘: diffMins
                });
                
                if (diffMins < 1) return '剛剛';
                if (diffMins < 60) return `${diffMins}分鐘前`;
                if (diffHours < 24) return `${diffHours}小時前`;
                if (diffDays < 7) return `${diffDays}天前`;
                
                return loginDate.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'Asia/Taipei'  // 確保顯示台灣時間
                });
                
            } catch (error) {
                console.error('格式化登入時間時發生錯誤:', error, '原始時間:', loginTime);
                return '時間解析錯誤';
            }
        }
        
        async function checkEmployeeTimes() {
            clearResults();
            addStatus('開始檢查員工時間資料...');
            
            try {
                await DatabaseManager.initialize();
                
                if (!window.supabase) {
                    addStatus('❌ Supabase 不可用');
                    return;
                }
                
                // 獲取最近的會話記錄
                const { data: sessions, error } = await window.supabase
                    .from('employee_sessions')
                    .select('*')
                    .order('login_time', { ascending: false })
                    .limit(10);
                
                if (error) {
                    addStatus(`❌ 查詢失敗: ${error.message}`);
                    return;
                }
                
                addStatus(`✅ 找到 ${sessions.length} 個會話記錄`);
                
                let detailedInfo = '=== 最近 10 個會話的時間資料 ===\n\n';
                
                const currentTime = new Date();
                
                sessions.forEach((session, index) => {
                    const loginTime = new Date(session.login_time);
                    const lastActivity = session.last_activity ? new Date(session.last_activity) : null;
                    
                    const timeDiffLogin = Math.floor((currentTime - loginTime) / (1000 * 60));
                    const timeDiffActivity = lastActivity ? Math.floor((currentTime - lastActivity) / (1000 * 60)) : null;
                    
                    detailedInfo += `${index + 1}. 員工: ${session.employee_id}\n`;
                    detailedInfo += `   會話ID: ${session.session_id}\n`;
                    detailedInfo += `   登入時間 (原始): ${session.login_time}\n`;
                    detailedInfo += `   登入時間 (解析): ${loginTime.toString()}\n`;
                    detailedInfo += `   登入時間 (台灣): ${loginTime.toLocaleString('zh-TW', {timeZone: 'Asia/Taipei'})}\n`;
                    detailedInfo += `   最後活動 (原始): ${session.last_activity || '無'}\n`;
                    if (lastActivity) {
                        detailedInfo += `   最後活動 (解析): ${lastActivity.toString()}\n`;
                        detailedInfo += `   最後活動 (台灣): ${lastActivity.toLocaleString('zh-TW', {timeZone: 'Asia/Taipei'})}\n`;
                    }
                    detailedInfo += `   狀態: ${session.is_active ? '活躍' : '非活躍'}\n`;
                    detailedInfo += `   登入時間差: ${timeDiffLogin} 分鐘\n`;
                    if (timeDiffActivity !== null) {
                        detailedInfo += `   活動時間差: ${timeDiffActivity} 分鐘\n`;
                    }
                    detailedInfo += `   格式化結果 (登入): ${formatLoginTime(session.login_time)}\n`;
                    if (session.last_activity) {
                        detailedInfo += `   格式化結果 (活動): ${formatLoginTime(session.last_activity)}\n`;
                    }
                    detailedInfo += `   ----------------------------------------\n\n`;
                });
                
                detailedInfo += `當前時間: ${currentTime.toString()}\n`;
                detailedInfo += `當前時間 (台灣): ${currentTime.toLocaleString('zh-TW', {timeZone: 'Asia/Taipei'})}\n`;
                
                document.getElementById('detailedData').textContent = detailedInfo;
                
            } catch (error) {
                addStatus(`❌ 檢查時發生錯誤: ${error.message}`);
                console.error('檢查員工時間時發生錯誤:', error);
            }
        }
        
        async function testFormatFunction() {
            addStatus('測試格式化函數...');
            
            // 測試不同的時間格式
            const testTimes = [
                new Date().toLocaleString("sv-SE", {timeZone: "Asia/Taipei"}).replace(" ", "T") + "+08:00", // 當前台灣時間
                new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), // 2小時前 UTC
                new Date(Date.now() - 2 * 60 * 60 * 1000).toLocaleString("sv-SE", {timeZone: "Asia/Taipei"}).replace(" ", "T") + "+08:00", // 2小時前台灣時間
                "2025-09-19T20:34:10+08:00", // 指定的台灣時間
                "2025-09-19T12:34:10.000Z", // 對應的UTC時間
            ];
            
            let testResults = '=== 格式化函數測試 ===\n\n';
            
            testTimes.forEach((timeStr, index) => {
                const result = formatLoginTime(timeStr);
                const parsed = new Date(timeStr);
                const now = new Date();
                const diffMins = Math.floor((now - parsed) / (1000 * 60));
                const diffHours = Math.floor(diffMins / 60);
                
                testResults += `測試 ${index + 1}:\n`;
                testResults += `  原始: ${timeStr}\n`;
                testResults += `  解析: ${parsed.toString()}\n`;
                testResults += `  實際時間差: ${diffMins}分鐘 (${diffHours}小時)\n`;
                testResults += `  格式化結果: ${result}\n`;
                testResults += `  --------------------------------\n\n`;
            });
            
            testResults += `當前時間: ${new Date().toString()}\n`;
            
            document.getElementById('formatTest').textContent = testResults;
        }
        
        // 頁面載入時自動檢查
        document.addEventListener('DOMContentLoaded', async function() {
            addStatus('調試工具已載入，請選擇操作...');
        });
    </script>
</body>
</html>
