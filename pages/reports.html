<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ±è¡¨ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../database.js"></script>
    <script src="../employee-auth.js"></script>
    <script src="auth-check.js"></script>

    <script>
        // å…¨å±€è®Šæ•¸
        let salesData = [];
        let productsData = [];
        let membersData = [];
        let inventoryData = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // è¨­å®šé è¨­æ—¥æœŸç¯„åœï¼ˆæœ¬æœˆï¼‰
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('startDate').value = firstDayOfMonth.toISOString().split('T')[0];
            document.getElementById('endDate').value = lastDayOfMonth.toISOString().split('T')[0];
            
            await loadAllData();
            await updateDashboard();
            setupCharts();
            
            // æ¸¬è©¦è³‡æ–™è¼‰å…¥
            setTimeout(() => {
                testPurchaseData();
                testPerformanceData();
            }, 1000);
        });

        // è¼‰å…¥æ‰€æœ‰æ•¸æ“š
        async function loadAllData() {
            try {
                await DatabaseManager.initialize();
                
                // ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰æ•¸æ“š
                const [sales, products, members, purchases, refunds] = await Promise.all([
                    BusinessAPI.getSalesHistory(),
                    BusinessAPI.getProducts(),
                    BusinessAPI.getMembers(),
                    BusinessAPI.getPurchaseHistory(),
                    BusinessAPI.getRefunds()
                ]);

                salesData = sales || [];
                productsData = products || [];
                membersData = members || [];
                purchaseData = purchases || [];
                refundData = refunds || [];
                inventoryData = []; // æš«æ™‚è¨­ç‚ºç©ºé™£åˆ—ï¼Œå› ç‚ºæ²’æœ‰åº«å­˜äº¤æ˜“API

                console.log('æ•¸æ“šè¼‰å…¥å®Œæˆ:', {
                    sales: salesData.length,
                    products: productsData.length,
                    members: membersData.length,
                    purchases: purchaseData.length,
                    refunds: refundData.length
                });
                
                // èª¿è©¦ä¿¡æ¯
                if (salesData.length > 0) {
                    console.log('éŠ·å”®æ•¸æ“šç¯„ä¾‹:', salesData[0]);
                    // æª¢æŸ¥éŠ·å”®é …ç›®çš„çµæ§‹
                    if (salesData[0].items) {
                        console.log('éŠ·å”®é …ç›®é¡å‹:', typeof salesData[0].items);
                        if (typeof salesData[0].items === 'string') {
                            try {
                                const parsedItems = JSON.parse(salesData[0].items);
                                console.log('è§£æå¾Œçš„éŠ·å”®é …ç›®:', parsedItems);
                            } catch (e) {
                                console.error('è§£æéŠ·å”®é …ç›®å¤±æ•—:', e);
                            }
                        }
                    }
                }
                if (productsData.length > 0) {
                    console.log('å•†å“æ•¸æ“šç¯„ä¾‹:', productsData[0]);
                }
                if (purchaseData.length > 0) {
                    console.log('é€²è²¨æ•¸æ“šç¯„ä¾‹:', purchaseData[0]);
                    console.log('é€²è²¨æ•¸æ“šç¸½æ•¸:', purchaseData.length);
                } else {
                    console.log('æ²’æœ‰é€²è²¨æ•¸æ“š');
                }
            } catch (error) {
                console.error('è¼‰å…¥æ•¸æ“šå¤±æ•—:', error);
                showNotification('è¼‰å…¥æ•¸æ“šå¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«é€£æ¥', 'error');
            }
        }

        // æ›´æ–°å„€è¡¨æ¿æ•¸æ“š
        async function updateDashboard() {
            updateStatistics();
            updateInventoryTable();
            await updateTopProducts();
            updateInventoryAlerts();
            updateMonthlyComparison();
        }

        // æ›´æ–°å„€è¡¨æ¿æ•¸æ“šï¼ˆæ”¯æ´æ—¥æœŸç¯„åœï¼‰
        async function updateDashboardWithDateRange(startDate, endDate) {
            updateStatisticsWithDateRange(startDate, endDate);
            updateInventoryTableWithDateRange(startDate, endDate);
            await updateTopProductsWithDateRange(startDate, endDate);
            updateInventoryAlerts();
            updateMonthlyComparisonWithDateRange(startDate, endDate);
            await setupCategoryChartWithDateRange(startDate, endDate);
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStatistics() {
            const currentMonthData = getCurrentMonthData();
            const lastMonthData = getLastMonthData();
            
            // æœ¬æœˆè¨‚å–®æ•¸
            const orderCount = currentMonthData.sales.length;
            document.getElementById('orderCount').textContent = orderCount;
            
            // è¨ˆç®—è¨‚å–®å¢é•·ç‡
            const orderGrowth = calculateGrowthRate(orderCount, lastMonthData.sales.length);
            updateGrowthDisplay('orderGrowth', orderGrowth, '%');
            
            // æœ¬æœˆç¸½é€²è²¨é¡
            const purchaseAmount = currentMonthData.purchases.reduce((sum, purchase) => sum + (purchase.total_cost || 0), 0);
            document.getElementById('purchaseAmount').textContent = `NT$${purchaseAmount.toLocaleString()}`;
            
            // è¨ˆç®—é€²è²¨å¢é•·ç‡
            const lastMonthPurchaseAmount = lastMonthData.purchases.reduce((sum, purchase) => sum + (purchase.total_cost || 0), 0);
            const purchaseGrowth = calculateGrowthRate(purchaseAmount, lastMonthPurchaseAmount);
            updateGrowthDisplay('purchaseGrowth', purchaseGrowth, '%');
            
            // æœ¬æœˆæ¯›åˆ©ç‡
            const grossProfit = calculateGrossProfit(currentMonthData.sales);
            const grossProfitRate = grossProfit > 0 ? ((grossProfit / currentMonthData.totalSales) * 100).toFixed(1) : 0;
            document.getElementById('grossProfitRate').textContent = `${grossProfitRate}%`;
            
            // è¨ˆç®—æ¯›åˆ©ç‡å¢é•·ç‡
            const lastMonthGrossProfit = calculateGrossProfit(lastMonthData.sales);
            const lastMonthGrossProfitRate = lastMonthData.totalSales > 0 ? ((lastMonthGrossProfit / lastMonthData.totalSales) * 100) : 0;
            const profitGrowth = calculateGrowthRate(parseFloat(grossProfitRate), lastMonthGrossProfitRate);
            updateGrowthDisplay('profitGrowth', profitGrowth, '%');
            
            // åº«å­˜é€±è½‰ç‡
            const turnoverRate = calculateInventoryTurnover();
            document.getElementById('turnoverRate').textContent = turnoverRate.toFixed(1);
            
            // è¨ˆç®—é€±è½‰ç‡å¢é•·ç‡
            const lastMonthTurnoverRate = calculateLastMonthInventoryTurnover();
            const turnoverGrowth = calculateGrowthRate(turnoverRate, lastMonthTurnoverRate);
            updateGrowthDisplay('turnoverGrowth', turnoverGrowth, '');
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“šï¼ˆæ”¯æ´æ—¥æœŸç¯„åœï¼‰
        function updateStatisticsWithDateRange(startDate, endDate) {
            const dateRangeData = getDataByDateRange(startDate, endDate);
            
            // æ—¥æœŸç¯„åœå…§è¨‚å–®æ•¸
            const orderCount = dateRangeData.sales.length;
            document.getElementById('orderCount').textContent = orderCount;
            
            // æ›´æ–°æ¨™ç±¤é¡¯ç¤ºæ—¥æœŸç¯„åœ
            const orderLabel = document.querySelector('#orderCount').parentElement.querySelector('p');
            if (orderLabel) {
                orderLabel.textContent = `${startDate} è‡³ ${endDate} è¨‚å–®æ•¸`;
            }
            
            // æ—¥æœŸç¯„åœå…§ç¸½é€²è²¨é¡
            const purchaseAmount = dateRangeData.purchases.reduce((sum, purchase) => sum + (purchase.total_cost || 0), 0);
            document.getElementById('purchaseAmount').textContent = `NT$${purchaseAmount.toLocaleString()}`;
            const purchaseLabel = document.querySelector('#purchaseAmount').parentElement.querySelector('p');
            if (purchaseLabel) {
                purchaseLabel.textContent = `${startDate} è‡³ ${endDate} ç¸½é€²è²¨é¡`;
            }
            
            // æ—¥æœŸç¯„åœå…§æ¯›åˆ©ç‡
            const grossProfit = calculateGrossProfit(dateRangeData.sales);
            const grossProfitRate = grossProfit > 0 ? ((grossProfit / dateRangeData.totalSales) * 100).toFixed(1) : 0;
            document.getElementById('grossProfitRate').textContent = `${grossProfitRate}%`;
            const profitLabel = document.querySelector('#grossProfitRate').parentElement.querySelector('p');
            if (profitLabel) {
                profitLabel.textContent = `${startDate} è‡³ ${endDate} æ¯›åˆ©ç‡`;
            }
            
            // åº«å­˜é€±è½‰ç‡ï¼ˆä¿æŒåŸæ¨£ï¼‰
            const turnoverRate = calculateInventoryTurnover();
            document.getElementById('turnoverRate').textContent = turnoverRate.toFixed(1);
            
            // éš±è—å¢é•·ç‡é¡¯ç¤º
            document.querySelectorAll('[id$="Growth"]').forEach(el => {
                el.style.display = 'none';
            });
        }

        // ç²å–æœ¬æœˆæ•¸æ“š
        function getCurrentMonthData() {
            const startOfMonth = new Date(currentYear, currentMonth, 1);
            const endOfMonth = new Date(currentYear, currentMonth + 1, 0);
            
            console.log('æœ¬æœˆæ—¥æœŸç¯„åœ:', startOfMonth.toISOString(), 'åˆ°', endOfMonth.toISOString());
            
            const sales = salesData.filter(sale => {
                // è™•ç†ä¸åŒçš„æ—¥æœŸæ ¼å¼
                let saleDate;
                if (sale.created_at) {
                    saleDate = new Date(sale.created_at);
                } else if (sale.sale_date) {
                    saleDate = new Date(sale.sale_date);
                } else if (sale.date) {
                    saleDate = new Date(sale.date);
                } else {
                    console.log('éŠ·å”®è¨˜éŒ„ç¼ºå°‘æ—¥æœŸ:', sale);
                    return false;
                }
                
                const isInCurrentMonth = saleDate >= startOfMonth && saleDate <= endOfMonth;
                if (isInCurrentMonth) {
                    console.log('æ‰¾åˆ°æœ¬æœˆéŠ·å”®è¨˜éŒ„:', saleDate.toISOString(), sale);
                }
                
                return isInCurrentMonth;
            });
            
            // ç²å–æœ¬æœˆé€²è²¨æ•¸æ“š
            const purchases = purchaseData.filter(purchase => {
                // è™•ç†ä¸åŒçš„æ—¥æœŸæ ¼å¼
                let purchaseDate;
                if (purchase.purchase_date) {
                    purchaseDate = new Date(purchase.purchase_date);
                } else if (purchase.created_at) {
                    purchaseDate = new Date(purchase.created_at);
                } else {
                    console.log('é€²è²¨è¨˜éŒ„ç¼ºå°‘æ—¥æœŸ:', purchase);
                    return false;
                }
                return purchaseDate >= startOfMonth && purchaseDate <= endOfMonth;
            });
            
            // ç²å–æœ¬æœˆé€€è²¨æ•¸æ“š
            const refunds = refundData.filter(refund => {
                const refundDate = new Date(refund.refund_date);
                return refundDate >= startOfMonth && refundDate <= endOfMonth;
            });
            
            const totalSales = sales.reduce((sum, sale) => sum + (sale.total_amount || sale.total || 0), 0);
            
            return { sales, purchases, refunds, totalSales };
        }

        // ç²å–æŒ‡å®šæ—¥æœŸç¯„åœçš„æ•¸æ“š
        function getDataByDateRange(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999); // è¨­å®šç‚ºç•¶å¤©çµæŸæ™‚é–“
            
            console.log('æ—¥æœŸç¯„åœæŸ¥è©¢:', start.toISOString(), 'åˆ°', end.toISOString());
            
            const sales = salesData.filter(sale => {
                // è™•ç†ä¸åŒçš„æ—¥æœŸæ ¼å¼
                let saleDate;
                if (sale.created_at) {
                    saleDate = new Date(sale.created_at);
                } else if (sale.sale_date) {
                    saleDate = new Date(sale.sale_date);
                } else if (sale.date) {
                    saleDate = new Date(sale.date);
                } else {
                    return false;
                }
                
                return saleDate >= start && saleDate <= end;
            });
            
            // ç²å–æ—¥æœŸç¯„åœå…§é€²è²¨æ•¸æ“š
            const purchases = purchaseData.filter(purchase => {
                // è™•ç†ä¸åŒçš„æ—¥æœŸæ ¼å¼
                let purchaseDate;
                if (purchase.purchase_date) {
                    purchaseDate = new Date(purchase.purchase_date);
                } else if (purchase.created_at) {
                    purchaseDate = new Date(purchase.created_at);
                } else {
                    return false;
                }
                return purchaseDate >= start && purchaseDate <= end;
            });
            
            // ç²å–æ—¥æœŸç¯„åœå…§é€€è²¨æ•¸æ“š
            const refunds = refundData.filter(refund => {
                const refundDate = new Date(refund.refund_date);
                return refundDate >= start && refundDate <= end;
            });
            
            const totalSales = sales.reduce((sum, sale) => sum + (sale.total_amount || sale.total || 0), 0);
            
            return {
                sales,
                purchases,
                refunds,
                totalSales
            };
        }

        // è¨ˆç®—æ¯›åˆ©ç‡ï¼ˆæ‰£é™¤é€€è²¨ï¼‰
        function calculateGrossProfit(sales) {
            const currentMonthData = getCurrentMonthData();
            let totalRevenue = 0;
            let totalCost = 0;
            
            sales.forEach(sale => {
                totalRevenue += sale.total_amount || sale.total || 0;
                
                // è§£æéŠ·å”®é …ç›®ä¾†è¨ˆç®—å¯¦éš›æˆæœ¬
                let items = [];
                if (sale.items) {
                    if (typeof sale.items === 'string') {
                        try {
                            items = JSON.parse(sale.items);
                        } catch (e) {
                            console.error('è§£æéŠ·å”®é …ç›® JSON å¤±æ•—:', e);
                            items = [];
                        }
                    } else if (Array.isArray(sale.items)) {
                        items = sale.items;
                    }
                }
                
                // è¨ˆç®—æ¯å€‹å•†å“çš„æˆæœ¬
                items.forEach(item => {
                    const product = productsData.find(p => 
                        p.id === item.product_id || 
                        p.barcode === item.barcode ||
                        p.name === item.name
                    );
                    if (product) {
                        // ä½¿ç”¨å•†å“æˆæœ¬æˆ–ä¼°ç®—æˆæœ¬
                        const cost = product.cost || (product.price * 0.6);
                        totalCost += cost * item.quantity;
                    } else {
                        // å¦‚æœæ‰¾ä¸åˆ°å•†å“ï¼Œä½¿ç”¨ä¼°ç®—å€¼
                        totalCost += (item.total_price || item.price * item.quantity) * 0.6;
                    }
                });
            });
            
            // æ‰£é™¤é€€è²¨çš„å½±éŸ¿
            const refundAmount = currentMonthData.refunds.reduce((sum, refund) => {
                return sum + (refund.refund_amount || 0);
            }, 0);
            
            const refundCost = refundAmount * 0.6; // å‡è¨­é€€è²¨æˆæœ¬ç‚ºé€€è²¨é‡‘é¡çš„60%
            
            return (totalRevenue - refundAmount) - (totalCost - refundCost);
        }

        // è¨ˆç®—åº«å­˜é€±è½‰ç‡
        function calculateInventoryTurnover() {
            const currentMonthData = getCurrentMonthData();
            const avgInventory = productsData.reduce((sum, product) => sum + (product.stock || 0), 0) / productsData.length;
            const salesCount = currentMonthData.sales.reduce((sum, sale) => {
                let items = [];
                if (sale.items) {
                    if (typeof sale.items === 'string') {
                        try {
                            items = JSON.parse(sale.items);
                        } catch (e) {
                            items = [];
                        }
                    } else if (Array.isArray(sale.items)) {
                        items = sale.items;
                    }
                }
                return sum + items.length;
            }, 0);
            
            return avgInventory > 0 ? salesCount / avgInventory : 0;
        }

        // æ›´æ–°åº«å­˜è¡¨æ ¼
        async function updateInventoryTable() {
            const tableBody = document.querySelector('#inventoryTable tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">è¼‰å…¥ä¸­...</td></tr>';
            
            try {
                // è¨ˆç®—æ‰€æœ‰å•†å“çš„é€²éŠ·å­˜æ•¸æ“š
                const inventoryDataPromises = productsData.map(async product => {
                    const beginningStock = product.stock || 0;
                    const purchases = await getProductPurchases(product.id);
                    const sales = getProductSales(product.id);
                    const endingStock = beginningStock + purchases - sales;
                    const salesAmount = getProductSalesAmount(product.id);
                    const avgPrice = sales > 0 ? salesAmount / sales : product.price || 0;
                    
                    return {
                        ...product,
                        beginningStock,
                        purchases,
                        sales,
                        endingStock,
                        salesAmount,
                        avgPrice,
                        stockStatus: getStockStatus(endingStock, product.min_stock || 10)
                    };
                });
                
                const inventoryData = await Promise.all(inventoryDataPromises);
                
                // æ¸…ç©ºè¼‰å…¥æç¤º
                tableBody.innerHTML = '';
                
                // æŒ‰éŠ·å”®é‡æ’åºï¼Œé¡¯ç¤ºå‰15å€‹å•†å“
                const sortedData = inventoryData
                    .sort((a, b) => b.sales - a.sales)
                    .slice(0, 15);
                
                sortedData.forEach(product => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100 hover:bg-gray-50';
                    
                    const stockStatusClass = getStockStatusClass(product.stockStatus);
                    const endingStockClass = product.endingStock <= 0 ? 'text-red-600' : 
                                           product.endingStock <= (product.min_stock || 10) ? 'text-[#17225e]' : '';
                    
                    row.innerHTML = `
                        <td class="py-3">
                            <div class="flex items-center space-x-2">
                                <span class="w-2 h-2 rounded-full ${stockStatusClass}"></span>
                                <div>
                                    <div class="font-medium">${product.name}</div>
                                    <div class="text-xs text-gray-500">${product.barcode || 'ç„¡æ¢ç¢¼'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center py-3">${product.beginningStock}</td>
                        <td class="text-center py-3 text-[#17225e]">+${product.purchases}</td>
                        <td class="text-center py-3 text-[#17225e]">-${product.sales}</td>
                        <td class="text-center py-3 font-semibold ${endingStockClass}">${product.endingStock}</td>
                        <td class="text-center py-3 text-sm text-gray-600">NT$${product.avgPrice.toLocaleString()}</td>
                        <td class="text-center py-3 text-sm text-gray-600">NT$${product.salesAmount.toLocaleString()}</td>
                    `;
                    
                    // æ·»åŠ é»æ“Šäº‹ä»¶æŸ¥çœ‹è©³ç´°ä¿¡æ¯
                    row.addEventListener('click', () => showProductDetail(product));
                    row.style.cursor = 'pointer';
                    
                    tableBody.appendChild(row);
                });
                
                // æ›´æ–°è¡¨æ ¼æ¨™é¡Œé¡¯ç¤ºç¸½è¨ˆ
                updateInventorySummary(inventoryData);
                
            } catch (error) {
                console.error('æ›´æ–°åº«å­˜è¡¨æ ¼å¤±æ•—:', error);
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</td></tr>';
            }
        }

        // æ›´æ–°åº«å­˜è¡¨æ ¼ï¼ˆæ”¯æ´æ—¥æœŸç¯„åœï¼‰
        async function updateInventoryTableWithDateRange(startDate, endDate) {
            const tableBody = document.querySelector('#inventoryTable tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">è¼‰å…¥ä¸­...</td></tr>';
            
            try {
                // è¨ˆç®—æ‰€æœ‰å•†å“çš„é€²éŠ·å­˜æ•¸æ“šï¼ˆæ—¥æœŸç¯„åœå…§ï¼‰
                const inventoryDataPromises = productsData.map(async product => {
                    const beginningStock = product.stock || 0;
                    const purchases = await getProductPurchasesByDateRange(product.id, startDate, endDate);
                    const sales = getProductSalesByDateRange(product.id, startDate, endDate);
                    const endingStock = beginningStock + purchases - sales;
                    const salesAmount = getProductSalesAmountByDateRange(product.id, startDate, endDate);
                    const avgPrice = sales > 0 ? salesAmount / sales : product.price || 0;
                    
                    return {
                        ...product,
                        beginningStock,
                        purchases,
                        sales,
                        endingStock,
                        salesAmount,
                        avgPrice,
                        stockStatus: getStockStatus(endingStock, product.min_stock || 10)
                    };
                });
                
                const inventoryData = await Promise.all(inventoryDataPromises);
                
                // æ¸…ç©ºè¼‰å…¥æç¤º
                tableBody.innerHTML = '';
                
                // æŒ‰éŠ·å”®é‡æ’åºï¼Œé¡¯ç¤ºå‰15å€‹å•†å“
                const sortedData = inventoryData
                    .sort((a, b) => b.sales - a.sales)
                    .slice(0, 15);
                
                sortedData.forEach(product => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100 hover:bg-gray-50';
                    
                    const stockStatusClass = getStockStatusClass(product.stockStatus);
                    const endingStockClass = product.endingStock <= 0 ? 'text-red-600' : 
                                           product.endingStock <= (product.min_stock || 10) ? 'text-[#17225e]' : '';
                    
                    row.innerHTML = `
                        <td class="py-3">
                            <div class="flex items-center space-x-2">
                                <span class="w-2 h-2 rounded-full ${stockStatusClass}"></span>
                                <div>
                                    <div class="font-medium">${product.name}</div>
                                    <div class="text-xs text-gray-500">${product.barcode || 'ç„¡æ¢ç¢¼'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center py-3">${product.beginningStock}</td>
                        <td class="text-center py-3 text-[#17225e]">+${product.purchases}</td>
                        <td class="text-center py-3 text-[#17225e]">-${product.sales}</td>
                        <td class="text-center py-3 font-semibold ${endingStockClass}">${product.endingStock}</td>
                        <td class="text-center py-3 text-sm text-gray-600">NT$${product.avgPrice.toLocaleString()}</td>
                        <td class="text-center py-3 text-sm text-gray-600">NT$${product.salesAmount.toLocaleString()}</td>
                    `;
                    
                    // æ·»åŠ é»æ“Šäº‹ä»¶æŸ¥çœ‹è©³ç´°ä¿¡æ¯
                    row.addEventListener('click', () => showProductDetail(product));
                    row.style.cursor = 'pointer';
                    
                    tableBody.appendChild(row);
                });
                
                // æ›´æ–°è¡¨æ ¼æ¨™é¡Œé¡¯ç¤ºç¸½è¨ˆ
                updateInventorySummary(inventoryData);
                
            } catch (error) {
                console.error('æ›´æ–°åº«å­˜è¡¨æ ¼å¤±æ•—:', error);
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</td></tr>';
            }
        }

        // ç²å–å•†å“é€²è²¨æ•¸é‡
        async function getProductPurchases(productId) {
            try {
                // ç›´æ¥å¾å·²è¼‰å…¥çš„é€²è²¨è³‡æ–™ä¸­ç¯©é¸
                const currentMonthData = getCurrentMonthData();
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                const productPurchases = currentMonthData.purchases.filter(purchase => {
                    // æ”¯æ´å¤šç¨®å•†å“IDåŒ¹é…æ–¹å¼
                    return purchase.product_id === productId || 
                           purchase.product_id === productId.toString() ||
                           purchase.product_id === parseInt(productId);
                });
                
                const totalQuantity = productPurchases.reduce((sum, purchase) => {
                    // è™•ç†ä¸åŒçš„æ—¥æœŸæ ¼å¼
                    let purchaseDate;
                    if (purchase.purchase_date) {
                        purchaseDate = new Date(purchase.purchase_date);
                    } else if (purchase.created_at) {
                        purchaseDate = new Date(purchase.created_at);
                    } else {
                        console.log('é€²è²¨è¨˜éŒ„ç¼ºå°‘æ—¥æœŸ:', purchase);
                        return sum;
                    }
                    
                    if (purchaseDate.getMonth() === currentMonth && purchaseDate.getFullYear() === currentYear) {
                        return sum + (purchase.quantity || 0);
                    }
                    return sum;
                }, 0);
                
                console.log(`å•†å“ ${productId} æœ¬æœˆé€²è²¨æ•¸é‡:`, totalQuantity, 'ç­†è¨˜éŒ„:', productPurchases.length);
                return totalQuantity;
            } catch (error) {
                console.error('ç²å–å•†å“é€²è²¨æ•¸é‡å¤±æ•—:', error);
                return 0;
            }
        }

        // ç²å–å•†å“é€²è²¨æ•¸é‡ï¼ˆæ”¯æ´æ—¥æœŸç¯„åœï¼‰
        async function getProductPurchasesByDateRange(productId, startDate, endDate) {
            try {
                const dateRangeData = getDataByDateRange(startDate, endDate);
                
                const productPurchases = dateRangeData.purchases.filter(purchase => {
                    return purchase.product_id === productId || 
                           purchase.product_id === productId.toString() ||
                           purchase.product_id === parseInt(productId);
                });
                
                const totalQuantity = productPurchases.reduce((sum, purchase) => {
                    return sum + (purchase.quantity || 0);
                }, 0);
                
                console.log(`å•†å“ ${productId} æ—¥æœŸç¯„åœé€²è²¨æ•¸é‡:`, totalQuantity, 'ç­†è¨˜éŒ„:', productPurchases.length);
                return totalQuantity;
            } catch (error) {
                console.error('ç²å–å•†å“æ—¥æœŸç¯„åœé€²è²¨æ•¸é‡å¤±æ•—:', error);
                return 0;
            }
        }

        // ç²å–å•†å“éŠ·å”®æ•¸é‡ï¼ˆæ”¯æ´æ—¥æœŸç¯„åœï¼‰
        function getProductSalesByDateRange(productId, startDate, endDate) {
            const dateRangeData = getDataByDateRange(startDate, endDate);
            const product = productsData.find(p => p.id === productId);
            
            // è¨ˆç®—éŠ·å”®æ•¸é‡
            const salesQuantity = dateRangeData.sales.reduce((sum, sale) => {
                let items = [];
                if (sale.items) {
                    if (typeof sale.items === 'string') {
                        try {
                            items = JSON.parse(sale.items);
                        } catch (e) {
                            items = [];
                        }
                    } else if (Array.isArray(sale.items)) {
                        items = sale.items;
                    }
                }
                
                const item = items.find(item => {
                    return item.product_id === productId || 
                           item.barcode === product?.barcode ||
                           item.name === product?.name;
                });
                
                return sum + (item ? item.quantity : 0);
            }, 0);
            
            // è¨ˆç®—é€€è²¨æ•¸é‡
            const refundQuantity = dateRangeData.refunds.reduce((sum, refund) => {
                if (refund.sale_id) {
                    const sale = dateRangeData.sales.find(s => s.id === refund.sale_id);
                    if (sale && sale.items) {
                        let items = [];
                        if (typeof sale.items === 'string') {
                            try {
                                items = JSON.parse(sale.items);
                            } catch (e) {
                                items = [];
                            }
                        } else if (Array.isArray(sale.items)) {
                            items = sale.items;
                        }
                        
                        const item = items.find(item => {
                            return item.product_id === productId || 
                                   item.barcode === product?.barcode ||
                                   item.name === product?.name;
                        });
                        
                        return sum + (item ? (refund.refund_quantity || item.quantity) : 0);
                    }
                }
                return sum;
            }, 0);
            
            return Math.max(0, salesQuantity - refundQuantity);
        }

        // ç²å–å•†å“éŠ·å”®é‡‘é¡ï¼ˆæ”¯æ´æ—¥æœŸç¯„åœï¼‰
        function getProductSalesAmountByDateRange(productId, startDate, endDate) {
            const dateRangeData = getDataByDateRange(startDate, endDate);
            const product = productsData.find(p => p.id === productId);
            
            // è¨ˆç®—éŠ·å”®é‡‘é¡
            const salesAmount = dateRangeData.sales.reduce((sum, sale) => {
                let items = [];
                if (sale.items) {
                    if (typeof sale.items === 'string') {
                        try {
                            items = JSON.parse(sale.items);
                        } catch (e) {
                            items = [];
                        }
                    } else if (Array.isArray(sale.items)) {
                        items = sale.items;
                    }
                }
                
                const item = items.find(item => {
                    return item.product_id === productId || 
                           item.barcode === product?.barcode ||
                           item.name === product?.name;
                });
                
                return sum + (item ? (item.total_price || item.price * item.quantity) : 0);
            }, 0);
            
            // è¨ˆç®—é€€è²¨é‡‘é¡
            const refundAmount = dateRangeData.refunds.reduce((sum, refund) => {
                if (refund.sale_id) {
                    const sale = dateRangeData.sales.find(s => s.id === refund.sale_id);
                    if (sale && sale.items) {
                        let items = [];
                        if (typeof sale.items === 'string') {
                            try {
                                items = JSON.parse(sale.items);
                            } catch (e) {
                                items = [];
                            }
                        } else if (Array.isArray(sale.items)) {
                            items = sale.items;
                        }
                        
                        const item = items.find(item => {
                            return item.product_id === productId || 
                                   item.barcode === product?.barcode ||
                                   item.name === product?.name;
                        });
                        
                        return sum + (item ? (refund.refund_amount || item.total_price) : 0);
                    }
                }
                return sum;
            }, 0);
            
            return Math.max(0, salesAmount - refundAmount);
        }

        // ç²å–å•†å“éŠ·å”®æ•¸é‡ï¼ˆæ‰£é™¤é€€è²¨ï¼‰
        function getProductSales(productId) {
            const currentMonthData = getCurrentMonthData();
            const product = productsData.find(p => p.id === productId);
            
            // è¨ˆç®—éŠ·å”®æ•¸é‡
            const salesQuantity = currentMonthData.sales.reduce((sum, sale) => {
                let items = [];
                if (sale.items) {
                    if (typeof sale.items === 'string') {
                        try {
                            items = JSON.parse(sale.items);
                        } catch (e) {
                            console.error('è§£æéŠ·å”®é …ç›® JSON å¤±æ•—:', e);
                            items = [];
                        }
                    } else if (Array.isArray(sale.items)) {
                        items = sale.items;
                    }
                }
                
                const item = items.find(item => {
                    return item.product_id === productId || 
                           item.barcode === product?.barcode ||
                           item.name === product?.name;
                });
                
                return sum + (item ? item.quantity : 0);
            }, 0);
            
            // è¨ˆç®—é€€è²¨æ•¸é‡
            const refundQuantity = currentMonthData.refunds.reduce((sum, refund) => {
                // æª¢æŸ¥é€€è²¨è¨˜éŒ„æ˜¯å¦åŒ…å«è©²å•†å“
                // é€™è£¡éœ€è¦æ ¹æ“šå¯¦éš›çš„é€€è²¨æ•¸æ“šçµæ§‹é€²è¡Œèª¿æ•´
                if (refund.sale_id) {
                    // æ‰¾åˆ°å°æ‡‰çš„éŠ·å”®è¨˜éŒ„
                    const sale = currentMonthData.sales.find(s => s.id === refund.sale_id);
                    if (sale && sale.items) {
                        let items = [];
                        if (typeof sale.items === 'string') {
                            try {
                                items = JSON.parse(sale.items);
                            } catch (e) {
                                items = [];
                            }
                        } else if (Array.isArray(sale.items)) {
                            items = sale.items;
                        }
                        
                        const item = items.find(item => {
                            return item.product_id === productId || 
                                   item.barcode === product?.barcode ||
                                   item.name === product?.name;
                        });
                        
                        // å¦‚æœé€€è²¨è¨˜éŒ„æœ‰å…·é«”çš„å•†å“æ•¸é‡ï¼Œä½¿ç”¨é€€è²¨æ•¸é‡
                        // å¦å‰‡å‡è¨­é€€è²¨äº†è©²éŠ·å”®è¨˜éŒ„ä¸­è©²å•†å“çš„å…¨éƒ¨æ•¸é‡
                        return sum + (item ? (refund.refund_quantity || item.quantity) : 0);
                    }
                }
                return sum;
            }, 0);
            
            // è¿”å›æ·¨éŠ·å”®æ•¸é‡ï¼ˆéŠ·å”® - é€€è²¨ï¼‰
            return Math.max(0, salesQuantity - refundQuantity);
        }

        // ç²å–å•†å“éŠ·å”®é‡‘é¡ï¼ˆæ‰£é™¤é€€è²¨ï¼‰
        function getProductSalesAmount(productId) {
            const currentMonthData = getCurrentMonthData();
            const product = productsData.find(p => p.id === productId);
            
            // è¨ˆç®—éŠ·å”®é‡‘é¡
            const salesAmount = currentMonthData.sales.reduce((sum, sale) => {
                let items = [];
                if (sale.items) {
                    if (typeof sale.items === 'string') {
                        try {
                            items = JSON.parse(sale.items);
                        } catch (e) {
                            console.error('è§£æéŠ·å”®é …ç›® JSON å¤±æ•—:', e);
                            items = [];
                        }
                    } else if (Array.isArray(sale.items)) {
                        items = sale.items;
                    }
                }
                
                const item = items.find(item => {
                    return item.product_id === productId || 
                           item.barcode === product?.barcode ||
                           item.name === product?.name;
                });
                
                return sum + (item ? (item.total_price || item.price * item.quantity) : 0);
            }, 0);
            
            // è¨ˆç®—é€€è²¨é‡‘é¡
            const refundAmount = currentMonthData.refunds.reduce((sum, refund) => {
                if (refund.sale_id) {
                    const sale = currentMonthData.sales.find(s => s.id === refund.sale_id);
                    if (sale && sale.items) {
                        let items = [];
                        if (typeof sale.items === 'string') {
                            try {
                                items = JSON.parse(sale.items);
                            } catch (e) {
                                items = [];
                            }
                        } else if (Array.isArray(sale.items)) {
                            items = sale.items;
                        }
                        
                        const item = items.find(item => {
                            return item.product_id === productId || 
                                   item.barcode === product?.barcode ||
                                   item.name === product?.name;
                        });
                        
                        if (item) {
                            // å¦‚æœé€€è²¨è¨˜éŒ„æœ‰å…·é«”çš„é€€è²¨é‡‘é¡ï¼Œä½¿ç”¨é€€è²¨é‡‘é¡
                            // å¦å‰‡æ ¹æ“šé€€è²¨æ•¸é‡è¨ˆç®—
                            const itemPrice = item.total_price || item.price * item.quantity;
                            const refundQuantity = refund.refund_quantity || item.quantity;
                            return sum + (itemPrice * (refundQuantity / item.quantity));
                        }
                    }
                }
                return sum;
            }, 0);
            
            // è¿”å›æ·¨éŠ·å”®é‡‘é¡ï¼ˆéŠ·å”® - é€€è²¨ï¼‰
            return Math.max(0, salesAmount - refundAmount);
        }

        // ç²å–åº«å­˜ç‹€æ…‹
        function getStockStatus(stock, minStock) {
            if (stock <= 0) return 'out_of_stock';
            if (stock <= minStock) return 'low_stock';
            return 'normal';
        }

        // ç²å–åº«å­˜ç‹€æ…‹æ¨£å¼
        function getStockStatusClass(status) {
            switch (status) {
                case 'out_of_stock': return 'bg-red-500';
                case 'low_stock': return 'bg-[#17225e]';
                default: return 'bg-green-500';
            }
        }

        // æ›´æ–°åº«å­˜æ‘˜è¦
        function updateInventorySummary(inventoryData) {
            const totalProducts = inventoryData.length;
            const outOfStock = inventoryData.filter(p => p.stockStatus === 'out_of_stock').length;
            const lowStock = inventoryData.filter(p => p.stockStatus === 'low_stock').length;
            const totalSales = inventoryData.reduce((sum, p) => sum + p.sales, 0);
            const totalSalesAmount = inventoryData.reduce((sum, p) => sum + p.salesAmount, 0);
            
            // æ›´æ–°è¡¨æ ¼æ¨™é¡Œ
            const tableTitle = document.querySelector('#inventoryTable').closest('.apple-card').querySelector('h3');
            if (tableTitle) {
                tableTitle.innerHTML = `é€²éŠ·å­˜æ˜ç´°å ±è¡¨ <span class="text-sm font-normal text-gray-500">(å…± ${totalProducts} é …å•†å“ï¼Œ${outOfStock} é …ç¼ºè²¨ï¼Œ${lowStock} é …ä½åº«å­˜ï¼Œæ·¨éŠ·å”®å·²æ‰£é™¤é€€è²¨)</span>`;
            }
        }

        // é¡¯ç¤ºå•†å“è©³ç´°ä¿¡æ¯
        function showProductDetail(product) {
            const currentMonthData = getCurrentMonthData();
            
            // è¨ˆç®—é€€è²¨æ•¸é‡
            const refundQuantity = currentMonthData.refunds.reduce((sum, refund) => {
                if (refund.sale_id) {
                    const sale = currentMonthData.sales.find(s => s.id === refund.sale_id);
                    if (sale && sale.items) {
                        let items = [];
                        if (typeof sale.items === 'string') {
                            try {
                                items = JSON.parse(sale.items);
                            } catch (e) {
                                items = [];
                            }
                        } else if (Array.isArray(sale.items)) {
                            items = sale.items;
                        }
                        
                        const item = items.find(item => {
                            return item.product_id === product.id || 
                                   item.barcode === product.barcode ||
                                   item.name === product.name;
                        });
                        
                        return sum + (item ? (refund.refund_quantity || item.quantity) : 0);
                    }
                }
                return sum;
            }, 0);
            
            const detailInfo = `
ğŸ“Š å•†å“è©³ç´°å ±è¡¨

å•†å“åç¨±ï¼š${product.name}
å•†å“æ¢ç¢¼ï¼š${product.barcode || 'ç„¡æ¢ç¢¼'}
å•†å“åˆ†é¡ï¼š${product.category || 'æœªåˆ†é¡'}
å•†å“åƒ¹æ ¼ï¼šNT$${product.price?.toLocaleString() || '0'}

ğŸ“ˆ æœ¬æœˆé€²éŠ·å­˜æ•¸æ“šï¼š
æœŸåˆåº«å­˜ï¼š${product.beginningStock} ä»¶
æœ¬æœˆé€²è²¨ï¼š${product.purchases} ä»¶
æœ¬æœˆéŠ·å”®ï¼š${product.sales + refundQuantity} ä»¶
æœ¬æœˆé€€è²¨ï¼š${refundQuantity} ä»¶
æ·¨éŠ·å”®ï¼š${product.sales} ä»¶
æœŸæœ«åº«å­˜ï¼š${product.endingStock} ä»¶
å¹³å‡å”®åƒ¹ï¼šNT$${product.avgPrice.toLocaleString()}
æ·¨éŠ·å”®é‡‘é¡ï¼šNT$${product.salesAmount.toLocaleString()}

ğŸ“‹ åº«å­˜ç‹€æ…‹ï¼š${getStockStatusText(product.stockStatus)}
æœ€ä½åº«å­˜ï¼š${product.min_stock || 10} ä»¶

${product.sales > 0 ? 'âœ… æœ¬æœˆæœ‰æ·¨éŠ·å”®è¨˜éŒ„' : 'âŒ æœ¬æœˆç„¡æ·¨éŠ·å”®è¨˜éŒ„'}
${refundQuantity > 0 ? `âš ï¸ æœ¬æœˆæœ‰ ${refundQuantity} ä»¶é€€è²¨` : ''}
            `;
            
            alert(detailInfo);
        }

        // ç²å–åº«å­˜ç‹€æ…‹æ–‡å­—
        function getStockStatusText(status) {
            switch (status) {
                case 'out_of_stock': return 'ğŸ”´ ç¼ºè²¨';
                case 'low_stock': return 'ğŸŸ¡ ä½åº«å­˜';
                default: return 'ğŸŸ¢ æ­£å¸¸';
            }
        }

        // åŒ¯å‡ºé€²éŠ·å­˜å ±è¡¨
        function exportInventoryReport() {
            const inventoryData = productsData.map(product => {
                const beginningStock = product.stock || 0;
                const purchases = getProductPurchases(product.id);
                const sales = getProductSales(product.id);
                const endingStock = beginningStock + purchases - sales;
                const salesAmount = getProductSalesAmount(product.id);
                const avgPrice = sales > 0 ? salesAmount / sales : product.price || 0;
                
                return {
                    name: product.name,
                    barcode: product.barcode || 'ç„¡æ¢ç¢¼',
                    category: product.category || 'æœªåˆ†é¡',
                    price: product.price || 0,
                    beginningStock,
                    purchases,
                    sales,
                    endingStock,
                    avgPrice,
                    salesAmount,
                    stockStatus: getStockStatusText(getStockStatus(endingStock, product.min_stock || 10))
                };
            });
            
            // æŒ‰éŠ·å”®é‡æ’åº
            const sortedData = inventoryData.sort((a, b) => b.sales - a.sales);
            
            // ç”ŸæˆCSVå…§å®¹
            const headers = ['å•†å“åç¨±', 'æ¢ç¢¼', 'åˆ†é¡', 'åƒ¹æ ¼', 'æœŸåˆåº«å­˜', 'é€²è²¨', 'éŠ·å”®', 'æœŸæœ«åº«å­˜', 'å¹³å‡å”®åƒ¹', 'éŠ·å”®é‡‘é¡', 'åº«å­˜ç‹€æ…‹'];
            const csvContent = [
                headers.join(','),
                ...sortedData.map(item => [
                    `"${item.name}"`,
                    `"${item.barcode}"`,
                    `"${item.category}"`,
                    item.price,
                    item.beginningStock,
                    item.purchases,
                    item.sales,
                    item.endingStock,
                    item.avgPrice,
                    item.salesAmount,
                    `"${item.stockStatus}"`
                ].join(','))
            ].join('\n');
            
            // ä¸‹è¼‰CSVæª”æ¡ˆ
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `é€²éŠ·å­˜æ˜ç´°å ±è¡¨_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('é€²éŠ·å­˜å ±è¡¨å·²åŒ¯å‡º', 'success');
        }

        // é¡¯ç¤ºåº«å­˜ç¯©é¸å™¨
        function showInventoryFilters() {
            const filterOptions = [
                { value: 'all', label: 'å…¨éƒ¨å•†å“' },
                { value: 'out_of_stock', label: 'ç¼ºè²¨å•†å“' },
                { value: 'low_stock', label: 'ä½åº«å­˜å•†å“' },
                { value: 'normal', label: 'åº«å­˜æ­£å¸¸' },
                { value: 'has_sales', label: 'æœ‰éŠ·å”®è¨˜éŒ„' },
                { value: 'no_sales', label: 'ç„¡éŠ·å”®è¨˜éŒ„' }
            ];
            
            const filter = prompt(
                'è«‹é¸æ“‡ç¯©é¸æ¢ä»¶ï¼š\n\n' +
                filterOptions.map((option, index) => `${index + 1}. ${option.label}`).join('\n') +
                '\n\nè«‹è¼¸å…¥æ•¸å­— (1-6)ï¼š'
            );
            
            if (filter && !isNaN(filter) && filter >= 1 && filter <= 6) {
                const selectedFilter = filterOptions[parseInt(filter) - 1].value;
                applyInventoryFilter(selectedFilter);
            }
        }

        // å¥—ç”¨åº«å­˜ç¯©é¸å™¨
        function applyInventoryFilter(filter) {
            const tableBody = document.querySelector('#inventoryTable tbody');
            if (!tableBody) return;
            
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const stockStatus = row.querySelector('.w-2.h-2.rounded-full').className;
                const sales = parseInt(row.querySelector('td:nth-child(4)').textContent.replace('-', ''));
                
                let show = true;
                
                switch (filter) {
                    case 'out_of_stock':
                        show = stockStatus.includes('bg-red-500');
                        break;
                    case 'low_stock':
                        show = stockStatus.includes('bg-[#17225e]');
                        break;
                    case 'normal':
                        show = stockStatus.includes('bg-green-500');
                        break;
                    case 'has_sales':
                        show = sales > 0;
                        break;
                    case 'no_sales':
                        show = sales === 0;
                        break;
                    default:
                        show = true;
                }
                
                row.style.display = show ? '' : 'none';
            });
            
            showNotification(`å·²ç¯©é¸ï¼š${getFilterLabel(filter)}`, 'info');
        }

        // ç²å–ç¯©é¸æ¨™ç±¤
        function getFilterLabel(filter) {
            const labels = {
                'all': 'å…¨éƒ¨å•†å“',
                'out_of_stock': 'ç¼ºè²¨å•†å“',
                'low_stock': 'ä½åº«å­˜å•†å“',
                'normal': 'åº«å­˜æ­£å¸¸',
                'has_sales': 'æœ‰éŠ·å”®è¨˜éŒ„',
                'no_sales': 'ç„¡éŠ·å”®è¨˜éŒ„'
            };
            return labels[filter] || 'å…¨éƒ¨å•†å“';
        }

        // æ›´æ–°ç†±éŠ·å•†å“
        async function updateTopProducts() {
            const productSales = calculateProductSales();
            const topProducts = productSales.slice(0, 3);
            
            const container = document.querySelector('#topProducts');
            if (!container) return;
            
            // ç²å–åˆ†é¡æ•¸æ“š
            let categories = [];
            try {
                categories = await BusinessAPI.getCategories();
            } catch (error) {
                console.error('ç²å–åˆ†é¡æ•¸æ“šå¤±æ•—:', error);
            }
            

            
            container.innerHTML = '';
            
            for (const product of topProducts) {
                const index = topProducts.indexOf(product);
                const rankColors = ['bg-[#17225e]', 'bg-gray-400', 'bg-[#17225e]'];
                const rankColor = rankColors[index] || 'bg-gray-400';
                
                // è™•ç†åˆ†é¡åç¨±
                let categoryName = product.category;
                if (product.category_id && categories.length > 0) {
                    const categoryObj = categories.find(cat => cat.id === product.category_id);
                    if (categoryObj) {
                        categoryName = categoryObj.name;
                    }
                }
                
                // è™•ç†å•†å“åœ–ç‰‡ - å¾åŸå§‹å•†å“æ•¸æ“šç²å–
                const originalProduct = productsData.find(p => p.id === product.id);
                let imageUrl = originalProduct ? originalProduct.image_url : product.image_url;
                
                if (!imageUrl || imageUrl === '') {
                    // æ ¹æ“šåˆ†é¡è¨­ç½®é è¨­åœ–ç‰‡ - ä½¿ç”¨æ­æ´²å®¶å±…/æ³¢è˜­é™¶é£Ÿå™¨ç›¸é—œåœ–ç‰‡
                    if (categoryName.includes('é¤å…·')) {
                        imageUrl = 'https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=32&h=32&fit=crop&crop=center';
                    } else if (categoryName.includes('æ“ºé£¾')) {
                        imageUrl = 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=32&h=32&fit=crop&crop=center';
                    } else if (categoryName.includes('å»šå…·')) {
                        imageUrl = 'https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=32&h=32&fit=crop&crop=center';
                    } else {
                        // ä½¿ç”¨æ­æ´²å®¶å±…é¢¨æ ¼çš„é è¨­åœ–ç‰‡
                        imageUrl = 'https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=32&h=32&fit=crop&crop=center';
                    }
                }
                
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="w-6 h-6 ${rankColor} text-white text-xs rounded-full flex items-center justify-center">${index + 1}</span>
                        <img src="${imageUrl}" 
                             class="w-8 h-8 rounded object-cover"
                             onerror="this.src='https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=32&h=32&fit=crop&crop=center'">
                        <div>
                            <span class="text-sm font-medium">${product.name}</span>
                            <p class="text-xs text-gray-500">${categoryName || 'æœªåˆ†é¡'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold text-[#17225e]">${product.salesCount} ä»¶</p>
                        <p class="text-xs text-gray-500">NT$${product.salesAmount.toLocaleString()}</p>
                    </div>
                `;
                
                container.appendChild(div);
            }
        }

        // æ›´æ–°ç†±éŠ·å•†å“ï¼ˆæ”¯æ´æ—¥æœŸç¯„åœï¼‰
        async function updateTopProductsWithDateRange(startDate, endDate) {
            const productSales = calculateProductSalesByDateRange(startDate, endDate);
            const topProducts = productSales.slice(0, 3);
            
            const container = document.querySelector('#topProducts');
            if (!container) return;
            
            // ç²å–åˆ†é¡æ•¸æ“š
            let categories = [];
            try {
                categories = await BusinessAPI.getCategories();
            } catch (error) {
                console.error('ç²å–åˆ†é¡æ•¸æ“šå¤±æ•—:', error);
            }
            
            container.innerHTML = '';
            
            for (const product of topProducts) {
                const index = topProducts.indexOf(product);
                const rankColors = ['bg-[#17225e]', 'bg-gray-400', 'bg-[#17225e]'];
                const rankColor = rankColors[index] || 'bg-gray-400';
                
                // è™•ç†åˆ†é¡åç¨±
                let categoryName = product.category;
                if (product.category_id && categories.length > 0) {
                    const categoryObj = categories.find(cat => cat.id === product.category_id);
                    if (categoryObj) {
                        categoryName = categoryObj.name;
                    }
                }
                
                // è™•ç†å•†å“åœ–ç‰‡ - å¾åŸå§‹å•†å“æ•¸æ“šç²å–
                const originalProduct = productsData.find(p => p.id === product.id);
                let imageUrl = originalProduct ? originalProduct.image_url : product.image_url;
                
                if (!imageUrl || imageUrl === '') {
                    // æ ¹æ“šåˆ†é¡è¨­ç½®é è¨­åœ–ç‰‡ - ä½¿ç”¨æ­æ´²å®¶å±…/æ³¢è˜­é™¶é£Ÿå™¨ç›¸é—œåœ–ç‰‡
                    if (categoryName.includes('é¤å…·')) {
                        imageUrl = 'https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=32&h=32&fit=crop&crop=center';
                    } else if (categoryName.includes('æ“ºé£¾')) {
                        imageUrl = 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=32&h=32&fit=crop&crop=center';
                    } else if (categoryName.includes('å»šå…·')) {
                        imageUrl = 'https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=32&h=32&fit=crop&crop=center';
                    } else {
                        // ä½¿ç”¨æ­æ´²å®¶å±…é¢¨æ ¼çš„é è¨­åœ–ç‰‡
                        imageUrl = 'https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=32&h=32&fit=crop&crop=center';
                    }
                }
                
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="w-6 h-6 ${rankColor} text-white text-xs rounded-full flex items-center justify-center">${index + 1}</span>
                        <img src="${imageUrl}" 
                             class="w-8 h-8 rounded object-cover"
                             onerror="this.src='https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=32&h=32&fit=crop&crop=center'">
                        <div>
                            <span class="text-sm font-medium">${product.name}</span>
                            <p class="text-xs text-gray-500">${categoryName || 'æœªåˆ†é¡'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold text-[#17225e]">${product.salesCount} ä»¶</p>
                        <p class="text-xs text-gray-500">NT$${product.salesAmount.toLocaleString()}</p>
                    </div>
                `;
                
                container.appendChild(div);
            }
        }

        // è¨ˆç®—å•†å“éŠ·å”®æ•¸æ“šï¼ˆæ”¯æ´æ—¥æœŸç¯„åœï¼‰
        function calculateProductSalesByDateRange(startDate, endDate) {
            const dateRangeData = getDataByDateRange(startDate, endDate);
            const productSalesMap = new Map();
            
            // è¨ˆç®—éŠ·å”®æ•¸æ“š
            dateRangeData.sales.forEach(sale => {
                let items = [];
                if (sale.items) {
                    if (typeof sale.items === 'string') {
                        try {
                            items = JSON.parse(sale.items);
                        } catch (e) {
                            console.error('è§£æéŠ·å”®é …ç›® JSON å¤±æ•—:', e);
                            items = [];
                        }
                    } else if (Array.isArray(sale.items)) {
                        items = sale.items;
                    }
                }
                
                items.forEach(item => {
                    // å˜—è©¦æ‰¾åˆ°å°æ‡‰çš„å•†å“
                    const product = productsData.find(p => 
                        p.id === item.product_id || 
                        p.barcode === item.barcode ||
                        p.name === item.name
                    );
                    
                    if (product) {
                        const category = product.category || 'æœªåˆ†é¡';
                        const category_id = product.category_id;
                        const image_url = product.image_url;
                        
                        if (!productSalesMap.has(product.id)) {
                            productSalesMap.set(product.id, {
                                id: product.id,
                                name: product.name,
                                category: category,
                                category_id: category_id,
                                image_url: image_url,
                                salesCount: 0,
                                salesAmount: 0
                            });
                        }
                        
                        const productSales = productSalesMap.get(product.id);
                        productSales.salesCount += item.quantity || 0;
                        productSales.salesAmount += item.total_price || (item.price * item.quantity) || 0;
                    }
                });
            });
            
            // æ‰£é™¤é€€è²¨æ•¸æ“š
            dateRangeData.refunds.forEach(refund => {
                // è™•ç†é€€è²¨è¨˜éŒ„
                if (refund.items) {
                    let refundItems = [];
                    if (typeof refund.items === 'string') {
                        try {
                            refundItems = JSON.parse(refund.items);
                        } catch (e) {
                            refundItems = [];
                        }
                    } else if (Array.isArray(refund.items)) {
                        refundItems = refund.items;
                    }
                    
                    refundItems.forEach(item => {
                        const product = productsData.find(p => 
                            p.id === item.product_id || 
                            p.barcode === item.barcode ||
                            p.name === item.name
                        );
                        
                        if (product && productSalesMap.has(product.id)) {
                            const productSales = productSalesMap.get(product.id);
                            const refundQuantity = item.quantity || refund.refund_quantity || 0;
                            const refundAmount = item.total_price || refund.refund_amount || 0;
                            
                            productSales.salesCount = Math.max(0, productSales.salesCount - refundQuantity);
                            productSales.salesAmount = Math.max(0, productSales.salesAmount - refundAmount);
                        }
                    });
                }
            });
            
            // è½‰æ›ç‚ºæ•¸çµ„ä¸¦æ’åº
            const productSalesArray = Array.from(productSalesMap.values())
                .filter(product => product.salesCount > 0)
                .sort((a, b) => b.salesCount - a.salesCount);
            
            return productSalesArray;
        }

        // è¨ˆç®—å•†å“éŠ·å”®æ•¸æ“šï¼ˆæœ¬æœˆï¼Œæ‰£é™¤é€€è²¨ï¼‰
        function calculateProductSales() {
            const currentMonthData = getCurrentMonthData();
            const productSalesMap = new Map();
            
            // è¨ˆç®—éŠ·å”®æ•¸æ“š
            currentMonthData.sales.forEach(sale => {
                let items = [];
                if (sale.items) {
                    if (typeof sale.items === 'string') {
                        try {
                            items = JSON.parse(sale.items);
                        } catch (e) {
                            console.error('è§£æéŠ·å”®é …ç›® JSON å¤±æ•—:', e);
                            items = [];
                        }
                    } else if (Array.isArray(sale.items)) {
                        items = sale.items;
                    }
                }
                
                items.forEach(item => {
                    // å˜—è©¦æ‰¾åˆ°å°æ‡‰çš„å•†å“
                    const product = productsData.find(p => 
                        p.id === item.product_id || 
                        p.barcode === item.barcode ||
                        p.name === item.name
                    );
                    
                    if (product) {
                        // ç²å–æ­£ç¢ºçš„åˆ†é¡ä¿¡æ¯
                        let category = product.category;
                        
                        // å¦‚æœæ²’æœ‰ category ä½†æœ‰ category_idï¼Œå¾ Supabase åˆ†é¡æ•¸æ“šä¸­æŸ¥æ‰¾
                        if (!category && product.category_id) {
                            // é€™è£¡éœ€è¦å…ˆç²å–åˆ†é¡æ•¸æ“šï¼Œä½†ç‚ºäº†é¿å…é‡è¤‡èª¿ç”¨ï¼Œæˆ‘å€‘å…ˆä½¿ç”¨é è¨­å€¼
                            // å¯¦éš›çš„åˆ†é¡åç¨±æœƒåœ¨ updateTopProducts ä¸­è™•ç†
                            category = `åˆ†é¡ID: ${product.category_id}`;
                        }
                        
                        // å¦‚æœä»ç„¶æ²’æœ‰åˆ†é¡ï¼Œä½¿ç”¨é è¨­åˆ†é¡
                        if (!category) {
                            category = 'å…¶ä»–';
                        }
                        
                        if (!productSalesMap.has(product.id)) {
                            productSalesMap.set(product.id, {
                                id: product.id,
                                name: product.name,
                                category: category,
                                category_id: product.category_id,
                                image_url: product.image_url || '',
                                salesCount: 0,
                                salesAmount: 0
                            });
                        }
                        
                        const productData = productSalesMap.get(product.id);
                        productData.salesCount += item.quantity || 0;
                        productData.salesAmount += (item.total_price || (item.price * item.quantity) || 0);
                    }
                });
            });
            
            // æ‰£é™¤é€€è²¨æ•¸æ“š
            currentMonthData.refunds.forEach(refund => {
                if (refund.sale_id) {
                    const sale = currentMonthData.sales.find(s => s.id === refund.sale_id);
                    if (sale && sale.items) {
                        let items = [];
                        if (typeof sale.items === 'string') {
                            try {
                                items = JSON.parse(sale.items);
                            } catch (e) {
                                items = [];
                            }
                        } else if (Array.isArray(sale.items)) {
                            items = sale.items;
                        }
                        
                        items.forEach(item => {
                            const product = productsData.find(p => 
                                p.id === item.product_id || 
                                p.barcode === item.barcode ||
                                p.name === item.name
                            );
                            
                            if (product && productSalesMap.has(product.id)) {
                                const productData = productSalesMap.get(product.id);
                                const refundQuantity = refund.refund_quantity || item.quantity;
                                productData.salesCount = Math.max(0, productData.salesCount - refundQuantity);
                                productData.salesAmount = Math.max(0, productData.salesAmount - (item.total_price || (item.price * refundQuantity)));
                            }
                        });
                    }
                }
            });
            
            return Array.from(productSalesMap.values())
                .filter(product => product.salesCount > 0) // åªé¡¯ç¤ºæœ‰éŠ·å”®çš„å•†å“
                .sort((a, b) => b.salesCount - a.salesCount);
        }

        // æ›´æ–°åº«å­˜é è­¦
        function updateInventoryAlerts() {
            const lowStockProducts = productsData.filter(product => 
                (product.stock || 0) <= 5 && (product.stock || 0) > 0
            );
            
            const outOfStockProducts = productsData.filter(product => 
                (product.stock || 0) <= 0
            );
            
            const container = document.querySelector('#inventoryAlerts');
            if (!container) return;
            
            container.innerHTML = '';
            
            // ä½åº«å­˜è­¦å‘Š
            lowStockProducts.slice(0, 3).forEach(product => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
                div.innerHTML = `
                    <span class="text-sm text-gray-800">${product.name}</span>
                    <span class="text-xs text-gray-600">ä½åº«å­˜ (${product.stock}ä»¶)</span>
                `;
                container.appendChild(div);
            });
            
            // ç¼ºè²¨è­¦å‘Š
            outOfStockProducts.slice(0, 2).forEach(product => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-red-50 rounded';
                div.innerHTML = `
                    <span class="text-sm text-red-800">${product.name}</span>
                    <span class="text-xs text-red-600">ç¼ºè²¨ (0ä»¶)</span>
                `;
                container.appendChild(div);
            });
        }

        // æ›´æ–°æœˆåº¦æ¯”è¼ƒ
        function updateMonthlyComparison() {
            const currentMonthData = getCurrentMonthData();
            const lastMonthData = getLastMonthData();
            
            // è¨ˆç®—æ·¨éŠ·å”®é¡ï¼ˆæ‰£é™¤é€€è²¨ï¼‰
            const currentMonthNetSales = currentMonthData.totalSales - 
                currentMonthData.refunds.reduce((sum, refund) => sum + (refund.refund_amount || 0), 0);
            
            const lastMonthNetSales = lastMonthData.totalSales - 
                lastMonthData.refunds.reduce((sum, refund) => sum + (refund.refund_amount || 0), 0);
            
            // æ›´æ–°æœ¬æœˆéŠ·å”®
            const currentMonthElement = document.getElementById('currentMonthSales');
            if (currentMonthElement) {
                currentMonthElement.textContent = `NT$${currentMonthNetSales.toLocaleString()}`;
            }
            
            // æ›´æ–°ä¸ŠæœˆéŠ·å”®
            const lastMonthElement = document.getElementById('lastMonthSales');
            if (lastMonthElement) {
                lastMonthElement.textContent = `NT$${lastMonthNetSales.toLocaleString()}`;
            }
            
            // è¨ˆç®—ä¸¦é¡¯ç¤ºå¢é•·ç‡
            const growthRate = calculateGrowthRate(currentMonthNetSales, lastMonthNetSales);
            const growthElement = document.getElementById('salesGrowth');
            if (growthElement) {
                updateGrowthDisplay('salesGrowth', growthRate, '%');
            }
        }

        // æ›´æ–°æœˆåº¦æ¯”è¼ƒï¼ˆæ”¯æ´æ—¥æœŸç¯„åœï¼‰
        function updateMonthlyComparisonWithDateRange(startDate, endDate) {
            const dateRangeData = getDataByDateRange(startDate, endDate);
            
            // è¨ˆç®—æ—¥æœŸç¯„åœå…§çš„æ·¨éŠ·å”®é¡ï¼ˆæ‰£é™¤é€€è²¨ï¼‰
            const dateRangeNetSales = dateRangeData.totalSales - 
                dateRangeData.refunds.reduce((sum, refund) => sum + (refund.refund_amount || 0), 0);
            
            // æ›´æ–°æ—¥æœŸç¯„åœéŠ·å”®
            const currentMonthElement = document.getElementById('currentMonthSales');
            if (currentMonthElement) {
                currentMonthElement.textContent = `NT$${dateRangeNetSales.toLocaleString()}`;
            }
            
            // æ›´æ–°æ¨™ç±¤é¡¯ç¤ºæ—¥æœŸç¯„åœ
            const lastMonthElement = document.getElementById('lastMonthSales');
            if (lastMonthElement) {
                lastMonthElement.textContent = `${startDate} è‡³ ${endDate}`;
            }
            
            // éš±è—å¢é•·ç‡é¡¯ç¤º
            const growthElement = document.getElementById('salesGrowth');
            if (growthElement) {
                growthElement.style.display = 'none';
            }
        }

        // ç²å–ä¸Šæœˆæ•¸æ“š
        function getLastMonthData() {
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            const startOfLastMonth = new Date(lastYear, lastMonth, 1);
            const endOfLastMonth = new Date(lastYear, lastMonth + 1, 0);
            
            const sales = salesData.filter(sale => {
                const saleDate = new Date(sale.created_at);
                return saleDate >= startOfLastMonth && saleDate <= endOfLastMonth;
            });
            
            const purchases = purchaseData.filter(purchase => {
                // è™•ç†ä¸åŒçš„æ—¥æœŸæ ¼å¼
                let purchaseDate;
                if (purchase.purchase_date) {
                    purchaseDate = new Date(purchase.purchase_date);
                } else if (purchase.created_at) {
                    purchaseDate = new Date(purchase.created_at);
                } else {
                    return false;
                }
                return purchaseDate >= startOfLastMonth && purchaseDate <= endOfLastMonth;
            });
            
            const refunds = refundData.filter(refund => {
                const refundDate = new Date(refund.refund_date);
                return refundDate >= startOfLastMonth && refundDate <= endOfLastMonth;
            });
            
            const totalSales = sales.reduce((sum, sale) => sum + (sale.total_amount || sale.total || 0), 0);
            
            return { sales, purchases, refunds, totalSales };
        }

        // è¨ˆç®—å¢é•·ç‡
        function calculateGrowthRate(current, previous) {
            if (previous === 0) return current > 0 ? 100 : 0;
            return ((current - previous) / previous * 100).toFixed(1);
        }

        // æ›´æ–°å¢é•·ç‡é¡¯ç¤º
        function updateGrowthDisplay(elementId, growthRate, unit) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const growth = parseFloat(growthRate);
            const icon = growth >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            const color = growth >= 0 ? 'text-[#17225e]' : 'text-red-500';
            
            element.innerHTML = `<i class="fas ${icon} mr-1"></i>${growth >= 0 ? '+' : ''}${growthRate}${unit} æ¯”ä¸Šæœˆ`;
            element.className = `text-xs ${color}`;
        }

        // è¨ˆç®—ä¸Šæœˆåº«å­˜é€±è½‰ç‡
        function calculateLastMonthInventoryTurnover() {
            const lastMonthData = getLastMonthData();
            const avgInventory = productsData.reduce((sum, product) => sum + (product.stock || 0), 0) / productsData.length;
            const salesCount = lastMonthData.sales.reduce((sum, sale) => {
                let items = [];
                if (sale.items) {
                    if (typeof sale.items === 'string') {
                        try {
                            items = JSON.parse(sale.items);
                        } catch (e) {
                            items = [];
                        }
                    } else if (Array.isArray(sale.items)) {
                        items = sale.items;
                    }
                }
                return sum + items.length;
            }, 0);
            
            return avgInventory > 0 ? salesCount / avgInventory : 0;
        }

        // è¨­ç½®åœ–è¡¨
        function setupCharts() {
            setupTrendChart();
            setupCategoryChart();
        }

        // è¨­ç½®è¶¨å‹¢åœ–
        function setupTrendChart() {
            const trendCtx = document.getElementById('trendChart');
            if (!trendCtx) return;
            
            const chartData = getChartData();
            
            new Chart(trendCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'éŠ·å”®é¡',
                        data: chartData.sales,
                        borderColor: '#17225e',
                        backgroundColor: 'rgba(23, 34, 94, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'é€²è²¨é¡',
                        data: chartData.purchases,
                        borderColor: '#dc2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // ç²å–åœ–è¡¨æ•¸æ“š
        function getChartData() {
            const labels = [];
            const sales = [];
            const purchases = [];
            
            // ç”Ÿæˆæœ€è¿‘6å¤©çš„æ•¸æ“š
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(`${date.getMonth() + 1}/${date.getDate()}`);
                
                const daySales = salesData.filter(sale => {
                    const saleDate = new Date(sale.created_at);
                    return saleDate.toDateString() === date.toDateString();
                });
                
                const dayPurchases = purchaseData.filter(purchase => {
                    const purchaseDate = new Date(purchase.purchase_date);
                    return purchaseDate.toDateString() === date.toDateString();
                });
                
                sales.push(daySales.reduce((sum, sale) => sum + (sale.total_amount || sale.total || 0), 0));
                purchases.push(dayPurchases.reduce((sum, purchase) => sum + (purchase.total_cost || 0), 0));
            }
            
            return { labels, sales, purchases };
        }

        // è¨­ç½®åˆ†é¡éŠ·å”®å æ¯”åœ–
        async function setupCategoryChart() {
            const categoryCtx = document.getElementById('categoryChart');
            if (!categoryCtx) return;
            
            const categoryData = await getCategoryData();
            
            // å¦‚æœæ²’æœ‰æ•¸æ“šï¼Œé¡¯ç¤ºç©ºç‹€æ…‹
            if (categoryData.values.length === 0) {
                categoryCtx.style.display = 'none';
                const container = categoryCtx.parentElement;
                if (container) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-chart-pie text-4xl mb-2"></i>
                            <p>æœ¬æœˆç„¡éŠ·å”®æ•¸æ“š</p>
                        </div>
                    `;
                }
                return;
            }
            
            new Chart(categoryCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: categoryData.labels,
                    datasets: [{
                        data: categoryData.values,
                        backgroundColor: [
                            '#17225e',
                            '#6b7280',
                            '#9ca3af',
                            '#d1d5db',
                            '#e5e7eb',
                            '#f3f4f6'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const detail = categoryData.details[context.dataIndex];
                                    return [
                                        `åˆ†é¡: ${detail.category}`,
                                        `éŠ·å”®æ•¸é‡: ${detail.quantity} ä»¶`,
                                        `éŠ·å”®é‡‘é¡: NT$${detail.amount.toLocaleString()}`,
                                        `å æ¯”: ${detail.percentage}%`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
            
            // æ›´æ–°åˆ†é¡éŠ·å”®è©³æƒ…
            updateCategoryDetails(categoryData.details);
        }

        // è¨­ç½®åˆ†é¡éŠ·å”®å æ¯”åœ–ï¼ˆæ”¯æ´æ—¥æœŸç¯„åœï¼‰
        async function setupCategoryChartWithDateRange(startDate, endDate) {
            const categoryCtx = document.getElementById('categoryChart');
            if (!categoryCtx) return;
            
            const categoryData = await getCategoryDataByDateRange(startDate, endDate);
            
            // å¦‚æœæ²’æœ‰æ•¸æ“šï¼Œé¡¯ç¤ºç©ºç‹€æ…‹
            if (categoryData.values.length === 0) {
                categoryCtx.style.display = 'none';
                const container = categoryCtx.parentElement;
                if (container) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-chart-pie text-4xl mb-2"></i>
                            <p>${startDate} è‡³ ${endDate} ç„¡éŠ·å”®æ•¸æ“š</p>
                        </div>
                    `;
                }
                return;
            }
            
            new Chart(categoryCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: categoryData.labels,
                    datasets: [{
                        data: categoryData.values,
                        backgroundColor: [
                            '#17225e',
                            '#6b7280',
                            '#9ca3af',
                            '#d1d5db',
                            '#e5e7eb',
                            '#f3f4f6'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const detail = categoryData.details[context.dataIndex];
                                    return [
                                        `åˆ†é¡: ${detail.category}`,
                                        `éŠ·å”®æ•¸é‡: ${detail.quantity} ä»¶`,
                                        `éŠ·å”®é‡‘é¡: NT$${detail.amount.toLocaleString()}`,
                                        `å æ¯”: ${detail.percentage}%`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
            
            // æ›´æ–°åˆ†é¡éŠ·å”®è©³æƒ…
            updateCategoryDetailsWithDateRange(categoryData.details, startDate, endDate);
        }

        // æ›´æ–°åˆ†é¡éŠ·å”®è©³æƒ…ï¼ˆæ”¯æ´æ—¥æœŸç¯„åœï¼‰
        function updateCategoryDetailsWithDateRange(categoryDetails, startDate, endDate) {
            const container = document.getElementById('categoryDetails');
            if (!container) return;
            
            if (categoryDetails.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center">${startDate} è‡³ ${endDate} ç„¡éŠ·å”®æ•¸æ“š</p>`;
                return;
            }
            
            let detailsHtml = '';
            categoryDetails.forEach((detail, index) => {
                const rankColors = ['bg-[#17225e]', 'bg-gray-400', 'bg-[#17225e]', 'bg-gray-400', 'bg-[#17225e]'];
                const rankColor = rankColors[index] || 'bg-gray-400';
                
                detailsHtml += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-2">
                        <div class="flex items-center space-x-3">
                            <span class="w-6 h-6 ${rankColor} text-white text-xs rounded-full flex items-center justify-center">${index + 1}</span>
                            <div>
                                <span class="text-sm font-medium text-gray-800">${detail.category}</span>
                                <p class="text-xs text-gray-500">${detail.quantity} ä»¶</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-semibold text-[#17225e]">NT$${detail.amount.toLocaleString()}</p>
                            <p class="text-xs text-gray-500">${detail.percentage}%</p>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = detailsHtml;
        }

        // æ›´æ–°åˆ†é¡éŠ·å”®è©³æƒ…
        function updateCategoryDetails(categoryDetails) {
            const container = document.getElementById('categoryDetails');
            if (!container) return;
            
            if (categoryDetails.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">æœ¬æœˆç„¡éŠ·å”®æ•¸æ“š</p>';
                return;
            }
            
            let detailsHtml = '';
            categoryDetails.forEach((detail, index) => {
                const rankColors = ['bg-[#17225e]', 'bg-gray-400', 'bg-[#17225e]', 'bg-gray-400', 'bg-[#17225e]'];
                const rankColor = rankColors[index] || 'bg-gray-400';
                
                detailsHtml += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-2">
                        <div class="flex items-center space-x-3">
                            <span class="w-6 h-6 ${rankColor} text-white text-xs rounded-full flex items-center justify-center">${index + 1}</span>
                            <div>
                                <span class="text-sm font-medium text-gray-800">${detail.category}</span>
                                <p class="text-xs text-gray-500">${detail.quantity} ä»¶</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-semibold text-[#17225e]">NT$${detail.amount.toLocaleString()}</p>
                            <p class="text-xs text-gray-500">${detail.percentage}%</p>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = detailsHtml;
        }

        // æ ¹æ“šåˆ†é¡IDç²å–åˆ†é¡åç¨±
        async function getCategoryNameById(categoryId) {
            try {
                // å¾ Supabase ç²å–çœŸå¯¦çš„åˆ†é¡æ•¸æ“š
                const categories = await BusinessAPI.getCategories();
                const category = categories.find(cat => cat.id === categoryId);
                return category ? category.name : 'å…¶ä»–';
            } catch (error) {
                console.error('ç²å–åˆ†é¡æ•¸æ“šå¤±æ•—:', error);
                return 'å…¶ä»–';
            }
        }

        // ç²å–åˆ†é¡éŠ·å”®å æ¯”æ•¸æ“šï¼ˆæœ¬æœˆï¼Œæ‰£é™¤é€€è²¨ï¼‰
        async function getCategoryData() {
            const currentMonthData = getCurrentMonthData();
            const categoryMap = new Map();
            
            console.log('=== åˆ†é¡éŠ·å”®æ•¸æ“šè¨ˆç®— ===');
            console.log('æœ¬æœˆéŠ·å”®è¨˜éŒ„æ•¸:', currentMonthData.sales.length);
            console.log('å•†å“æ•¸æ“šç¸½æ•¸:', productsData.length);
            
            // å…ˆç²å–æ‰€æœ‰åˆ†é¡æ•¸æ“š
            let categories = [];
            try {
                categories = await BusinessAPI.getCategories();
                console.log('ç²å–åˆ°çš„åˆ†é¡æ•¸æ“š:', categories);
            } catch (error) {
                console.error('ç²å–åˆ†é¡æ•¸æ“šå¤±æ•—:', error);
            }
            
            // è¨ˆç®—éŠ·å”®æ•¸æ“š
            for (const sale of currentMonthData.sales) {
                let items = [];
                if (sale.items) {
                    if (typeof sale.items === 'string') {
                        try {
                            items = JSON.parse(sale.items);
                        } catch (e) {
                            console.error('è§£æéŠ·å”®é …ç›® JSON å¤±æ•—:', e);
                            items = [];
                        }
                    } else if (Array.isArray(sale.items)) {
                        items = sale.items;
                    }
                }
                
                console.log(`éŠ·å”®è¨˜éŒ„é …ç›®:`, items);
                
                for (const item of items) {
                    console.log(`é …ç›®:`, item);
                    
                    // å˜—è©¦æ‰¾åˆ°å°æ‡‰çš„å•†å“
                    const product = productsData.find(p => 
                        p.id === item.product_id || 
                        p.barcode === item.barcode ||
                        p.name === item.name
                    );
                    
                    console.log(`æ‰¾åˆ°å•†å“:`, product);
                    
                    if (product) {
                        // æª¢æŸ¥åˆ†é¡ä¿¡æ¯
                        let category = product.category;
                        
                        // å¦‚æœæ²’æœ‰ category ä½†æœ‰ category_idï¼Œå¾ Supabase åˆ†é¡æ•¸æ“šä¸­æŸ¥æ‰¾
                        if (!category && product.category_id) {
                            const categoryObj = categories.find(cat => cat.id === product.category_id);
                            category = categoryObj ? categoryObj.name : 'å…¶ä»–';
                            console.log(`æ ¹æ“š category_id ${product.category_id} æ‰¾åˆ°åˆ†é¡:`, category);
                        }
                        
                        // å¦‚æœä»ç„¶æ²’æœ‰åˆ†é¡ï¼Œä½¿ç”¨é è¨­åˆ†é¡
                        if (!category) {
                            category = 'å…¶ä»–';
                        }
                        
                        const currentData = categoryMap.get(category) || { quantity: 0, amount: 0 };
                        currentData.quantity += item.quantity || 0;
                        currentData.amount += (item.total_price || (item.price * item.quantity) || 0);
                        categoryMap.set(category, currentData);
                        console.log(`æ›´æ–°åˆ†é¡ ${category}:`, currentData);
                    } else {
                        console.log(`å•†å“æœªæ‰¾åˆ°:`, item.name);
                    }
                }
            }
            
            // æ‰£é™¤é€€è²¨æ•¸æ“š
            console.log('=== è™•ç†é€€è²¨æ•¸æ“š ===');
            console.log('æœ¬æœˆé€€è²¨è¨˜éŒ„æ•¸:', currentMonthData.refunds.length);
            
            for (const refund of currentMonthData.refunds) {
                console.log('è™•ç†é€€è²¨è¨˜éŒ„:', refund);
                
                // è™•ç†é€€è²¨é …ç›®
                let refundItems = [];
                
                // å¦‚æœé€€è²¨è¨˜éŒ„æœ‰ items æ¬„ä½
                if (refund.items) {
                    if (typeof refund.items === 'string') {
                        try {
                            refundItems = JSON.parse(refund.items);
                        } catch (e) {
                            console.error('è§£æé€€è²¨é …ç›® JSON å¤±æ•—:', e);
                            refundItems = [];
                        }
                    } else if (Array.isArray(refund.items)) {
                        refundItems = refund.items;
                    }
                }
                // å¦‚æœæ²’æœ‰ items ä½†æœ‰ sale_idï¼Œå¾åŸéŠ·å”®è¨˜éŒ„ç²å–
                else if (refund.sale_id) {
                    const sale = currentMonthData.sales.find(s => s.id === refund.sale_id);
                    if (sale && sale.items) {
                        if (typeof sale.items === 'string') {
                            try {
                                refundItems = JSON.parse(sale.items);
                            } catch (e) {
                                refundItems = [];
                            }
                        } else if (Array.isArray(sale.items)) {
                            refundItems = sale.items;
                        }
                    }
                }
                // å¦‚æœåªæœ‰å–®ä¸€å•†å“ä¿¡æ¯
                else if (refund.product_id || refund.product_name) {
                    refundItems = [{
                        product_id: refund.product_id,
                        name: refund.product_name,
                        quantity: refund.refund_quantity || refund.quantity || 1,
                        price: refund.refund_price || refund.price || 0,
                        total_price: refund.refund_amount || refund.amount || 0
                    }];
                }
                
                console.log('é€€è²¨é …ç›®:', refundItems);
                
                for (const item of refundItems) {
                    const product = productsData.find(p => 
                        p.id === item.product_id || 
                        p.barcode === item.barcode ||
                        p.name === item.name
                    );
                    
                    if (product) {
                        // æª¢æŸ¥åˆ†é¡ä¿¡æ¯
                        let category = product.category;
                        
                        // å¦‚æœæ²’æœ‰ category ä½†æœ‰ category_idï¼Œå¾ Supabase åˆ†é¡æ•¸æ“šä¸­æŸ¥æ‰¾
                        if (!category && product.category_id) {
                            const categoryObj = categories.find(cat => cat.id === product.category_id);
                            category = categoryObj ? categoryObj.name : 'å…¶ä»–';
                        }
                        
                        // å¦‚æœä»ç„¶æ²’æœ‰åˆ†é¡ï¼Œä½¿ç”¨é è¨­åˆ†é¡
                        if (!category) {
                            category = 'å…¶ä»–';
                        }
                        
                        if (categoryMap.has(category)) {
                            const currentData = categoryMap.get(category);
                            const refundQuantity = item.quantity || refund.refund_quantity || 1;
                            const refundAmount = item.total_price || (item.price * refundQuantity) || refund.refund_amount || 0;
                            
                            currentData.quantity = Math.max(0, currentData.quantity - refundQuantity);
                            currentData.amount = Math.max(0, currentData.amount - refundAmount);
                            categoryMap.set(category, currentData);
                            
                            console.log(`æ‰£é™¤é€€è²¨ - åˆ†é¡ ${category}: æ•¸é‡ -${refundQuantity}, é‡‘é¡ -${refundAmount}`);
                            console.log(`æ›´æ–°å¾Œåˆ†é¡ ${category}:`, currentData);
                        }
                    }
                }
            }
            
            // æŒ‰éŠ·å”®é‡‘é¡æ’åºï¼Œå–å‰5å€‹åˆ†é¡
            const sortedCategories = Array.from(categoryMap.entries())
                .filter(([, data]) => data.amount > 0) // åªé¡¯ç¤ºæœ‰éŠ·å”®çš„åˆ†é¡
                .sort((a, b) => b[1].amount - a[1].amount)
                .slice(0, 5);
            
            // è¨ˆç®—ç¸½éŠ·å”®é‡‘é¡
            const totalAmount = sortedCategories.reduce((sum, [, data]) => sum + data.amount, 0);
            
            return {
                labels: sortedCategories.map(([category, data]) => 
                    `${category} (${((data.amount / totalAmount) * 100).toFixed(1)}%)`
                ),
                values: sortedCategories.map(([, data]) => data.amount),
                details: sortedCategories.map(([category, data]) => ({
                    category,
                    quantity: data.quantity,
                    amount: data.amount,
                    percentage: totalAmount > 0 ? ((data.amount / totalAmount) * 100).toFixed(1) : 0
                }))
            };
        }

        // ç²å–åˆ†é¡éŠ·å”®å æ¯”æ•¸æ“šï¼ˆæ”¯æ´æ—¥æœŸç¯„åœï¼‰
        async function getCategoryDataByDateRange(startDate, endDate) {
            const dateRangeData = getDataByDateRange(startDate, endDate);
            const categoryMap = new Map();
            
            console.log('=== åˆ†é¡éŠ·å”®æ•¸æ“šè¨ˆç®—ï¼ˆæ—¥æœŸç¯„åœï¼‰ ===');
            console.log('æ—¥æœŸç¯„åœéŠ·å”®è¨˜éŒ„æ•¸:', dateRangeData.sales.length);
            console.log('å•†å“æ•¸æ“šç¸½æ•¸:', productsData.length);
            
            // å…ˆç²å–æ‰€æœ‰åˆ†é¡æ•¸æ“š
            let categories = [];
            try {
                categories = await BusinessAPI.getCategories();
                console.log('ç²å–åˆ°çš„åˆ†é¡æ•¸æ“š:', categories);
            } catch (error) {
                console.error('ç²å–åˆ†é¡æ•¸æ“šå¤±æ•—:', error);
            }
            
            // è¨ˆç®—éŠ·å”®æ•¸æ“š
            for (const sale of dateRangeData.sales) {
                let items = [];
                if (sale.items) {
                    if (typeof sale.items === 'string') {
                        try {
                            items = JSON.parse(sale.items);
                        } catch (e) {
                            console.error('è§£æéŠ·å”®é …ç›® JSON å¤±æ•—:', e);
                            items = [];
                        }
                    } else if (Array.isArray(sale.items)) {
                        items = sale.items;
                    }
                }
                
                for (const item of items) {
                    // å˜—è©¦æ‰¾åˆ°å°æ‡‰çš„å•†å“
                    const product = productsData.find(p => 
                        p.id === item.product_id || 
                        p.barcode === item.barcode ||
                        p.name === item.name
                    );
                    
                    if (product) {
                        // æª¢æŸ¥åˆ†é¡ä¿¡æ¯
                        let category = product.category;
                        
                        // å¦‚æœæ²’æœ‰ category ä½†æœ‰ category_idï¼Œå¾ Supabase åˆ†é¡æ•¸æ“šä¸­æŸ¥æ‰¾
                        if (!category && product.category_id) {
                            const categoryObj = categories.find(cat => cat.id === product.category_id);
                            category = categoryObj ? categoryObj.name : 'å…¶ä»–';
                        }
                        
                        // å¦‚æœä»ç„¶æ²’æœ‰åˆ†é¡ï¼Œä½¿ç”¨é è¨­åˆ†é¡
                        if (!category) {
                            category = 'å…¶ä»–';
                        }
                        
                        const currentData = categoryMap.get(category) || { quantity: 0, amount: 0 };
                        currentData.quantity += item.quantity || 0;
                        currentData.amount += (item.total_price || (item.price * item.quantity) || 0);
                        categoryMap.set(category, currentData);
                    }
                }
            }
            
            // æ‰£é™¤é€€è²¨æ•¸æ“š
            for (const refund of dateRangeData.refunds) {
                // è™•ç†é€€è²¨é …ç›®
                let refundItems = [];
                
                // å¦‚æœé€€è²¨è¨˜éŒ„æœ‰ items æ¬„ä½
                if (refund.items) {
                    if (typeof refund.items === 'string') {
                        try {
                            refundItems = JSON.parse(refund.items);
                        } catch (e) {
                            console.error('è§£æé€€è²¨é …ç›® JSON å¤±æ•—:', e);
                            refundItems = [];
                        }
                    } else if (Array.isArray(refund.items)) {
                        refundItems = refund.items;
                    }
                }
                // å¦‚æœæ²’æœ‰ items ä½†æœ‰ sale_idï¼Œå¾åŸéŠ·å”®è¨˜éŒ„ç²å–
                else if (refund.sale_id) {
                    const sale = dateRangeData.sales.find(s => s.id === refund.sale_id);
                    if (sale && sale.items) {
                        if (typeof sale.items === 'string') {
                            try {
                                refundItems = JSON.parse(sale.items);
                            } catch (e) {
                                refundItems = [];
                            }
                        } else if (Array.isArray(sale.items)) {
                            refundItems = sale.items;
                        }
                    }
                }
                // å¦‚æœåªæœ‰å–®ä¸€å•†å“ä¿¡æ¯
                else if (refund.product_id || refund.product_name) {
                    refundItems = [{
                        product_id: refund.product_id,
                        name: refund.product_name,
                        quantity: refund.refund_quantity || refund.quantity || 1,
                        price: refund.refund_price || refund.price || 0,
                        total_price: refund.refund_amount || refund.amount || 0
                    }];
                }
                
                for (const item of refundItems) {
                    const product = productsData.find(p => 
                        p.id === item.product_id || 
                        p.barcode === item.barcode ||
                        p.name === item.name
                    );
                    
                    if (product) {
                        // æª¢æŸ¥åˆ†é¡ä¿¡æ¯
                        let category = product.category;
                        
                        // å¦‚æœæ²’æœ‰ category ä½†æœ‰ category_idï¼Œå¾ Supabase åˆ†é¡æ•¸æ“šä¸­æŸ¥æ‰¾
                        if (!category && product.category_id) {
                            const categoryObj = categories.find(cat => cat.id === product.category_id);
                            category = categoryObj ? categoryObj.name : 'å…¶ä»–';
                        }
                        
                        // å¦‚æœä»ç„¶æ²’æœ‰åˆ†é¡ï¼Œä½¿ç”¨é è¨­åˆ†é¡
                        if (!category) {
                            category = 'å…¶ä»–';
                        }
                        
                        if (categoryMap.has(category)) {
                            const currentData = categoryMap.get(category);
                            const refundQuantity = item.quantity || refund.refund_quantity || 1;
                            const refundAmount = item.total_price || (item.price * refundQuantity) || refund.refund_amount || 0;
                            
                            currentData.quantity = Math.max(0, currentData.quantity - refundQuantity);
                            currentData.amount = Math.max(0, currentData.amount - refundAmount);
                            categoryMap.set(category, currentData);
                        }
                    }
                }
            }
            
            // æŒ‰éŠ·å”®é‡‘é¡æ’åºï¼Œå–å‰5å€‹åˆ†é¡
            const sortedCategories = Array.from(categoryMap.entries())
                .filter(([, data]) => data.amount > 0) // åªé¡¯ç¤ºæœ‰éŠ·å”®çš„åˆ†é¡
                .sort((a, b) => b[1].amount - a[1].amount)
                .slice(0, 5);
            
            // è¨ˆç®—ç¸½éŠ·å”®é‡‘é¡
            const totalAmount = sortedCategories.reduce((sum, [, data]) => sum + data.amount, 0);
            
            return {
                labels: sortedCategories.map(([category, data]) => 
                    `${category} (${((data.amount / totalAmount) * 100).toFixed(1)}%)`
                ),
                values: sortedCategories.map(([, data]) => data.amount),
                details: sortedCategories.map(([category, data]) => ({
                    category,
                    quantity: data.quantity,
                    amount: data.amount,
                    percentage: totalAmount > 0 ? ((data.amount / totalAmount) * 100).toFixed(1) : 0
                }))
            };
        }

        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const alertClass = {
                'success': 'bg-gray-100 border-[#17225e] text-gray-700',
                'error': 'bg-red-100 border-red-500 text-red-700',
                'warning': 'bg-gray-100 border-gray-500 text-gray-700',
                'info': 'bg-gray-100 border-[#17225e] text-gray-700'
            }[type];

            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg border ${alertClass} z-50`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // å•†å“æŸ¥è©¢åŠŸèƒ½
        async function quickProductReport() {
            const searchInput = prompt('è«‹è¼¸å…¥å•†å“æ¢ç¢¼ã€å•†å“åç¨±æˆ–å•†å“IDï¼š');
            if (!searchInput) return;
            
            // æœå°‹å•†å“ï¼ˆæ”¯æ´æ¢ç¢¼ã€åç¨±ã€IDï¼‰
            const product = productsData.find(p => 
                p.barcode === searchInput || 
                p.name === searchInput || 
                p.id.toString() === searchInput
            );
            
            if (!product) {
                alert(`æ‰¾ä¸åˆ°å•†å“ï¼š${searchInput}\n\nè«‹ç¢ºèªï¼š\n- æ¢ç¢¼æ˜¯å¦æ­£ç¢º\n- å•†å“åç¨±æ˜¯å¦å®Œæ•´\n- å•†å“IDæ˜¯å¦æ­£ç¢º`);
                return;
            }
            
            const productSales = getProductSalesData(product.id);
            await showProductReport(product, productSales);
        }

        // ç²å–å•†å“éŠ·å”®æ•¸æ“š
        function getProductSalesData(productId) {
            const product = productsData.find(p => p.id === productId);
            if (!product) return { salesCount: 0, totalQuantity: 0, totalAmount: 0, averagePrice: 0 };
            
            const sales = salesData.filter(sale => {
                let items = [];
                if (sale.items) {
                    if (typeof sale.items === 'string') {
                        try {
                            items = JSON.parse(sale.items);
                        } catch (e) {
                            items = [];
                        }
                    } else if (Array.isArray(sale.items)) {
                        items = sale.items;
                    }
                }
                
                return items.some(item => 
                    item.product_id === productId || 
                    item.barcode === product.barcode ||
                    item.name === product.name
                );
            });
            
            let totalQuantity = 0;
            let totalAmount = 0;
            
            sales.forEach(sale => {
                let items = [];
                if (sale.items) {
                    if (typeof sale.items === 'string') {
                        try {
                            items = JSON.parse(sale.items);
                        } catch (e) {
                            items = [];
                        }
                    } else if (Array.isArray(sale.items)) {
                        items = sale.items;
                    }
                }
                
                const item = items.find(item => 
                    item.product_id === productId || 
                    item.barcode === product.barcode ||
                    item.name === product.name
                );
                
                if (item) {
                    totalQuantity += item.quantity || 0;
                    totalAmount += (item.total_price || (item.price * item.quantity) || 0);
                }
            });
            
            return {
                salesCount: sales.length,
                totalQuantity,
                totalAmount,
                averagePrice: totalQuantity > 0 ? totalAmount / totalQuantity : 0
            };
        }

        // é¡¯ç¤ºå•†å“å ±è¡¨
        async function showProductReport(product, salesData) {
            // ç²å–åˆ†é¡æ•¸æ“š
            let categories = [];
            try {
                categories = await BusinessAPI.getCategories();
            } catch (error) {
                console.error('ç²å–åˆ†é¡æ•¸æ“šå¤±æ•—:', error);
            }
            
            // è™•ç†åˆ†é¡åç¨±
            let categoryName = product.category;
            if (!categoryName && product.category_id && categories.length > 0) {
                const categoryObj = categories.find(cat => cat.id === product.category_id);
                if (categoryObj) {
                    categoryName = categoryObj.name;
                }
            }
            if (!categoryName) {
                categoryName = 'æœªåˆ†é¡';
            }
            
            // è¨ˆç®—æœ¬æœˆéŠ·å”®æ•¸æ“š
            const currentMonthData = getCurrentMonthData();
            const currentMonthSales = currentMonthData.sales.filter(sale => {
                let items = [];
                if (sale.items) {
                    if (typeof sale.items === 'string') {
                        try {
                            items = JSON.parse(sale.items);
                        } catch (e) {
                            items = [];
                        }
                    } else if (Array.isArray(sale.items)) {
                        items = sale.items;
                    }
                }
                
                return items.some(item => 
                    item.product_id === product.id || 
                    item.barcode === product.barcode ||
                    item.name === product.name
                );
            });
            
            // è¨ˆç®—æœ¬æœˆé€€è²¨æ•¸æ“š
            const currentMonthRefunds = currentMonthData.refunds.filter(refund => {
                return refund.product_id === product.id || 
                       (refund.items && JSON.parse(refund.items).some(item => 
                           item.product_id === product.id || 
                           item.barcode === product.barcode ||
                           item.name === product.name
                       ));
            });
            
            const report = `
ğŸ“Š å•†å“éŠ·å”®å ±è¡¨

å•†å“è³‡è¨Šï¼š
å•†å“åç¨±ï¼š${product.name}
å•†å“åˆ†é¡ï¼š${categoryName}
å•†å“IDï¼š${product.id}
æ¢ç¢¼ï¼š${product.barcode || 'ç„¡'}
å–®åƒ¹ï¼šNT$${product.price?.toLocaleString() || '0'}
ç•¶å‰åº«å­˜ï¼š${product.stock || 0} ä»¶

ğŸ“ˆ ç¸½éŠ·å”®æ•¸æ“šï¼š
ç¸½éŠ·å”®æ¬¡æ•¸ï¼š${salesData.salesCount} æ¬¡
ç¸½éŠ·å”®æ•¸é‡ï¼š${salesData.totalQuantity} ä»¶
ç¸½éŠ·å”®é‡‘é¡ï¼šNT$${salesData.totalAmount.toLocaleString()}
å¹³å‡å”®åƒ¹ï¼šNT$${salesData.averagePrice.toLocaleString()}

ğŸ“… æœ¬æœˆæ•¸æ“šï¼š
æœ¬æœˆéŠ·å”®æ¬¡æ•¸ï¼š${currentMonthSales.length} æ¬¡
æœ¬æœˆé€€è²¨æ¬¡æ•¸ï¼š${currentMonthRefunds.length} æ¬¡
æœ¬æœˆæ·¨éŠ·å”®ï¼š${salesData.salesCount > 0 ? 'âœ… æœ‰éŠ·å”®è¨˜éŒ„' : 'âŒ ç„¡éŠ·å”®è¨˜éŒ„'}

ğŸ’¡ åº«å­˜å»ºè­°ï¼š
${product.stock <= 0 ? 'ğŸ”´ ç¼ºè²¨ - å»ºè­°é€²è²¨' : 
  product.stock <= 5 ? 'ğŸŸ¡ åº«å­˜åä½ - æ³¨æ„è£œè²¨' : 
  'ğŸŸ¢ åº«å­˜å……è¶³'}
            `;
            
            alert(report);
        }



        // çµ±ä¸€å°èˆªå‡½æ•¸
        function navigateToPage(page) {
            try {
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'navigate',
                        page: page
                    }, '*');
                } else {
                    window.location.href = `${page}.html`;
                }
            } catch (error) {
                window.open(`${page}.html`, '_blank');
            }
        }

        // é‡æ–°æ•´ç†å ±è¡¨
        async function refreshReports() {
            try {
                showNotification('æ­£åœ¨é‡æ–°è¼‰å…¥å ±è¡¨æ•¸æ“š...', 'info');
                await loadAllData();
                await updateDashboard();
                showNotification('å ±è¡¨æ•¸æ“šå·²æ›´æ–°', 'success');
            } catch (error) {
                console.error('é‡æ–°è¼‰å…¥å ±è¡¨å¤±æ•—:', error);
                showNotification('é‡æ–°è¼‰å…¥å ±è¡¨å¤±æ•—', 'error');
            }
        }

        // æ—¥æœŸç¯„åœæŸ¥è©¢
        async function queryByDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showNotification('è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸ', 'warning');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showNotification('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ', 'error');
                return;
            }
            
            try {
                showNotification('æ­£åœ¨æŸ¥è©¢æŒ‡å®šæ—¥æœŸç¯„åœçš„æ•¸æ“š...', 'info');
                
                // æ›´æ–°ç•¶å‰æŸ¥è©¢çš„æ—¥æœŸç¯„åœ
                window.currentQueryStartDate = startDate;
                window.currentQueryEndDate = endDate;
                
                // é‡æ–°è¼‰å…¥æ•¸æ“šä¸¦æ›´æ–°é¡¯ç¤º
                await loadAllData();
                await updateDashboardWithDateRange(startDate, endDate);
                
                showNotification(`å·²æŸ¥è©¢ ${startDate} è‡³ ${endDate} çš„æ•¸æ“š`, 'success');
            } catch (error) {
                console.error('æ—¥æœŸç¯„åœæŸ¥è©¢å¤±æ•—:', error);
                showNotification('æ—¥æœŸç¯„åœæŸ¥è©¢å¤±æ•—', 'error');
            }
        }

        // é‡ç½®åˆ°æœ¬æœˆæ•¸æ“š
        async function resetToCurrentMonth() {
            try {
                showNotification('æ­£åœ¨é‡ç½®åˆ°æœ¬æœˆæ•¸æ“š...', 'info');
                
                // æ¸…é™¤ç•¶å‰æŸ¥è©¢çš„æ—¥æœŸç¯„åœ
                window.currentQueryStartDate = null;
                window.currentQueryEndDate = null;
                
                // é‡æ–°è¨­å®šæ—¥æœŸç‚ºæœ¬æœˆ
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                
                document.getElementById('startDate').value = firstDayOfMonth.toISOString().split('T')[0];
                document.getElementById('endDate').value = lastDayOfMonth.toISOString().split('T')[0];
                
                // é‡æ–°è¼‰å…¥æ•¸æ“šä¸¦æ›´æ–°é¡¯ç¤º
                await loadAllData();
                await updateDashboard();
                
                // æ¢å¾©å¢é•·ç‡é¡¯ç¤º
                document.querySelectorAll('[id$="Growth"]').forEach(el => {
                    el.style.display = 'block';
                });
                
                // æ¢å¾©æœˆåº¦æ¯”è¼ƒé¡¯ç¤º
                const salesGrowthElement = document.getElementById('salesGrowth');
                if (salesGrowthElement) {
                    salesGrowthElement.style.display = 'block';
                }
                
                // æ¢å¾©åŸå§‹æ¨™ç±¤
                const labels = document.querySelectorAll('.apple-card p');
                if (labels.length >= 9) {
                    labels[0].textContent = 'æœ¬æœˆè¨‚å–®æ•¸';
                    labels[4].textContent = 'æœ¬æœˆç¸½é€²è²¨é¡';
                    labels[8].textContent = 'æœ¬æœˆæ¯›åˆ©ç‡';
                }
                
                // æ¢å¾©æœˆåº¦æ¯”è¼ƒæ¨™ç±¤
                const lastMonthElement = document.getElementById('lastMonthSales');
                if (lastMonthElement) {
                    lastMonthElement.textContent = 'NT$0';
                }
                
                // é‡æ–°è¨­ç½®åˆ†é¡åœ–è¡¨ç‚ºæœ¬æœˆæ•¸æ“š
                await setupCategoryChart();
                
                showNotification('å·²é‡ç½®åˆ°æœ¬æœˆæ•¸æ“š', 'success');
            } catch (error) {
                console.error('é‡ç½®åˆ°æœ¬æœˆå¤±æ•—:', error);
                showNotification('é‡ç½®åˆ°æœ¬æœˆå¤±æ•—', 'error');
            }
        }

        // åŒ¯å‡ºå ±è¡¨
        function exportReports() {
            try {
                // å‰µå»ºå ±è¡¨å…§å®¹
                const reportContent = generateReportContent();
                
                // å‰µå»ºä¸‹è¼‰é€£çµ
                const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `ç‡Ÿæ¥­å ±è¡¨_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification('å ±è¡¨å·²åŒ¯å‡º', 'success');
            } catch (error) {
                console.error('åŒ¯å‡ºå ±è¡¨å¤±æ•—:', error);
                showNotification('åŒ¯å‡ºå ±è¡¨å¤±æ•—', 'error');
            }
        }

        // ç”Ÿæˆå ±è¡¨å…§å®¹
        function generateReportContent() {
            const currentMonthData = getCurrentMonthData();
            const lastMonthData = getLastMonthData();
            
            let content = `æ³¢æ³¢ èš æ­æ´²å®¶å±…/æ³¢è˜­é™¶é£Ÿå™¨ - ç‡Ÿæ¥­å ±è¡¨\n`;
            content += `å ±è¡¨æ—¥æœŸ: ${new Date().toLocaleDateString('zh-TW')}\n`;
            content += `==========================================\n\n`;
            
            // æœ¬æœˆçµ±è¨ˆ
            content += `æœ¬æœˆçµ±è¨ˆ:\n`;
            content += `- è¨‚å–®æ•¸: ${currentMonthData.sales.length}\n`;
            content += `- éŠ·å”®é‡‘é¡: NT$${currentMonthData.totalSales.toLocaleString()}\n`;
            content += `- é€²è²¨é‡‘é¡: NT$${currentMonthData.purchases.reduce((sum, p) => sum + (p.total_cost || 0), 0).toLocaleString()}\n`;
            content += `- æ¯›åˆ©ç‡: ${currentMonthData.totalSales > 0 ? ((calculateGrossProfit(currentMonthData.sales) / currentMonthData.totalSales) * 100).toFixed(1) : 0}%\n\n`;
            
            // ä¸Šæœˆæ¯”è¼ƒ
            content += `ä¸Šæœˆæ¯”è¼ƒ:\n`;
            content += `- è¨‚å–®æ•¸: ${lastMonthData.sales.length}\n`;
            content += `- éŠ·å”®é‡‘é¡: NT$${lastMonthData.totalSales.toLocaleString()}\n`;
            content += `- é€²è²¨é‡‘é¡: NT$${lastMonthData.purchases.reduce((sum, p) => sum + (p.total_cost || 0), 0).toLocaleString()}\n\n`;
            
            // ç†±éŠ·å•†å“
            const topProducts = calculateProductSales().slice(0, 5);
            content += `ç†±éŠ·å•†å“ TOP 5:\n`;
            topProducts.forEach((product, index) => {
                content += `${index + 1}. ${product.name} - ${product.salesCount}ä»¶ - NT$${product.salesAmount.toLocaleString()}\n`;
            });
            
            return content;
        }

        // æ¸¬è©¦é€²è²¨è³‡æ–™è¼‰å…¥
        function testPurchaseData() {
            console.log('=== é€²è²¨è³‡æ–™æ¸¬è©¦ ===');
            console.log('ç¸½é€²è²¨è¨˜éŒ„æ•¸:', purchaseData.length);
            
            if (purchaseData.length > 0) {
                console.log('é€²è²¨è¨˜éŒ„ç¯„ä¾‹:', purchaseData[0]);
                console.log('é€²è²¨è¨˜éŒ„æ¬„ä½:', Object.keys(purchaseData[0]));
                
                const currentMonthData = getCurrentMonthData();
                console.log('æœ¬æœˆé€²è²¨è¨˜éŒ„æ•¸:', currentMonthData.purchases.length);
                
                if (currentMonthData.purchases.length > 0) {
                    console.log('æœ¬æœˆé€²è²¨è¨˜éŒ„ç¯„ä¾‹:', currentMonthData.purchases[0]);
                }
            } else {
                console.log('æ²’æœ‰é€²è²¨è¨˜éŒ„');
            }
        }

        // æ¸¬è©¦ç‡Ÿæ¥­ç¸¾æ•ˆè³‡æ–™
        async function testPerformanceData() {
            console.log('=== ç‡Ÿæ¥­ç¸¾æ•ˆè³‡æ–™æ¸¬è©¦ ===');
            
            console.log('ç•¶å‰æœˆä»½:', currentMonth + 1, 'å¹´:', currentYear);
            console.log('ç¸½éŠ·å”®è¨˜éŒ„æ•¸:', salesData.length);
            console.log('ç¸½å•†å“æ•¸:', productsData.length);
            
            if (salesData.length > 0) {
                console.log('éŠ·å”®è¨˜éŒ„ç¯„ä¾‹:', salesData[0]);
                console.log('éŠ·å”®è¨˜éŒ„æ—¥æœŸæ¬„ä½:', Object.keys(salesData[0]));
            }
            
            const currentMonthData = getCurrentMonthData();
            console.log('æœ¬æœˆéŠ·å”®è¨˜éŒ„æ•¸:', currentMonthData.sales.length);
            console.log('æœ¬æœˆé€€è²¨è¨˜éŒ„æ•¸:', currentMonthData.refunds.length);
            console.log('æœ¬æœˆç¸½éŠ·å”®é¡:', currentMonthData.totalSales);
            
            if (currentMonthData.sales.length > 0) {
                console.log('æœ¬æœˆéŠ·å”®è¨˜éŒ„ç¯„ä¾‹:', currentMonthData.sales[0]);
            }
            
            const productSales = calculateProductSales();
            console.log('ç†±éŠ·å•†å“æ•¸é‡:', productSales.length);
            if (productSales.length > 0) {
                console.log('ç†±éŠ·å•†å“TOP3:', productSales.slice(0, 3).map(p => ({
                    name: p.name,
                    salesCount: p.salesCount,
                    salesAmount: p.salesAmount
                })));
            }
            
            const lowStockProducts = productsData.filter(product => 
                (product.stock || 0) <= 5 && (product.stock || 0) > 0
            );
            const outOfStockProducts = productsData.filter(product => 
                (product.stock || 0) <= 0
            );
            console.log('ä½åº«å­˜å•†å“æ•¸:', lowStockProducts.length);
            console.log('ç¼ºè²¨å•†å“æ•¸:', outOfStockProducts.length);
            
            // æ¸¬è©¦åˆ†é¡éŠ·å”®æ•¸æ“š
            const categoryData = await getCategoryData();
            console.log('åˆ†é¡éŠ·å”®æ•¸æ“š:', categoryData.details);
        }

        // å›åˆ°ä¸»é é¢
        function goBackToMenu() {
            window.location.href = '../index.html';
        }
    </script>
    <style>
        .apple-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .report-card {
            transition: all 0.3s ease;
        }
        .report-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen p-4">
    
    <!-- é ‚éƒ¨æ“ä½œå€ -->
    <div class="mb-6">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">å ±è¡¨ä¸­å¿ƒ</h1>
                <p class="text-gray-600">é€²éŠ·å­˜å ±è¡¨åˆ†æèˆ‡æ•¸æ“šçµ±è¨ˆ</p>
            </div>
            <div class="flex space-x-3">
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-600">é–‹å§‹æ—¥æœŸï¼š</span>
                    <input type="date" id="startDate" 
                           class="px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                    <span class="text-sm text-gray-600">çµæŸæ—¥æœŸï¼š</span>
                    <input type="date" id="endDate" 
                           class="px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                </div>
                <button onclick="goBackToMenu()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-th-large mr-2"></i>å›é¸å–®
                </button>
                <button onclick="navigateToPage('members')" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-users mr-2"></i>æœƒå“¡ç®¡ç†
                </button>
                <button onclick="queryByDateRange()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-search mr-2"></i>æŸ¥è©¢
                </button>
                <button onclick="resetToCurrentMonth()" class="bg-gray-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-600 transition-colors">
                    <i class="fas fa-undo mr-2"></i>æœ¬æœˆ
                </button>
                <button onclick="exportReports()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-download mr-2"></i>åŒ¯å‡ºPDF
                </button>
                <button onclick="quickProductReport()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-barcode mr-2"></i>å•†å“æŸ¥è©¢
                </button>

            </div>
        </div>
    </div>

    <!-- é—œéµç¸¾æ•ˆæŒ‡æ¨™ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        
        <!-- æœ¬æœˆè¨‚å–®æ•¸ -->
        <div class="apple-card rounded-xl p-6 report-card shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">æœ¬æœˆè¨‚å–®æ•¸</p>
                                    <p class="text-2xl font-bold text-[#17225e]" id="orderCount">0</p>
                                    <p class="text-xs text-[#17225e]" id="orderGrowth">
                        <i class="fas fa-arrow-up mr-1"></i>+0% æ¯”ä¸Šæœˆ
                    </p>
                </div>
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                <i class="fas fa-shopping-cart text-[#17225e]"></i>
                </div>
            </div>
        </div>

        <!-- ç¸½é€²è²¨é¡ -->
        <div class="apple-card rounded-xl p-6 report-card shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">æœ¬æœˆç¸½é€²è²¨é¡</p>
                    <p class="text-2xl font-bold text-[#17225e]" id="purchaseAmount">NT$0</p>
                    <p class="text-xs text-[#17225e]" id="purchaseGrowth">
                        <i class="fas fa-arrow-up mr-1"></i>+0% æ¯”ä¸Šæœˆ
                    </p>
                </div>
                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                                          <i class="fas fa-truck text-[#17225e]"></i>
                </div>
            </div>
        </div>

        <!-- æ¯›åˆ©ç‡ -->
        <div class="apple-card rounded-xl p-6 report-card shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">æœ¬æœˆæ¯›åˆ©ç‡</p>
                                    <p class="text-2xl font-bold text-[#17225e]" id="grossProfitRate">0%</p>
                                    <p class="text-xs text-[#17225e]" id="profitGrowth">
                        <i class="fas fa-arrow-up mr-1"></i>+0% æ¯”ä¸Šæœˆ
                    </p>
                </div>
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                <i class="fas fa-percentage text-[#17225e]"></i>
                </div>
            </div>
        </div>

        <!-- åº«å­˜é€±è½‰ç‡ -->
        <div class="apple-card rounded-xl p-6 report-card shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">åº«å­˜é€±è½‰ç‡</p>
                                    <p class="text-2xl font-bold text-[#17225e]" id="turnoverRate">0</p>
                                    <p class="text-xs text-[#17225e]" id="turnoverGrowth">
                        <i class="fas fa-arrow-up mr-1"></i>+0 æ¯”ä¸Šæœˆ
                    </p>
                </div>
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                <i class="fas fa-sync text-[#17225e]"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- åœ–è¡¨åˆ†æå€åŸŸ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        
        <!-- é€²éŠ·å­˜è¶¨å‹¢åœ– -->
        <div class="apple-card rounded-xl p-6 shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">é€²éŠ·å­˜è¶¨å‹¢åˆ†æ</h3>
                <div class="flex items-center space-x-4 text-sm">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-[#17225e] rounded-full mr-1"></div>
                        <span>éŠ·å”®</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-[#dc2626] rounded-full mr-1"></div>
                        <span>é€²è²¨</span>
                    </div>
                </div>
            </div>
            <div style="height: 200px; position: relative;">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- å•†å“åˆ†é¡éŠ·å”®å æ¯” -->
        <div class="apple-card rounded-xl p-6 shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">å•†å“åˆ†é¡éŠ·å”®å æ¯”</h3>
                <span class="text-sm text-gray-600">æœ¬æœˆæ•¸æ“š</span>
            </div>
            <div style="height: 250px; position: relative;">
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="mt-4">
                <h4 class="font-medium text-gray-700 mb-3">åˆ†é¡éŠ·å”®è©³æƒ…</h4>
                <div id="categoryDetails">
                    <!-- åˆ†é¡è©³æƒ…å°‡ç”± JavaScript å‹•æ…‹å¡«å…… -->
                </div>
            </div>
        </div>
    </div>

    <!-- è©³ç´°å ±è¡¨ -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
        
        <!-- é€²éŠ·å­˜æ˜ç´°å ±è¡¨ -->
        <div class="apple-card rounded-xl p-6 shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">é€²éŠ·å­˜æ˜ç´°å ±è¡¨</h3>
                <div class="flex space-x-2">
                    <button onclick="exportInventoryReport()" class="text-[#17225e] text-sm hover:underline">
                        <i class="fas fa-download mr-1"></i>åŒ¯å‡ºå ±è¡¨
                    </button>
                    <button onclick="showInventoryFilters()" class="text-[#17225e] text-sm hover:underline">
                        <i class="fas fa-filter mr-1"></i>ç¯©é¸
                </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm" id="inventoryTable">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-3 text-gray-600">å•†å“è³‡è¨Š</th>
                            <th class="text-center py-3 text-gray-600">æœŸåˆåº«å­˜</th>
                            <th class="text-center py-3 text-gray-600">é€²è²¨</th>
                            <th class="text-center py-3 text-gray-600">æ·¨éŠ·å”®</th>
                            <th class="text-center py-3 text-gray-600">æœŸæœ«åº«å­˜</th>
                            <th class="text-center py-3 text-gray-600">å¹³å‡å”®åƒ¹</th>
                            <th class="text-center py-3 text-gray-600">éŠ·å”®é‡‘é¡</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- å•†å“æ˜ç´°å°‡ç”± JavaScript å‹•æ…‹å¡«å…… -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ç‡Ÿæ¥­ç¸¾æ•ˆåˆ†æ -->
        <div class="apple-card rounded-xl p-6 shadow-lg">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">ç‡Ÿæ¥­ç¸¾æ•ˆåˆ†æ</h3>
            
            <div class="space-y-6">
                
                <!-- ç†±éŠ·å•†å“TOP3 -->
                <div>
                    <h4 class="font-medium text-gray-700 mb-3">ç†±éŠ·å•†å“ TOP 3</h4>
                    <div class="space-y-3" id="topProducts">
                        <!-- ç†±éŠ·å•†å“å°‡ç”± JavaScript å‹•æ…‹å¡«å…… -->
                    </div>
                </div>

                <!-- æœˆåº¦æ¯”è¼ƒ -->
                <div>
                    <h4 class="font-medium text-gray-700 mb-3">æœˆåº¦æ¯”è¼ƒ</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm text-[#17225e] mb-1">æœ¬æœˆéŠ·å”®</p>
                            <p class="text-lg font-bold text-gray-700" id="currentMonthSales">NT$0</p>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600 mb-1">ä¸ŠæœˆéŠ·å”®</p>
                            <p class="text-lg font-bold text-gray-800" id="lastMonthSales">NT$0</p>
                        </div>
                    </div>
                    <div class="mt-2">
                        <p id="salesGrowth" class="text-xs text-gray-600">å¢é•·ç‡: 0% æ¯”ä¸Šæœˆ</p>
                    </div>
                </div>

                <!-- åº«å­˜é è­¦ -->
                <div>
                    <h4 class="font-medium text-gray-700 mb-3">åº«å­˜é è­¦æé†’</h4>
                    <div class="space-y-2" id="inventoryAlerts">
                        <!-- åº«å­˜é è­¦å°‡ç”± JavaScript å‹•æ…‹å¡«å…… -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æª¢æŸ¥æƒæåŠŸèƒ½æ˜¯å¦è¼‰å…¥
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (typeof window.quickScan !== 'function') {
                    console.log('æƒæåŠŸèƒ½æœªè¼‰å…¥ï¼Œæä¾›æ‰‹å‹•è¼¸å…¥æ›¿ä»£æ–¹æ¡ˆ');
                    window.quickScan = function(onSuccess, onError) {
                        const barcode = prompt('è«‹è¼¸å…¥æ¢ç¢¼è™Ÿç¢¼æŸ¥çœ‹éŠ·å”®å ±è¡¨');
                        if (barcode) {
                            onSuccess(barcode);
                        } else if (onError) {
                            onError(new Error('ç”¨æˆ¶å–æ¶ˆè¼¸å…¥'));
                        }
                    };
                    console.log('æ‰‹å‹•è¼¸å…¥åŠŸèƒ½å·²å°±ç·’');
                }
            }, 1000);
        });
    </script>
</body>
</html> 