<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../employee-auth.js"></script>
    <script src="auth-check.js"></script>
    <script src="../database.js"></script>
    <script src="../heartbeat.js"></script>

    <script>
        // 簡單的認證檢查測試
        console.log('=== products.html 腳本載入測試 ===');
        console.log('employee-auth.js 是否載入:', typeof EmployeeAuth !== 'undefined');
        console.log('auth-check.js 是否載入:', typeof checkAuthentication !== 'undefined');
        

    </script>
    <style>
        .apple-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .category-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .category-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }
        .product-card {
            transition: all 0.2s ease;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        .category-view {
            display: block;
        }
        .products-view {
            display: none;
        }
        .active-category {
            border: 2px solid #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen p-4">
    
    <!-- 頂部操作區 -->
    <div class="mb-6">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">商品與庫存管理</h1>
                <p class="text-gray-600" id="pageSubtitle">選擇商品分類查看商品和庫存狀態</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="goBackToMenu()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-th-large mr-2"></i>回選單
                </button>
                <button onclick="navigateToPage('members')" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-users mr-2"></i>會員管理
                </button>
                <button id="backToCategories" class="bg-gray-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-600 transition-colors" style="display: none;">
                    <i class="fas fa-arrow-left mr-2"></i>返回分類
                </button>
                <button id="addProductBtn" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-plus mr-2"></i>新增商品
                </button>

                <button onclick="goToImportExport()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-file-import mr-2"></i>匯出/入
                </button>
                <button onclick="showStockTakingModal()" class="bg-gray-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-700 transition-colors">
                    <i class="fas fa-clipboard-check mr-2"></i>盤點作業
                </button>
                <button onclick="showCategoryManagement()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-tags mr-2"></i>分類管理
                </button>
            </div>
        </div>
    </div>

    <!-- 統計卡片 -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="apple-card rounded-xl p-4 shadow-lg">
            <div class="text-center">
                <p class="text-2xl font-bold text-[#17225e]" id="totalProducts">156</p>
                <p class="text-sm text-gray-600">總商品數</p>
            </div>
        </div>
        <div class="apple-card rounded-xl p-4 shadow-lg">
            <div class="text-center">
                <p class="text-2xl font-bold text-[#17225e]" id="inStockProducts">142</p>
                <p class="text-sm text-gray-600">有庫存</p>
            </div>
        </div>
        <div class="apple-card rounded-xl p-4 shadow-lg">
            <div class="text-center">
                <p class="text-2xl font-bold text-[#17225e]" id="lowStockProducts">8</p>
                <p class="text-sm text-gray-600">低庫存</p>
            </div>
        </div>
        <div class="apple-card rounded-xl p-4 shadow-lg">
            <div class="text-center">
                <p class="text-2xl font-bold text-[#17225e]" id="totalValue">NT$485,230</p>
                <p class="text-sm text-gray-600">庫存總值</p>
            </div>
        </div>
    </div>

    <!-- 分類檢視 -->
    <div id="categoryView" class="category-view">
        <div class="apple-card rounded-xl p-6 shadow-lg">
            <h3 class="text-lg font-semibold text-gray-800 mb-6">商品分類</h3>
            
            <div id="categoriesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- 分類卡片將在這裡動態生成 -->
            </div>
        </div>
    </div>

    <!-- 商品檢視 -->
    <div id="productsView" class="products-view">
        <!-- 搜尋和篩選區 -->
        <div class="apple-card rounded-xl p-6 mb-6 shadow-lg">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div class="lg:col-span-2">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="搜尋商品名稱、條碼..." onkeyup="searchProducts()"
                               class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                <div>
                    <select id="stockFilter" onchange="filterProducts()" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="">所有庫存狀態</option>
                        <option value="normal">有庫存</option>
                        <option value="low">低庫存</option>
                        <option value="out">缺貨</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 商品列表 -->
        <div class="apple-card rounded-xl p-6 shadow-lg">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-800" id="categoryTitle">商品列表</h3>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600" id="productCount">共 24 項商品</span>
                    <div class="flex items-center space-x-2">
                        <button class="p-2 text-gray-500 hover:text-gray-700" onclick="toggleView('grid')">
                            <i class="fas fa-th"></i>
                        </button>
                        <button class="p-2 text-[#17225e] hover:text-[#1a2a6e]" onclick="toggleView('list')">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 網格檢視 -->
            <div id="gridView" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4" style="display: grid;">
                <!-- 商品卡片 (小方形樣式) -->
            </div>

            <!-- 列表檢視 -->
            <div id="listView" class="space-y-3" style="display: none;">
                <!-- 列表項目 -->
            </div>

            <!-- 分頁 -->
            <div class="flex justify-between items-center mt-6 pt-6 border-t border-gray-200">
                                  <p class="text-sm text-gray-600">顯示 1-24 項，共 <span id="totalProducts">48</span> 項商品</p>
                    <button class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50" disabled>
                        上一頁
                    </button>
                    <button class="px-3 py-1 text-sm bg-[#17225e] text-white rounded">1</button>
                    <button class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50">2</button>
                    <button class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50">
                        下一頁
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增商品模態框 -->
    <div id="addProductModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl w-full max-w-2xl max-h-screen overflow-y-auto">
                <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">新增商品</h3>
                    <button onclick="hideAddProductModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="addProductForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">商品名稱</label>
                            <input type="text" id="productName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="請輸入商品名稱">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">商品條碼</label>
                            <div class="flex">
                                <input type="text" id="productBarcode" required class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="請輸入條碼">
                                <button type="button" onclick="generateBarcode()" class="px-3 py-2 bg-gray-500 text-white rounded-r-lg hover:bg-gray-600 transition-colors">
                                    <i class="fas fa-random"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">商品圖片</label>
                        <input type="file" id="productImageFile" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">選擇圖片後，系統會自動上傳並產生 URL 儲存到資料庫。</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">售價</label>
                            <input type="number" id="productPrice" required min="0" step="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="請輸入售價">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">成本價</label>
                            <input type="number" id="productCost" min="0" step="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="請輸入成本價">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">商品分類</label>
                            <select id="productCategory" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">請選擇分類</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">初始庫存</label>
                            <input type="number" id="productStock" required min="0" step="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="請輸入初始庫存">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">安全庫存</label>
                            <input type="number" id="productMinStock" min="0" step="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="低於此數量時警告" value="10">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">供應商</label>
                            <div class="flex space-x-2">
                                <select id="productSupplier" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">請選擇供應商</option>
                                </select>
                                <button type="button" onclick="showAddSupplierModal()" class="px-3 py-2 bg-[#17225e] text-white rounded-r-lg hover:bg-[#1a2a6e] transition-colors">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">商品描述</label>
                        <textarea id="productDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="請輸入商品描述（選填）"></textarea>
                    </div>
                    

                    
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="testDatabaseConnection()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            <i class="fas fa-database mr-2"></i>測試連接
                        </button>
                        <button type="button" onclick="hideAddProductModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 bg-[#17225e] text-white rounded-lg hover:bg-[#1a2a6e] transition-colors">
                            <i class="fas fa-plus mr-2"></i>新增商品
                        </button>
                    </div>
                </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增供應商模態框 -->
    <div id="addSupplierModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800" id="supplierModalTitle">新增供應商</h3>
                <button onclick="closeSupplierModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="supplierForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">供應商名稱 *</label>
                        <input type="text" id="supplierName" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">聯絡人</label>
                        <input type="text" id="contactPerson" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">電話</label>
                        <input type="tel" id="supplierPhone" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">電子郵件</label>
                        <input type="email" id="supplierEmail" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">地址</label>
                    <textarea id="supplierAddress" rows="2" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">備註</label>
                    <textarea id="supplierNotes" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeSupplierModal()" 
                            class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        取消
                    </button>
                    <button type="submit" 
                            class="px-6 py-2 bg-[#17225e] text-white rounded-lg hover:bg-[#1a2a6e] transition-colors">
                        儲存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 編輯商品模態框 -->
    <div id="editProductModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl w-full max-w-2xl max-h-screen overflow-y-auto">
                <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">編輯商品</h3>
                    <button onclick="hideEditProductModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="editProductForm" class="space-y-4">
                    <input type="hidden" id="editProductIndex">
                    <input type="hidden" id="editProductCategory">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">商品名稱</label>
                            <input type="text" id="editProductName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">商品條碼</label>
                            <input type="text" id="editProductBarcode" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">售價</label>
                            <input type="number" id="editProductPrice" required min="0" step="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">庫存數量</label>
                            <input type="number" id="editProductStock" required min="0" step="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="hideEditProductModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                            取消
                        </button>
                        <button type="button" onclick="deleteProduct()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                            <i class="fas fa-trash mr-2"></i>刪除
                        </button>
                        <button type="submit" class="px-4 py-2 bg-[#17225e] text-white rounded-lg hover:bg-[#1a2a6e] transition-colors">
                            <i class="fas fa-save mr-2"></i>保存
                        </button>
                    </div>
                </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 商品數據
        let productData = {};
        let categoriesData = [];
        let suppliersData = [];

        // 商品管理功能

        // 顯示新增商品模態框
        function showAddProductModal() {
            console.log('showAddProductModal 被調用');
            const modal = document.getElementById('addProductModal');
            if (!modal) {
                console.error('找不到 addProductModal 元素');
                return;
            }
            modal.classList.remove('hidden');
            const nameInput = document.getElementById('productName');
            if (nameInput) {
                nameInput.focus();
            }
            console.log('新增商品模態框已顯示');
        }

        // 隱藏新增商品模態框
        function hideAddProductModal() {
            document.getElementById('addProductModal').classList.add('hidden');
            document.getElementById('addProductForm').reset();
        }

        // 生成隨機條碼
        function generateBarcode() {
            const barcode = Math.floor(Math.random() * 9000000000000) + 1000000000000;
            document.getElementById('productBarcode').value = barcode.toString();
        }



        // 新增商品表單提交處理函數
        async function handleAddProduct(e) {
            e.preventDefault();
            
            const name = document.getElementById('productName').value.trim();
            const barcode = document.getElementById('productBarcode').value.trim();
            const price = parseInt(document.getElementById('productPrice').value);
            const cost = parseInt(document.getElementById('productCost').value) || 0;
            const categoryId = document.getElementById('productCategory').value;
            const stock = parseInt(document.getElementById('productStock').value);
            const minStock = parseInt(document.getElementById('productMinStock').value) || 10;
            const supplierElement = document.getElementById('productSupplier');
            const supplier = supplierElement ? supplierElement.value.trim() : '';
            console.log('供應商元素:', supplierElement);
            console.log('供應商選擇值:', supplier);
            console.log('供應商選項數量:', supplierElement ? supplierElement.options.length : 0);
            console.log('供應商資料:', suppliersData);
            const description = document.getElementById('productDescription').value.trim();

            // 驗證必填欄位
            if (!name || !barcode || !categoryId) {
                alert('請填寫商品名稱、條碼和選擇分類');
                return;
            }

            // 驗證供應商選擇
            console.log('驗證供應商選擇 - supplier:', supplier, 'suppliersData.length:', suppliersData.length);
            if (!supplier) {
                if (suppliersData.length === 0) {
                    alert('請先新增供應商，然後再新增商品');
                    showAddSupplierModal(); // 顯示供應商新增模態框
                } else {
                    alert('請選擇供應商');
                }
                return;
            }

            try {
                // 檢查資料庫連接狀態
                console.log('檢查資料庫連接狀態...');
                if (!DatabaseManager.isConnected()) {
                    console.log('資料庫未連接，嘗試重新初始化...');
                    const initSuccess = await DatabaseManager.initialize();
                    if (!initSuccess) {
                        throw new Error('資料庫初始化失敗');
                    }
                }
                console.log('資料庫連接狀態:', DatabaseManager.getStatus());

                // 檢查條碼是否已存在於Supabase
                console.log('檢查條碼是否重複...');
                const existingProducts = await BusinessAPI.getProducts();
                if (existingProducts === null) {
                    throw new Error('無法獲取現有商品資料，資料庫連接可能有問題');
                }
                const barcodeExists = existingProducts.some(product => product.barcode === barcode);
                
                if (barcodeExists) {
                    alert('此條碼已存在，請使用其他條碼');
                    return;
                }

                // 計算庫存狀態
                let status = 'normal';
                if (stock === 0) status = 'out';
                else if (stock <= minStock) status = 'low';

                // 準備要插入到Supabase的商品資料
                const productDataForSupabase = {
                    name: name,
                    barcode: barcode,
                    price: price,
                    cost: cost,
                    category_id: parseInt(categoryId), // 確保是數字
                    stock: stock,
                    min_stock: minStock, // Supabase欄位名稱
                    description: description,
                    // status: status, // 移除，因為Supabase表中沒有此欄位
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                // 檢查供應商是否已選擇
                console.log('供應商選擇值:', supplier);
                if (!supplier || supplier === '') {
                    alert('請選擇供應商');
                    return;
                }
                
                        // 根據外鍵約束，supplier 欄位應該存儲供應商名稱，不是 ID
        // 從供應商資料中找到對應的名稱
        console.log('尋找供應商 - supplier 值:', supplier, '類型:', typeof supplier);
        console.log('suppliersData:', suppliersData);
        
        let selectedSupplier;
        if (typeof supplier === 'string' && supplier.trim() !== '') {
            // 如果 supplier 是字串，直接使用（可能是供應商名稱）
            selectedSupplier = suppliersData.find(s => s.name === supplier);
        } else if (supplier) {
            // 如果 supplier 是數字，轉換為整數後查找
            const supplierId = parseInt(supplier);
            selectedSupplier = suppliersData.find(s => s.number === supplierId);
        }
        
        if (!selectedSupplier) {
            console.error('找不到選擇的供應商資料');
            console.error('供應商選擇值:', supplier);
            console.error('可用供應商:', suppliersData);
            alert('找不到選擇的供應商資料，請重新選擇供應商');
            return;
        }
        
        productDataForSupabase.supplier = selectedSupplier.name; // 存儲供應商名稱
        console.log('設定後的 supplier:', productDataForSupabase.supplier);

                // 若使用者選了圖片，先上傳取得 URL
                const imageInput = document.getElementById('productImageFile');
                if (imageInput && imageInput.files && imageInput.files[0]) {
                    try {
                        console.log('開始上傳圖片...');
                        const imageUrl = await BusinessAPI.uploadProductImage(imageInput.files[0]);
                        if (imageUrl) {
                            productDataForSupabase.image_url = imageUrl;
                            console.log('圖片上傳成功，URL:', imageUrl);
                        } else {
                            console.warn('圖片上傳失敗，返回的URL為null');
                        }
                    } catch (error) {
                        console.warn('圖片上傳失敗，繼續新增商品:', error);
                        // 圖片上傳失敗不影響商品新增
                    }
                }

                // 插入到Supabase
                console.log('準備插入商品資料到Supabase:', productDataForSupabase);
                console.log('資料庫連接狀態:', DatabaseManager.getStatus());
                console.log('Supabase 客戶端狀態:', supabase ? '已初始化' : '未初始化');
                
                // 先檢查資料表結構
                try {
                    console.log('檢查 products 表結構...');
                    const { data: tableCheck, error: tableError } = await supabase
                        .from('products')
                        .select('*')
                        .limit(1);
                    
                    if (tableError) {
                        throw new Error(`無法存取 products 表: ${tableError.message}`);
                    }
                    
                    if (tableCheck && tableCheck.length > 0) {
                        const actualFields = Object.keys(tableCheck[0]);
                        console.log('products 表實際欄位:', actualFields);
                        
                        // 檢查必要欄位是否存在
                        const requiredFields = ['name', 'barcode', 'price', 'category_id', 'stock'];
                        const missingFields = requiredFields.filter(field => !actualFields.includes(field));
                        
                        if (missingFields.length > 0) {
                            throw new Error(`products 表缺少必要欄位: ${missingFields.join(', ')}`);
                        }
                        
                        // 檢查欄位名稱是否匹配
                        const codeFields = Object.keys(productDataForSupabase);
                        const mismatchedFields = codeFields.filter(field => !actualFields.includes(field));
                        
                        if (mismatchedFields.length > 0) {
                            console.warn('發現欄位名稱不匹配:', mismatchedFields);
                            // 移除不匹配的欄位
                            mismatchedFields.forEach(field => {
                                delete productDataForSupabase[field];
                                console.log(`已移除欄位: ${field}`);
                            });
                        }
                    }
                } catch (structureError) {
                    console.error('資料表結構檢查失敗:', structureError);
                    throw new Error(`資料表結構問題: ${structureError.message}`);
                }
                
                const result = await BusinessAPI.addProduct(productDataForSupabase);
                
                if (result) {
                    console.log('商品成功新增到Supabase:', result);
                    
                    // 重新載入商品資料
                    await loadProductDataFromSupabase();
                    
                    // 更新統計
                    updateStatistics();
                    
                    // 如果當前正在查看該分類，重新渲染
                    if (String(currentCategory) === String(categoryId)) {
                        renderProducts(categoryId);
                    }
                    
                    alert('商品新增成功！已儲存到資料庫');
                    hideAddProductModal();
                } else {
                    console.error('BusinessAPI.addProduct 返回 null 或 undefined');
                    throw new Error('新增商品失敗：資料庫操作未成功');
                }
                
            } catch (error) {
                console.error('新增商品到Supabase失敗:', error);
                console.error('錯誤詳情:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                
                // 提供更具體的錯誤訊息
                let errorMessage = '新增商品失敗';
                if (error.message.includes('資料庫初始化失敗')) {
                    errorMessage += '：資料庫連接失敗，請檢查網路連線和Supabase設定';
                } else if (error.message.includes('無法獲取現有商品資料')) {
                    errorMessage += '：資料庫查詢失敗，請檢查資料表是否存在';
                } else if (error.message.includes('資料庫操作未成功')) {
                    errorMessage += '：資料插入失敗，請檢查資料格式和資料表結構';
                } else {
                    errorMessage += '：' + error.message;
                }
                
                alert(errorMessage);
            }
        }

        // 導航和工具函數

        // 回到主頁面
        function goBackToMenu() {
            window.location.href = '../index.html';
        }

        // 統一導航函數
        function navigateToPage(page) {
            try {
                // 嘗試與父頁面通信切換iframe
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'navigate',
                        page: page
                    }, '*');
                } else {
                    // 如果不在iframe中，直接跳轉
                    window.location.href = `${page}.html`;
                }
            } catch (error) {
                // 備用方案：在新分頁中開啟
                window.open(`${page}.html`, '_blank');
            }
        }

        // 前往匯出/入頁面
        function goToImportExport() {
            navigateToPage('import-export');
        }

        // 顯示盤點作業彈出視窗
        function showStockTakingModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">盤點作業</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 盤點清單 -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">盤點清單</h4>
                            <div class="space-y-2 max-h-96 overflow-y-auto" id="stockTakingList">
                                <!-- 盤點項目將動態添加 -->
                            </div>
                        </div>
                        
                        <!-- 盤點統計 -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">盤點統計</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                                    <span class="text-gray-700">總商品數</span>
                                    <span class="font-semibold text-[#17225e]" id="stockTakingTotal">0</span>
                                </div>
                                <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                                    <span class="text-gray-700">已盤點</span>
                                    <span class="font-semibold text-green-600" id="stockTakingCounted">0</span>
                                </div>
                                <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                                    <span class="text-gray-700">差異項目</span>
                                    <span class="font-semibold text-yellow-600" id="stockTakingDiff">0</span>
                                </div>
                            </div>
                            
                            <div class="mt-6 space-y-3">
                                <button onclick="startStockTaking()" class="w-full bg-[#17225e] text-white py-2 rounded-lg hover:bg-[#1a2a6e] transition-colors">
                                    <i class="fas fa-play mr-2"></i>開始盤點
                                </button>
                                <button onclick="exportStockTakingReport()" class="w-full bg-[#17225e] text-white py-2 rounded-lg hover:bg-[#1a2a6e] transition-colors">
                                    <i class="fas fa-download mr-2"></i>匯出盤點報告
                                </button>
                                <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                    關閉
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            loadStockTakingList();
        }

        // 顯示分類管理
        function showCategoryManagement() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">分類管理</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <!-- 統計卡片 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="apple-card rounded-xl p-4 shadow-lg">
                            <div class="text-center">
                                <p class="text-2xl font-bold text-[#17225e]" id="modalTotalCategories">0</p>
                                <p class="text-sm text-gray-600">總分類數</p>
                            </div>
                        </div>
                        <div class="apple-card rounded-xl p-4 shadow-lg">
                            <div class="text-center">
                                <p class="text-2xl font-bold text-[#17225e]" id="modalTotalProducts">0</p>
                                <p class="text-sm text-gray-600">商品總數</p>
                            </div>
                        </div>
                        <div class="apple-card rounded-xl p-4 shadow-lg">
                            <div class="text-center">
                                <p class="text-2xl font-bold text-[#17225e]" id="modalPopularCategory">-</p>
                                <p class="text-sm text-gray-600">熱門分類</p>
                            </div>
                        </div>
                        <div class="apple-card rounded-xl p-4 shadow-lg">
                            <div class="text-center">
                                <p class="text-2xl font-bold text-[#17225e]" id="modalEmptyCategories">0</p>
                                <p class="text-sm text-gray-600">空分類</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 操作按鈕 -->
                    <div class="flex space-x-3 mb-6">
                        <button onclick="showAddCategoryModal()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                            <i class="fas fa-plus mr-2"></i>新增分類
                        </button>
                        <button onclick="showImportCategoryModal()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                            <i class="fas fa-upload mr-2"></i>匯入分類
                        </button>
                        <button onclick="exportCategories()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                            <i class="fas fa-download mr-2"></i>匯出分類
                        </button>
                    </div>
                    
                    <!-- 搜尋 -->
                    <div class="mb-4">
                        <input type="text" id="searchCategory" placeholder="搜尋分類..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                    </div>
                    
                    <!-- 分類列表 -->
                    <div id="modalCategoriesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- 分類項目將動態添加 -->
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            loadCategoriesForModal();
        }

        // 載入商品資料
        async function loadProductDataFromSupabase() {
            try {
                // 從Supabase獲取商品資料
                const products = await BusinessAPI.getProducts();
                
                if (products && products.length > 0) {
                    // 將Supabase資料轉換為本地格式
                    productData = {};
                    
                    products.forEach(product => {
                        const categoryId = product.category_id.toString();
                        if (!productData[categoryId]) {
                            productData[categoryId] = [];
                        }
                        
                        // 轉換資料格式
                        const localProduct = {
                            name: product.name,
                            barcode: product.barcode,
                            price: product.price,
                            cost: product.cost || 0,
                            category_id: product.category_id,
                            stock: product.stock,
                            minStock: product.min_stock || 10,
                            supplier: product.supplier || '',
                            description: product.description || '',
                            image_url: product.image_url || '',
                            // 移除圖片字段，因為不再需要
                            // status 將根據庫存動態計算
                        };
                        
                        productData[categoryId].push(localProduct);
                    });
                    
                    console.log('成功從Supabase載入商品資料:', products.length, '筆');
                } else {
                    productData = {};
                    console.log('沒有找到商品資料或載入失敗');
                }
            } catch (error) {
                console.error('載入商品資料失敗:', error);
                productData = {};
                showNotification('載入商品資料失敗，請檢查資料庫連接', 'error');
            }
        }

        // 載入商品資料（保持向後兼容）
        function loadProductData() {
            const savedProducts = localStorage.getItem('productData');
            if (savedProducts) {
                productData = JSON.parse(savedProducts);
            } else {
                // 初始化空的商品資料結構
                productData = {
                    tableware: [],
                    glassware: [],
                    decorative: [],
                    teaware: [],
                    kitchenware: [],
                    others: []
                };
                localStorage.setItem('productData', JSON.stringify(productData));
            }
        }

        // 保存商品資料
        function saveProductData() {
            localStorage.setItem('productData', JSON.stringify(productData));
        }

        // 當前選中的分類
        let currentCategory = '';

        // 切換分類檢視
        function showCategory(categoryId) {
            currentCategory = categoryId;
            
            // 從分類資料中找到對應的分類
            // 確保型別一致性，將 categoryId 轉換為字串進行比較
            const category = categoriesData.find(cat => String(cat.id) === String(categoryId));
            const categoryName = category ? category.name : '未知分類';

            document.getElementById('categoryView').style.display = 'none';
            document.getElementById('productsView').style.display = 'block';
            document.getElementById('backToCategories').style.display = 'inline-block';
            document.getElementById('pageSubtitle').textContent = `管理 ${categoryName} 商品`;
            document.getElementById('categoryTitle').textContent = categoryName;
            
            renderProducts(categoryId);
        }

        // 返回分類檢視
        function backToCategories() {
            document.getElementById('categoryView').style.display = 'block';
            document.getElementById('productsView').style.display = 'none';
            document.getElementById('backToCategories').style.display = 'none';
            document.getElementById('pageSubtitle').textContent = '選擇商品分類查看商品';
        }

        // 渲染商品
        function renderProducts(category) {
            const products = productData[String(category)] || [];
            const gridView = document.getElementById('gridView');
            const listView = document.getElementById('listView');
            
            document.getElementById('productCount').textContent = `共 ${products.length} 項商品`;
            document.getElementById('totalProducts').textContent = products.length;

            // 網格檢視
            gridView.innerHTML = products.map(product => `
                <div class="product-card bg-white rounded-lg p-3 shadow-md">
                    <div class="relative mb-3">
                        <div class="w-full h-20 bg-gray-100 rounded flex items-center justify-center overflow-hidden">
                            ${product.image_url ? `<img src="${product.image_url}" alt="${product.name}" class="w-full h-full object-cover">` : `<i class="fas fa-box text-gray-400 text-2xl"></i>`}
                        </div>
                        <div class="absolute top-1 right-1">
                            <span class="bg-${getStatusColor(calculateProductStatus(product))}-100 text-${getStatusColor(calculateProductStatus(product))}-800 text-xs px-1 py-0.5 rounded-full">
                                ${getStatusText(calculateProductStatus(product))}
                            </span>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-800 text-sm mb-1 truncate">${product.name}</h4>
                        <p class="text-xs text-gray-600 mb-2">條碼: ${product.barcode}</p>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-600">售價</span>
                            <span class="font-bold text-[#17225e] text-sm">NT$${product.price.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-xs text-gray-600">庫存</span>
                            <span class="font-semibold ${product.stock > 10 ? 'text-green-600' : product.stock > 0 ? 'text-orange-600' : 'text-red-600'} text-sm">${product.stock} 件</span>
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="editProduct('${currentCategory}', ${products.indexOf(product)})" class="flex-1 bg-[#17225e] text-white py-1.5 rounded text-xs hover:bg-[#1a2a6e] transition-colors">
                                <i class="fas fa-edit mr-1"></i>編輯
                            </button>
                            <button onclick="viewProduct('${currentCategory}', ${products.indexOf(product)})" class="px-2 py-1.5 border border-gray-300 rounded text-xs hover:bg-gray-50 transition-colors">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            // 列表檢視
            listView.innerHTML = products.map(product => `
                <div class="flex items-center space-x-4 p-3 bg-white rounded-lg shadow-sm">
                    <div class="w-12 h-12 bg-gray-100 rounded flex items-center justify-center overflow-hidden">
                        ${product.image_url ? `<img src="${product.image_url}" alt="${product.name}" class="w-full h-full object-cover">` : `<i class="fas fa-box text-gray-400"></i>`}
                    </div>
                    <div class="flex-1">
                        <h4 class="font-medium text-gray-800">${product.name}</h4>
                        <p class="text-sm text-gray-600">條碼: ${product.barcode}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-gray-600">售價</p>
                        <p class="font-bold text-[#17225e]">NT$${product.price.toLocaleString()}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-gray-600">庫存</p>
                        <p class="font-semibold ${product.stock > 10 ? 'text-green-600' : product.stock > 0 ? 'text-orange-600' : 'text-red-600'}">${product.stock} 件</p>
                    </div>
                    <div class="text-center">
                        <span class="inline-block bg-${getStatusColor(calculateProductStatus(product))}-100 text-${getStatusColor(calculateProductStatus(product))}-800 text-xs px-2 py-1 rounded-full">
                            ${getStatusText(calculateProductStatus(product))}
                        </span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editProduct('${currentCategory}', ${products.indexOf(product)})" class="bg-[#17225e] text-white px-3 py-1 rounded text-sm hover:bg-[#1a2a6e] transition-colors">
                            <i class="fas fa-edit mr-1"></i>編輯
                        </button>
                        <button onclick="viewProduct('${currentCategory}', ${products.indexOf(product)})" class="px-2 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 transition-colors">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 切換檢視模式
        function toggleView(viewType) {
            const gridView = document.getElementById('gridView');
            const listView = document.getElementById('listView');
            
            if (viewType === 'grid') {
                gridView.style.display = 'grid';
                listView.style.display = 'none';
            } else {
                gridView.style.display = 'none';
                listView.style.display = 'block';
            }
        }

        // 獲取狀態顏色
        function getStatusColor(status) {
            switch(status) {
                case 'normal': return 'green';
                case 'low': return 'orange';
                case 'out': return 'red';
                default: return 'gray';
            }
        }

        // 動態計算商品狀態
        function calculateProductStatus(product) {
            const stock = product.stock || 0;
            const minStock = product.minStock || 10;
            
            if (stock === 0) return 'out';
            else if (stock <= minStock) return 'low';
            else return 'normal';
        }

        // 獲取狀態文字
        function getStatusText(status) {
            switch(status) {
                case 'normal': return '正常';
                case 'low': return '低庫存';
                case 'out': return '缺貨';
                default: return '未知';
            }
        }



        // 載入分類資料
        async function loadCategoriesData() {
            try {
                // 從Supabase獲取分類資料
                const categories = await BusinessAPI.getCategories();
                
                if (categories) {
                    categoriesData = categories;
                    console.log('成功載入分類資料:', categoriesData.length, '筆');
                    populateCategorySelect();
                    renderCategoryCards(); // 渲染分類卡片
                } else {
                    categoriesData = [];
                    console.log('沒有找到分類資料或載入失敗');
                }
            } catch (error) {
                console.error('載入分類資料失敗:', error);
                categoriesData = [];
                showNotification('載入分類資料失敗，請檢查資料庫連接', 'error');
            }
        }

        // 載入供應商資料
        async function loadSuppliersData() {
            try {
                // 從Supabase獲取供應商資料
                const suppliers = await BusinessAPI.getSuppliers();
                
                if (suppliers) {
                    suppliersData = suppliers;
                    console.log('成功載入供應商資料:', suppliersData.length, '筆');
                    populateSupplierSelect();
                } else {
                    suppliersData = [];
                    console.log('沒有找到供應商資料或載入失敗');
                }
            } catch (error) {
                console.error('載入供應商資料失敗:', error);
                suppliersData = [];
                showNotification('載入供應商資料失敗，請檢查資料庫連接', 'error');
            }
        }

        // 填充分類選擇下拉選單
        function populateCategorySelect() {
            const categorySelect = document.getElementById('productCategory');
            if (!categorySelect) {
                console.warn('populateCategorySelect: 找不到 #productCategory，略過更新');
                return;
            }
            
            // 清空現有選項（保留預設選項）
            categorySelect.innerHTML = '<option value="">請選擇分類</option>';
            
            // 添加分類選項
            categoriesData.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        }

        // 填充分類選擇下拉選單
        function populateSupplierSelect() {
            const supplierSelect = document.getElementById('productSupplier');
            if (!supplierSelect) {
                console.warn('populateSupplierSelect: 找不到 #productSupplier 元素');
                return;
            }
            
            console.log('populateSupplierSelect: 開始載入供應商選項，供應商數量:', suppliersData.length);
            
            // 清空現有選項
            supplierSelect.innerHTML = '';
            
            // 檢查是否有供應商數據
            if (suppliersData.length === 0) {
                supplierSelect.innerHTML = '<option value="">請先新增供應商</option>';
                console.log('populateSupplierSelect: 沒有供應商數據');
                return;
            }
            
            // 添加預設選項
            supplierSelect.innerHTML = '<option value="">請選擇供應商</option>';
            
            // 添加供應商選項
            suppliersData.forEach(supplier => {
                const option = document.createElement('option');
                // 根據外鍵約束，我們需要存儲供應商名稱，所以這裡使用名稱作為值
                option.value = supplier.name; // 使用供應商名稱作為值，符合外鍵約束
                option.textContent = supplier.name;
                supplierSelect.appendChild(option);
                console.log('新增供應商選項:', supplier.name, '值:', supplier.name);
            });
            
            console.log('populateSupplierSelect: 完成載入供應商選項');
        }

        // 渲染分類卡片
        function renderCategoryCards() {
            const categoriesGrid = document.getElementById('categoriesGrid');
            
            if (!categoriesGrid) return;
            
            // 清空現有內容
            categoriesGrid.innerHTML = '';
            
            // 為每個分類生成卡片
            categoriesData.forEach(category => {
                const categoryCard = createCategoryCard(category);
                categoriesGrid.appendChild(categoryCard);
            });
            
            // 重新綁定點擊事件
            bindCategoryCardEvents();
        }

        // 創建分類卡片
        function createCategoryCard(category) {
            const card = document.createElement('div');
            card.className = 'category-card apple-card rounded-xl p-6 shadow-md text-center';
            card.setAttribute('data-category', String(category.id));
            
            // 計算該分類的商品統計
            const categoryProducts = productData[String(category.id)] || [];
            const productCount = categoryProducts.length;
            const totalValue = categoryProducts.reduce((sum, product) => sum + (product.price * product.stock), 0);
            
            // 根據分類名稱選擇圖標和顏色
            const iconConfig = getCategoryIconConfig(category.name);
            
            card.innerHTML = `
                <div class="w-16 h-16 ${iconConfig.bgColor} rounded-full flex items-center justify-center mx-auto mb-4">
                    ${iconConfig.isSvg ? iconConfig.icon : `<i class="${iconConfig.icon} text-2xl ${iconConfig.textColor}"></i>`}
                </div>
                <h4 class="font-semibold text-gray-800 mb-2">${category.name}</h4>
                <p class="text-sm text-gray-600 mb-3">${category.description || '商品分類'}</p>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500">商品數量</span>
                    <span class="font-semibold text-[#17225e]">${productCount} 件</span>
                </div>
                <div class="flex justify-between text-sm mt-1">
                    <span class="text-gray-500">庫存價值</span>
                    <span class="font-semibold text-green-600">NT$${totalValue.toLocaleString()}</span>
                </div>
            `;
            
            return card;
        }

        // 根據分類名稱獲取圖標配置
        function getCategoryIconConfig(categoryName) {
            const configs = {
                '餐具': { icon: 'fas fa-utensils', bgColor: 'bg-gray-100', textColor: 'text-[#17225e]' },
                '酒具': { icon: 'fas fa-wine-glass', bgColor: 'bg-purple-100', textColor: 'text-purple-600' },
                '擺飾': { icon: 'fas fa-seedling', bgColor: 'bg-gray-100', textColor: 'text-[#17225e]' },
                '茶具': { icon: 'fas fa-coffee', bgColor: 'bg-pink-100', textColor: 'text-pink-600' },
                '廚具': { icon: 'fas fa-blender', bgColor: 'bg-gray-100', textColor: 'text-[#17225e]' },
                '電子': { icon: 'fas fa-mobile-alt', bgColor: 'bg-indigo-100', textColor: 'text-indigo-600' },
                '服飾': { icon: 'fas fa-tshirt', bgColor: 'bg-red-100', textColor: 'text-red-600' },
                '運動': { icon: 'fas fa-dumbbell', bgColor: 'bg-orange-100', textColor: 'text-orange-600' },
                '瓷器': { 
                    icon: `<svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                        <path d="M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/>
                        <circle cx="12" cy="12" r="2"/>
                    </svg>`, 
                    bgColor: 'bg-cyan-100', 
                    textColor: 'text-cyan-600',
                    isSvg: true
                },
                '家居': { 
                    icon: `<svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                        <path d="M8 12h8v2H8z"/>
                        <path d="M8 14h8v2H8z"/>
                        <path d="M8 16h6v2H8z"/>
                    </svg>`, 
                    bgColor: 'bg-amber-100', 
                    textColor: 'text-amber-600',
                    isSvg: true
                },
                '裝飾': { 
                    icon: `<svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        <path d="M12 6l1.5 3.13L17 9.27l-2.5 2.43.59 3.44L12 15.77l-3.09 1.37.59-3.44L7 9.27l3.5-.14L12 6z"/>
                    </svg>`, 
                    bgColor: 'bg-rose-100', 
                    textColor: 'text-rose-600',
                    isSvg: true
                }
            };
            
            // 根據分類名稱匹配最適合的配置
            for (const [key, config] of Object.entries(configs)) {
                if (categoryName.includes(key)) {
                    return config;
                }
            }
            
            // 預設配置
            return { icon: 'fas fa-box', bgColor: 'bg-gray-100', textColor: 'text-gray-600' };
        }

        // 綁定分類卡片事件
        function bindCategoryCardEvents() {
            document.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', function() {
                    const categoryId = this.getAttribute('data-category');
                    showCategory(categoryId);
                });
            });
        }

        // 顯示通知
        function showNotification(message, type = 'info') {
            const alertClass = {
                'success': 'bg-gray-100 border-[#17225e] text-gray-700',
                'error': 'bg-red-100 border-red-500 text-red-700',
                'warning': 'bg-gray-100 border-gray-500 text-gray-700',
                'info': 'bg-gray-100 border-[#17225e] text-gray-700'
            }[type];
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 border-l-4 p-4 rounded shadow-lg ${alertClass}`;
            notification.innerHTML = `
                <div class="flex">
                    <div class="flex-1">${message}</div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // 顯示新增供應商模態框
        function showAddSupplierModal() {
            document.getElementById('supplierModalTitle').textContent = '新增供應商';
            document.getElementById('supplierForm').reset();
            document.getElementById('addSupplierModal').classList.remove('hidden');
        }

        // 關閉供應商模態框
        function closeSupplierModal() {
            document.getElementById('addSupplierModal').classList.add('hidden');
        }

        // 處理新增供應商
        async function handleAddSupplier(e) {
            e.preventDefault();
            
            try {
                const supplierData = {
                    name: document.getElementById('supplierName').value,
                    contact_person: document.getElementById('contactPerson').value,
                    phone: document.getElementById('supplierPhone').value,
                    email: document.getElementById('supplierEmail').value,
                    address: document.getElementById('supplierAddress').value,
                    notes: document.getElementById('supplierNotes').value
                };

                // 驗證必填欄位
                if (!supplierData.name.trim()) {
                    showNotification('請輸入供應商名稱', 'error');
                    return;
                }

                // 新增供應商到資料庫
                const newSupplier = await BusinessAPI.addSupplier(supplierData);
                
                if (newSupplier) {
                    // 重新載入供應商資料並更新下拉選單
                    await loadSuppliersData();
                    
                    // 將新增的供應商ID填入商品表單的供應商欄位
                    document.getElementById('productSupplier').value = supplierData.id;
                    
                    closeSupplierModal();
                    showNotification('供應商新增成功！', 'success');
                } else {
                    showNotification('新增供應商失敗，請檢查資料庫連接', 'error');
                }
            } catch (error) {
                console.error('處理供應商資料時發生錯誤:', error);
                showNotification('操作失敗: ' + error.message, 'error');
            }
        }

        // 事件監聽
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOMContentLoaded 事件觸發');
            
            // 進行權限檢查
            const isAuthenticated = await checkAuthentication();
            if (!isAuthenticated) {
                console.log('認證失敗，重定向');
                return; // 如果未通過認證，函數會自動重定向
            }
            
            // 檢查商品管理權限
            const hasPermission = await checkPermission(['products', 'purchase']);
            if (!hasPermission) {
                return; // 權限不足，會顯示錯誤並重定向
            }
            
            console.log('認證成功，開始初始化頁面');
            
            // 啟動心跳機制
            console.log('🔄 Products頁面：啟動心跳機制');
            HeartbeatManager.checkAndStart();
            
            // 統一初始化資料庫
            console.log('初始化資料庫...');
            await DatabaseManager.initialize();
            
            // 載入商品資料
            console.log('載入商品資料...');
            await loadProductDataFromSupabase();
            
            // 載入分類資料
            console.log('載入分類資料...');
            await loadCategoriesData();
            
            // 載入供應商資料
            console.log('載入供應商資料...');
            await loadSuppliersData();

            // 更新統計
            console.log('更新統計...');
            updateStatistics();
            
            console.log('頁面初始化完成');

            // 返回按鈕點擊事件
            document.getElementById('backToCategories').addEventListener('click', backToCategories);

            // 新增商品按鈕
            document.getElementById('addProductBtn').addEventListener('click', function() {
                showAddProductModal();
            });



            // 供應商表單提交事件
            document.getElementById('supplierForm').addEventListener('submit', handleAddSupplier);
            
            // 新增商品表單提交事件
            document.getElementById('addProductForm').addEventListener('submit', handleAddProduct);
            
            // 編輯商品表單提交事件
            document.getElementById('editProductForm').addEventListener('submit', handleEditProduct);
        });

        // 統一導航函數
        function navigateToPage(page) {
            try {
                // 嘗試與父頁面通信切換iframe
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'navigate',
                        page: page
                    }, '*');
                } else {
                    // 如果不在iframe中，直接跳轉
                    window.location.href = `${page}.html`;
                }
            } catch (error) {
                // 備用方案：在新分頁中開啟
                window.open(`${page}.html`, '_blank');
            }
        }

        // 前往匯出/入頁面
        function goToImportExport() {
            navigateToPage('import-export');
        }





        // 編輯商品
        function editProduct(categoryId, index) {
            const product = productData[String(categoryId)][index];
            
            document.getElementById('editProductIndex').value = index;
            document.getElementById('editProductCategory').value = categoryId;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductBarcode').value = product.barcode;
            document.getElementById('editProductPrice').value = product.price;
            document.getElementById('editProductStock').value = product.stock;
            
            document.getElementById('editProductModal').classList.remove('hidden');
        }

        // 隱藏編輯商品模態框
        function hideEditProductModal() {
            document.getElementById('editProductModal').classList.add('hidden');
        }

        // 編輯商品表單提交處理函數
        function handleEditProduct(e) {
            e.preventDefault();
            
            const index = parseInt(document.getElementById('editProductIndex').value);
            const categoryId = document.getElementById('editProductCategory').value;
            const name = document.getElementById('editProductName').value.trim();
            const barcode = document.getElementById('editProductBarcode').value.trim();
            const price = parseInt(document.getElementById('editProductPrice').value);
            const stock = parseInt(document.getElementById('editProductStock').value);

            // 更新商品
            const product = productData[String(categoryId)][index];
            product.name = name;
            product.barcode = barcode;
            product.price = price;
            product.stock = stock;
            
            // 移除狀態更新，因為狀態將動態計算
            // const minStock = product.minStock || 10;
            // if (stock === 0) product.status = 'out';
            // else if (stock <= minStock) product.status = 'low';
            // else product.status = 'normal';

            saveProductData();

            // 重新渲染
            renderProducts(categoryId);
            updateStatistics();

            alert('商品更新成功！');
            hideEditProductModal();
        }

        // 刪除商品
        function deleteProduct() {
            if (confirm('確定要刪除此商品嗎？此操作無法復原。')) {
                const index = parseInt(document.getElementById('editProductIndex').value);
                const categoryId = document.getElementById('editProductCategory').value;
                
                productData[String(categoryId)].splice(index, 1);
                saveProductData();
                
                renderProducts(categoryId);
                updateStatistics();
                
                alert('商品已刪除');
                hideEditProductModal();
            }
        }

        // 查看商品詳情
        function viewProduct(categoryId, index) {
            const product = productData[String(categoryId)][index];
            
            const details = `
商品詳情：

名稱：${product.name}
條碼：${product.barcode}
售價：NT$${product.price.toLocaleString()}
庫存：${product.stock} 件
狀態：${getStatusText(calculateProductStatus(product))}
${product.cost ? '成本：NT$' + product.cost.toLocaleString() : ''}
${product.supplier ? '供應商：' + product.supplier : ''}
${product.description ? '描述：' + product.description : ''}
            `.trim();
            
            alert(details);
        }

        // 搜尋商品
        function searchProducts() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!currentCategory) return;
            
            let products = [...productData[String(currentCategory)]];
            
            if (query) {
                products = products.filter(product => 
                    product.name.toLowerCase().includes(query) ||
                    product.barcode.includes(query)
                );
            }
            
            renderFilteredProducts(products);
        }

        // 篩選商品
        function filterProducts() {
            const stockFilter = document.getElementById('stockFilter').value;
            
            if (!currentCategory) return;
            
            let products = [...productData[String(currentCategory)]];
            
            // 應用搜尋篩選
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            if (query) {
                products = products.filter(product => 
                    product.name.toLowerCase().includes(query) ||
                    product.barcode.includes(query)
                );
            }
            
            // 應用庫存篩選
            if (stockFilter) {
                products = products.filter(product => calculateProductStatus(product) === stockFilter);
            }
            
            renderFilteredProducts(products);
        }

        // 已移除排序功能

        // 渲染篩選後的商品
        function renderFilteredProducts(products) {
            const gridView = document.getElementById('gridView');
            const listView = document.getElementById('listView');
            
            document.getElementById('productCount').textContent = `共 ${products.length} 項商品`;
            
            // 網格檢視
            gridView.innerHTML = products.map((product, index) => `
                <div class="product-card bg-white rounded-lg p-3 shadow-md">
                    <div class="relative mb-3">
                        <div class="w-full h-20 bg-gray-100 rounded flex items-center justify-center">
                            <i class="fas fa-box text-gray-400 text-2xl"></i>
                        </div>
                        <div class="absolute top-1 right-1">
                            <span class="bg-${getStatusColor(calculateProductStatus(product))}-100 text-${getStatusColor(calculateProductStatus(product))}-800 text-xs px-1 py-0.5 rounded-full">
                                ${getStatusText(calculateProductStatus(product))}
                            </span>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-800 text-sm mb-1 truncate">${product.name}</h4>
                        <p class="text-xs text-gray-600 mb-2">條碼: ${product.barcode}</p>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-600">售價</span>
                            <span class="font-bold text-[#17225e] text-sm">NT$${product.price.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-xs text-gray-600">庫存</span>
                            <span class="font-semibold ${product.stock > 10 ? 'text-green-600' : product.stock > 0 ? 'text-orange-600' : 'text-red-600'} text-sm">${product.stock} 件</span>
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="editProductFromFiltered('${currentCategory}', '${product.barcode}')" class="flex-1 bg-[#17225e] text-white py-1.5 rounded text-xs hover:bg-[#1a2a6e] transition-colors">
                                <i class="fas fa-edit mr-1"></i>編輯
                            </button>
                            <button onclick="viewProductFromFiltered('${currentCategory}', '${product.barcode}')" class="px-2 py-1.5 border border-gray-300 rounded text-xs hover:bg-gray-50 transition-colors">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            // 列表檢視
            listView.innerHTML = products.map((product, index) => `
                <div class="flex items-center space-x-4 p-3 bg-white rounded-lg shadow-sm">
                    <div class="w-12 h-12 bg-gray-100 rounded flex items-center justify-center">
                        <i class="fas fa-box text-gray-400"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="font-medium text-gray-800">${product.name}</h4>
                        <p class="text-sm text-gray-600">條碼: ${product.barcode}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-gray-600">售價</p>
                        <p class="font-bold text-[#17225e]">NT$${product.price.toLocaleString()}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-gray-600">庫存</p>
                        <p class="font-semibold ${product.stock > 10 ? 'text-green-600' : product.stock > 0 ? 'text-orange-600' : 'text-red-600'}">${product.stock} 件</p>
                    </div>
                    <div class="text-center">
                        <span class="inline-block bg-${getStatusColor(calculateProductStatus(product))}-100 text-${getStatusColor(calculateProductStatus(product))}-800 text-xs px-2 py-1 rounded-full">
                            ${getStatusText(calculateProductStatus(product))}
                        </span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editProductFromFiltered('${currentCategory}', '${product.barcode}')" class="bg-[#17225e] text-white px-3 py-1 rounded text-sm hover:bg-[#1a2a6e] transition-colors">
                            <i class="fas fa-edit mr-1"></i>編輯
                        </button>
                        <button onclick="viewProductFromFiltered('${currentCategory}', '${product.barcode}')" class="px-2 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50 transition-colors">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 從篩選結果編輯商品
        function editProductFromFiltered(categoryId, barcode) {
            const index = productData[String(categoryId)].findIndex(product => product.barcode === barcode);
            if (index !== -1) {
                editProduct(categoryId, index);
            }
        }

        // 從篩選結果查看商品
        function viewProductFromFiltered(categoryId, barcode) {
            const index = productData[String(categoryId)].findIndex(product => product.barcode === barcode);
            if (index !== -1) {
                viewProduct(categoryId, index);
            }
        }

        // 更新統計數據
        function updateStatistics() {
            let totalProducts = 0;
            let inStock = 0;
            let lowStock = 0;
            let outOfStock = 0;

            for (const category in productData) {
                productData[category].forEach(product => {
                    totalProducts++;
                    const status = calculateProductStatus(product);
                    if (status === 'normal') inStock++;
                    else if (status === 'low') lowStock++;
                    else if (status === 'out') outOfStock++;
                });
            }

            // 更新統計卡片
            const statsCards = document.querySelectorAll('.apple-card p.text-2xl');
            if (statsCards.length >= 4) {
                statsCards[0].textContent = totalProducts;
                statsCards[1].textContent = inStock;
                statsCards[2].textContent = lowStock;
                statsCards[3].textContent = outOfStock;
            }
        }

        // 初始化統計
        updateStatistics();

        // 回到主頁面
        function goBackToMenu() {
            window.location.href = '../index.html';
        }

        // 顯示盤點作業彈出視窗
        function showStockTakingModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">盤點作業</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 盤點清單 -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">盤點清單</h4>
                            <div class="space-y-2 max-h-96 overflow-y-auto" id="stockTakingList">
                                <!-- 盤點項目將動態添加 -->
                            </div>
                        </div>
                        
                        <!-- 盤點統計 -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">盤點統計</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                                    <span class="text-gray-700">總商品數</span>
                                    <span class="font-semibold text-[#17225e]" id="stockTakingTotal">0</span>
                                </div>
                                <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                                    <span class="text-gray-700">已盤點</span>
                                    <span class="font-semibold text-green-600" id="stockTakingCounted">0</span>
                                </div>
                                <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                                    <span class="text-gray-700">差異項目</span>
                                    <span class="font-semibold text-yellow-600" id="stockTakingDiff">0</span>
                                </div>
                            </div>
                            
                            <div class="mt-6 space-y-3">
                                <button onclick="startStockTaking()" class="w-full bg-[#17225e] text-white py-2 rounded-lg hover:bg-[#1a2a6e] transition-colors">
                                    <i class="fas fa-play mr-2"></i>開始盤點
                                </button>
                                <button onclick="exportStockTakingReport()" class="w-full bg-[#17225e] text-white py-2 rounded-lg hover:bg-[#1a2a6e] transition-colors">
                                    <i class="fas fa-download mr-2"></i>匯出盤點報告
                                </button>
                                <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                    關閉
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            loadStockTakingList();
        }

        // 載入盤點清單
        function loadStockTakingList() {
            const container = document.getElementById('stockTakingList');
            if (!container) return;
            
            let allProducts = [];
            for (const category in productData) {
                allProducts = allProducts.concat(productData[category]);
            }
            
            container.innerHTML = allProducts.map(product => `
                <div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg">
                    <div class="flex-1">
                        <h5 class="font-medium text-gray-800">${product.name}</h5>
                        <p class="text-sm text-gray-600">條碼: ${product.barcode}</p>
                    </div>
                    <div class="text-center mx-4">
                        <p class="text-xs text-gray-600">系統庫存</p>
                        <p class="font-semibold text-[#17225e]">${product.stock}</p>
                    </div>
                    <div class="text-center mx-4">
                        <p class="text-xs text-gray-600">實際庫存</p>
                        <input type="number" min="0" value="${product.stock}" 
                               class="w-16 px-2 py-1 border border-gray-300 rounded text-center text-sm"
                               onchange="updateStockTakingCount()">
                    </div>
                    <div class="text-center mx-4">
                        <p class="text-xs text-gray-600">差異</p>
                        <p class="font-semibold text-gray-600" id="diff-${product.barcode}">0</p>
                    </div>
                </div>
            `).join('');
            
            updateStockTakingCount();
        }

        // 更新盤點統計
        function updateStockTakingCount() {
            const inputs = document.querySelectorAll('#stockTakingList input[type="number"]');
            let total = inputs.length;
            let counted = 0;
            let diffCount = 0;
            
            inputs.forEach(input => {
                const barcode = input.closest('div').querySelector('p').textContent.split(': ')[1];
                const systemStock = parseInt(input.defaultValue);
                const actualStock = parseInt(input.value) || 0;
                const diff = actualStock - systemStock;
                
                const diffElement = document.getElementById(`diff-${barcode}`);
                if (diffElement) {
                    diffElement.textContent = diff;
                    diffElement.className = `font-semibold ${diff === 0 ? 'text-gray-600' : diff > 0 ? 'text-green-600' : 'text-red-600'}`;
                }
                
                if (actualStock !== systemStock) {
                    diffCount++;
                }
                counted++;
            });
            
            document.getElementById('stockTakingTotal').textContent = total;
            document.getElementById('stockTakingCounted').textContent = counted;
            document.getElementById('stockTakingDiff').textContent = diffCount;
        }

        // 開始盤點
        function startStockTaking() {
            const inputs = document.querySelectorAll('#stockTakingList input[type="number"]');
            const stockTakingData = [];
            
            inputs.forEach(input => {
                const productDiv = input.closest('div');
                const name = productDiv.querySelector('h5').textContent;
                const barcode = productDiv.querySelector('p').textContent.split(': ')[1];
                const systemStock = parseInt(input.defaultValue);
                const actualStock = parseInt(input.value) || 0;
                
                stockTakingData.push({
                    name,
                    barcode,
                    systemStock,
                    actualStock,
                    difference: actualStock - systemStock
                });
            });
            
            // 儲存盤點數據
            localStorage.setItem('stockTakingData', JSON.stringify(stockTakingData));
            alert('盤點數據已儲存！');
        }

        // 匯出盤點報告
        function exportStockTakingReport() {
            const stockTakingData = JSON.parse(localStorage.getItem('stockTakingData') || '[]');
            if (stockTakingData.length === 0) {
                alert('沒有盤點數據可匯出');
                return;
            }
            
            const report = {
                date: new Date().toISOString(),
                total: stockTakingData.length,
                counted: stockTakingData.length,
                differences: stockTakingData.filter(item => item.difference !== 0).length,
                items: stockTakingData
            };
            
            const dataStr = JSON.stringify(report, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `stock_taking_report_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            alert('盤點報告匯出成功！');
        }

        // 載入分類數據用於模態框
        async function loadCategoriesForModal() {
            try {
                // 優先從 Supabase 載入
                const cats = await BusinessAPI.getCategories();
                categoriesData = Array.isArray(cats) ? cats : [];

                // 正規化並計算商品數
                const normalized = categoriesData
                    .map(cat => ({
                        id: cat.id,
                        name: cat.name,
                        description: cat.description || '',
                        color: cat.color || 'blue',
                        productCount: (productData[String(cat.id)] || []).length
                    }));

                updateCategoriesForModal(normalized);
                updateModalStatistics(normalized);
            } catch (error) {
                console.error('載入分類（模態框）失敗:', error);
                // 後備：用目前已載入的 categoriesData
                const fallback = (categoriesData || []).map(cat => ({
                    id: cat.id,
                    name: cat.name,
                    description: cat.description || '',
                    color: cat.color || 'blue',
                    order: cat.order || 1,
                    productCount: (productData[String(cat.id)] || []).length
                }));
                updateCategoriesForModal(fallback);
                updateModalStatistics(fallback);
            }
        }

        // 更新模態框中的分類列表
        function updateCategoriesForModal(categories) {
            const container = document.getElementById('modalCategoriesList');
            if (!container) return;
            
            container.innerHTML = categories.map(category => `
                <div class="category-item apple-card rounded-xl p-4 shadow-md">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-4 h-4 rounded-full bg-${category.color}-500 mr-3"></div>
                            <h4 class="text-lg font-semibold text-gray-800">${category.name}</h4>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editCategory('${category.id}')" class="text-[#17225e] hover:text-[#1a2a6e]">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteCategory('${category.id}')" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm mb-3">${category.description}</p>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-500">商品數量：${category.productCount}</span>
                    </div>
                </div>
            `).join('');
        }

        // 更新模態框統計
        function updateModalStatistics(categories) {
            // 總分類數
            document.getElementById('modalTotalCategories').textContent = categories.length;

            // 總商品數（以目前載入的 productData 為準）
            const totalProducts = Object.values(productData).reduce((sum, arr) => sum + (Array.isArray(arr) ? arr.length : 0), 0);
            document.getElementById('modalTotalProducts').textContent = totalProducts;

            // 計算每個分類的商品數量
            const countsById = {};
            Object.keys(productData).forEach(catId => {
                countsById[catId] = (productData[catId] || []).length;
            });

            // 找出熱門分類（顯示分類名稱）
            let popularCategory = '-';
            let maxCount = 0;
            categories.forEach(cat => {
                const count = countsById[String(cat.id)] || 0;
                if (count > maxCount) {
                    maxCount = count;
                    popularCategory = cat.name;
                }
            });
            document.getElementById('modalPopularCategory').textContent = popularCategory;

            // 空分類數
            const emptyCount = categories.filter(cat => (countsById[String(cat.id)] || 0) === 0).length;
            document.getElementById('modalEmptyCategories').textContent = emptyCount;
        }

        // 顯示新增分類模態框
        function showAddCategoryModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">新增分類</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form id="categoryForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">分類名稱</label>
                            <input type="text" id="categoryName" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">分類描述</label>
                            <textarea id="categoryDescription" rows="3" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">分類顏色</label>
                            <select id="categoryColor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                                <option value="blue">藍色</option>
                                <option value="green">綠色</option>
                                <option value="yellow">黃色</option>
                                <option value="red">紅色</option>
                                <option value="purple">紫色</option>
                                <option value="pink">粉色</option>
                                <option value="indigo">靛藍</option>
                                <option value="gray">灰色</option>
                            </select>
                        </div>
                        
                        <div>
                            
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                                取消
                            </button>
                            <button type="submit" 
                                    class="px-4 py-2 bg-[#17225e] text-white rounded-lg hover:bg-[#1a2a6e] transition-colors">
                                儲存
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // 表單提交事件
            document.getElementById('categoryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveCategory();
            });
        }

        // 儲存分類
        async function saveCategory() {
            const name = document.getElementById('categoryName').value.trim();
            const description = document.getElementById('categoryDescription').value.trim();
            const color = document.getElementById('categoryColor').value;

            if (!name) {
                alert('請輸入分類名稱');
                return;
            }

            try {
                // 重新從資料庫載入最新分類資料以確保檢查準確性
                await loadCategoriesData();
                
                // 以最新的 categoriesData 檢查名稱重複
                const duplicate = (categoriesData || []).some(cat => String(cat.name).trim() === name);
                if (duplicate) {
                    alert('分類名稱已存在，請使用不同的名稱');
                    return;
                }
                
                // 設定分類排序順序，使用現有分類數量 + 1 作為新分類的順序
                const order = (categoriesData || []).length + 1;

                const payload = { name, description, color, order };
                const created = await BusinessAPI.addCategory(payload);
                if (!created) {
                    alert('分類新增失敗，請檢查資料庫連接或分類名稱是否重複');
                    return;
                }

                // 重新載入分類，刷新主畫面與模態框列表
                await loadCategoriesData();
                renderCategoryCards();
                const addCatModal = document.getElementById('categoryForm')?.closest('.fixed');
                if (addCatModal) addCatModal.remove();
                await loadCategoriesForModal();
                alert('分類新增成功！');
            } catch (error) {
                console.error('新增分類失敗:', error);
                
                // 根據錯誤類型提供更友善的訊息
                let errorMessage = '分類新增失敗';
                if (error.message && error.message.includes('duplicate key')) {
                    errorMessage = '分類名稱已存在，請使用不同的名稱';
                } else if (error.message && error.message.includes('unique constraint')) {
                    errorMessage = '分類名稱已存在，請使用不同的名稱';
                } else if (error.message) {
                    errorMessage = '分類新增失敗：' + error.message;
                } else {
                    errorMessage = '分類新增失敗：未知錯誤，請檢查網路連接';
                }
                
                alert(errorMessage);
            }
        }

        // 編輯分類
        function editCategory(categoryId) {
            // 從目前的 categoriesData 取得分類
            const category = (categoriesData || []).find(cat => String(cat.id) === String(categoryId));
            if (!category) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">編輯分類</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form id="editCategoryForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">分類名稱</label>
                            <input type="text" id="editCategoryName" value="${category.name}" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">分類描述</label>
                            <textarea id="editCategoryDescription" rows="3" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">${category.description}</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">分類顏色</label>
                            <select id="editCategoryColor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                                <option value="blue" ${category.color === 'blue' ? 'selected' : ''}>藍色</option>
                                <option value="green" ${category.color === 'green' ? 'selected' : ''}>綠色</option>
                                <option value="yellow" ${category.color === 'yellow' ? 'selected' : ''}>黃色</option>
                                <option value="red" ${category.color === 'red' ? 'selected' : ''}>紅色</option>
                                <option value="purple" ${category.color === 'purple' ? 'selected' : ''}>紫色</option>
                                <option value="pink" ${category.color === 'pink' ? 'selected' : ''}>粉色</option>
                                <option value="indigo" ${category.color === 'indigo' ? 'selected' : ''}>靛藍</option>
                                <option value="gray" ${category.color === 'gray' ? 'selected' : ''}>灰色</option>
                            </select>
                        </div>
                        
                        <div>
                            
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                                取消
                            </button>
                            <button type="submit" 
                                    class="px-4 py-2 bg-[#17225e] text-white rounded-lg hover:bg-[#1a2a6e] transition-colors">
                                儲存
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // 表單提交事件
            document.getElementById('editCategoryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                updateCategory(categoryId);
            });
        }

        // 更新分類
        async function updateCategory(categoryId) {
            const name = document.getElementById('editCategoryName').value.trim();
            const description = document.getElementById('editCategoryDescription').value.trim();
            const color = document.getElementById('editCategoryColor').value;
            
            // 保持原有的排序順序，或使用預設值
            const currentCategory = (categoriesData || []).find(cat => String(cat.id) === String(categoryId));
            const order = currentCategory ? currentCategory.order : 1;
            
            if (!name) {
                alert('請輸入分類名稱');
                return;
            }
            
            // 檢查是否有重複的分類名稱（排除自己）
            const nameDup = (categoriesData || []).some(cat => String(cat.name).trim() === name && String(cat.id) !== String(categoryId));
            if (nameDup) {
                alert('分類名稱已存在，請使用不同的名稱');
                return;
            }

            try {
                const updated = await BusinessAPI.updateCategory(categoryId, { name, description, color, order });
                if (!updated) {
                    alert('分類更新失敗，請檢查資料庫連接');
                    return;
                }

                await loadCategoriesData();
                renderCategoryCards();
                const editCatModal = document.getElementById('editCategoryForm')?.closest('.fixed');
                if (editCatModal) editCatModal.remove();
                await loadCategoriesForModal();
                alert('分類更新成功！');
            } catch (error) {
                console.error('更新分類失敗:', error);
                alert('分類更新失敗：' + (error.message || '未知錯誤'));
            }
        }

        // 刪除分類
        async function deleteCategory(categoryId) {
            // 以目前的 categoriesData 取得分類
            const category = (categoriesData || []).find(cat => String(cat.id) === String(categoryId));
            if (!category) return;
            
            // 計算該分類商品數量（以當前 productData 為準）
            const productCount = (productData[String(categoryId)] || []).length;
            
            if (productCount > 0) {
                alert(`無法刪除包含 ${productCount} 個商品的分類！\n請先將商品移至其他分類。`);
                return;
            }
            
            const confirmDelete = confirm(`確定要刪除分類「${category.name}」嗎？`);
            if (!confirmDelete) return;

            try {
                const ok = await BusinessAPI.deleteCategory(categoryId);
                if (!ok) {
                    alert('分類刪除失敗，請檢查資料庫連接');
                    return;
                }
                await loadCategoriesData();
                renderCategoryCards();
                await loadCategoriesForModal();
                alert('分類刪除成功！');
            } catch (error) {
                console.error('刪除分類失敗:', error);
                alert('分類刪除失敗：' + (error.message || '未知錯誤'));
            }
        }

        // 匯出分類
        function exportCategories() {
            const categories = (categoriesData || []).map(cat => ({
                id: cat.id,
                name: cat.name,
                description: cat.description || '',
                color: cat.color || 'blue'
            }));
            if (categories.length === 0) {
                alert('沒有分類數據可匯出');
                return;
            }

            // 轉換為CSV格式
            const csvHeaders = ['ID', '分類名稱', '描述', '顏色'];
            const csvRows = categories.map(cat => [
                cat.id,
                `"${cat.name}"`, // 用引號包圍以防逗號問題
                `"${cat.description}"`,
                cat.color
            ]);

            // 組合CSV內容
            const csvContent = [
                csvHeaders.join(','), // 標題行
                ...csvRows.map(row => row.join(',')) // 數據行
            ].join('\n');

            // 添加BOM以支援中文顯示
            const BOM = '\uFEFF';
            const dataBlob = new Blob([BOM + csvContent], {type: 'text/csv;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `categories_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            URL.revokeObjectURL(url);
            alert('分類匯出成功！已儲存為CSV格式');
        }

        // 顯示匯入分類模態框
        function showImportCategoryModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">匯入分類</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">選擇檔案</label>
                            <input type="file" id="importCategoryFile" accept=".json,.csv" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                        </div>
                        
                        <div class="p-3 bg-gray-50 border border-gray-200 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle text-[#17225e] mr-2"></i>
                                <span class="text-sm text-gray-700">支援 JSON 和 CSV 格式</span>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                                取消
                            </button>
                            <button onclick="importCategories()" 
                                    class="px-4 py-2 bg-[#17225e] text-white rounded-lg hover:bg-[#1a2a6e] transition-colors">
                                匯入
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 匯入分類
        async function importCategories() {
            const fileInput = document.getElementById('importCategoryFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('請選擇檔案');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    let importedCategories;
                    
                    if (file.name.endsWith('.json')) {
                        importedCategories = JSON.parse(e.target.result);
                    } else if (file.name.endsWith('.csv')) {
                        importedCategories = parseCategoryCSV(e.target.result);
                    } else {
                        alert('不支援的檔案格式');
                        return;
                    }
                    
                    if (Array.isArray(importedCategories)) {
                        // 移除非法欄位並去重（以名稱為準）
                        const toInsert = [];
                        const existingNames = new Set((categoriesData || []).map(c => String(c.name).trim()));
                        importedCategories.forEach(c => {
                            const name = String(c.name || '').trim();
                            if (!name || existingNames.has(name)) return;
                            toInsert.push({
                                name,
                                description: c.description || '',
                                color: c.color || 'blue'
                            });
                            existingNames.add(name);
                        });

                        if (toInsert.length === 0) {
                            alert('沒有可匯入的分類（可能都已存在或資料無效）');
                            return;
                        }

                        // 逐筆新增到資料庫（也可改用批量）
                        for (const payload of toInsert) {
                            await BusinessAPI.addCategory(payload);
                        }

                        await loadCategoriesData();
                        renderCategoryCards();
                        const importCatModal = document.getElementById('importCategoryFile')?.closest('.fixed');
                        if (importCatModal) importCatModal.remove();
                        await loadCategoriesForModal();
                        alert(`成功匯入 ${toInsert.length} 個分類！`);
                    } else {
                        alert('檔案格式錯誤');
                    }
                } catch (error) {
                    alert('匯入失敗：' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // 解析分類CSV
        function parseCategoryCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const categories = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.trim());
                    const category = {};
                    headers.forEach((header, index) => {
                        category[header] = values[index] || '';
                    });
                    categories.push(category);
                }
            }
            
            return categories;
        }

        // 頁面載入時初始化（已合併到主要的DOMContentLoaded事件中）

        // 測試資料庫連接
        async function testDatabaseConnection() {
            try {
                console.log('=== 開始測試資料庫連接 ===');
                
                // 檢查全域變數
                console.log('DatabaseManager 狀態:', typeof DatabaseManager);
                console.log('BusinessAPI 狀態:', typeof BusinessAPI);
                console.log('supabase 狀態:', typeof window.supabase);
                
                // 檢查資料庫管理器狀態
                if (typeof DatabaseManager !== 'undefined') {
                    console.log('DatabaseManager 連接狀態:', DatabaseManager.getStatus());
                    console.log('DatabaseManager 是否已初始化:', DatabaseManager.isInitialized);
                }
                
                // 測試資料庫初始化
                console.log('嘗試初始化資料庫...');
                const initSuccess = await DatabaseManager.initialize();
                console.log('資料庫初始化結果:', initSuccess);
                
                if (initSuccess) {
                    // 測試基本查詢
                    console.log('測試基本查詢...');
                    const categories = await BusinessAPI.getCategories();
                    console.log('分類查詢結果:', categories);
                    
                    const suppliers = await BusinessAPI.getSuppliers();
                    console.log('供應商查詢結果:', suppliers);
                    
                    const products = await BusinessAPI.getProducts();
                    console.log('商品查詢結果:', products);
                    
                    alert('資料庫連接測試成功！\n\n' +
                          '連接狀態: ' + DatabaseManager.getStatus() + '\n' +
                          '分類數量: ' + (categories ? categories.length : '查詢失敗') + '\n' +
                          '供應商數量: ' + (suppliers ? suppliers.length : '查詢失敗') + '\n' +
                          '商品數量: ' + (products ? products.length : '查詢失敗'));
                } else {
                    alert('資料庫連接測試失敗！\n請檢查網路連線和Supabase設定。');
                }
                
            } catch (error) {
                console.error('資料庫連接測試失敗:', error);
                alert('資料庫連接測試失敗！\n錯誤: ' + error.message);
            }
        }

        // 新增商品表單提交處理函數
    </script>
</body>
</html> 