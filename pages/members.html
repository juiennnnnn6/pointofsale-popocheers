<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒå“¡ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../employee-auth.js"></script>
    <script src="auth-check.js"></script>
    <script src="../database.js"></script>
    <script src="../heartbeat.js"></script>
    <script>
        // ç°¡å–®çš„èªè­‰æª¢æŸ¥æ¸¬è©¦
        console.log('=== members.html è…³æœ¬è¼‰å…¥æ¸¬è©¦ ===');
        console.log('employee-auth.js æ˜¯å¦è¼‰å…¥:', typeof EmployeeAuth !== 'undefined');
        console.log('auth-check.js æ˜¯å¦è¼‰å…¥:', typeof checkAuthentication !== 'undefined');
        console.log('database.js æ˜¯å¦è¼‰å…¥:', typeof BusinessAPI !== 'undefined');
    </script>
    <style>
        .apple-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .member-card {
            transition: all 0.3s ease;
        }
        .member-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .modal {
            backdrop-filter: blur(5px);
        }
        .member-avatar {
            background: linear-gradient(135deg, #17225e 0%, #1a2a6e 100%);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen p-4">
    
    <!-- é ‚éƒ¨æ“ä½œå€ -->
    <div class="mb-6">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">æœƒå“¡ç®¡ç†</h1>
                <p class="text-gray-600">æ–°å¢ã€ç·¨è¼¯å’Œç®¡ç†æœƒå“¡è³‡æ–™</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="goBackToMenu()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-th-large mr-2"></i>å›é¸å–®
                </button>
                <button onclick="showAddMemberModal()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-user-plus mr-2"></i>æ–°å¢æœƒå“¡
                </button>
                <button onclick="exportMembers()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-file-export mr-2"></i>åŒ¯å‡ºæœƒå“¡
                </button>
                <button onclick="showImportModal()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-file-import mr-2"></i>åŒ¯å…¥æœƒå“¡
                </button>
                <button onclick="showBatchDeleteModal()" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600 transition-colors">
                    <i class="fas fa-trash mr-2"></i>æ‰¹é‡åˆªé™¤
                </button>
            </div>
        </div>
    </div>

    <!-- æœƒå“¡çµ±è¨ˆå¡ç‰‡ -->
    <!-- æœç´¢å’Œç¯©é¸å€ -->
    <div class="apple-card rounded-xl p-6 mb-6 shadow-lg">
        <div class="flex flex-col lg:flex-row lg:items-center gap-4">
            <!-- ç¸½æœƒå“¡æ•¸ -->
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-users text-[#17225e]"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">ç¸½æœƒå“¡æ•¸</p>
                        <p class="text-2xl font-bold text-[#17225e]" id="totalMembers">0</p>
                    </div>
                </div>
            </div>
            
            <div class="flex-1">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="æœç´¢æœƒå“¡å§“åã€é›»è©±æˆ–éƒµç®±..." 
                           class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="performSearch()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-search mr-2"></i>æœç´¢
                </button>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleViewMode('grid')" id="gridViewBtn" class="bg-[#17225e] text-white px-3 py-2 rounded-lg hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-th"></i>
                </button>
                <button onclick="toggleViewMode('list')" id="listViewBtn" class="bg-gray-300 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                    <i class="fas fa-list"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- æœƒå“¡åˆ—è¡¨ - å¡ç‰‡è¦–åœ– -->
    <div id="gridView" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-6">
        <!-- æœƒå“¡å¡ç‰‡å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
    </div>

    <!-- æœƒå“¡åˆ—è¡¨ - è¡¨æ ¼è¦–åœ– -->
    <div id="listView" class="apple-card rounded-xl shadow-lg overflow-hidden" style="display: none;">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">æœƒå“¡</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">è¯çµ¡è³‡è¨Š</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">åœ°å€</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">å‚™è¨»</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="memberTableBody">
                    <!-- æœƒå“¡åˆ—è¡¨å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- æ–°å¢æœƒå“¡æ¨¡æ…‹æ¡† -->
    <div id="addMemberModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-800">æ–°å¢æœƒå“¡</h2>
                        <button onclick="hideAddMemberModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form id="addMemberForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">å§“å *</label>
                                <input type="text" id="memberName" required 
                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">é›»è©± *</label>
                                <input type="tel" id="memberPhone" required 
                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">éƒµç®±</label>
                                <input type="email" id="memberEmail" 
                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">åœ°å€</label>
                                <input type="text" id="memberAddress" 
                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
                            <textarea id="memberNotes" rows="3" 
                                      class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent"
                                      placeholder="è«‹è¼¸å…¥æœƒå“¡å‚™è¨»è³‡è¨Š..."></textarea>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="hideAddMemberModal()" 
                                    class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                                å–æ¶ˆ
                            </button>
                            <button type="submit" 
                                    class="bg-[#17225e] text-white px-4 py-2 rounded-lg hover:bg-[#1a2a6e] transition-colors">
                                <i class="fas fa-save mr-2"></i>å„²å­˜
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯æœƒå“¡æ¨¡æ…‹æ¡† -->
    <div id="editMemberModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-800">ç·¨è¼¯æœƒå“¡</h2>
                        <button onclick="hideEditMemberModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form id="editMemberForm" class="space-y-4">
                        <input type="hidden" id="editMemberId">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">å§“å *</label>
                                <input type="text" id="editMemberName" required 
                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">é›»è©± *</label>
                                <input type="tel" id="editMemberPhone" required 
                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">éƒµç®±</label>
                                <input type="email" id="editMemberEmail" 
                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">åœ°å€</label>
                                <input type="text" id="editMemberAddress" 
                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
                            <textarea id="editMemberNotes" rows="3" 
                                      class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent"
                                      placeholder="è«‹è¼¸å…¥æœƒå“¡å‚™è¨»è³‡è¨Š..."></textarea>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="hideEditMemberModal()" 
                                    class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                                å–æ¶ˆ
                            </button>
                            <button type="submit" 
                                    class="bg-[#17225e] text-white px-4 py-2 rounded-lg hover:bg-[#1a2a6e] transition-colors">
                                <i class="fas fa-save mr-2"></i>æ›´æ–°
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- æœç´¢çµæœå½ˆçª— -->
    <div id="searchResultModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800" id="searchResultTitle">æœç´¢çµæœ</h3>
                <button onclick="closeSearchResultModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="searchResultContent">
                <!-- æœç´¢çµæœå°‡åœ¨é€™è£¡é¡¯ç¤º -->
            </div>
        </div>
    </div>

    <!-- åˆªé™¤ç¢ºèªæ¨¡æ…‹æ¡† -->
    <div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden z-[60] flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
                    ç¢ºèªåˆªé™¤
                </h3>
                <button onclick="closeDeleteConfirmModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div id="deleteConfirmContent">
                    <!-- åˆªé™¤ç¢ºèªå…§å®¹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
                
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-red-500 mt-1 mr-3"></i>
                        <div class="text-sm text-red-700">
                            <p class="font-semibold mb-1">æ³¨æ„äº‹é …ï¼š</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li>æ­¤æ“ä½œç„¡æ³•å¾©åŸ</li>
                                <li>ç›¸é—œçš„è¨‚å–®è¨˜éŒ„å°‡ä¿ç•™</li>
                                <li>å»ºè­°å…ˆå‚™ä»½é‡è¦è³‡æ–™</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button onclick="closeDeleteConfirmModal()" 
                            class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                        å–æ¶ˆ
                    </button>
                    <button id="confirmDeleteBtn" 
                            class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors">
                        <i class="fas fa-trash mr-2"></i>ç¢ºèªåˆªé™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡åˆªé™¤æ¨¡æ…‹æ¡† -->
    <div id="batchDeleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-users-cog text-red-500 mr-3"></i>
                    æ‰¹é‡åˆªé™¤æœƒå“¡
                </h3>
                <button onclick="closeBatchDeleteModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- é¸æ“‡æ§åˆ¶ -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <button onclick="selectAllMembers()" class="text-[#17225e] hover:text-[#1a2a6e] text-sm">
                            <i class="fas fa-check-square mr-1"></i>å…¨é¸
                        </button>
                        <button onclick="deselectAllMembers()" class="text-gray-600 hover:text-gray-800 text-sm">
                            <i class="fas fa-square mr-1"></i>å–æ¶ˆå…¨é¸
                        </button>
                    </div>
                    <div class="text-sm text-gray-600">
                        å·²é¸æ“‡ <span id="selectedCount">0</span> å€‹æœƒå“¡
                    </div>
                </div>

                <!-- é¸ä¸­çš„æœƒå“¡åˆ—è¡¨ -->
                <div id="selectedMembersList" class="bg-gray-50 rounded-lg p-4 max-h-60 overflow-y-auto">
                    <p class="text-gray-500 text-center">è«‹é¸æ“‡è¦åˆªé™¤çš„æœƒå“¡</p>
                </div>

                <!-- è­¦å‘Šä¿¡æ¯ -->
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-red-500 mt-1 mr-3"></i>
                        <div class="text-sm text-red-700">
                            <p class="font-semibold mb-1">é‡è¦è­¦å‘Šï¼š</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li>æ‰¹é‡åˆªé™¤æ“ä½œç„¡æ³•å¾©åŸ</li>
                                <li>å°‡æ°¸ä¹…åˆªé™¤é¸ä¸­çš„æ‰€æœ‰æœƒå“¡è³‡æ–™</li>
                                <li>å»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½å†é€²è¡Œæ“ä½œ</li>
                                <li>ç›¸é—œçš„è¨‚å–®è¨˜éŒ„å°‡ä¿ç•™</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="flex justify-end space-x-3">
                    <button onclick="closeBatchDeleteModal()" 
                            class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                        å–æ¶ˆ
                    </button>
                    <button id="batchDeleteBtn" onclick="confirmBatchDelete()" 
                            class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors" disabled>
                        <i class="fas fa-trash mr-2"></i>åˆªé™¤é¸ä¸­æœƒå“¡
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- åŒ¯å…¥æœƒå“¡æ¨¡æ…‹æ¡† -->
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">åŒ¯å…¥æœƒå“¡è³‡æ–™</h3>
                <button onclick="closeImportModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- æ–‡ä»¶ä¸Šå‚³å€åŸŸ -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                    <div class="mb-4">
                        <i class="fas fa-file-csv text-4xl text-gray-400"></i>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">é¸æ“‡ CSV æ–‡ä»¶</h4>
                    <p class="text-gray-600 mb-4">æ”¯æ´çš„æ ¼å¼ï¼šæœƒå“¡ç·¨è™Ÿ,å§“å,é›»è©±,éƒµç®±,åœ°å€,å‚™è¨»,è¨»å†Šæ—¥æœŸ</p>
                    <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="handleFileSelect(event)">
                    <button onclick="document.getElementById('csvFileInput').click()" 
                            class="bg-[#17225e] text-white px-6 py-3 rounded-lg hover:bg-[#1a2a6e] transition-colors">
                        <i class="fas fa-upload mr-2"></i>é¸æ“‡æ–‡ä»¶
                    </button>
                </div>

                <!-- æ–‡ä»¶é è¦½å€åŸŸ -->
                <div id="filePreview" class="hidden">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4">æ–‡ä»¶é è¦½</h4>
                    <div class="bg-gray-50 rounded-lg p-4 max-h-60 overflow-y-auto">
                        <div id="previewContent"></div>
                    </div>
                </div>

                <!-- åŒ¯å…¥é¸é … -->
                <div id="importOptions" class="hidden">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4">åŒ¯å…¥é¸é …</h4>
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="skipHeader" checked class="mr-3">
                            <label for="skipHeader" class="text-gray-700">è·³éæ¨™é¡Œè¡Œ</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="updateExisting" class="mr-3">
                            <label for="updateExisting" class="text-gray-700">æ›´æ–°ç¾æœ‰æœƒå“¡ï¼ˆå¦‚æœæœƒå“¡ç·¨è™Ÿç›¸åŒï¼‰</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="generateNewIds" class="mr-3">
                            <label for="generateNewIds" class="text-gray-700">ç‚ºæ–°æœƒå“¡è‡ªå‹•ç”Ÿæˆç·¨è™Ÿ</label>
                        </div>
                    </div>
                </div>

                <!-- åŒ¯å…¥çµæœ -->
                <div id="importResults" class="hidden">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4">åŒ¯å…¥çµæœ</h4>
                    <div id="importResultsContent" class="bg-gray-50 rounded-lg p-4"></div>
                </div>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="flex justify-end space-x-3">
                    <button onclick="closeImportModal()" 
                            class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                        å–æ¶ˆ
                    </button>
                    <button id="importButton" onclick="importMembers()" 
                            class="bg-[#17225e] text-white px-6 py-2 rounded-lg hover:bg-[#1a2a6e] transition-colors hidden">
                        <i class="fas fa-download mr-2"></i>é–‹å§‹åŒ¯å…¥
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æœƒå“¡æ•¸æ“š
        let membersData = [];

        // è¼‰å…¥æœƒå“¡è³‡æ–™
        async function loadMembersData() {
            try {
                // ç­‰å¾…è³‡æ–™åº«åˆå§‹åŒ–
                await DatabaseManager.initialize();
                
                if (DatabaseManager.isConnected()) {
                    // å¾ Supabase è¼‰å…¥è³‡æ–™
                    const data = await BusinessAPI.getMembers();
                    if (data) {
                        membersData = data;
                        console.log('å¾ Supabase è¼‰å…¥æœƒå“¡è³‡æ–™:', membersData);
                    } else {
                        console.log('ç„¡æ³•å¾ Supabase è¼‰å…¥è³‡æ–™ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™');
                        loadLocalMembersData();
                    }
                } else {
                    console.log('è³‡æ–™åº«æœªé€£æ¥ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™');
                    loadLocalMembersData();
                }
            } catch (error) {
                console.error('è¼‰å…¥æœƒå“¡è³‡æ–™å¤±æ•—:', error);
                loadLocalMembersData();
            }
        }

        // è¼‰å…¥æœ¬åœ°æœƒå“¡è³‡æ–™ï¼ˆå‚™ç”¨ï¼‰
        function loadLocalMembersData() {
            const savedMembers = localStorage.getItem('membersData');
            if (savedMembers) {
                membersData = JSON.parse(savedMembers);
            } else {
                // é è¨­æœƒå“¡è³‡æ–™
                membersData = [
                    {
                        id: '1',
                        name: 'ç‹å°æ˜',
                        phone: '0912-345-678',
                        email: 'wang@example.com',
                        address: 'å°åŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯äº”æ®µ7è™Ÿ',
                        notes: 'VIPå®¢æˆ¶ï¼Œå–œæ­¡å’–å•¡',
                        created_at: '2023-03-15T00:00:00.000Z'
                    },
                    {
                        id: '2',
                        name: 'æç¾è¯',
                        phone: '0987-654-321',
                        email: 'li@example.com',
                        address: 'æ–°åŒ—å¸‚æ¿æ©‹å€ä¸­å±±è·¯ä¸€æ®µ161è™Ÿ',
                        notes: 'å¸¸å®¢ï¼Œåå¥½ç”œé»',
                        created_at: '2022-08-10T00:00:00.000Z'
                    }
                ];
                localStorage.setItem('membersData', JSON.stringify(membersData));
            }
        }

        // ä¿å­˜æœƒå“¡è³‡æ–™
        function saveMembersData() {
            localStorage.setItem('membersData', JSON.stringify(membersData));
        }

        let currentViewMode = 'grid';
        let filteredMembers = [...membersData];

        // é é¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // é€²è¡Œæ¬Šé™æª¢æŸ¥
            const isAuthenticated = await checkAuthentication();
            if (!isAuthenticated) {
                return; // å¦‚æœæœªé€šéèªè­‰ï¼Œå‡½æ•¸æœƒè‡ªå‹•é‡å®šå‘
            }
            
            // æª¢æŸ¥æœƒå“¡ç®¡ç†æ¬Šé™
            const hasPermission = await checkPermission(['members']);
            if (!hasPermission) {
                return; // æ¬Šé™ä¸è¶³ï¼Œæœƒé¡¯ç¤ºéŒ¯èª¤ä¸¦é‡å®šå‘
            }
            
            // å•Ÿå‹•å¿ƒè·³æ©Ÿåˆ¶
            console.log('ğŸ”„ Membersé é¢ï¼šå•Ÿå‹•å¿ƒè·³æ©Ÿåˆ¶');
            HeartbeatManager.checkAndStart();
            
            await loadMembersData();
            renderMembers();
            updateStatistics();
            setupEventListeners();
        });

        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // æœç´¢åŠŸèƒ½ - æ”¯æ´æŒ‰ Enter éµæœç´¢
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            // è¡¨å–®æäº¤
            document.getElementById('addMemberForm').addEventListener('submit', handleAddMember);
            document.getElementById('editMemberForm').addEventListener('submit', handleEditMember);
            
            // åŒ¯å…¥é¸é …è®Šæ›´æ™‚æ›´æ–°é è¦½
            document.getElementById('skipHeader').addEventListener('change', function() {
                const file = document.getElementById('csvFileInput').files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const lines = e.target.result.split('\n');
                        showFilePreview(lines);
                    };
                    reader.readAsText(file, 'UTF-8');
                }
            });

            // ç›£è½é¸æ“‡æ¡†è®Šæ›´
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('member-checkbox')) {
                    updateBatchDeleteButton();
                    updateSelectedMembersList();
                }
            });

            // ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†åˆªé™¤å’Œç·¨è¼¯æŒ‰éˆ•
            document.addEventListener('click', function(e) {
                const button = e.target.closest('button[data-action]');
                if (!button) return;
                
                const action = button.getAttribute('data-action');
                const memberId = button.getAttribute('data-member-id');
                
                if (!memberId) return;
                
                console.log('æŒ‰éˆ•é»æ“Š:', action, memberId);
                
                if (action === 'delete') {
                    e.preventDefault();
                    showDeleteConfirm(memberId);
                } else if (action === 'edit') {
                    e.preventDefault();
                    editMember(memberId);
                } else if (action === 'delete-from-search') {
                    e.preventDefault();
                    deleteMemberFromSearch(memberId);
                } else if (action === 'edit-from-search') {
                    e.preventDefault();
                    editMemberFromSearch(memberId);
                }
            });
        }

        // åŸ·è¡Œæœç´¢
        function performSearch() {
            filterMembers();
        }

        // ç¯©é¸æœƒå“¡
        function filterMembers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                // å¦‚æœæœç´¢æ¬„ä½ç‚ºç©ºï¼Œé¡¯ç¤ºæ‰€æœ‰æœƒå“¡
                filteredMembers = [...membersData];
                renderMembers();
                return;
            }

            // æœç´¢æœƒå“¡
            const searchResults = membersData.filter(member => {
                const matchesSearch = member.name.toLowerCase().includes(searchTerm) ||
                                    member.phone.includes(searchTerm) ||
                                    (member.email && member.email.toLowerCase().includes(searchTerm));

                return matchesSearch;
            });

            // é¡¯ç¤ºæœç´¢çµæœå½ˆçª—
            showSearchResults(searchResults, searchTerm);
        }

        // é¡¯ç¤ºæœç´¢çµæœ
        function showSearchResults(results, searchTerm) {
            const modal = document.getElementById('searchResultModal');
            const title = document.getElementById('searchResultTitle');
            const content = document.getElementById('searchResultContent');

            title.textContent = `æœç´¢çµæœ: "${searchTerm}"`;

            if (results.length === 0) {
                // æ²’æœ‰æœç´¢åˆ°çµæœ
                content.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-search text-gray-400 text-4xl mb-4"></i>
                        <h4 class="text-lg font-semibold text-gray-600 mb-2">ç„¡æ­¤è³‡æ–™</h4>
                        <p class="text-gray-500">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆ "${searchTerm}" çš„æœƒå“¡è³‡æ–™</p>
                    </div>
                `;
            } else {
                // é¡¯ç¤ºæœç´¢çµæœ
                content.innerHTML = `
                    <div class="mb-4">
                        <p class="text-gray-600">æ‰¾åˆ° ${results.length} ç­†ç¬¦åˆçš„æœƒå“¡è³‡æ–™ï¼š</p>
                    </div>
                    <div class="space-y-4">
                        ${results.map(member => `
                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center">
                                        <div class="member-avatar w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                                            ${member.name.charAt(0)}
                                        </div>
                                        <div>
                                            <h4 class="text-lg font-semibold text-gray-800">${member.name}</h4>
                                            <p class="text-sm text-gray-600">æœƒå“¡ç·¨è™Ÿ: ${member.id}</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button data-action="edit-from-search" data-member-id="${member.id}" class="text-[#17225e] hover:text-[#1a2a6e]">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button data-action="delete-from-search" data-member-id="${member.id}" class="text-red-500 hover:text-red-700">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <p class="text-gray-600"><i class="fas fa-phone mr-2"></i><strong>é›»è©±ï¼š</strong>${member.phone}</p>
                                        <p class="text-gray-600"><i class="fas fa-envelope mr-2"></i><strong>éƒµç®±ï¼š</strong>${member.email || 'æœªè¨­å®š'}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600"><i class="fas fa-map-marker-alt mr-2"></i><strong>åœ°å€ï¼š</strong>${member.address || 'æœªè¨­å®š'}</p>
                                        <p class="text-gray-600"><i class="fas fa-calendar mr-2"></i><strong>è¨»å†Šæ—¥æœŸï¼š</strong>${member.created_at ? new Date(member.created_at).toLocaleDateString() : 'æœªçŸ¥'}</p>
                                    </div>
                                </div>
                                ${member.notes ? `
                                    <div class="mt-3 pt-3 border-t border-gray-200">
                                        <p class="text-gray-600"><i class="fas fa-sticky-note mr-2"></i><strong>å‚™è¨»ï¼š</strong>${member.notes}</p>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            modal.classList.remove('hidden');
        }

        // é—œé–‰æœç´¢çµæœå½ˆçª—
        function closeSearchResultModal() {
            document.getElementById('searchResultModal').classList.add('hidden');
        }

        // å¾æœç´¢çµæœç·¨è¼¯æœƒå“¡
        async function editMemberFromSearch(memberId) {
            closeSearchResultModal();
            editMember(memberId);
        }

        // å¾æœç´¢çµæœåˆªé™¤æœƒå“¡
        async function deleteMemberFromSearch(memberId) {
            closeSearchResultModal();
            showDeleteConfirm(memberId);
        }

        // æ¸…é™¤ç¯©é¸
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            filteredMembers = [...membersData];
            renderMembers();
        }

        // åˆ‡æ›è¦–åœ–æ¨¡å¼
        function toggleViewMode(mode) {
            currentViewMode = mode;
            
            const gridView = document.getElementById('gridView');
            const listView = document.getElementById('listView');
            const gridBtn = document.getElementById('gridViewBtn');
            const listBtn = document.getElementById('listViewBtn');

            if (mode === 'grid') {
                gridView.style.display = 'grid';
                listView.style.display = 'none';
                gridBtn.classList.add('bg-emerald-500', 'text-white');
                gridBtn.classList.remove('bg-gray-300', 'text-gray-700');
                listBtn.classList.add('bg-gray-300', 'text-gray-700');
                listBtn.classList.remove('bg-emerald-500', 'text-white');
            } else {
                gridView.style.display = 'none';
                listView.style.display = 'block';
                listBtn.classList.add('bg-emerald-500', 'text-white');
                listBtn.classList.remove('bg-gray-300', 'text-gray-700');
                gridBtn.classList.add('bg-gray-300', 'text-gray-700');
                gridBtn.classList.remove('bg-emerald-500', 'text-white');
            }
            
            renderMembers();
        }

        // æ¸²æŸ“æœƒå“¡åˆ—è¡¨
        function renderMembers() {
            if (currentViewMode === 'grid') {
                renderGridView();
            } else {
                renderListView();
            }
        }

        // æ¸²æŸ“å¡ç‰‡è¦–åœ–
        function renderGridView() {
            const container = document.getElementById('gridView');
            container.innerHTML = '';

            filteredMembers.forEach(member => {
                const memberCard = createMemberCard(member);
                container.appendChild(memberCard);
            });
        }

        // å‰µå»ºæœƒå“¡å¡ç‰‡
        function createMemberCard(member) {
            const card = document.createElement('div');
            card.className = 'apple-card rounded-xl p-6 member-card shadow-lg';
            
            card.innerHTML = `
                <div class="flex items-center mb-4">
                    <div class="flex items-center">
                        <input type="checkbox" id="member-${member.id}" class="mr-3 member-checkbox" 
                               onchange="updateBatchDeleteButton()">
                    <div class="member-avatar w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg mr-4">
                        ${member.name.charAt(0)}
                        </div>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-800">${member.name}</h3>
                        <p class="text-sm text-gray-600">${member.id}</p>
                    </div>
                </div>
                
                <div class="space-y-2 mb-4">
                    <div class="flex items-center text-sm text-gray-600">
                        <i class="fas fa-phone w-4 mr-2"></i>
                        ${member.phone}
                    </div>
                    <div class="flex items-center text-sm text-gray-600">
                        <i class="fas fa-envelope w-4 mr-2"></i>
                        ${member.email || 'æœªè¨­å®š'}
                    </div>
                    <div class="flex items-center text-sm text-gray-600">
                        <i class="fas fa-map-marker-alt w-4 mr-2"></i>
                        ${member.address || 'æœªè¨­å®š'}
                    </div>
                </div>
                
                ${member.notes ? `
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-1">å‚™è¨»</p>
                    <p class="text-sm text-gray-800 bg-gray-50 p-2 rounded">${member.notes}</p>
                </div>
                ` : ''}
                
                <div class="flex space-x-2">
                    <button data-action="edit" data-member-id="${member.id}" 
                            class="flex-1 bg-[#17225e] text-white text-sm py-2 rounded-lg hover:bg-[#1a2a6e] transition-colors">
                        <i class="fas fa-edit mr-1"></i>ç·¨è¼¯
                    </button>
                    <button data-action="delete" data-member-id="${member.id}" 
                            class="flex-1 bg-red-500 text-white text-sm py-2 rounded-lg hover:bg-red-600 transition-colors">
                        <i class="fas fa-trash mr-1"></i>åˆªé™¤
                    </button>
                </div>
            `;

            return card;
        }

        // æ¸²æŸ“è¡¨æ ¼è¦–åœ–
        function renderListView() {
            const tbody = document.getElementById('memberTableBody');
            tbody.innerHTML = '';

            filteredMembers.forEach(member => {
                const row = createMemberRow(member);
                tbody.appendChild(row);
            });
        }

        // å‰µå»ºæœƒå“¡è¡¨æ ¼è¡Œ
        function createMemberRow(member) {
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-200 hover:bg-gray-50';
            
            row.innerHTML = `
                <td class="py-3 px-4">
                    <div class="flex items-center">
                        <input type="checkbox" id="member-${member.id}" class="mr-3 member-checkbox" 
                               onchange="updateBatchDeleteButton()">
                        <div class="member-avatar w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                            ${member.name.charAt(0)}
                        </div>
                        <div>
                            <div class="font-medium text-gray-800">${member.name}</div>
                            <div class="text-sm text-gray-600">${member.id}</div>
                        </div>
                    </div>
                </td>
                <td class="py-3 px-4">
                    <div class="text-sm">
                        <div>${member.phone}</div>
                        <div class="text-gray-600">${member.email || 'æœªè¨­å®š'}</div>
                    </div>
                </td>
                <td class="py-3 px-4">
                    <div class="text-sm text-gray-600">${member.address || 'æœªè¨­å®š'}</div>
                </td>
                <td class="py-3 px-4">
                    <div class="text-sm text-gray-600">${member.notes || 'ç„¡å‚™è¨»'}</div>
                </td>
                <td class="py-3 px-4">
                    <div class="flex space-x-2">
                        <button data-action="edit" data-member-id="${member.id}" 
                                class="text-[#17225e] hover:text-[#1a2a6e]">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button data-action="delete" data-member-id="${member.id}" 
                                class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;

            return row;
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStatistics() {
            const totalMembers = membersData.length;
            const activeMembers = membersData.length; // ç°¡åŒ–çµ±è¨ˆ
            
            // è¨ˆç®—æœ¬æœˆæ–°æœƒå“¡
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const newMembers = membersData.filter(m => {
                if (!m.created_at) return false;
                const createdDate = new Date(m.created_at);
                return createdDate.getMonth() === thisMonth && createdDate.getFullYear() === thisYear;
            }).length;

            // å®‰å…¨åœ°æ›´æ–°å…ƒç´ ï¼Œæª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            const totalMembersEl = document.getElementById('totalMembers');
            if (totalMembersEl) {
                totalMembersEl.textContent = totalMembers.toLocaleString();
            }
            
            const activeMembersEl = document.getElementById('activeMembers');
            if (activeMembersEl) {
                activeMembersEl.textContent = activeMembers.toLocaleString();
            }
            
            const newMembersEl = document.getElementById('newMembers');
            if (newMembersEl) {
                newMembersEl.textContent = newMembers.toLocaleString();
            }
        }

        // é¡¯ç¤ºæ–°å¢æœƒå“¡æ¨¡æ…‹æ¡†
        function showAddMemberModal() {
            document.getElementById('addMemberModal').classList.remove('hidden');
        }

        // éš±è—æ–°å¢æœƒå“¡æ¨¡æ…‹æ¡†
        function hideAddMemberModal() {
            document.getElementById('addMemberModal').classList.add('hidden');
            document.getElementById('addMemberForm').reset();
        }

        // ç”Ÿæˆç­‰å·®æ•¸åˆ—IDçš„å‡½æ•¸
        async function generateSequentialId() {
            try {
                // å¦‚æœè³‡æ–™åº«å·²é€£æ¥ï¼Œå¾Supabaseç²å–æœ€å¾Œä¸€ç­†æœƒå“¡çš„ID
                if (DatabaseManager.isConnected()) {
                    const allMembers = await BusinessAPI.getMembers();
                    if (allMembers && allMembers.length > 0) {
                        // æ‰¾å‡ºæœ€å¤§çš„æ•¸å­—ID
                        const numericIds = allMembers
                            .map(member => {
                                // å¦‚æœIDæ˜¯ç´”æ•¸å­—ï¼Œç›´æ¥è½‰æ›ï¼›å¦å‰‡æå–æ•¸å­—éƒ¨åˆ†
                                const idStr = member.id.toString();
                                if (/^\d+$/.test(idStr)) {
                                    return parseInt(idStr);
                                } else {
                                    const match = idStr.match(/\d+/);
                                    return match ? parseInt(match[0]) : 0;
                                }
                            })
                            .filter(id => id > 0);
                        
                        if (numericIds.length > 0) {
                            const maxId = Math.max(...numericIds);
                            const nextId = maxId + 1;
                            console.log('å¾Supabaseç²å–æœ€å¤§ID:', maxId, 'ï¼Œç”Ÿæˆä¸‹ä¸€å€‹ID:', nextId);
                            return nextId.toString();
                        }
                    }
                }
                
                // å¦‚æœç„¡æ³•å¾Supabaseç²å–è³‡æ–™ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™
                if (membersData.length > 0) {
                    const numericIds = membersData
                        .map(member => {
                            // å¦‚æœIDæ˜¯ç´”æ•¸å­—ï¼Œç›´æ¥è½‰æ›ï¼›å¦å‰‡æå–æ•¸å­—éƒ¨åˆ†
                            const idStr = member.id.toString();
                            if (/^\d+$/.test(idStr)) {
                                return parseInt(idStr);
                            } else {
                                const match = idStr.match(/\d+/);
                                return match ? parseInt(match[0]) : 0;
                            }
                        })
                        .filter(id => id > 0);
                    
                    if (numericIds.length > 0) {
                        const maxId = Math.max(...numericIds);
                        const nextId = maxId + 1;
                        console.log('å¾æœ¬åœ°è³‡æ–™ç²å–æœ€å¤§ID:', maxId, 'ï¼Œç”Ÿæˆä¸‹ä¸€å€‹ID:', nextId);
                        return nextId.toString();
                    }
                }
                
                // å¦‚æœæ²’æœ‰ä»»ä½•æœƒå“¡è³‡æ–™ï¼Œå¾1é–‹å§‹
                console.log('æ²’æœ‰ç¾æœ‰æœƒå“¡è³‡æ–™ï¼Œå¾ID 1é–‹å§‹');
                return '1';
                
            } catch (error) {
                console.error('ç”ŸæˆIDæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                // éŒ¯èª¤æ™‚ä½¿ç”¨æœ¬åœ°è³‡æ–™çš„æœ€å¤§ID + 1
                if (membersData.length > 0) {
                    const numericIds = membersData
                        .map(member => {
                            // å¦‚æœIDæ˜¯ç´”æ•¸å­—ï¼Œç›´æ¥è½‰æ›ï¼›å¦å‰‡æå–æ•¸å­—éƒ¨åˆ†
                            const idStr = member.id.toString();
                            if (/^\d+$/.test(idStr)) {
                                return parseInt(idStr);
                            } else {
                                const match = idStr.match(/\d+/);
                                return match ? parseInt(match[0]) : 0;
                            }
                        })
                        .filter(id => id > 0);
                    
                    if (numericIds.length > 0) {
                        const maxId = Math.max(...numericIds);
                        return (maxId + 1).toString();
                    }
                }
                return '1';
            }
        }

        // è™•ç†æ–°å¢æœƒå“¡
        async function handleAddMember(e) {
            e.preventDefault();
            
            // ç”Ÿæˆç­‰å·®æ•¸åˆ—ID
            const sequentialId = await generateSequentialId();
            
            const newMember = {
                id: sequentialId,
                name: document.getElementById('memberName').value,
                phone: document.getElementById('memberPhone').value,
                email: document.getElementById('memberEmail').value,
                address: document.getElementById('memberAddress').value,
                notes: document.getElementById('memberNotes').value
            };

            try {
                let result = null;
                
                // å˜—è©¦å„²å­˜åˆ° Supabase
                if (DatabaseManager.isConnected()) {
                    console.log('å˜—è©¦å„²å­˜åˆ° Supabaseï¼Œä½¿ç”¨ç­‰å·®æ•¸åˆ—ID:', sequentialId);
                    result = await BusinessAPI.addMember(newMember);
                    
                    if (result) {
                        console.log('æˆåŠŸå„²å­˜åˆ° Supabaseï¼Œä½¿ç”¨ç­‰å·®æ•¸åˆ—ID:', result);
                        // é‡æ–°è¼‰å…¥è³‡æ–™
                        await loadMembersData();
                    } else {
                        console.log('Supabase å„²å­˜å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å„²å­˜');
                        // å¦‚æœ Supabase å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å„²å­˜
                        newMember.created_at = new Date().toISOString();
                        membersData.push(newMember);
                        saveMembersData();
                    }
                } else {
                    console.log('è³‡æ–™åº«æœªé€£æ¥ï¼Œä½¿ç”¨æœ¬åœ°å„²å­˜');
                    newMember.created_at = new Date().toISOString();
                    membersData.push(newMember);
                    saveMembersData();
                }
                
                filteredMembers = [...membersData];
                renderMembers();
                updateStatistics();
                hideAddMemberModal();
                
                showNotification('æœƒå“¡æ–°å¢æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('æ–°å¢æœƒå“¡å¤±æ•—:', error);
                showNotification('æ–°å¢æœƒå“¡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

        // ç·¨è¼¯æœƒå“¡
        function editMember(memberId) {
            const member = membersData.find(m => m.id === memberId);
            if (!member) return;

            // å¡«å……ç·¨è¼¯è¡¨å–®
            document.getElementById('editMemberId').value = member.id;
            document.getElementById('editMemberName').value = member.name;
            document.getElementById('editMemberPhone').value = member.phone;
            document.getElementById('editMemberEmail').value = member.email || '';
            document.getElementById('editMemberAddress').value = member.address || '';
            document.getElementById('editMemberNotes').value = member.notes || '';

            // é¡¯ç¤ºç·¨è¼¯æ¨¡æ…‹æ¡†
            document.getElementById('editMemberModal').classList.remove('hidden');
        }

        // éš±è—ç·¨è¼¯æœƒå“¡æ¨¡æ…‹æ¡†
        function hideEditMemberModal() {
            document.getElementById('editMemberModal').classList.add('hidden');
            document.getElementById('editMemberForm').reset();
        }

        // è™•ç†ç·¨è¼¯æœƒå“¡
        async function handleEditMember(e) {
            e.preventDefault();
            
            const memberId = document.getElementById('editMemberId').value;
            const memberIndex = membersData.findIndex(m => m.id === memberId);
            
            if (memberIndex === -1) return;

            const updatedMember = {
                name: document.getElementById('editMemberName').value,
                phone: document.getElementById('editMemberPhone').value,
                email: document.getElementById('editMemberEmail').value,
                address: document.getElementById('editMemberAddress').value,
                notes: document.getElementById('editMemberNotes').value
            };

            try {
                // å˜—è©¦æ›´æ–°åˆ° Supabase
                if (DatabaseManager.isConnected()) {
                    const result = await BusinessAPI.updateMember(memberId, updatedMember);
                    if (result) {
                        // é‡æ–°è¼‰å…¥è³‡æ–™
                        await loadMembersData();
                    } else {
                        // å¦‚æœ Supabase å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°æ›´æ–°
                        membersData[memberIndex] = { ...membersData[memberIndex], ...updatedMember };
                        saveMembersData();
                    }
                } else {
                    // æœ¬åœ°æ›´æ–°
                    membersData[memberIndex] = { ...membersData[memberIndex], ...updatedMember };
                    saveMembersData();
                }
                
                filteredMembers = [...membersData];
                renderMembers();
                updateStatistics();
                hideEditMemberModal();
                
                showNotification('æœƒå“¡è³‡æ–™æ›´æ–°æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('æ›´æ–°æœƒå“¡å¤±æ•—:', error);
                showNotification('æ›´æ–°æœƒå“¡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

        // é¡¯ç¤ºåˆªé™¤ç¢ºèª
        function showDeleteConfirm(memberId) {
            console.log('showDeleteConfirm è¢«èª¿ç”¨ï¼ŒmemberId:', memberId, 'é¡å‹:', typeof memberId);
            console.log('ç•¶å‰æœƒå“¡æ•¸æ“š:', membersData);
            
            // å˜—è©¦ä¸åŒé¡å‹çš„åŒ¹é…
            let member = membersData.find(m => m.id === memberId);
            
            if (!member) {
                // å˜—è©¦å­—ç¬¦ä¸²åŒ¹é…
                member = membersData.find(m => m.id.toString() === memberId.toString());
            }
            
            if (!member) {
                // å˜—è©¦æ•¸å­—åŒ¹é…
                const numericId = parseInt(memberId);
                if (!isNaN(numericId)) {
                    member = membersData.find(m => parseInt(m.id) === numericId);
                }
            }
            
            if (!member) {
                console.error('æ‰¾ä¸åˆ°æœƒå“¡:', memberId);
                console.log('æ‰€æœ‰æœƒå“¡ID:', membersData.map(m => ({ id: m.id, type: typeof m.id })));
                return;
            }
            
            console.log('æ‰¾åˆ°æœƒå“¡:', member);

            const modal = document.getElementById('deleteConfirmModal');
            const content = document.getElementById('deleteConfirmContent');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            
            if (!modal) {
                console.error('æ‰¾ä¸åˆ° deleteConfirmModal å…ƒç´ ');
                return;
            }
            
            if (!content) {
                console.error('æ‰¾ä¸åˆ° deleteConfirmContent å…ƒç´ ');
                return;
            }
            
            if (!confirmBtn) {
                console.error('æ‰¾ä¸åˆ° confirmDeleteBtn å…ƒç´ ');
                return;
            }
            
            console.log('æ‰€æœ‰å…ƒç´ éƒ½æ‰¾åˆ°äº†ï¼Œæº–å‚™é¡¯ç¤ºæ¨¡æ…‹æ¡†');
            
            content.innerHTML = `
                <div class="space-y-3">
                    <p class="text-gray-700">ç¢ºå®šè¦åˆªé™¤ä»¥ä¸‹æœƒå“¡å—ï¼Ÿ</p>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="member-avatar w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                                ${member.name.charAt(0)}
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">${member.name}</h4>
                                <p class="text-sm text-gray-600">æœƒå“¡ç·¨è™Ÿ: ${member.id}</p>
                                <p class="text-sm text-gray-600">é›»è©±: ${member.phone}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // è¨­ç½®ç¢ºèªæŒ‰éˆ•äº‹ä»¶
            confirmBtn.onclick = () => performDelete(member.id);
            
            console.log('æº–å‚™ç§»é™¤ hidden é¡');
            modal.classList.remove('hidden');
            console.log('æ¨¡æ…‹æ¡†æ‡‰è©²å·²ç¶“é¡¯ç¤º');
        }

        // é—œé–‰åˆªé™¤ç¢ºèªæ¨¡æ…‹æ¡†
        function closeDeleteConfirmModal() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
        }

        // åŸ·è¡Œåˆªé™¤æ“ä½œ
        async function performDelete(memberId) {
            console.log('performDelete è¢«èª¿ç”¨ï¼ŒmemberId:', memberId, 'é¡å‹:', typeof memberId);
            
            // å˜—è©¦ä¸åŒé¡å‹çš„åŒ¹é…
            let member = membersData.find(m => m.id === memberId);
            
            if (!member) {
                // å˜—è©¦å­—ç¬¦ä¸²åŒ¹é…
                member = membersData.find(m => m.id.toString() === memberId.toString());
            }
            
            if (!member) {
                // å˜—è©¦æ•¸å­—åŒ¹é…
                const numericId = parseInt(memberId);
                if (!isNaN(numericId)) {
                    member = membersData.find(m => parseInt(m.id) === numericId);
                }
            }
            
            if (!member) {
                console.error('æ‰¾ä¸åˆ°è¦åˆªé™¤çš„æœƒå“¡:', memberId);
                console.log('æ‰€æœ‰æœƒå“¡ID:', membersData.map(m => ({ id: m.id, type: typeof m.id })));
                showNotification('æ‰¾ä¸åˆ°è¦åˆªé™¤çš„æœƒå“¡', 'error');
                return;
            }

            try {
                console.log('é–‹å§‹åˆªé™¤æœƒå“¡:', memberId, member);
                
                // å…ˆå˜—è©¦æœ¬åœ°åˆªé™¤ï¼Œç¢ºä¿ç”¨æˆ¶é«”é©—
                const originalMembersData = [...membersData];
                membersData = membersData.filter(m => m.id !== member.id);
                saveMembersData();
                
                // æ›´æ–°ç•Œé¢
                filteredMembers = [...membersData];
                renderMembers();
                updateStatistics();
                
                // å˜—è©¦å¾ Supabase åˆªé™¤ï¼ˆå¦‚æœé€£æ¥å¯ç”¨ï¼‰
                    if (DatabaseManager.isConnected()) {
                    console.log('å˜—è©¦å¾ Supabase åˆªé™¤æœƒå“¡:', member.id);
                    const success = await BusinessAPI.deleteMember(member.id);
                    
                    if (!success) {
                        console.warn('Supabase åˆªé™¤å¤±æ•—ï¼Œä½†æœ¬åœ°å·²åˆªé™¤');
                        showNotification('æœƒå“¡å·²å¾æœ¬åœ°åˆªé™¤ï¼Œä½†é›²ç«¯åŒæ­¥å¤±æ•—', 'warning');
                        } else {
                        console.log('Supabase åˆªé™¤æˆåŠŸ');
                        showNotification('æœƒå“¡åˆªé™¤æˆåŠŸï¼', 'success');
                        }
                    } else {
                    console.log('è³‡æ–™åº«æœªé€£æ¥ï¼Œåƒ…æœ¬åœ°åˆªé™¤');
                    showNotification('æœƒå“¡åˆªé™¤æˆåŠŸï¼ï¼ˆåƒ…æœ¬åœ°ï¼‰', 'success');
                }
                
                closeDeleteConfirmModal();
                
            } catch (error) {
                console.error('åˆªé™¤æœƒå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                
                // å¦‚æœç™¼ç”ŸéŒ¯èª¤ï¼Œæ¢å¾©åŸå§‹æ•¸æ“š
                membersData = originalMembersData;
                        saveMembersData();
                filteredMembers = [...membersData];
                renderMembers();
                updateStatistics();
                
                showNotification('åˆªé™¤æœƒå“¡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

        // é¡¯ç¤ºæ‰¹é‡åˆªé™¤æ¨¡æ…‹æ¡†
        function showBatchDeleteModal() {
            document.getElementById('batchDeleteModal').classList.remove('hidden');
            updateSelectedMembersList();
        }

        // é—œé–‰æ‰¹é‡åˆªé™¤æ¨¡æ…‹æ¡†
        function closeBatchDeleteModal() {
            document.getElementById('batchDeleteModal').classList.add('hidden');
            deselectAllMembers();
        }

        // å…¨é¸æœƒå“¡
        function selectAllMembers() {
            const checkboxes = document.querySelectorAll('.member-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updateBatchDeleteButton();
            updateSelectedMembersList();
        }

        // å–æ¶ˆå…¨é¸
        function deselectAllMembers() {
            const checkboxes = document.querySelectorAll('.member-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateBatchDeleteButton();
            updateSelectedMembersList();
        }

        // æ›´æ–°æ‰¹é‡åˆªé™¤æŒ‰éˆ•ç‹€æ…‹
        function updateBatchDeleteButton() {
            const selectedCheckboxes = document.querySelectorAll('.member-checkbox:checked');
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            const selectedCount = document.getElementById('selectedCount');
            
            const count = selectedCheckboxes.length;
            selectedCount.textContent = count;
            
            batchDeleteBtn.disabled = count === 0;
            if (count === 0) {
                batchDeleteBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                batchDeleteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // æ›´æ–°é¸ä¸­æœƒå“¡åˆ—è¡¨
        function updateSelectedMembersList() {
            const selectedCheckboxes = document.querySelectorAll('.member-checkbox:checked');
            const listContainer = document.getElementById('selectedMembersList');
            
            if (selectedCheckboxes.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 text-center">è«‹é¸æ“‡è¦åˆªé™¤çš„æœƒå“¡</p>';
                return;
            }

            const selectedMembers = Array.from(selectedCheckboxes).map(checkbox => {
                const memberId = checkbox.id.replace('member-', '');
                
                // ä½¿ç”¨èˆ‡å–®å€‹åˆªé™¤ç›¸åŒçš„åŒ¹é…é‚è¼¯
                let member = membersData.find(m => m.id === memberId);
                
                if (!member) {
                    // å˜—è©¦å­—ç¬¦ä¸²åŒ¹é…
                    member = membersData.find(m => m.id.toString() === memberId.toString());
                }
                
                if (!member) {
                    // å˜—è©¦æ•¸å­—åŒ¹é…
                    const numericId = parseInt(memberId);
                    if (!isNaN(numericId)) {
                        member = membersData.find(m => parseInt(m.id) === numericId);
                    }
                }
                
                return member;
            }).filter(Boolean);

            const membersHtml = selectedMembers.map(member => `
                <div class="flex items-center justify-between p-3 bg-white rounded-lg mb-2">
                    <div class="flex items-center">
                        <div class="member-avatar w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-xs mr-3">
                            ${member.name.charAt(0)}
                        </div>
                        <div>
                            <div class="font-medium text-gray-800">${member.name}</div>
                            <div class="text-sm text-gray-600">${member.phone}</div>
                        </div>
                    </div>
                    <div class="text-sm text-gray-500">${member.id}</div>
                </div>
            `).join('');

            listContainer.innerHTML = membersHtml;
        }

        // ç¢ºèªæ‰¹é‡åˆªé™¤
        async function confirmBatchDelete() {
            const selectedCheckboxes = document.querySelectorAll('.member-checkbox:checked');
            const selectedMembers = Array.from(selectedCheckboxes).map(checkbox => {
                const memberId = checkbox.id.replace('member-', '');
                
                // ä½¿ç”¨èˆ‡å–®å€‹åˆªé™¤ç›¸åŒçš„åŒ¹é…é‚è¼¯
                let member = membersData.find(m => m.id === memberId);
                
                if (!member) {
                    // å˜—è©¦å­—ç¬¦ä¸²åŒ¹é…
                    member = membersData.find(m => m.id.toString() === memberId.toString());
                }
                
                if (!member) {
                    // å˜—è©¦æ•¸å­—åŒ¹é…
                    const numericId = parseInt(memberId);
                    if (!isNaN(numericId)) {
                        member = membersData.find(m => parseInt(m.id) === numericId);
                    }
                }
                
                return member;
            }).filter(Boolean);

            if (selectedMembers.length === 0) {
                showNotification('è«‹é¸æ“‡è¦åˆªé™¤çš„æœƒå“¡', 'error');
                return;
            }

            console.log('é¸ä¸­çš„æœƒå“¡:', selectedMembers);

            // é¡¯ç¤ºæœ€çµ‚ç¢ºèª
            const content = document.getElementById('deleteConfirmContent');
            content.innerHTML = `
                <div class="space-y-3">
                    <p class="text-gray-700">ç¢ºå®šè¦åˆªé™¤ä»¥ä¸‹ <strong>${selectedMembers.length}</strong> å€‹æœƒå“¡å—ï¼Ÿ</p>
                    <div class="bg-gray-50 rounded-lg p-4 max-h-40 overflow-y-auto">
                        ${selectedMembers.map(member => `
                            <div class="flex items-center py-1">
                                <div class="member-avatar w-6 h-6 rounded-full flex items-center justify-center text-white font-bold text-xs mr-2">
                                    ${member.name.charAt(0)}
                                </div>
                                <span class="text-sm text-gray-700">${member.name} (${member.id})</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // è¨­ç½®ç¢ºèªæŒ‰éˆ•äº‹ä»¶
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            confirmBtn.onclick = () => performBatchDelete(selectedMembers);
            
            // é—œé–‰æ‰¹é‡åˆªé™¤æ¨¡æ…‹æ¡†ï¼Œé¡¯ç¤ºç¢ºèªæ¨¡æ…‹æ¡†
            closeBatchDeleteModal();
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
        }

        // åŸ·è¡Œæ‰¹é‡åˆªé™¤
        async function performBatchDelete(selectedMembers) {
            // åœ¨æœ€å¤–å±¤è²æ˜ï¼Œç¢ºä¿ä½œç”¨åŸŸè¦†è“‹æ•´å€‹å‡½æ•¸
            const originalMembersData = [...membersData];
            
            try {
                console.log('é–‹å§‹æ‰¹é‡åˆªé™¤æœƒå“¡:', selectedMembers.length, 'å€‹');
                console.log('è¦åˆªé™¤çš„æœƒå“¡:', selectedMembers);
                
                // å…ˆé€²è¡Œæœ¬åœ°åˆªé™¤
                const memberIds = selectedMembers.map(m => m.id);
                console.log('è¦åˆªé™¤çš„æœƒå“¡ID:', memberIds);
                
                membersData = membersData.filter(m => !memberIds.includes(m.id));
                saveMembersData();
                
                // æ›´æ–°ç•Œé¢
                filteredMembers = [...membersData];
                renderMembers();
                updateStatistics();
                    
                let successCount = 0;
                let errorCount = 0;
                const errors = [];

                // å˜—è©¦å¾ Supabase åˆªé™¤
                if (DatabaseManager.isConnected()) {
                    for (const member of selectedMembers) {
                        try {
                            console.log('å˜—è©¦å¾ Supabase åˆªé™¤æœƒå“¡:', member.id, member.name);
                            const success = await BusinessAPI.deleteMember(member.id);
                            
                            if (success) {
                                successCount++;
                                console.log('æˆåŠŸåˆªé™¤æœƒå“¡:', member.name);
                            } else {
                                errorCount++;
                                errors.push(`åˆªé™¤æœƒå“¡ ${member.name} å¤±æ•—`);
                                console.warn('åˆªé™¤æœƒå“¡å¤±æ•—:', member.name);
                            }
                        } catch (error) {
                            errorCount++;
                            errors.push(`åˆªé™¤æœƒå“¡ ${member.name} æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
                            console.error('åˆªé™¤æœƒå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', member.name, error);
                        }
                    }
                } else {
                    console.log('è³‡æ–™åº«æœªé€£æ¥ï¼Œåƒ…æœ¬åœ°åˆªé™¤');
                    successCount = selectedMembers.length;
                }

                closeDeleteConfirmModal();

                if (errorCount === 0) {
                    showNotification(`æˆåŠŸåˆªé™¤ ${successCount} å€‹æœƒå“¡ï¼`, 'success');
                } else {
                    showNotification(`åˆªé™¤å®Œæˆï¼šæˆåŠŸ ${successCount} å€‹ï¼Œå¤±æ•— ${errorCount} å€‹`, 'warning');
                    console.error('æ‰¹é‡åˆªé™¤éŒ¯èª¤:', errors);
                }
                
            } catch (error) {
                console.error('æ‰¹é‡åˆªé™¤å¤±æ•—:', error);
                
                // å¦‚æœç™¼ç”ŸéŒ¯èª¤ï¼Œæ¢å¾©åŸå§‹æ•¸æ“š
                membersData = originalMembersData;
                saveMembersData();
                filteredMembers = [...membersData];
                renderMembers();
                updateStatistics();
                
                showNotification('æ‰¹é‡åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

        // åŒ¯å‡ºæœƒå“¡
        function exportMembers() {
            const csvContent = [
                ['æœƒå“¡ç·¨è™Ÿ', 'å§“å', 'é›»è©±', 'éƒµç®±', 'åœ°å€', 'å‚™è¨»', 'è¨»å†Šæ—¥æœŸ'],
                ...membersData.map(member => [
                    member.id,
                    member.name,
                    member.phone,
                    member.email || '',
                    member.address || '',
                    member.notes || '',
                    member.created_at ? new Date(member.created_at).toLocaleDateString() : ''
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `æœƒå“¡è³‡æ–™_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('æœƒå“¡è³‡æ–™åŒ¯å‡ºæˆåŠŸï¼', 'success');
        }

        // é¡¯ç¤ºåŒ¯å…¥æ¨¡æ…‹æ¡†
        function showImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
            resetImportModal();
        }

        // é—œé–‰åŒ¯å…¥æ¨¡æ…‹æ¡†
        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            resetImportModal();
        }

        // é‡ç½®åŒ¯å…¥æ¨¡æ…‹æ¡†
        function resetImportModal() {
            document.getElementById('csvFileInput').value = '';
            document.getElementById('filePreview').classList.add('hidden');
            document.getElementById('importOptions').classList.add('hidden');
            document.getElementById('importResults').classList.add('hidden');
            document.getElementById('importButton').classList.add('hidden');
            document.getElementById('previewContent').innerHTML = '';
            document.getElementById('importResultsContent').innerHTML = '';
        }

        // è™•ç†æ–‡ä»¶é¸æ“‡
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showNotification('è«‹é¸æ“‡ CSV æ–‡ä»¶', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const lines = csvContent.split('\n');
                    
                    if (lines.length < 2) {
                        showNotification('CSV æ–‡ä»¶æ ¼å¼ä¸æ­£ç¢ºï¼Œè‡³å°‘éœ€è¦æ¨™é¡Œè¡Œå’Œä¸€è¡Œæ•¸æ“š', 'error');
                        return;
                    }

                    // é¡¯ç¤ºé è¦½
                    showFilePreview(lines);
                    
                    // é¡¯ç¤ºåŒ¯å…¥é¸é …
                    document.getElementById('importOptions').classList.remove('hidden');
                    document.getElementById('importButton').classList.remove('hidden');
                    
                } catch (error) {
                    console.error('è®€å–æ–‡ä»¶å¤±æ•—:', error);
                    showNotification('è®€å–æ–‡ä»¶å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        // é¡¯ç¤ºæ–‡ä»¶é è¦½
        function showFilePreview(lines) {
            const previewContent = document.getElementById('previewContent');
            const skipHeader = document.getElementById('skipHeader').checked;
            
            let previewLines = lines;
            if (skipHeader && lines.length > 1) {
                previewLines = lines.slice(1);
            }
            
            const previewHtml = previewLines.slice(0, 5).map((line, index) => {
                const columns = line.split(',').map(col => col.trim());
                return `
                    <div class="text-sm text-gray-700 mb-2">
                        <span class="font-semibold">ç¬¬ ${index + 1} è¡Œï¼š</span>
                        ${columns.map(col => `<span class="bg-gray-200 px-2 py-1 rounded mr-2">${col || '(ç©º)'}</span>`).join('')}
                    </div>
                `;
            }).join('');
            
            previewContent.innerHTML = previewHtml;
            document.getElementById('filePreview').classList.remove('hidden');
        }

        // åŒ¯å…¥æœƒå“¡
        async function importMembers() {
            const file = document.getElementById('csvFileInput').files[0];
            if (!file) {
                showNotification('è«‹å…ˆé¸æ“‡æ–‡ä»¶', 'error');
                return;
            }

            const skipHeader = document.getElementById('skipHeader').checked;
            const updateExisting = document.getElementById('updateExisting').checked;
            const generateNewIds = document.getElementById('generateNewIds').checked;

            try {
                const csvContent = await readFileAsText(file);
                const lines = csvContent.split('\n').filter(line => line.trim());
                
                if (skipHeader && lines.length > 0) {
                    lines.shift(); // ç§»é™¤æ¨™é¡Œè¡Œ
                }

                if (lines.length === 0) {
                    showNotification('æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æ•¸æ“šè¡Œ', 'error');
                    return;
                }

                const importResults = await processImportData(lines, updateExisting, generateNewIds);
                showImportResults(importResults);
                
            } catch (error) {
                console.error('åŒ¯å…¥å¤±æ•—:', error);
                showNotification('åŒ¯å…¥å¤±æ•—: ' + error.message, 'error');
            }
        }

        // è®€å–æ–‡ä»¶ç‚ºæ–‡æœ¬
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('è®€å–æ–‡ä»¶å¤±æ•—'));
                reader.readAsText(file, 'UTF-8');
            });
        }

        // è™•ç†åŒ¯å…¥æ•¸æ“š
        async function processImportData(lines, updateExisting, generateNewIds) {
            const results = {
                total: lines.length,
                imported: 0,
                updated: 0,
                skipped: 0,
                errors: []
            };

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                try {
                    const columns = line.split(',').map(col => col.trim());
                    
                    // é©—è­‰å¿…è¦æ¬„ä½
                    if (columns.length < 3) {
                        results.errors.push(`ç¬¬ ${i + 1} è¡Œï¼šæ•¸æ“šæ¬„ä½ä¸è¶³ï¼ˆéœ€è¦è‡³å°‘æœƒå“¡ç·¨è™Ÿã€å§“åã€é›»è©±ï¼‰`);
                        results.skipped++;
                        continue;
                    }

                    let [id, name, phone, email, address, notes, created_at] = columns;
                    
                    // é©—è­‰å¿…è¦æ¬„ä½
                    if (!name || !phone) {
                        results.errors.push(`ç¬¬ ${i + 1} è¡Œï¼šå§“åå’Œé›»è©±ç‚ºå¿…å¡«æ¬„ä½`);
                        results.skipped++;
                        continue;
                    }

                    // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°æœƒå“¡
                    const existingMember = membersData.find(m => m.id === id);
                    
                    if (existingMember) {
                        if (updateExisting) {
                            // æ›´æ–°ç¾æœ‰æœƒå“¡
                            const updatedMember = {
                                ...existingMember,
                                name,
                                phone,
                                email: email || existingMember.email,
                                address: address || existingMember.address,
                                notes: notes || existingMember.notes
                            };

                            if (DatabaseManager.isConnected()) {
                                await BusinessAPI.updateMember(id, updatedMember);
                            } else {
                                const index = membersData.findIndex(m => m.id === id);
                                membersData[index] = updatedMember;
                                saveMembersData();
                            }
                            results.updated++;
                        } else {
                            results.errors.push(`ç¬¬ ${i + 1} è¡Œï¼šæœƒå“¡ç·¨è™Ÿ ${id} å·²å­˜åœ¨ï¼Œè·³é`);
                            results.skipped++;
                        }
                    } else {
                        // æ–°å¢æœƒå“¡
                        if (generateNewIds && !id) {
                            id = await generateSequentialId();
                        }

                        if (!id) {
                            results.errors.push(`ç¬¬ ${i + 1} è¡Œï¼šç¼ºå°‘æœƒå“¡ç·¨è™Ÿä¸”æœªå•Ÿç”¨è‡ªå‹•ç”Ÿæˆ`);
                            results.skipped++;
                            continue;
                        }

                        const newMember = {
                            id,
                            name,
                            phone,
                            email: email || '',
                            address: address || '',
                            notes: notes || '',
                            created_at: created_at ? new Date(created_at).toISOString() : new Date().toISOString()
                        };

                        if (DatabaseManager.isConnected()) {
                            await BusinessAPI.addMember(newMember);
                        } else {
                            membersData.push(newMember);
                            saveMembersData();
                        }
                        results.imported++;
                    }
                } catch (error) {
                    results.errors.push(`ç¬¬ ${i + 1} è¡Œï¼šè™•ç†å¤±æ•— - ${error.message}`);
                    results.skipped++;
                }
            }

            // é‡æ–°è¼‰å…¥æ•¸æ“š
            await loadMembersData();
            filteredMembers = [...membersData];
            renderMembers();
            updateStatistics();

            return results;
        }

        // é¡¯ç¤ºåŒ¯å…¥çµæœ
        function showImportResults(results) {
            const content = document.getElementById('importResultsContent');
            
            let html = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-3 bg-gray-100 rounded-lg">
                                                          <div class="text-2xl font-bold text-[#17225e]">${results.total}</div>
                              <div class="text-sm text-gray-700">ç¸½è¡Œæ•¸</div>
                        </div>
                        <div class="text-center p-3 bg-green-100 rounded-lg">
                            <div class="text-2xl font-bold text-green-600">${results.imported}</div>
                            <div class="text-sm text-green-700">æ–°å¢</div>
                        </div>
                        <div class="text-center p-3 bg-yellow-100 rounded-lg">
                            <div class="text-2xl font-bold text-yellow-600">${results.updated}</div>
                            <div class="text-sm text-yellow-700">æ›´æ–°</div>
                        </div>
                        <div class="text-center p-3 bg-red-100 rounded-lg">
                            <div class="text-2xl font-bold text-red-600">${results.skipped}</div>
                            <div class="text-sm text-red-700">è·³é</div>
                        </div>
                    </div>
            `;

            if (results.errors.length > 0) {
                html += `
                    <div class="mt-4">
                        <h5 class="font-semibold text-red-600 mb-2">éŒ¯èª¤è©³æƒ…ï¼š</h5>
                        <div class="bg-red-50 rounded-lg p-3 max-h-40 overflow-y-auto">
                            ${results.errors.map(error => `<div class="text-sm text-red-700 mb-1">â€¢ ${error}</div>`).join('')}
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            content.innerHTML = html;
            
            document.getElementById('importResults').classList.remove('hidden');
            document.getElementById('importButton').classList.add('hidden');
        }

        // çµ±ä¸€å°èˆªå‡½æ•¸
        function navigateToPage(page) {
            try {
                // å˜—è©¦èˆ‡çˆ¶é é¢é€šä¿¡åˆ‡æ›iframe
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'navigate',
                        page: page
                    }, '*');
                } else {
                    // å¦‚æœä¸åœ¨iframeä¸­ï¼Œç›´æ¥è·³è½‰
                    window.location.href = `${page}.html`;
                }
            } catch (error) {
                // å‚™ç”¨æ–¹æ¡ˆï¼šåœ¨æ–°åˆ†é ä¸­é–‹å•Ÿ
                window.open(`${page}.html`, '_blank');
            }
        }

        // å›åˆ°ä¸»é é¢
        function goBackToMenu() {
            window.location.href = '../index.html';
        }



        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-[#17225e]',
                warning: 'bg-yellow-500'
            };

            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full`;
            notification.textContent = message;

            document.body.appendChild(notification);

            // å‹•ç•«é¡¯ç¤º
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);

            // è‡ªå‹•éš±è—
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html> 