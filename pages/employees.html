<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“¡å·¥ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../employee-auth.js"></script>
    <script src="../database.js"></script>
    <script src="../heartbeat.js"></script>
    <script src="auth-check.js"></script>
    <style>
        .apple-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen p-4">
    
    <!-- é ‚éƒ¨æ“ä½œå€ -->
    <div class="mb-6">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">å“¡å·¥ç®¡ç†</h1>
                <p class="text-gray-600">ç®¡ç†å“¡å·¥è³‡æ–™ã€æ¬Šé™å’Œç™»å…¥ç‹€æ…‹</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="goBackToMenu()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-th-large mr-2"></i>å›é¸å–®
                </button>
                <button onclick="showAddEmployeeModal()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-plus mr-2"></i>æ–°å¢å“¡å·¥
                </button>
                <button onclick="updateEmployeeLoginStatus()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>åˆ·æ–°ç‹€æ…‹
                </button>
            </div>
        </div>
    </div>

    <!-- å“¡å·¥çµ±è¨ˆå¡ç‰‡ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="apple-card rounded-xl p-4 text-center">
            <i class="fas fa-users text-2xl text-[#17225e] mb-2"></i>
            <h3 class="text-lg font-semibold text-gray-800" id="totalEmployees">0</h3>
            <p class="text-sm text-gray-600">ç¸½å“¡å·¥æ•¸</p>
        </div>
        <div class="apple-card rounded-xl p-4 text-center">
                            <i class="fas fa-user-check text-2xl text-[#17225e] mb-2"></i>
            <h3 class="text-lg font-semibold text-gray-800" id="activeEmployees">0</h3>
            <p class="text-sm text-gray-600">åœ¨è·å“¡å·¥</p>
        </div>
        <div class="apple-card rounded-xl p-4 text-center border-l-4 border-green-500">
            <i class="fas fa-wifi text-2xl text-green-600 mb-2"></i>
            <h3 class="text-lg font-semibold text-green-700" id="onlineEmployees">0</h3>
            <p class="text-sm text-green-600">ç·šä¸Šå“¡å·¥</p>
            <div class="mt-2">
                <i class="fas fa-circle text-green-500 animate-pulse"></i>
                <span class="text-xs text-green-600 ml-1">å³æ™‚ç‹€æ…‹</span>
            </div>
        </div>
        <div class="apple-card rounded-xl p-4 text-center">
                            <i class="fas fa-user-tie text-2xl text-[#17225e] mb-2"></i>
            <h3 class="text-lg font-semibold text-gray-800" id="managerCount">0</h3>
            <p class="text-sm text-gray-600">ç®¡ç†è·ä½</p>
        </div>
    </div>

    <!-- å“¡å·¥åˆ—è¡¨ -->
    <div class="apple-card rounded-xl p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-gray-800">å“¡å·¥åˆ—è¡¨</h2>
            <div class="flex space-x-2">
                <input type="text" id="searchEmployee" placeholder="æœå°‹å“¡å·¥..." class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#17225e] focus:border-[#17225e]">
                <select id="filterRole" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#17225e] focus:border-[#17225e]">
                    <option value="">æ‰€æœ‰è·ä½</option>
                    <option value="ç®¡ç†å“¡">ç®¡ç†å“¡</option>
                    <option value="åº—é•·">åº—é•·</option>
                    <option value="æ”¶éŠ€å“¡">æ”¶éŠ€å“¡</option>
                    <option value="å€‰ç®¡">å€‰ç®¡</option>
                    <option value="éŠ·å”®å“¡">éŠ·å”®å“¡</option>
                </select>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">å“¡å·¥ç·¨è™Ÿ</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">å§“å</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">è·ä½</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">é›»è©±</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">ç‹€æ…‹</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">ç™»å…¥ç‹€æ…‹</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">æ¬Šé™</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="employeesTableBody">
                    <!-- å“¡å·¥è³‡æ–™å°‡å‹•æ…‹è¼‰å…¥ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯å“¡å·¥å½ˆå‡ºè¦–çª— -->
    <div id="employeeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800" id="modalTitle">æ–°å¢å“¡å·¥</h3>
                <button onclick="closeEmployeeModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="employeeForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å“¡å·¥ç·¨è™Ÿ *</label>
                    <input type="text" id="employeeId" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-[#17225e]">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å§“å *</label>
                    <input type="text" id="employeeName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-[#17225e]">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">è·ä½ *</label>
                    <select id="employeeRole" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-[#17225e]" onchange="updatePermissionsByRole()">
                        <option value="">è«‹é¸æ“‡è·ä½</option>
                        <option value="ç®¡ç†å“¡">ç®¡ç†å“¡</option>
                        <option value="åº—é•·">åº—é•·</option>
                        <option value="æ”¶éŠ€å“¡">æ”¶éŠ€å“¡</option>
                        <option value="å€‰ç®¡">å€‰ç®¡</option>
                        <option value="éŠ·å”®å“¡">éŠ·å”®å“¡</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">æ¬Šé™è¨­å®š</label>
                    <p class="text-xs text-orange-600 mb-3">âš ï¸ è·ä½é¸æ“‡ä¸æœƒè‡ªå‹•è³¦äºˆæ¬Šé™ï¼Œéœ€ç®¡ç†å“¡æ‰‹å‹•é¸æ“‡å…è¨±ä½¿ç”¨çš„åŠŸèƒ½</p>
                    <div id="permissionsContainer" class="grid grid-cols-2 gap-3 text-sm text-gray-600">
                        <div class="flex items-center">
                            <input type="checkbox" id="permSales" class="mr-2">
                            <label for="permSales">éŠ·å”®ä½œæ¥­</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="permProducts" class="mr-2">
                            <label for="permProducts">å•†å“ç®¡ç†</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="permPurchase" class="mr-2">
                            <label for="permPurchase">é€²è²¨ä½œæ¥­</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="permMembers" class="mr-2">
                            <label for="permMembers">æœƒå“¡ç®¡ç†</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="permReports" class="mr-2">
                            <label for="permReports">å ±è¡¨ä¸­å¿ƒ</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="permEmployees" class="mr-2">
                            <label for="permEmployees">å“¡å·¥ç®¡ç†</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="permSuppliers" class="mr-2">
                            <label for="permSuppliers">ä¾›æ‡‰å•†ç®¡ç†</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="permImportExport" class="mr-2">
                            <label for="permImportExport">è³‡æ–™åŒ¯å‡º/å…¥</label>
                        </div>
                    </div>
                    <p id="roleDescription" class="text-xs text-gray-500 mt-3">è«‹æ‰‹å‹•é¸æ“‡è©²å“¡å·¥å¯ä»¥ä½¿ç”¨çš„åŠŸèƒ½é é¢</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">é›»è©±</label>
                    <input type="tel" id="employeePhone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-[#17225e]">
                </div>
                

                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç‹€æ…‹</label>
                    <select id="employeeStatus" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-[#17225e]">
                        <option value="active">åœ¨è·</option>
                        <option value="inactive">é›¢è·</option>
                        <option value="suspended">åœè·</option>
                    </select>
                </div>
            </form>
            
            <div class="mt-6 flex space-x-3">
                <button onclick="closeEmployeeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                    å–æ¶ˆ
                </button>
                <button onclick="saveEmployee()" class="flex-1 px-4 py-2 bg-[#17225e] text-white rounded-lg hover:bg-[#1a2a6e] transition-colors">
                    å„²å­˜
                </button>
            </div>
        </div>
    </div>

    <script>
        // é è¨­å“¡å·¥è³‡æ–™
        const defaultEmployees = [
            {
                id: 'EMP001',
                name: 'ç®¡ç†å“¡',
                role: 'ç®¡ç†å“¡',
                phone: '0900-000-000',
                status: 'active',
                lastLogin: null,
                isOnline: false,
                permissions: ['all']
            },
            {
                id: 'EMP002',
                name: 'åº—é•·',
                role: 'åº—é•·',
                phone: '0987-654-321',
                status: 'active',
                lastLogin: null,
                isOnline: false,
                permissions: ['sales', 'products', 'purchase', 'members', 'reports']
            },
            {
                id: 'EMP003',
                name: 'æ”¶éŠ€å“¡',
                role: 'æ”¶éŠ€å“¡',
                phone: '0912-345-678',
                status: 'active',
                lastLogin: null,
                isOnline: false,
                permissions: ['sales', 'members']
            },
            {
                id: 'EMP004',
                name: 'å€‰ç®¡',
                role: 'å€‰ç®¡',
                phone: '0923-456-789',
                status: 'active',
                lastLogin: null,
                isOnline: false,
                permissions: ['products', 'purchase', 'reports']
            }
        ];

        // ç•¶å‰å“¡å·¥è³‡æ–™
        let employees = [...defaultEmployees];
        let editingEmployeeId = null;

        // è¼‰å…¥å“¡å·¥è³‡æ–™
        async function loadEmployees() {
            try {
                // å¾ Supabase è¼‰å…¥å“¡å·¥è³‡æ–™
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                const supabase = createClient(
                    'https://cgwhckykrlphnibmuvhz.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnd2hja3lrcmxwaG5pYm11dmh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMDA1ODMsImV4cCI6MjA2ODY3NjU4M30.LiIG69wjvcyrJhdNAk0Y171uKCU4f-ROIiejS7Xd7zY'
                );
                
                const { data, error } = await supabase
                    .from('employees')
                    .select('*')
                    .order('employee_id');
                
                console.log('Supabase æŸ¥è©¢çµæœ:', { data, error });
                
                if (error) {
                    console.error('è¼‰å…¥å“¡å·¥è³‡æ–™å¤±æ•—:', error);
                    // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­è³‡æ–™
                    employees = defaultEmployees;
                    console.log('ä½¿ç”¨é è¨­å“¡å·¥è³‡æ–™:', employees);
                } else {
                    console.log('å¾ Supabase è¼‰å…¥åˆ°å“¡å·¥è³‡æ–™:', data);
                    if (data && data.length > 0) {
                        // è½‰æ› Supabase è³‡æ–™æ ¼å¼ç‚ºæœ¬åœ°æ ¼å¼
                        employees = data.map(emp => {
                            let permissions = [];
                            try {
                                if (emp.permissions) {
                                    if (typeof emp.permissions === 'string') {
                                        permissions = JSON.parse(emp.permissions);
                                    } else if (Array.isArray(emp.permissions)) {
                                        permissions = emp.permissions;
                                    }
                                }
                            } catch (parseError) {
                                console.error('è§£ææ¬Šé™å¤±æ•—:', parseError, 'åŸå§‹è³‡æ–™:', emp.permissions);
                                permissions = [];
                            }
                            
                            return {
                                id: emp.employee_id || emp.username || emp.id,
                                name: emp.name,
                                role: emp.position || emp.role || 'å“¡å·¥',
                                phone: emp.phone || '',
                                email: emp.email || '',
                                status: 'active',
                                lastLogin: emp.last_login || null,
                                isOnline: emp.is_online || false,
                                permissions: permissions
                            };
                        });
                        console.log('è½‰æ›å¾Œçš„å“¡å·¥è³‡æ–™:', employees);
                    } else {
                        console.log('Supabase ä¸­æ²’æœ‰å“¡å·¥è³‡æ–™ï¼Œä½¿ç”¨é è¨­è³‡æ–™');
                        employees = defaultEmployees;
                    }
                }
                
                updateEmployeeDisplay();
                updateStatistics();
                
            } catch (error) {
                console.error('è¼‰å…¥å“¡å·¥è³‡æ–™å¤±æ•—:', error);
                // ä½¿ç”¨é è¨­è³‡æ–™
                employees = defaultEmployees;
                updateEmployeeDisplay();
                updateStatistics();
            }
        }

        // æ¸¬è©¦å‡½æ•¸ï¼šæª¢æŸ¥ Supabase ä¸­çš„å¯¦éš›è³‡æ–™
        async function testSupabaseData() {
            try {
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                const supabase = createClient(
                    'https://cgwhckykrlphnibmuvhz.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnd2hja3lrcmxwaG5pYm11dmh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMDA1ODMsImV4cCI6MjA2ODY3NjU4M30.LiIG69wjvcyrJhdNAk0Y171uKCU4f-ROIiejS7Xd7zY'
                );

                const { data, error } = await supabase
                    .from('employees')
                    .select('*')
                    .order('employee_id');
                
                console.log('=== Supabase å¯¦éš›è³‡æ–™æª¢æŸ¥ ===');
                console.log('æŸ¥è©¢çµæœ:', { data, error });
                console.log('è³‡æ–™æ•¸é‡:', data ? data.length : 0);
                if (data && data.length > 0) {
                    data.forEach((emp, index) => {
                        console.log(`å“¡å·¥ ${index + 1}:`, emp);
                        console.log(`å“¡å·¥ ${index + 1} æ¬„ä½:`, Object.keys(emp));
                        console.log(`æ˜¯å¦æœ‰ phone æ¬„ä½:`, emp.hasOwnProperty('phone'));
                    });
                } else {
                    console.log('æ²’æœ‰å“¡å·¥è³‡æ–™');
                }
                console.log('========================');
                
                return { data, error };
            } catch (error) {
                console.error('æ¸¬è©¦ Supabase è³‡æ–™å¤±æ•—:', error);
                return { data: null, error };
            }
        }

        // æ¸¬è©¦ phone æ¬„ä½æ˜¯å¦å­˜åœ¨
        async function testPhoneField() {
            try {
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                const supabase = createClient(
                    'https://cgwhckykrlphnibmuvhz.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnd2hja3lrcmxwaG5pYm11dmh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMDA1ODMsImV4cCI6MjA2ODY3NjU4M30.LiIG69wjvcyrJhdNAk0Y171uKCU4f-ROIiejS7Xd7zY'
                );

                // å˜—è©¦æ¸¬è©¦æ’å…¥ä¸€ç­†åŒ…å« phone çš„è³‡æ–™
                console.log('=== æ¸¬è©¦ phone æ¬„ä½ ===');
                const testData = {
                    employee_id: 'TEST_PHONE',
                    name: 'æ¸¬è©¦é›»è©±æ¬„ä½',
                    position: 'æ¸¬è©¦',
                    phone: '0900-000-000',
                    permissions: JSON.stringify(['sales'])
                };

                const { data, error } = await supabase
                    .from('employees')
                    .insert([testData])
                    .select();

                if (error) {
                    console.error('phone æ¬„ä½æ¸¬è©¦å¤±æ•—:', error);
                    if (error.message.includes('phone')) {
                        console.log('âŒ employees è¡¨å¯èƒ½æ²’æœ‰ phone æ¬„ä½');
                        console.log('è«‹åœ¨ Supabase ä¸­åŸ·è¡Œä»¥ä¸‹ SQL ä¾†æ–°å¢ phone æ¬„ä½:');
                        console.log('ALTER TABLE employees ADD COLUMN phone TEXT;');
                    }
                    return false;
                } else {
                    console.log('âœ… phone æ¬„ä½æ¸¬è©¦æˆåŠŸ:', data);
                    
                    // åˆªé™¤æ¸¬è©¦è³‡æ–™
                    await supabase
                        .from('employees')
                        .delete()
                        .eq('employee_id', 'TEST_PHONE');
                    
                    console.log('æ¸¬è©¦è³‡æ–™å·²æ¸…é™¤');
                    return true;
                }
            } catch (error) {
                console.error('æ¸¬è©¦ phone æ¬„ä½æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return false;
            }
        }

        // æ‰‹å‹•è§¸ç™¼é¡¯ç¤ºæ›´æ–°ï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰
        function forceUpdateDisplay() {
            console.log('=== æ‰‹å‹•è§¸ç™¼é¡¯ç¤ºæ›´æ–° ===');
            console.log('ç•¶å‰å“¡å·¥é™£åˆ—:', employees);
            updateEmployeeDisplay();
            updateStatistics();
        }

        // æ›´æ–°å“¡å·¥é¡¯ç¤º
        function updateEmployeeDisplay() {
            const tbody = document.getElementById('employeesTableBody');
            const searchTerm = document.getElementById('searchEmployee').value.toLowerCase();
            const filterRole = document.getElementById('filterRole').value;

            console.log('=== æ›´æ–°å“¡å·¥é¡¯ç¤ºè¨ºæ–· ===');
            console.log('ç•¶å‰å“¡å·¥é™£åˆ—:', employees);
            console.log('å“¡å·¥é™£åˆ—é•·åº¦:', employees.length);
            console.log('æœå°‹é—œéµå­—:', searchTerm);
            console.log('è·ä½ç¯©é¸:', filterRole);

            let filteredEmployees = employees.filter(emp => {
                const matchesSearch = emp.name.toLowerCase().includes(searchTerm) || 
                                    emp.id.toLowerCase().includes(searchTerm);
                const matchesRole = !filterRole || emp.role === filterRole;
                const shouldInclude = matchesSearch && matchesRole;
                
                console.log(`å“¡å·¥ ${emp.id} (${emp.name}):`, {
                    matchesSearch,
                    matchesRole,
                    shouldInclude,
                    empRole: emp.role,
                    filterRole: filterRole
                });
                
                return shouldInclude;
            });

            console.log('ç¯©é¸å¾Œçš„å“¡å·¥:', filteredEmployees);
            console.log('ç¯©é¸å¾Œæ•¸é‡:', filteredEmployees.length);

            tbody.innerHTML = filteredEmployees.map(emp => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4 font-mono text-[#17225e]">${emp.id}</td>
                    <td class="py-3 px-4 font-semibold">${emp.name}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                            emp.role === 'ç®¡ç†å“¡' ? 'bg-gray-100 text-[#17225e]' :
                emp.role === 'åº—é•·' ? 'bg-gray-100 text-[#17225e]' :
                emp.role === 'æ”¶éŠ€å“¡' ? 'bg-gray-100 text-[#17225e]' :
                emp.role === 'å€‰ç®¡' ? 'bg-gray-100 text-[#17225e]' :
                'bg-gray-100 text-gray-800'
                        }">${emp.role}</span>
                    </td>
                    <td class="py-3 px-4 text-gray-600">${emp.phone || '-'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                            emp.status === 'active' ? 'bg-gray-100 text-[#17225e]' :
                emp.status === 'inactive' ? 'bg-red-100 text-red-800' :
                'bg-gray-100 text-gray-800'
                        }">${emp.status === 'active' ? 'åœ¨è·' : emp.status === 'inactive' ? 'é›¢è·' : 'åœè·'}</span>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex flex-col">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                emp.isOnline ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'
                            }">
                                <i class="fas fa-circle text-xs mr-1 ${emp.isOnline ? 'text-green-500' : 'text-gray-400'}"></i>
                                ${emp.isOnline ? 'ç·šä¸Š' : 'é›¢ç·š'}
                            </span>
                            ${emp.lastLogin ? `<span class="text-xs text-gray-500 mt-1">æœ€å¾Œç™»å…¥: ${formatLoginTime(emp.lastLogin)}</span>` : '<span class="text-xs text-gray-400 mt-1">å¾æœªç™»å…¥</span>'}
                        </div>
                    </td>
                    <td class="py-3 px-4 text-xs text-gray-600">
                        ${emp.permissions ? emp.permissions.join(', ') : 'ç„¡'}
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <button onclick="editEmployee('${emp.id}')" class="text-[#17225e] hover:text-[#1a2a6e]">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteEmployee('${emp.id}')" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            console.log('=== é¡¯ç¤ºæ›´æ–°å®Œæˆ ===');
        }

        // æ ¼å¼åŒ–ç™»å…¥æ™‚é–“
        function formatLoginTime(loginTime) {
            if (!loginTime) return 'å¾æœªç™»å…¥';
            
            try {
                // è™•ç†ä¸åŒçš„æ™‚é–“æ ¼å¼
                let loginDate;
                
                if (typeof loginTime === 'string') {
                    // å¦‚æœæ˜¯æˆ‘å€‘è‡ªå®šç¾©çš„å°ç£æ™‚é–“æ ¼å¼ (2025-09-19T22:04:00+08:00)
                    if (loginTime.includes('+08:00')) {
                        // ç›´æ¥è§£æï¼ŒJavaScript æ‡‰è©²èƒ½æ­£ç¢ºè™•ç†æ™‚å€
                        loginDate = new Date(loginTime);
                    } 
                    // å¦‚æœæ˜¯ ISO æ ¼å¼ (UTC æ™‚é–“)
                    else if (loginTime.includes('T') && loginTime.includes('Z')) {
                        loginDate = new Date(loginTime);
                    }
                    // å…¶ä»–æ ¼å¼
                    else {
                        loginDate = new Date(loginTime);
                    }
                } else {
                    loginDate = new Date(loginTime);
                }
                
                // æª¢æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                if (isNaN(loginDate.getTime())) {
                    console.error('ç„¡æ•ˆçš„ç™»å…¥æ™‚é–“æ ¼å¼:', loginTime);
                    return 'æ™‚é–“æ ¼å¼éŒ¯èª¤';
                }
                
                const now = new Date();
                const diffMs = now - loginDate;
                const diffMins = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);
                
                // èª¿è©¦ä¿¡æ¯
                console.log('æ™‚é–“æ ¼å¼åŒ–èª¿è©¦:', {
                    åŸå§‹æ™‚é–“: loginTime,
                    è§£æå¾Œ: loginDate.toISOString(),
                    æœ¬åœ°æ™‚é–“: loginDate.toLocaleString('zh-TW'),
                    æ™‚é–“å·®åˆ†é˜: diffMins
                });
                
                if (diffMins < 1) return 'å‰›å‰›';
                if (diffMins < 60) return `${diffMins}åˆ†é˜å‰`;
                if (diffHours < 24) return `${diffHours}å°æ™‚å‰`;
                if (diffDays < 7) return `${diffDays}å¤©å‰`;
                
                return loginDate.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'Asia/Taipei'  // ç¢ºä¿é¡¯ç¤ºå°ç£æ™‚é–“
                });
                
            } catch (error) {
                console.error('æ ¼å¼åŒ–ç™»å…¥æ™‚é–“æ™‚ç™¼ç”ŸéŒ¯èª¤:', error, 'åŸå§‹æ™‚é–“:', loginTime);
                return 'æ™‚é–“è§£æéŒ¯èª¤';
            }
        }

        // æ›´æ–°å“¡å·¥ç™»å…¥ç‹€æ…‹ï¼ˆå¾sessionè¡¨ç²å–çœŸå¯¦ç‹€æ…‹ï¼‰
        async function updateEmployeeLoginStatus() {
            try {
                console.log('ğŸ” å¾sessionè¡¨ç²å–å“¡å·¥ç™»å…¥ç‹€æ…‹...');
                
                // å‰µå»ºSupabaseå®¢æˆ¶ç«¯
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                const supabase = createClient(
                    'https://cgwhckykrlphnibmuvhz.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnd2hja3lrcmxwaG5pYm11dmh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMDA1ODMsImV4cCI6MjA2ODY3NjU4M30.LiIG69wjvcyrJhdNAk0Y171uKCU4f-ROIiejS7Xd7zY'
                );
                
                // å…ˆæ¸¬è©¦ç°¡å–®æŸ¥è©¢ï¼Œçœ‹çœ‹è¡¨çµæ§‹
                console.log('æ¸¬è©¦employee_sessionsè¡¨æŸ¥è©¢...');
                const { data: testData, error: testError } = await supabase
                    .from('employee_sessions')
                    .select('*')
                    .limit(1);
                
                console.log('è¡¨çµæ§‹æ¸¬è©¦:', { testData, testError });
                
                // å¾employee_sessionsè¡¨ç²å–æ´»èºæœƒè©±
                const { data: sessionData, error } = await supabase
                    .from('employee_sessions')
                    .select('*')
                    .eq('is_active', true)
                    .order('login_time', { ascending: false });
                
                console.log('ğŸ“Š æŸ¥è©¢çµæœ:', { sessionData, error });
                    
                if (error) {
                    console.error('ç²å–æœƒè©±ç‹€æ…‹å¤±æ•—:', error);
                    return;
                }
                
                // æª¢æŸ¥ä¸¦æ¸…ç†ç„¡æ•ˆçš„æœƒè©±è¨˜éŒ„
                if (sessionData && sessionData.length > 0) {
                    const validEmployeeIds = employees.map(e => e.id);
                    const invalidSessions = sessionData.filter(session => 
                        !validEmployeeIds.includes(session.employee_id)
                    );
                    
                    if (invalidSessions.length > 0) {
                        console.log('âš ï¸  ç™¼ç¾ç„¡æ•ˆæœƒè©±ï¼Œæº–å‚™æ¸…ç†:', invalidSessions.map(s => s.employee_id));
                        await cleanupInvalidSessions(invalidSessions);
                        
                        // é‡æ–°æŸ¥è©¢æœ‰æ•ˆæœƒè©±
                        const { data: validSessionData, error: validError } = await supabase
                            .from('employee_sessions')
                            .select('*')
                            .eq('is_active', true)
                            .order('login_time', { ascending: false });
                        
                        if (!validError) {
                            sessionData.length = 0; // æ¸…ç©ºåŸé™£åˆ—
                            sessionData.push(...(validSessionData || [])); // æ·»åŠ æœ‰æ•ˆæœƒè©±
                            console.log('âœ… å·²æ›´æ–°ç‚ºæœ‰æ•ˆæœƒè©±:', sessionData);
                        }
                    }
                }
                
                // å…ˆå°‡æ‰€æœ‰å“¡å·¥è¨­ç‚ºé›¢ç·š
                employees.forEach(emp => {
                    emp.isOnline = false;
                    emp.lastLogin = null;
                });
                
                // æŸ¥è©¢æ‰€æœ‰å“¡å·¥çš„æœ€å¾Œç™»å…¥è¨˜éŒ„ï¼ˆåŒ…æ‹¬å·²ç™»å‡ºçš„ï¼‰
                for (const emp of employees) {
                    try {
                        const { data: lastLoginData, error: lastLoginError } = await supabase
                            .from('employee_sessions')
                            .select('login_time, last_activity')
                            .eq('employee_id', emp.id)
                            .order('login_time', { ascending: false })
                            .limit(1);
                        
                        if (!lastLoginError && lastLoginData && lastLoginData.length > 0) {
                            // å„ªå…ˆä½¿ç”¨ last_activityï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ login_time
                            emp.lastLogin = lastLoginData[0].last_activity || lastLoginData[0].login_time;
                            console.log(`å“¡å·¥ ${emp.id} æœ€å¾Œæ´»å‹•æ™‚é–“:`, emp.lastLogin);
                        }
                    } catch (error) {
                        console.error(`æŸ¥è©¢å“¡å·¥ ${emp.id} æœ€å¾Œç™»å…¥æ™‚é–“å¤±æ•—:`, error);
                    }
                }
                
                if (sessionData && sessionData.length > 0) {
                    console.log('æ‰¾åˆ°æ´»èºæœƒè©±:', sessionData.length, 'å€‹');
                    
                    // è™•ç†æ´»èºæœƒè©±
                    const now = new Date();
                    const activeEmployeeIds = new Set();
                    
                    sessionData.forEach(session => {
                        console.log('ğŸ” è™•ç†æœƒè©±:', session);
                        console.log('æœƒè©±å“¡å·¥ID:', session.employee_id);
                        console.log('å“¡å·¥åˆ—è¡¨ä¸­çš„ID:', employees.map(e => e.id));
                        
                        const employeeIndex = employees.findIndex(e => e.id === session.employee_id);
                        console.log('æ‰¾åˆ°å“¡å·¥ç´¢å¼•:', employeeIndex);
                        
                        if (employeeIndex !== -1) {
                            // ä½¿ç”¨last_activityä½œç‚ºæ´»å‹•æ™‚é–“ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨login_time
                            const lastActivity = new Date(session.last_activity || session.login_time);
                            const diffMinutes = (now - lastActivity) / (1000 * 60);
                            
                            console.log('å“¡å·¥æ´»å‹•æ™‚é–“æª¢æŸ¥:', {
                                employee_id: session.employee_id,
                                lastActivity: lastActivity,
                                diffMinutes: diffMinutes,
                                hasLastActivity: !!session.last_activity
                            });
                            
                            // 5åˆ†é˜ç„¡æ´»å‹•å¾Œæ¨™è¨˜ç‚ºé›¢ç·šï¼ˆçµ¦å¿ƒè·³æ©Ÿåˆ¶æ›´å¤šæ™‚é–“ï¼‰
                            if (diffMinutes > 5) { // 5åˆ†é˜
                                console.log('âŒ æœƒè©±è¶…æ™‚ï¼ˆ5åˆ†é˜ï¼‰ï¼Œæ¨™è¨˜ç‚ºé›¢ç·š:', session.employee_id);
                                // æ¨™è¨˜ç‰¹å®šæœƒè©±ç‚ºéæ´»èº
                                updateSpecificSessionOfflineStatus(session.session_id);
                                // æ³¨æ„ï¼šä¸è¦è¨­å®š employees[employeeIndex].isOnline = falseï¼Œå› ç‚ºå¯èƒ½æœ‰å…¶ä»–æœ‰æ•ˆæœƒè©±
                            } else {
                                console.log('âœ… å“¡å·¥åœ¨ç·š:', session.employee_id);
                                // å“¡å·¥åœ¨ç·š - åªè¦æœ‰ä¸€å€‹æœ‰æ•ˆæœƒè©±å°±è¨­ç‚ºåœ¨ç·š
                                employees[employeeIndex].isOnline = true;
                                employees[employeeIndex].lastLogin = session.last_activity || session.login_time;
                                activeEmployeeIds.add(session.employee_id);
                            }
                        } else {
                            console.log('âŒ æ‰¾ä¸åˆ°åŒ¹é…çš„å“¡å·¥ID:', session.employee_id);
                        }
                    });
                    
                    console.log('ç·šä¸Šå“¡å·¥æ•¸é‡:', activeEmployeeIds.size);
                    console.log('æ´»èºå“¡å·¥IDåˆ—è¡¨:', Array.from(activeEmployeeIds));
                    
                    // èª¿è©¦ï¼šæª¢æŸ¥æ¯å€‹å“¡å·¥çš„æœ€çµ‚ç‹€æ…‹
                    employees.forEach(emp => {
                        console.log(`æœ€çµ‚ç‹€æ…‹ - å“¡å·¥ ${emp.id}: isOnline=${emp.isOnline}, lastLogin=${emp.lastLogin}`);
                    });
                } else {
                    console.log('æ²’æœ‰æ‰¾åˆ°æ´»èºæœƒè©±');
                }
                
                // é‡æ–°æ¸²æŸ“å“¡å·¥åˆ—è¡¨å’Œçµ±è¨ˆè³‡æ–™
                updateEmployeeDisplay();
                updateStatistics();
                
            } catch (error) {
                console.error('æ›´æ–°å“¡å·¥ç™»å…¥ç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }
        
        // æ¸…ç†ç„¡æ•ˆçš„æœƒè©±è¨˜éŒ„
        async function cleanupInvalidSessions(invalidSessions) {
            try {
                console.log('ğŸ§¹ é–‹å§‹æ¸…ç†ç„¡æ•ˆæœƒè©±...');
                
                // å‰µå»ºSupabaseå®¢æˆ¶ç«¯
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                const supabase = createClient(
                    'https://cgwhckykrlphnibmuvhz.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnd2hja3lrcmxwaG5pYm11dmh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMDA1ODMsImV4cCI6MjA2ODY3NjU4M30.LiIG69wjvcyrJhdNAk0Y171uKCU4f-ROIiejS7Xd7zY'
                );
                
                const logoutTime = new Date().toISOString();
                const sessionIds = invalidSessions.map(s => s.session_id);
                
                const { error } = await supabase
                    .from('employee_sessions')
                    .update({ 
                        is_active: false,
                        logout_time: logoutTime
                    })
                    .in('session_id', sessionIds);
                
                if (error) {
                    console.error('æ¸…ç†ç„¡æ•ˆæœƒè©±å¤±æ•—:', error);
                } else {
                    console.log('âœ… å·²æ¸…ç†ç„¡æ•ˆæœƒè©±:', sessionIds);
                }
            } catch (error) {
                console.error('æ¸…ç†ç„¡æ•ˆæœƒè©±æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }
        
        // æ›´æ–°ç‰¹å®šæœƒè©±é›¢ç·šç‹€æ…‹åˆ°è³‡æ–™åº«
        async function updateSpecificSessionOfflineStatus(sessionId) {
            try {
                const logoutTime = new Date().toISOString();
                
                // å‰µå»ºSupabaseå®¢æˆ¶ç«¯
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                const supabase = createClient(
                    'https://cgwhckykrlphnibmuvhz.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnd2hja3lrcmxwaG5pYm11dmh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMDA1ODMsImV4cCI6MjA2ODY3NjU4M30.LiIG69wjvcyrJhdNAk0Y171uKCU4f-ROIiejS7Xd7zY'
                );
                
                const { error } = await supabase
                    .from('employee_sessions')
                    .update({ 
                        is_active: false,
                        logout_time: logoutTime
                    })
                    .eq('session_id', sessionId);
                
                if (error) {
                    console.error('æ›´æ–°ç‰¹å®šæœƒè©±ç‹€æ…‹å¤±æ•—:', error);
                } else {
                    console.log('ç‰¹å®šæœƒè©±å·²æ¨™è¨˜ç‚ºé›¢ç·š:', sessionId);
                }
            } catch (error) {
                console.error('æ›´æ–°ç‰¹å®šæœƒè©±ç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // æ›´æ–°å“¡å·¥æ‰€æœ‰æœƒè©±é›¢ç·šç‹€æ…‹åˆ°è³‡æ–™åº«ï¼ˆä¿ç•™èˆŠå‡½æ•¸ä»¥é˜²å…¶ä»–åœ°æ–¹ä½¿ç”¨ï¼‰
        async function updateSessionOfflineStatus(employeeId) {
            try {
                const logoutTime = new Date().toISOString();
                
                // å‰µå»ºSupabaseå®¢æˆ¶ç«¯
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                const supabase = createClient(
                    'https://cgwhckykrlphnibmuvhz.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnd2hja3lrcmxwaG5pYm11dmh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMDA1ODMsImV4cCI6MjA2ODY3NjU4M30.LiIG69wjvcyrJhdNAk0Y171uKCU4f-ROIiejS7Xd7zY'
                );
                
                const { error } = await supabase
                    .from('employee_sessions')
                    .update({ 
                        is_active: false,
                        logout_time: logoutTime
                    })
                    .eq('employee_id', employeeId)
                    .eq('is_active', true);
                
                if (error) {
                    console.error('æ›´æ–°æœƒè©±é›¢ç·šç‹€æ…‹å¤±æ•—:', error);
                } else {
                    console.log('æœƒè©±å·²æ¨™è¨˜ç‚ºé›¢ç·š:', employeeId);
                }
            } catch (error) {
                console.error('æ›´æ–°æœƒè©±é›¢ç·šç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // æ›´æ–°çµ±è¨ˆè³‡æ–™
        function updateStatistics() {
            document.getElementById('totalEmployees').textContent = employees.length;
            document.getElementById('activeEmployees').textContent = employees.filter(emp => emp.status === 'active').length;
            document.getElementById('onlineEmployees').textContent = employees.filter(emp => emp.isOnline).length;
            document.getElementById('managerCount').textContent = employees.filter(emp => emp.role === 'åº—é•·' || emp.role === 'ç®¡ç†å“¡').length;
        }

        // é¡¯ç¤ºæ–°å¢å“¡å·¥è¦–çª—
        function showAddEmployeeModal() {
            editingEmployeeId = null;
            document.getElementById('modalTitle').textContent = 'æ–°å¢å“¡å·¥';
            document.getElementById('employeeForm').reset();
            document.getElementById('employeeModal').classList.remove('hidden');
        }

        // é—œé–‰å“¡å·¥è¦–çª—
        function closeEmployeeModal() {
            document.getElementById('employeeModal').classList.add('hidden');
            editingEmployeeId = null;
        }

        // ç·¨è¼¯å“¡å·¥
        function editEmployee(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;

            editingEmployeeId = employeeId;
            document.getElementById('modalTitle').textContent = 'ç·¨è¼¯å“¡å·¥';
            
            document.getElementById('employeeId').value = employee.id;
            document.getElementById('employeeName').value = employee.name;
            document.getElementById('employeeRole').value = employee.role;
            document.getElementById('employeePhone').value = employee.phone || '';

            document.getElementById('employeeStatus').value = employee.status;
            
            // å…ˆè§¸ç™¼è·ä½æ¬Šé™æ›´æ–°
            updatePermissionsByRole();
            
            // ç„¶å¾Œæ ¹æ“šå¯¦éš›æ¬Šé™è¦†è“‹é è¨­è¨­å®š
            const permissions = employee.permissions || [];
            document.getElementById('permSales').checked = permissions.includes('sales') || permissions.includes('all');
            document.getElementById('permProducts').checked = permissions.includes('products') || permissions.includes('all');
            document.getElementById('permPurchase').checked = permissions.includes('purchase') || permissions.includes('all');
            document.getElementById('permMembers').checked = permissions.includes('members') || permissions.includes('all');
            document.getElementById('permReports').checked = permissions.includes('reports') || permissions.includes('all');
            document.getElementById('permEmployees').checked = permissions.includes('employees') || permissions.includes('all');
            document.getElementById('permSuppliers').checked = permissions.includes('suppliers') || permissions.includes('all');
            document.getElementById('permImportExport').checked = permissions.includes('import-export') || permissions.includes('all');
            
            document.getElementById('employeeModal').classList.remove('hidden');
        }

        // å„²å­˜å“¡å·¥
        async function saveEmployee() {
            const form = document.getElementById('employeeForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // æ”¶é›†æ¬Šé™è¨­å®š
            const permissions = [];
            if (document.getElementById('permSales').checked) permissions.push('sales');
            if (document.getElementById('permProducts').checked) permissions.push('products');
            if (document.getElementById('permPurchase').checked) permissions.push('purchase');
            if (document.getElementById('permMembers').checked) permissions.push('members');
            if (document.getElementById('permReports').checked) permissions.push('reports');
            if (document.getElementById('permEmployees').checked) permissions.push('employees');
            if (document.getElementById('permSuppliers').checked) permissions.push('suppliers');
            if (document.getElementById('permImportExport').checked) permissions.push('import-export');

            // å¦‚æœæ‰€æœ‰æ¬Šé™éƒ½å‹¾é¸ï¼Œè¨­ç‚ºall
            if (permissions.length >= 8) {
                permissions.length = 0;
                permissions.push('all');
            }

            const employeeData = {
                id: document.getElementById('employeeId').value,
                name: document.getElementById('employeeName').value,
                role: document.getElementById('employeeRole').value,
                phone: document.getElementById('employeePhone').value,
                status: document.getElementById('employeeStatus').value,
                lastLogin: null,
                isOnline: false,
                permissions: permissions
            };

            try {
                // åŒæ­¥åˆ° Supabase
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                const supabase = createClient(
                    'https://cgwhckykrlphnibmuvhz.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnd2hja3lrcmxwaG5pYm11dmh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMDA1ODMsImV4cCI6MjA2ODY3NjU4M30.LiIG69wjvcyrJhdNAk0Y171uKCU4f-ROIiejS7Xd7zY'
                );

                const supabaseData = {
                    employee_id: employeeData.id,
                    name: employeeData.name,
                    position: employeeData.role,
                    phone: employeeData.phone,
                    permissions: JSON.stringify(employeeData.permissions)
                };

                if (editingEmployeeId) {
                    // ç·¨è¼¯ç¾æœ‰å“¡å·¥
                    const { error } = await supabase
                        .from('employees')
                        .update(supabaseData)
                        .eq('employee_id', editingEmployeeId);
                    
                    if (error) throw error;
                } else {
                    // æ–°å¢å“¡å·¥
                    const { error } = await supabase
                        .from('employees')
                        .insert([supabaseData]);
                    
                    if (error) throw error;
                }

                // é‡æ–°è¼‰å…¥å“¡å·¥è³‡æ–™
                console.log('å„²å­˜æˆåŠŸï¼Œé–‹å§‹é‡æ–°è¼‰å…¥å“¡å·¥è³‡æ–™...');
                await loadEmployees();
                console.log('é‡æ–°è¼‰å…¥å®Œæˆï¼Œç•¶å‰å“¡å·¥æ•¸é‡:', employees.length);
                closeEmployeeModal();
                
                alert(editingEmployeeId ? 'å“¡å·¥è³‡æ–™å·²æ›´æ–°ï¼' : 'å“¡å·¥å·²æ–°å¢ï¼');
                
            } catch (error) {
                console.error('å„²å­˜å“¡å·¥è³‡æ–™å¤±æ•—:', error);
                alert(`å„²å­˜å¤±æ•—ï¼š${error.message}`);
            }
        }

        // åˆªé™¤å“¡å·¥
        async function deleteEmployee(employeeId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å“¡å·¥å—ï¼Ÿ')) return;
            
            try {
                // å¾ Supabase åˆªé™¤å“¡å·¥
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                const supabase = createClient(
                    'https://cgwhckykrlphnibmuvhz.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnd2hja3lrcmxwaG5pYm11dmh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMDA1ODMsImV4cCI6MjA2ODY3NjU4M30.LiIG69wjvcyrJhdNAk0Y171uKCU4f-ROIiejS7Xd7zY'
                );

                const { error } = await supabase
                    .from('employees')
                    .delete()
                    .eq('employee_id', employeeId);
                
                if (error) throw error;

                // é‡æ–°è¼‰å…¥å“¡å·¥è³‡æ–™
                await loadEmployees();
                
                alert('å“¡å·¥å·²åˆªé™¤ï¼');
                
            } catch (error) {
                console.error('åˆªé™¤å“¡å·¥å¤±æ•—:', error);
                alert(`åˆªé™¤å¤±æ•—ï¼š${error.message}`);
            }
        }

        // å›åˆ°ä¸»é¸å–®
        function goBackToMenu() {
            window.location.href = '../index.html';
        }

        // æ ¹æ“šè·ä½æ›´æ–°æ¬Šé™è¨­å®š
        function updatePermissionsByRole() {
            const role = document.getElementById('employeeRole').value;
            const roleDescription = document.getElementById('roleDescription');
            
            // ä¸å†è‡ªå‹•è¨­å®šæ¬Šé™ï¼Œåªé¡¯ç¤ºè·ä½æè¿°å’Œå»ºè­°
            switch(role) {
                case 'ç®¡ç†å“¡':
                    roleDescription.textContent = 'ç®¡ç†å“¡ï¼šç³»çµ±æœ€é«˜ç®¡ç†è·ä½ï¼Œå¯æ ¹æ“šéœ€è¦åˆ†é…ä»»ä½•æ¬Šé™';
                    break;
                    
                case 'åº—é•·':
                    roleDescription.textContent = 'åº—é•·ï¼šé–€åº—ç®¡ç†è·ä½ï¼Œå»ºè­°åˆ†é…ç‡Ÿé‹ç›¸é—œæ¬Šé™ï¼ˆéŠ·å”®ã€å•†å“ã€é€²è²¨ã€æœƒå“¡ã€å ±è¡¨ï¼‰';
                    break;
                    
                case 'æ”¶éŠ€å“¡':
                    roleDescription.textContent = 'æ”¶éŠ€å“¡ï¼šå‰å°æœå‹™è·ä½ï¼Œå»ºè­°åˆ†é…éŠ·å”®å’Œæœƒå“¡ç®¡ç†æ¬Šé™';
                    break;
                    
                case 'å€‰ç®¡':
                    roleDescription.textContent = 'å€‰ç®¡ï¼šåº«å­˜ç®¡ç†è·ä½ï¼Œå»ºè­°åˆ†é…å•†å“ç®¡ç†ã€é€²è²¨ä½œæ¥­æ¬Šé™';
                    break;
                    
                case 'éŠ·å”®å“¡':
                    roleDescription.textContent = 'éŠ·å”®å“¡ï¼šéŠ·å”®å°ˆå“¡è·ä½ï¼Œå»ºè­°åˆ†é…éŠ·å”®ä½œæ¥­æ¬Šé™';
                    break;
                    
                default:
                    roleDescription.textContent = 'è«‹æ‰‹å‹•é¸æ“‡è©²å“¡å·¥å¯ä»¥ä½¿ç”¨çš„åŠŸèƒ½é é¢';
            }
        }

        // äº‹ä»¶ç›£è½å™¨
        document.addEventListener('DOMContentLoaded', async function() {
            // é€²è¡Œæ¬Šé™æª¢æŸ¥
            const isAuthenticated = await checkAuthentication();
            if (!isAuthenticated) {
                return; // å¦‚æœæœªé€šéèªè­‰ï¼Œå‡½æ•¸æœƒè‡ªå‹•é‡å®šå‘
            }
            
            // æª¢æŸ¥å“¡å·¥ç®¡ç†æ¬Šé™
            const hasPermission = await checkPermission(['employees']);
            if (!hasPermission) {
                return; // æ¬Šé™ä¸è¶³ï¼Œæœƒé¡¯ç¤ºéŒ¯èª¤ä¸¦é‡å®šå‘
            }
            
            // å•Ÿå‹•å¿ƒè·³æ©Ÿåˆ¶
            console.log('ğŸ”„ Employeesé é¢ï¼šå•Ÿå‹•å¿ƒè·³æ©Ÿåˆ¶');
            HeartbeatManager.checkAndStart();
            
            await loadEmployees();
            
            // åˆå§‹åŒ–ç™»å…¥ç‹€æ…‹è¿½è¹¤
            updateEmployeeLoginStatus();
            
            // æ¯30ç§’æ›´æ–°ä¸€æ¬¡ç™»å…¥ç‹€æ…‹
            setInterval(updateEmployeeLoginStatus, 30000);
            
            // æœå°‹åŠŸèƒ½
            document.getElementById('searchEmployee').addEventListener('input', updateEmployeeDisplay);
            document.getElementById('filterRole').addEventListener('change', updateEmployeeDisplay);
        });

        // æ¸¬è©¦å‡½æ•¸å·²ç§»é™¤
    </script>
</body>
</html> 