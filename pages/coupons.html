<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å„ªæƒ åˆ¸ç®¡ç† - æ³¢æ³¢ èš æ­æ´²å®¶å±…/æ³¢è˜­é™¶é£Ÿå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../employee-auth.js"></script>
    <script src="../database.js"></script>
    <script src="../heartbeat.js"></script>
    <script src="auth-check.js"></script>
    <style>
        .apple-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .coupon-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .coupon-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .coupon-code {
            background: linear-gradient(45deg, #17225e, #1a2a6e);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .discount-badge {
            background: linear-gradient(45deg, #17225e, #1a2a6e);
        }
        .expired-badge {
            background: linear-gradient(45deg, #6b7280, #9ca3af);
        }
        .active-badge {
            background: linear-gradient(45deg, #17225e, #1a2a6e);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    
    <div class="container mx-auto px-4 py-8">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-ticket-alt text-[#17225e] mr-3"></i>
                    å„ªæƒ åˆ¸ç®¡ç†
                </h1>
                <p class="text-gray-600">ç®¡ç†åº—å…§æ‰€æœ‰å„ªæƒ åˆ¸ï¼Œæå‡é¡§å®¢è³¼ç‰©é«”é©—</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="showAddCouponModal()" class="bg-[#17225e] text-white px-6 py-3 rounded-lg hover:bg-[#1a2a6e] transition-colors flex items-center">
                    <i class="fas fa-plus mr-2"></i>
                    æ–°å¢å„ªæƒ åˆ¸
                </button>
                <button onclick="goBackToMenu()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>
                    å›é¸å–®
                </button>
            </div>
        </div>

        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="apple-card rounded-xl p-6 text-center">
                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                          <i class="fas fa-ticket-alt text-[#17225e] text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-1">ç¸½å„ªæƒ åˆ¸</h3>
                <p class="text-2xl font-bold text-[#17225e]" id="totalCoupons">0</p>
            </div>
            
            <div class="apple-card rounded-xl p-6 text-center">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-check-circle text-[#17225e] text-xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-800 mb-1">å•Ÿç”¨ä¸­</h3>
            <p class="text-2xl font-bold text-[#17225e]" id="activeCoupons">0</p>
            </div>
            
            <div class="apple-card rounded-xl p-6 text-center">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-clock text-[#17225e] text-xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-800 mb-1">å³å°‡åˆ°æœŸ</h3>
            <p class="text-2xl font-bold text-[#17225e]" id="expiringSoon">0</p>
            </div>
            
            <div class="apple-card rounded-xl p-6 text-center">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-chart-line text-[#17225e] text-xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-800 mb-1">æœ¬æœˆä½¿ç”¨</h3>
            <p class="text-2xl font-bold text-[#17225e]" id="monthlyUsage">0</p>
            </div>
        </div>

        <!-- æœå°‹å’Œç¯©é¸ -->
        <div class="apple-card rounded-xl p-6 mb-6">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                <div class="lg:col-span-2">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="æœå°‹å„ªæƒ åˆ¸ä»£ç¢¼æˆ–åç¨±..." onkeyup="searchCoupons()"
                               class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                <div>
                    <select id="statusFilter" onchange="filterCoupons()" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                        <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                        <option value="active">å•Ÿç”¨ä¸­</option>
                        <option value="expired">å·²éæœŸ</option>
                        <option value="disabled">å·²åœç”¨</option>
                    </select>
                </div>
                <div>
                    <select id="typeFilter" onchange="filterCoupons()" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e] focus:border-transparent">
                        <option value="">æ‰€æœ‰é¡å‹</option>
                        <option value="percentage">ç™¾åˆ†æ¯”æŠ˜æ‰£</option>
                        <option value="fixed">å›ºå®šé‡‘é¡</option>
                        <option value="buy_x_get_y">è²·Xé€Y</option>
                        <option value="member_only">æœƒå“¡å°ˆå±¬</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- å„ªæƒ åˆ¸åˆ—è¡¨ -->
        <div class="apple-card rounded-xl p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-800">å„ªæƒ åˆ¸åˆ—è¡¨</h2>
                <div class="flex items-center space-x-3">
                    <span class="text-sm text-gray-600">å…± <span id="couponCount">0</span> å¼µå„ªæƒ åˆ¸</span>
                    <button onclick="generateBatchCoupons()" class="text-[#17225e] hover:text-[#1a2a6e] text-sm font-medium">
                        <i class="fas fa-magic mr-1"></i>æ‰¹é‡ç”Ÿæˆ
                    </button>
                </div>
            </div>
            
            <div id="couponsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- å„ªæƒ åˆ¸å¡ç‰‡å°‡å‹•æ…‹ç”Ÿæˆ -->
            </div>
            
            <!-- ç©ºç‹€æ…‹ -->
            <div id="emptyCoupons" class="text-center py-12 hidden">
                <i class="fas fa-ticket-alt text-gray-300 text-6xl mb-4"></i>
                <h3 class="text-xl font-medium text-gray-500 mb-2">é‚„æ²’æœ‰å„ªæƒ åˆ¸</h3>
                <p class="text-gray-400 mb-6">å‰µå»ºæ‚¨çš„ç¬¬ä¸€å¼µå„ªæƒ åˆ¸ä¾†å¸å¼•é¡§å®¢</p>
                <button onclick="showAddCouponModal()" class="bg-[#17225e] text-white px-6 py-3 rounded-lg hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-plus mr-2"></i>
                    æ–°å¢å„ªæƒ åˆ¸
                </button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯å„ªæƒ åˆ¸å½ˆå‡ºè¦–çª— -->
    <div id="couponModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800" id="modalTitle">æ–°å¢å„ªæƒ åˆ¸</h3>
                <button onclick="closeCouponModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="couponForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å„ªæƒ åˆ¸åç¨±</label>
                        <input type="text" id="couponName" required class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e]" placeholder="ä¾‹ï¼šé€±å¹´æ…¶ç‰¹æƒ ">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å„ªæƒ åˆ¸ä»£ç¢¼</label>
                        <div class="flex">
                            <input type="text" id="couponCode" required class="flex-1 px-4 py-3 border border-gray-200 rounded-l-lg focus:ring-2 focus:ring-[#17225e]" placeholder="WELCOME2024">
                            <button type="button" onclick="generateCouponCode()" class="px-4 py-3 bg-gray-100 border border-l-0 border-gray-200 rounded-r-lg hover:bg-gray-200 transition-colors">
                                <i class="fas fa-random"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å„ªæƒ é¡å‹</label>
                        <select id="couponType" onchange="toggleDiscountFields()" required class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e]">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="percentage">ç™¾åˆ†æ¯”æŠ˜æ‰£</option>
                            <option value="fixed">å›ºå®šé‡‘é¡æŠ˜æ‰£</option>
                            <option value="buy_x_get_y">è²·Xé€Y</option>
                            <option value="member_only">æœƒå“¡å°ˆå±¬</option>
                        </select>
                    </div>
                    <div id="discountValueField">
                        <label class="block text-sm font-medium text-gray-700 mb-2">æŠ˜æ‰£å€¼</label>
                        <input type="number" id="discountValue" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e]" placeholder="10">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æœ€ä½æ¶ˆè²»</label>
                        <input type="number" id="minAmount" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e]" placeholder="500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é–‹å§‹æ—¥æœŸ</label>
                        <input type="datetime-local" id="startDate" required class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e]">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">çµæŸæ—¥æœŸ</label>
                        <input type="datetime-local" id="endDate" required class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e]">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä½¿ç”¨æ¬¡æ•¸é™åˆ¶</label>
                        <input type="number" id="usageLimit" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e]" placeholder="100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ¯äººä½¿ç”¨æ¬¡æ•¸</label>
                        <input type="number" id="userLimit" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e]" placeholder="1">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">é©ç”¨å•†å“åˆ†é¡</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="categories" value="all" class="mr-2"> å…¨éƒ¨å•†å“
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="categories" value="tableware" class="mr-2"> é¤å…·ç³»åˆ—
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="categories" value="glassware" class="mr-2"> é…’å…·ç³»åˆ—
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="categories" value="decorative" class="mr-2"> æ“ºé£¾ç³»åˆ—
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="categories" value="teaware" class="mr-2"> èŒ¶å…·ç³»åˆ—
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="categories" value="kitchenware" class="mr-2"> å»šå…·ç³»åˆ—
                        </label>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»èªªæ˜</label>
                    <textarea id="couponDescription" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#17225e]" placeholder="å„ªæƒ åˆ¸ä½¿ç”¨èªªæ˜..."></textarea>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeCouponModal()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="px-6 py-3 bg-[#17225e] text-white rounded-lg hover:bg-[#1a2a6e] transition-colors">
                        <i class="fas fa-save mr-2"></i>
                        å„²å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // å„ªæƒ åˆ¸æ•¸æ“šåº«
        let couponsData = [];

        // è¼‰å…¥å„ªæƒ åˆ¸è³‡æ–™
        function loadCouponsData() {
            const savedCoupons = localStorage.getItem('couponsData');
            if (savedCoupons) {
                couponsData = JSON.parse(savedCoupons);
            } else {
                // é è¨­å„ªæƒ åˆ¸è³‡æ–™
                couponsData = [
                    {
                        id: 'C001',
                        name: 'æ–°æœƒå“¡æ­¡è¿ç¦®',
                        code: 'WELCOME2024',
                        type: 'percentage',
                        discountValue: 15,
                        minAmount: 500,
                        startDate: '2024-01-01T00:00',
                        endDate: '2024-12-31T23:59',
                        usageLimit: 1000,
                        userLimit: 1,
                        usedCount: 156,
                        categories: ['all'],
                        description: 'æ–°æœƒå“¡é¦–æ¬¡è³¼ç‰©äº«15%æŠ˜æ‰£',
                        status: 'active',
                        createdDate: '2024-01-01'
                    },
                    {
                        id: 'C002',
                        name: 'æ˜¥ç¯€ç‰¹æƒ ',
                        code: 'CNY2024',
                        type: 'fixed',
                        discountValue: 200,
                        minAmount: 1000,
                        startDate: '2024-02-01T00:00',
                        endDate: '2024-12-31T23:59',
                        usageLimit: 500,
                        userLimit: 2,
                        usedCount: 89,
                        categories: ['é¤å…·', 'èŒ¶å…·'],
                        description: 'æ˜¥ç¯€æœŸé–“é¤å…·èŒ¶å…·æ»¿åƒæŠ˜200',
                        status: 'active',
                        createdDate: '2024-01-15'
                    },
                    {
                        id: 'C004',
                        name: 'VIPæœƒå“¡å°ˆäº«',
                        code: 'VIP2024',
                        type: 'member_only',
                        discountValue: 20,
                        minAmount: 800,
                        startDate: '2024-01-01T00:00',
                        endDate: '2024-12-31T23:59',
                        usageLimit: 9999,
                        userLimit: 5,
                        usedCount: 245,
                        categories: ['all'],
                        description: 'VIPæœƒå“¡å°ˆå±¬20%æŠ˜æ‰£',
                        status: 'active',
                        createdDate: '2024-01-01'
                    }
                ];
                localStorage.setItem('couponsData', JSON.stringify(couponsData));
            }
        }

        // ä¿å­˜å„ªæƒ åˆ¸è³‡æ–™
        function saveCouponsData() {
            localStorage.setItem('couponsData', JSON.stringify(couponsData));
        }

        let currentEditingCoupon = null;

        // çµ±ä¸€å°èˆªå‡½æ•¸
        function navigateToPage(page) {
            try {
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'navigate',
                        page: page
                    }, '*');
                } else {
                    window.location.href = `${page}.html`;
                }
            } catch (error) {
                window.open(`${page}.html`, '_blank');
            }
        }

        // é é¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // é€²è¡Œæ¬Šé™æª¢æŸ¥
            const isAuthenticated = await checkAuthentication();
            if (!isAuthenticated) {
                return; // å¦‚æœæœªé€šéèªè­‰ï¼Œå‡½æ•¸æœƒè‡ªå‹•é‡å®šå‘
            }
            
            // å•Ÿå‹•å¿ƒè·³æ©Ÿåˆ¶
            console.log('ğŸ”„ Couponsé é¢ï¼šå•Ÿå‹•å¿ƒè·³æ©Ÿåˆ¶');
            HeartbeatManager.checkAndStart();
            
            loadCouponsData();
            renderCoupons();
            updateStatistics();
            setDefaultDates();
        });

        // è¨­ç½®é è¨­æ—¥æœŸ
        function setDefaultDates() {
            const now = new Date();
            const nextMonth = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
            
            document.getElementById('startDate').value = now.toISOString().slice(0, 16);
            document.getElementById('endDate').value = nextMonth.toISOString().slice(0, 16);
        }

        // æ›´æ–°çµ±è¨ˆè³‡æ–™
        function updateStatistics() {
            const total = couponsData.length;
            const active = couponsData.filter(c => c.status === 'active').length;
            const expiringSoon = couponsData.filter(c => {
                const endDate = new Date(c.endDate);
                const now = new Date();
                const daysDiff = (endDate - now) / (1000 * 60 * 60 * 24);
                return daysDiff <= 7 && daysDiff > 0 && c.status === 'active';
            }).length;
            const monthlyUsage = couponsData.reduce((sum, c) => sum + c.usedCount, 0);

            document.getElementById('totalCoupons').textContent = total;
            document.getElementById('activeCoupons').textContent = active;
            document.getElementById('expiringSoon').textContent = expiringSoon;
            document.getElementById('monthlyUsage').textContent = monthlyUsage;
        }

        // æ¸²æŸ“å„ªæƒ åˆ¸åˆ—è¡¨
        function renderCoupons() {
            const container = document.getElementById('couponsList');
            const emptyState = document.getElementById('emptyCoupons');
            
            if (couponsData.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            emptyState.classList.add('hidden');

            container.innerHTML = couponsData.map(coupon => {
                const statusBadge = getStatusBadge(coupon);
                const typeBadge = getTypeBadge(coupon);
                const progress = Math.min((coupon.usedCount / coupon.usageLimit) * 100, 100);

                return `
                    <div class="coupon-card bg-white rounded-xl p-6 shadow-md">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-800 mb-1">${coupon.name}</h3>
                                <p class="coupon-code font-mono text-lg font-bold mb-2">${coupon.code}</p>
                                <div class="flex items-center space-x-2 mb-2">
                                    ${statusBadge}
                                    ${typeBadge}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editCoupon('${coupon.id}')" class="text-[#17225e] hover:text-[#1a2a6e] p-1">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="toggleCouponStatus('${coupon.id}')" class="text-gray-600 hover:text-gray-800 p-1">
                                    <i class="fas fa-${coupon.status === 'active' ? 'pause' : 'play'}"></i>
                                </button>
                                <button onclick="deleteCoupon('${coupon.id}')" class="text-red-600 hover:text-red-800 p-1">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">æŠ˜æ‰£</span>
                                <span class="font-medium">${getDiscountText(coupon)}</span>
                            </div>
                            
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">æœ€ä½æ¶ˆè²»</span>
                                <span class="font-medium">NT$${coupon.minAmount.toLocaleString()}</span>
                            </div>
                            
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">æœ‰æ•ˆæœŸé™</span>
                                <span class="font-medium">${formatDate(coupon.endDate)}</span>
                            </div>
                            
                            <div class="space-y-1">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">ä½¿ç”¨é€²åº¦</span>
                                    <span class="font-medium">${coupon.usedCount}/${coupon.usageLimit}</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-[#17225e] h-2 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <p class="text-xs text-gray-500">${coupon.description}</p>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('couponCount').textContent = couponsData.length;
        }

        // ç²å–ç‹€æ…‹å¾½ç« 
        function getStatusBadge(coupon) {
            const now = new Date();
            const endDate = new Date(coupon.endDate);
            
            if (coupon.status === 'disabled') {
                return '<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs">å·²åœç”¨</span>';
            } else if (endDate < now) {
                return '<span class="px-2 py-1 expired-badge text-white rounded-full text-xs">å·²éæœŸ</span>';
            } else {
                return '<span class="px-2 py-1 active-badge text-white rounded-full text-xs">å•Ÿç”¨ä¸­</span>';
            }
        }

        // ç²å–é¡å‹å¾½ç« 
        function getTypeBadge(coupon) {
            const types = {
                'percentage': 'ç™¾åˆ†æ¯”',
                'fixed': 'å›ºå®šé‡‘é¡',
                'buy_x_get_y': 'è²·é€',
                'member_only': 'æœƒå“¡å°ˆå±¬'
            };
            return `<span class="px-2 py-1 bg-gray-100 text-[#17225e] rounded-full text-xs">${types[coupon.type]}</span>`;
        }

        // ç²å–æŠ˜æ‰£æ–‡å­—
        function getDiscountText(coupon) {
            switch (coupon.type) {
                case 'percentage':
                    return `${coupon.discountValue}% æŠ˜æ‰£`;
                case 'fixed':
                    return `NT$${coupon.discountValue} æŠ˜æ‰£`;
                case 'buy_x_get_y':
                    return 'è²·3é€1';
                case 'member_only':
                    return `æœƒå“¡${coupon.discountValue}% æŠ˜æ‰£`;
                default:
                    return 'ç‰¹æ®Šå„ªæƒ ';
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('zh-TW');
        }

        // é¡¯ç¤ºæ–°å¢å„ªæƒ åˆ¸å½ˆçª—
        function showAddCouponModal() {
            currentEditingCoupon = null;
            document.getElementById('modalTitle').textContent = 'æ–°å¢å„ªæƒ åˆ¸';
            document.getElementById('couponForm').reset();
            setDefaultDates();
            document.getElementById('couponModal').classList.remove('hidden');
        }

        // é—œé–‰å„ªæƒ åˆ¸å½ˆçª—
        function closeCouponModal() {
            document.getElementById('couponModal').classList.add('hidden');
            currentEditingCoupon = null;
        }

        // ç”Ÿæˆå„ªæƒ åˆ¸ä»£ç¢¼
        function generateCouponCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('couponCode').value = code;
        }

        // åˆ‡æ›æŠ˜æ‰£æ¬„ä½
        function toggleDiscountFields() {
            const type = document.getElementById('couponType').value;
            const field = document.getElementById('discountValueField');
            const label = field.querySelector('label');
            const input = field.querySelector('input');
            
            switch (type) {
                case 'percentage':
                    label.textContent = 'æŠ˜æ‰£ç™¾åˆ†æ¯” (%)';
                    input.placeholder = '15';
                    field.style.display = 'block';
                    break;
                case 'fixed':
                    label.textContent = 'æŠ˜æ‰£é‡‘é¡ (NT$)';
                    input.placeholder = '200';
                    field.style.display = 'block';
                    break;
                case 'buy_x_get_y':
                    field.style.display = 'none';
                    break;
                case 'member_only':
                    label.textContent = 'æœƒå“¡æŠ˜æ‰£ (%)';
                    input.placeholder = '20';
                    field.style.display = 'block';
                    break;
                default:
                    field.style.display = 'block';
            }
        }

        // å„ªæƒ åˆ¸è¡¨å–®æäº¤
        document.getElementById('couponForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const categories = Array.from(document.querySelectorAll('input[name="categories"]:checked')).map(cb => cb.value);
            
            const couponData = {
                id: currentEditingCoupon || 'C' + String(Date.now()).slice(-6),
                name: document.getElementById('couponName').value,
                code: document.getElementById('couponCode').value.toUpperCase(),
                type: document.getElementById('couponType').value,
                discountValue: parseFloat(document.getElementById('discountValue').value) || 0,
                minAmount: parseFloat(document.getElementById('minAmount').value) || 0,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                usageLimit: parseInt(document.getElementById('usageLimit').value) || 999,
                userLimit: parseInt(document.getElementById('userLimit').value) || 1,
                usedCount: currentEditingCoupon ? couponsData.find(c => c.id === currentEditingCoupon).usedCount : 0,
                categories: categories,
                description: document.getElementById('couponDescription').value,
                status: 'active',
                createdDate: currentEditingCoupon ? couponsData.find(c => c.id === currentEditingCoupon).createdDate : new Date().toISOString().split('T')[0]
            };

            // é©—è­‰
            if (couponsData.some(c => c.code === couponData.code && c.id !== currentEditingCoupon)) {
                alert('å„ªæƒ åˆ¸ä»£ç¢¼å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–ä»£ç¢¼');
                return;
            }

            if (currentEditingCoupon) {
                // ç·¨è¼¯
                const index = couponsData.findIndex(c => c.id === currentEditingCoupon);
                couponsData[index] = couponData;
                alert('å„ªæƒ åˆ¸æ›´æ–°æˆåŠŸï¼');
            } else {
                // æ–°å¢
                couponsData.push(couponData);
                alert('å„ªæƒ åˆ¸æ–°å¢æˆåŠŸï¼');
            }

            saveCouponsData();
            closeCouponModal();
            renderCoupons();
            updateStatistics();
        });

        // ç·¨è¼¯å„ªæƒ åˆ¸
        function editCoupon(id) {
            const coupon = couponsData.find(c => c.id === id);
            if (!coupon) return;

            currentEditingCoupon = id;
            document.getElementById('modalTitle').textContent = 'ç·¨è¼¯å„ªæƒ åˆ¸';
            
            // å¡«å…¥æ•¸æ“š
            document.getElementById('couponName').value = coupon.name;
            document.getElementById('couponCode').value = coupon.code;
            document.getElementById('couponType').value = coupon.type;
            document.getElementById('discountValue').value = coupon.discountValue;
            document.getElementById('minAmount').value = coupon.minAmount;
            document.getElementById('startDate').value = coupon.startDate;
            document.getElementById('endDate').value = coupon.endDate;
            document.getElementById('usageLimit').value = coupon.usageLimit;
            document.getElementById('userLimit').value = coupon.userLimit;
            document.getElementById('couponDescription').value = coupon.description;
            
            // è¨­ç½®åˆ†é¡è¤‡é¸æ¡†
            document.querySelectorAll('input[name="categories"]').forEach(cb => {
                cb.checked = coupon.categories.includes(cb.value);
            });

            toggleDiscountFields();
            document.getElementById('couponModal').classList.remove('hidden');
        }

        // åˆ‡æ›å„ªæƒ åˆ¸ç‹€æ…‹
        function toggleCouponStatus(id) {
            const coupon = couponsData.find(c => c.id === id);
            if (!coupon) return;

            coupon.status = coupon.status === 'active' ? 'disabled' : 'active';
            saveCouponsData();
            renderCoupons();
            updateStatistics();
            
            const statusText = coupon.status === 'active' ? 'å•Ÿç”¨' : 'åœç”¨';
            alert(`å„ªæƒ åˆ¸å·²${statusText}ï¼`);
        }

        // åˆªé™¤å„ªæƒ åˆ¸
        function deleteCoupon(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µå„ªæƒ åˆ¸å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
            
            couponsData = couponsData.filter(c => c.id !== id);
            saveCouponsData();
            renderCoupons();
            updateStatistics();
            alert('å„ªæƒ åˆ¸å·²åˆªé™¤ï¼');
        }

        // æœå°‹å„ªæƒ åˆ¸
        function searchCoupons() {
            filterCoupons();
        }

        // ç¯©é¸å„ªæƒ åˆ¸
        function filterCoupons() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;

            let filteredCoupons = couponsData;

            // æœå°‹ç¯©é¸
            if (searchTerm) {
                filteredCoupons = filteredCoupons.filter(coupon =>
                    coupon.name.toLowerCase().includes(searchTerm) ||
                    coupon.code.toLowerCase().includes(searchTerm)
                );
            }

            // ç‹€æ…‹ç¯©é¸
            if (statusFilter) {
                if (statusFilter === 'expired') {
                    filteredCoupons = filteredCoupons.filter(coupon => {
                        const endDate = new Date(coupon.endDate);
                        return endDate < new Date();
                    });
                } else {
                    filteredCoupons = filteredCoupons.filter(coupon => coupon.status === statusFilter);
                }
            }

            // é¡å‹ç¯©é¸
            if (typeFilter) {
                filteredCoupons = filteredCoupons.filter(coupon => coupon.type === typeFilter);
            }

            // æš«å­˜åŸå§‹æ•¸æ“š
            const originalData = couponsData;
            couponsData = filteredCoupons;
            renderCoupons();
            couponsData = originalData;
        }

        // æ‰¹é‡ç”Ÿæˆå„ªæƒ åˆ¸
        function generateBatchCoupons() {
            const count = prompt('è«‹è¼¸å…¥è¦ç”Ÿæˆçš„å„ªæƒ åˆ¸æ•¸é‡ï¼š', '10');
            if (!count || isNaN(count) || count <= 0) return;

            const baseName = prompt('è«‹è¼¸å…¥å„ªæƒ åˆ¸åç¨±å‰ç¶´ï¼š', 'é™æ™‚å„ªæƒ åˆ¸');
            if (!baseName) return;

            for (let i = 1; i <= parseInt(count); i++) {
                const code = 'BATCH' + String(Date.now() + i).slice(-6);
                const coupon = {
                    id: 'C' + String(Date.now() + i).slice(-6),
                    name: `${baseName} ${i}`,
                    code: code,
                    type: 'percentage',
                    discountValue: 10,
                    minAmount: 500,
                    startDate: new Date().toISOString().slice(0, 16),
                    endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 16),
                    usageLimit: 100,
                    userLimit: 1,
                    usedCount: 0,
                    categories: ['all'],
                    description: `æ‰¹é‡ç”Ÿæˆçš„å„ªæƒ åˆ¸ #${i}`,
                    status: 'active',
                    createdDate: new Date().toISOString().split('T')[0]
                };
                couponsData.push(coupon);
            }

            saveCouponsData();
            renderCoupons();
            updateStatistics();
            alert(`æˆåŠŸç”Ÿæˆ ${count} å¼µå„ªæƒ åˆ¸ï¼`);
        }

        // å°å‡ºå„ªæƒ åˆ¸çµ¦éŠ·å”®é é¢ä½¿ç”¨
        window.getCouponsData = function() {
            return couponsData;
        };

        // é©—è­‰å„ªæƒ åˆ¸
        window.validateCoupon = function(code, orderAmount, memberLevel, categories) {
            const coupon = couponsData.find(c => c.code.toUpperCase() === code.toUpperCase());
            
            if (!coupon) {
                return { valid: false, message: 'å„ªæƒ åˆ¸ä¸å­˜åœ¨' };
            }

            if (coupon.status !== 'active') {
                return { valid: false, message: 'å„ªæƒ åˆ¸å·²åœç”¨' };
            }

            const now = new Date();
            const startDate = new Date(coupon.startDate);
            const endDate = new Date(coupon.endDate);

            if (now < startDate) {
                return { valid: false, message: 'å„ªæƒ åˆ¸å°šæœªç”Ÿæ•ˆ' };
            }

            if (now > endDate) {
                return { valid: false, message: 'å„ªæƒ åˆ¸å·²éæœŸ' };
            }

            if (coupon.usedCount >= coupon.usageLimit) {
                return { valid: false, message: 'å„ªæƒ åˆ¸ä½¿ç”¨æ¬¡æ•¸å·²é”ä¸Šé™' };
            }

            if (orderAmount < coupon.minAmount) {
                return { valid: false, message: `æœ€ä½æ¶ˆè²»é‡‘é¡ç‚º NT$${coupon.minAmount}` };
            }

            if (coupon.type === 'member_only' && !memberLevel) {
                return { valid: false, message: 'æ­¤å„ªæƒ åˆ¸åƒ…é™æœƒå“¡ä½¿ç”¨' };
            }

            // æª¢æŸ¥é©ç”¨åˆ†é¡
            if (!coupon.categories.includes('all')) {
                const hasValidCategory = categories.some(cat => coupon.categories.includes(cat));
                if (!hasValidCategory) {
                    return { valid: false, message: 'å„ªæƒ åˆ¸ä¸é©ç”¨æ–¼è³¼ç‰©è»Šä¸­çš„å•†å“' };
                }
            }

            return { valid: true, coupon: coupon };
        };

        // ä½¿ç”¨å„ªæƒ åˆ¸
        window.useCoupon = function(code) {
            const coupon = couponsData.find(c => c.code.toUpperCase() === code.toUpperCase());
            if (coupon) {
                coupon.usedCount++;
                saveCouponsData();
                updateStatistics();
                renderCoupons();
            }
        };

        // å›åˆ°ä¸»é é¢
        function goBackToMenu() {
            window.location.href = '../index.html';
        }

    </script>
</body>
</html> 