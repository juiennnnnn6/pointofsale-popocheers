<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“åŒ¯å‡º/å…¥ - é€²éŠ·å­˜ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../employee-auth.js"></script>
    <script src="../database.js"></script>
    <script src="../heartbeat.js"></script>
    <script src="auth-check.js"></script>

    <style>
        .apple-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .upload-area {
            border: 2px dashed #e5e7eb;
            transition: all 0.3s ease;
        }
        .upload-area.dragover {
            border-color: #17225e;
            background-color: #eff6ff;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen p-4">
    
    <!-- æ¨™é¡Œå€åŸŸ -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">è³‡æ–™åŒ¯å‡º/å…¥</h1>
                <p class="text-gray-600">æ‰¹é‡ç®¡ç†å•†å“å’Œæœƒå“¡è³‡æ–™ï¼Œæ”¯æ´Excelå’ŒCSVæ ¼å¼</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="goBackToMenu()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-th-large mr-2"></i>å›é¸å–®
                </button>
                <button onclick="downloadTemplate()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">
                    <i class="fas fa-download mr-2"></i>ä¸‹è¼‰æ¨¡æ¿
                </button>
            </div>
        </div>
    </div>

    <!-- åŠŸèƒ½å€åŸŸ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        
        <!-- å•†å“åŒ¯å‡ºåŠŸèƒ½ -->
        <div class="apple-card rounded-xl p-6 shadow-lg">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-file-export mr-2 text-[#17225e]"></i>
                åŒ¯å‡ºå•†å“è³‡æ–™
            </h2>
            
            <!-- åŒ¯å‡ºé¸é … -->
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">åŒ¯å‡ºæ ¼å¼</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="exportFormat" value="csv" checked class="mr-2">
                            <i class="fas fa-file-csv mr-2 text-[#17225e]"></i>
                            <span>CSVæ ¼å¼</span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="exportFormat" value="excel" class="mr-2">
                            <i class="fas fa-file-excel mr-2 text-[#17225e]"></i>
                            <span>Excelæ ¼å¼</span>
                        </label>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">åŒ¯å‡ºç¯„åœ</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="exportRange" value="all" checked class="mr-2">
                            <span>æ‰€æœ‰å•†å“</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="exportRange" value="inStock" class="mr-2">
                            <span>æœ‰åº«å­˜å•†å“</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="exportRange" value="lowStock" class="mr-2">
                            <span>ä½åº«å­˜å•†å“</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="exportRange" value="outOfStock" class="mr-2">
                            <span>ç¼ºè²¨å•†å“</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- åŒ¯å‡ºæŒ‰éˆ• -->
            <button onclick="exportProducts()" class="w-full bg-[#17225e] text-white py-3 px-4 rounded-lg hover:bg-[#1a2a6e] transition-colors font-medium">
                <i class="fas fa-download mr-2"></i>
                é–‹å§‹åŒ¯å‡º
            </button>
            
            <!-- åŒ¯å‡ºç‹€æ…‹ -->
            <div id="exportStatus" class="mt-4 hidden">
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                    <div class="flex items-center">
                                                  <i class="fas fa-spinner fa-spin mr-2 text-[#17225e]"></i>
                                                  <span class="text-gray-700">æ­£åœ¨æº–å‚™åŒ¯å‡ºè³‡æ–™...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- å•†å“åŒ¯å…¥åŠŸèƒ½ -->
        <div class="apple-card rounded-xl p-6 shadow-lg">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-file-import mr-2 text-[#17225e]"></i>
                åŒ¯å…¥å•†å“è³‡æ–™
            </h2>
            
            <!-- æª”æ¡ˆä¸Šå‚³å€åŸŸ -->
            <div id="uploadArea" class="upload-area rounded-lg p-8 text-center mb-4">
                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                <p class="text-gray-600 mb-2">æ‹–æ”¾æª”æ¡ˆè‡³æ­¤è™•æˆ–é»æ“Šé¸æ“‡</p>
                <p class="text-sm text-gray-500">æ”¯æ´ .csv, .xlsx, .xls æ ¼å¼</p>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" class="hidden">
                <button onclick="selectFile()" class="mt-3 bg-[#17225e] text-white px-4 py-2 rounded-lg hover:bg-[#1a2a6e] transition-colors">
                    é¸æ“‡æª”æ¡ˆ
                </button>
            </div>
            
            <!-- æª”æ¡ˆè³‡è¨Š -->
            <div id="fileInfo" class="hidden mb-4">
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-file mr-2 text-[#17225e]"></i>
                            <span id="fileName" class="font-medium"></span>
                        </div>
                        <button onclick="clearFile()" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">
                        å¤§å°: <span id="fileSize"></span>
                    </div>
                </div>
            </div>
            
            <!-- åŒ¯å…¥é¸é … -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">åŒ¯å…¥æ¨¡å¼</label>
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="radio" name="importMode" value="update" checked class="mr-2">
                        <span>æ›´æ–°ç¾æœ‰å•†å“ï¼ˆæ ¹æ“šæ¢ç¢¼ï¼‰</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="importMode" value="add" class="mr-2">
                        <span>åªæ–°å¢æ–°å•†å“</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="importMode" value="replace" class="mr-2">
                        <span>æ›¿æ›æ‰€æœ‰å•†å“</span>
                    </label>
                </div>
            </div>
            
            <!-- åŒ¯å…¥æŒ‰éˆ• -->
            <button id="importBtn" onclick="importProducts()" disabled class="w-full bg-gray-400 text-white py-3 px-4 rounded-lg font-medium cursor-not-allowed">
                <i class="fas fa-upload mr-2"></i>
                é–‹å§‹åŒ¯å…¥
            </button>
            
            <!-- æ¸¬è©¦æŒ‰éˆ•ï¼ˆèª¿è©¦ç”¨ï¼‰ -->
            <div class="grid grid-cols-3 gap-2 mt-2">
                <button onclick="testImportFunction()" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                    <i class="fas fa-bug mr-2"></i>
                    æ¸¬è©¦åŒ¯å…¥åŠŸèƒ½
                </button>
                <button onclick="debugFileImport()" class="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors text-sm">
                    <i class="fas fa-file-alt mr-2"></i>
                    èª¿è©¦æª”æ¡ˆåŒ¯å…¥
                </button>
                <button onclick="cleanDuplicateProducts()" class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors text-sm">
                    <i class="fas fa-trash mr-2"></i>
                    æ¸…ç†é‡è¤‡å•†å“
                </button>
            </div>
        </div>
    </div>

    <!-- æœƒå“¡åŒ¯å…¥åŒ¯å‡ºåŠŸèƒ½ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        
        <!-- æœƒå“¡åŒ¯å‡ºåŠŸèƒ½ -->
        <div class="apple-card rounded-xl p-6 shadow-lg">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-file-export mr-2 text-[#17225e]"></i>
                åŒ¯å‡ºæœƒå“¡è³‡æ–™
            </h2>
            
            <!-- åŒ¯å‡ºé¸é … -->
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">åŒ¯å‡ºæ ¼å¼</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="memberExportFormat" value="csv" checked class="mr-2">
                            <i class="fas fa-file-csv mr-2 text-[#17225e]"></i>
                            <span>CSVæ ¼å¼</span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="memberExportFormat" value="excel" class="mr-2">
                            <i class="fas fa-file-excel mr-2 text-[#17225e]"></i>
                            <span>Excelæ ¼å¼</span>
                        </label>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">åŒ¯å‡ºç¯„åœ</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="memberExportRange" value="all" checked class="mr-2">
                            <span>æ‰€æœ‰æœƒå“¡</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="memberExportRange" value="active" class="mr-2">
                            <span>å•Ÿç”¨æœƒå“¡</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="memberExportRange" value="vip" class="mr-2">
                            <span>VIPæœƒå“¡</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- åŒ¯å‡ºæŒ‰éˆ• -->
            <button onclick="exportMembers()" class="w-full bg-[#17225e] text-white py-3 px-4 rounded-lg hover:bg-[#1a2a6e] transition-colors font-medium">
                <i class="fas fa-download mr-2"></i>
                é–‹å§‹åŒ¯å‡ºæœƒå“¡
            </button>
        </div>

        <!-- æœƒå“¡åŒ¯å…¥åŠŸèƒ½ -->
        <div class="apple-card rounded-xl p-6 shadow-lg">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-file-import mr-2 text-[#17225e]"></i>
                åŒ¯å…¥æœƒå“¡è³‡æ–™
            </h2>
            
            <!-- æª”æ¡ˆä¸Šå‚³å€åŸŸ -->
            <div id="memberUploadArea" class="upload-area rounded-lg p-8 text-center mb-4">
                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                <p class="text-gray-600 mb-2">æ‹–æ”¾æª”æ¡ˆè‡³æ­¤è™•æˆ–é»æ“Šé¸æ“‡</p>
                <p class="text-sm text-gray-500">æ”¯æ´ .csv, .xlsx, .xls æ ¼å¼</p>
                <input type="file" id="memberFileInput" accept=".csv,.xlsx,.xls" class="hidden">
                <button onclick="selectMemberFile()" class="mt-3 bg-[#17225e] text-white px-4 py-2 rounded-lg hover:bg-[#1a2a6e] transition-colors">
                    é¸æ“‡æª”æ¡ˆ
                </button>
            </div>
            
            <!-- æª”æ¡ˆè³‡è¨Š -->
            <div id="memberFileInfo" class="hidden mb-4">
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-file mr-2 text-[#17225e]"></i>
                            <span id="memberFileName" class="font-medium"></span>
                        </div>
                        <button onclick="clearMemberFile()" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">
                        å¤§å°: <span id="memberFileSize"></span>
                    </div>
                </div>
            </div>
            
            <!-- åŒ¯å…¥é¸é … -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">åŒ¯å…¥æ¨¡å¼</label>
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="radio" name="memberImportMode" value="update" checked class="mr-2">
                        <span>æ›´æ–°ç¾æœ‰æœƒå“¡ï¼ˆæ ¹æ“šæœƒå“¡ç·¨è™Ÿï¼‰</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="memberImportMode" value="add" class="mr-2">
                        <span>åªæ–°å¢æ–°æœƒå“¡</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="memberImportMode" value="replace" class="mr-2">
                        <span>æ›¿æ›æ‰€æœ‰æœƒå“¡</span>
                    </label>
                </div>
            </div>
            
            <!-- åŒ¯å…¥æŒ‰éˆ• -->
            <button id="memberImportBtn" onclick="importMembers()" disabled class="w-full bg-gray-400 text-white py-3 px-4 rounded-lg font-medium cursor-not-allowed">
                <i class="fas fa-upload mr-2"></i>
                é–‹å§‹åŒ¯å…¥æœƒå“¡
            </button>
        </div>
    </div>

    <!-- é€²åº¦é¡¯ç¤º -->
    <div id="progressArea" class="hidden apple-card rounded-xl p-6 shadow-lg mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">åŒ¯å…¥é€²åº¦</h3>
        <div class="space-y-4">
            <div class="bg-gray-200 rounded-full h-4">
                <div id="progressBar" class="progress-bar bg-[#17225e] h-4 rounded-full" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-sm text-gray-600">
                <span id="progressText">æº–å‚™ä¸­...</span>
                <span id="progressPercent">0%</span>
            </div>
        </div>
    </div>

    <!-- çµæœé¡¯ç¤º -->
    <div id="resultArea" class="hidden apple-card rounded-xl p-6 shadow-lg mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i id="resultIcon" class="fas fa-check-circle mr-2 text-[#17225e]"></i>
            <span id="resultTitle">åŒ¯å…¥å®Œæˆ</span>
        </h3>
        <div id="resultContent"></div>
    </div>

    <!-- å•†å“é è¦½ -->
    <div id="previewArea" class="hidden apple-card rounded-xl p-6 shadow-lg">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-eye mr-2 text-[#17225e]"></i>
            è³‡æ–™é è¦½
        </h3>
        <div class="overflow-x-auto">
            <table id="previewTable" class="min-w-full border-collapse border border-gray-300">
                <thead id="previewHeader"></thead>
                <tbody id="previewBody"></tbody>
            </table>
        </div>
        <div class="mt-4 flex justify-between items-center">
            <div class="text-sm text-gray-600">
                é¡¯ç¤ºå‰ <span id="previewCount">5</span> ç­†è³‡æ–™
            </div>
            <div class="space-x-3">
                <button onclick="cancelImport()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    å–æ¶ˆ
                </button>
                <button onclick="confirmImport()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg hover:bg-[#1a2a6e] transition-colors">
                    ç¢ºèªåŒ¯å…¥
                </button>
            </div>
        </div>
    </div>

    <script>
        // æ³¢æ³¢ èš æ­æ´²å®¶å±…/æ³¢è˜­é™¶é£Ÿå™¨å•†å“è³‡æ–™åº«ï¼ˆæ”¯æ´åŒæ¢ç¢¼å¤šå•†å“å°é …ï¼‰
        let products = {};
        
        // åˆå§‹åŒ–å•†å“è³‡æ–™ï¼ˆå±•å¹³å¤šå•†å“å°é …çµæ§‹ä»¥ä¾¿åŒ¯å‡ºå…¥ï¼‰
        const mockProducts = {
            '1234567890123': [  // æ­å¼éª¨ç“·é¤ç›¤ç³»åˆ—
                {
                    id: 'P001-01',
                    name: 'æ­å¼éª¨ç“·é¤ç›¤',
                    variant: '20cm ç™½è‰²ç¶“å…¸æ¬¾',
                    price: 890,
                    stock: 15,
                    category: 'é¤å…·',
                    supplier: 'æ­æ´²ç²¾å“ç“·å™¨',
                    description: 'ç´”ç™½éª¨ç“·ï¼Œç¶“å…¸æ­å¼è¨­è¨ˆ'
                },
                {
                    id: 'P001-02',
                    name: 'æ­å¼éª¨ç“·é¤ç›¤',
                    variant: '20cm è—èŠ±åœ–æ¡ˆæ¬¾',
                    price: 950,
                    stock: 8,
                    category: 'é¤å…·',
                    supplier: 'æ­æ´²ç²¾å“ç“·å™¨',
                    description: 'æ‰‹ç¹ªè—èŠ±åœ–æ¡ˆï¼Œç²¾ç·»å·¥è—'
                },
                {
                    id: 'P001-03',
                    name: 'æ­å¼éª¨ç“·é¤ç›¤',
                    variant: '20cm é‡‘é‚Šå¥¢è¯æ¬¾',
                    price: 1280,
                    stock: 5,
                    category: 'é¤å…·',
                    supplier: 'æ­æ´²ç²¾å“ç“·å™¨',
                    description: '24Ké‡‘é‚Šè£é£¾ï¼Œå¥¢è¯å…¸é›…'
                }
            ],
            '2345678901234': [  // æ°´æ™¶é…’æ¯ç³»åˆ—
                {
                    id: 'P002-01',
                    name: 'æ–½è¯æ´›ä¸–å¥‡æ°´æ™¶é…’æ¯',
                    variant: 'ç´…é…’æ¯ 300ml',
                    price: 2890,
                    stock: 12,
                    category: 'é…’å…·',
                    supplier: 'æ–½è¯æ´›ä¸–å¥‡',
                    description: 'å¥§åœ°åˆ©æ°´æ™¶ï¼Œå®Œç¾é…’æ¯å¼§åº¦'
                },
                {
                    id: 'P002-02',
                    name: 'æ–½è¯æ´›ä¸–å¥‡æ°´æ™¶é…’æ¯',
                    variant: 'é¦™æª³æ¯ 200ml',
                    price: 2590,
                    stock: 18,
                    category: 'é…’å…·',
                    supplier: 'æ–½è¯æ´›ä¸–å¥‡',
                    description: 'ç´°é•·æ¯èº«ï¼Œä¿æŒæ°£æ³¡å®Œç¾'
                }
            ],
            '3456789012345': [  // å®¶å±…æ“ºé£¾ç³»åˆ—
                {
                    id: 'P003-01',
                    name: 'åŒ—æ­é¢¨é™¶ç“·èŠ±ç“¶',
                    variant: 'å°è™Ÿ 15cm ç°è‰²',
                    price: 680,
                    stock: 25,
                    category: 'æ“ºé£¾',
                    supplier: 'åŒ—æ­å®¶å±…',
                    description: 'ç°¡ç´„åŒ—æ­è¨­è¨ˆï¼Œå•å…‰è³ªæ„Ÿ'
                },
                {
                    id: 'P003-02',
                    name: 'åŒ—æ­é¢¨é™¶ç“·èŠ±ç“¶',
                    variant: 'ä¸­è™Ÿ 25cm ç™½è‰²',
                    price: 980,
                    stock: 15,
                    category: 'æ“ºé£¾',
                    supplier: 'åŒ—æ­å®¶å±…',
                    description: 'ç´”ç™½é™¶ç“·ï¼Œä¸­æ€§ç™¾æ­'
                }
            ],
            '4567890123456': [  // èŒ¶å…·ç³»åˆ—
                {
                    id: 'P004-01',
                    name: 'è‹±å¼éª¨ç“·èŒ¶æ¯çµ„',
                    variant: 'ç¶“å…¸ç«ç‘°åœ–æ¡ˆ',
                    price: 1590,
                    stock: 0,
                    category: 'èŒ¶å…·',
                    supplier: 'è‹±åœ‹çš‡å®¶ç“·å™¨',
                    description: 'å‚³çµ±è‹±å¼ä¸‹åˆèŒ¶èŒ¶æ¯'
                }
            ],
            '5678901234567': [  // é¤å…·å¥—è£
                {
                    id: 'P005-01',
                    name: 'æ³•å¼é¤å…·å¥—è£',
                    variant: '4äººä»½åŸºç¤æ¬¾',
                    price: 3890,
                    stock: 6,
                    category: 'é¤å…·',
                    supplier: 'æ³•åœ‹é¤å…·',
                    description: 'åŒ…å«é¤ç›¤ã€æ¹¯ç¢—ã€èŒ¶æ¯'
                },
                {
                    id: 'P005-02',
                    name: 'æ³•å¼é¤å…·å¥—è£',
                    variant: '4äººä»½è±ªè¯æ¬¾',
                    price: 5890,
                    stock: 3,
                    category: 'é¤å…·',
                    supplier: 'æ³•åœ‹é¤å…·',
                    description: 'åŒ…å«é¤ç›¤ã€æ¹¯ç¢—ã€èŒ¶æ¯ã€ç”œé»ç›¤'
                }
            ],
            '6789012345678': [  // å»šæˆ¿ç”¨å“
                {
                    id: 'P006-01',
                    name: 'å¾·åœ‹ä¸é½é‹¼å»šå…·',
                    variant: 'åŸºç¤3ä»¶çµ„',
                    price: 2200,
                    stock: 12,
                    category: 'å»šå…·',
                    supplier: 'å¾·åœ‹å»šå…·',
                    description: 'æ¹¯å‹ºã€æ¼å‹ºã€éŸå­'
                }
            ]
        };

        // å±•å¹³æ•¸æ“šçµæ§‹ç‚ºå–®ä¸€å•†å“æ ¼å¼ï¼ˆç”¨æ–¼åŒ¯å‡ºå…¥ï¼‰
        for (const barcode in mockProducts) {
            mockProducts[barcode].forEach(product => {
                products[product.id] = {
                    name: `${product.name} - ${product.variant}`,
                    price: product.price,
                    stock: product.stock,
                    category: product.category,
                    supplier: product.supplier,
                    barcode: barcode,
                    variant: product.variant,
                    description: product.description
                };
            });
        }

        let selectedFile = null;
        let parsedData = null;
        let memberSelectedFile = null;
        let memberParsedData = null;

        // çµ±ä¸€å°èˆªå‡½æ•¸
        function navigateToPage(page) {
            try {
                // å˜—è©¦èˆ‡çˆ¶é é¢é€šä¿¡åˆ‡æ›iframe
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'navigate',
                        page: page
                    }, '*');
                } else {
                    // å¦‚æœä¸åœ¨iframeä¸­ï¼Œç›´æ¥è·³è½‰
                    window.location.href = `${page}.html`;
                }
            } catch (error) {
                // å‚™ç”¨æ–¹æ¡ˆï¼šåœ¨æ–°åˆ†é ä¸­é–‹å•Ÿ
                window.open(`${page}.html`, '_blank');
            }
        }

        // å›åˆ°ä¸»é é¢
        function goBackToMenu() {
            window.location.href = '../index.html';
        }

        // ä¸‹è¼‰æ¨¡æ¿
        function downloadTemplate() {
            // å•†å“æ¨¡æ¿
            const productHeaders = ['æ¢ç¢¼', 'å•†å“åç¨±', 'åƒ¹æ ¼', 'åº«å­˜', 'åˆ†é¡', 'ä¾›æ‡‰å•†', 'æè¿°', 'æœ€ä½åº«å­˜', 'æˆæœ¬'];
            const productSampleData = [
                ['1234567890123', 'æ­å¼éª¨ç“·é¤ç›¤', '890', '15', 'é¤å…·', 'æ­æ´²ç“·å™¨ä¾›æ‡‰å•†', 'ç´”ç™½éª¨ç“·ï¼Œç¶“å…¸æ­å¼è¨­è¨ˆ', '10', '600'],
                ['2345678901234', 'æ–½è¯æ´›ä¸–å¥‡æ°´æ™¶é…’æ¯', '2890', '12', 'é…’å…·', 'å¥§åœ°åˆ©æ°´æ™¶ä¾›æ‡‰å•†', 'å¥§åœ°åˆ©æ°´æ™¶ï¼Œå®Œç¾é…’æ¯å¼§åº¦', '5', '2000']
            ];
            
            const productCsvContent = [productHeaders, ...productSampleData]
                .map(row => {
                    return row.map(field => {
                        const fieldStr = String(field || '');
                        if (fieldStr.includes(',') || fieldStr.includes('"') || fieldStr.includes('\n') || fieldStr.includes('\r')) {
                            return '"' + fieldStr.replace(/"/g, '""') + '"';
                        }
                        return fieldStr;
                    }).join(',');
                })
                .join('\r\n');
            
            const productBlob = new Blob(['\uFEFF' + productCsvContent], { type: 'text/csv;charset=utf-8;' });
            const productLink = document.createElement('a');
            productLink.href = URL.createObjectURL(productBlob);
            productLink.download = 'å•†å“åŒ¯å…¥æ¨¡æ¿.csv';
            productLink.click();
            
            // æœƒå“¡æ¨¡æ¿
            const memberHeaders = ['æœƒå“¡ç·¨è™Ÿ', 'å§“å', 'é›»è©±', 'é›»å­éƒµä»¶', 'ç”Ÿæ—¥', 'æœƒå“¡ç­‰ç´š', 'ç©åˆ†', 'ç‹€æ…‹', 'åœ°å€', 'å‚™è¨»'];
            const memberSampleData = [
                ['M001', 'ç‹å°æ˜', '0912345678', 'wang@example.com', '1990-01-15', 'ä¸€èˆ¬', '100', 'active', 'å°åŒ—å¸‚ä¿¡ç¾©å€', 'æ–°æœƒå“¡'],
                ['M002', 'æç¾è¯', '0923456789', 'lee@example.com', '1985-05-20', 'é‡‘å¡', '500', 'active', 'å°åŒ—å¸‚å¤§å®‰å€', 'VIPå®¢æˆ¶']
            ];
            
            const memberCsvContent = [memberHeaders, ...memberSampleData]
                .map(row => {
                    return row.map(field => {
                        const fieldStr = String(field || '');
                        if (fieldStr.includes(',') || fieldStr.includes('"') || fieldStr.includes('\n') || fieldStr.includes('\r')) {
                            return '"' + fieldStr.replace(/"/g, '""') + '"';
                        }
                        return fieldStr;
                    }).join(',');
                })
                .join('\r\n');
            
            const memberBlob = new Blob(['\uFEFF' + memberCsvContent], { type: 'text/csv;charset=utf-8;' });
            const memberLink = document.createElement('a');
            memberLink.href = URL.createObjectURL(memberBlob);
            memberLink.download = 'æœƒå“¡åŒ¯å…¥æ¨¡æ¿.csv';
            memberLink.click();
            
            showMessage('å•†å“å’Œæœƒå“¡æ¨¡æ¿å·²ä¸‹è¼‰ï¼Œè«‹ä¾ç…§æ ¼å¼å¡«å…¥è³‡æ–™', 'success');
        }

        // åŒ¯å‡ºå•†å“
        async function exportProducts() {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            const range = document.querySelector('input[name="exportRange"]:checked').value;
            
            document.getElementById('exportStatus').classList.remove('hidden');
            
            try {
                // åˆå§‹åŒ–è³‡æ–™åº«é€£æ¥
                await DatabaseManager.initialize();
                
                let productsData = [];
                
                if (DatabaseManager.isConnected()) {
                    // å¾ Supabase ç²å–å•†å“è³‡æ–™
                    console.log('å¾ Supabase è¼‰å…¥å•†å“è³‡æ–™...');
                    const data = await BusinessAPI.getProducts();
                    if (data && data.length > 0) {
                        productsData = data;
                        console.log('æˆåŠŸè¼‰å…¥', productsData.length, 'ç­†å•†å“è³‡æ–™');
                    } else {
                        console.log('Supabase ä¸­ç„¡å•†å“è³‡æ–™ï¼Œå˜—è©¦æœ¬åœ°è³‡æ–™');
                        const savedProducts = localStorage.getItem('productData');
                        productsData = savedProducts ? JSON.parse(savedProducts) : [];
                    }
                } else {
                    console.log('è³‡æ–™åº«æœªé€£æ¥ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™');
                    const savedProducts = localStorage.getItem('productData');
                    productsData = savedProducts ? JSON.parse(savedProducts) : [];
                }
                
                if (productsData.length === 0) {
                    document.getElementById('exportStatus').classList.add('hidden');
                    showMessage('ç„¡å•†å“è³‡æ–™å¯åŒ¯å‡º', 'warning');
                    return;
                }
                
                // è¼‰å…¥åˆ†é¡è³‡æ–™ä»¥é€²è¡Œåç¨±æ˜ å°„
                let categoriesData = [];
                try {
                    categoriesData = await BusinessAPI.getCategories() || [];
                    console.log('è¼‰å…¥åˆ†é¡è³‡æ–™ç”¨æ–¼æ˜ å°„:', categoriesData.length, 'ç­†');
                } catch (error) {
                    console.error('è¼‰å…¥åˆ†é¡è³‡æ–™å¤±æ•—:', error);
                }
                
                // æ ¹æ“šç¯„åœéæ¿¾å•†å“
                const filteredProducts = filterProductsFromData(productsData, range);
                
                const headers = ['æ¢ç¢¼', 'å•†å“åç¨±', 'åƒ¹æ ¼', 'åº«å­˜', 'åˆ†é¡', 'ä¾›æ‡‰å•†', 'æè¿°', 'æœ€ä½åº«å­˜', 'æˆæœ¬'];
                const data = [headers];
                
                filteredProducts.forEach(product => {
                    // æ ¹æ“š category_id æŸ¥æ‰¾åˆ†é¡åç¨±
                    let categoryName = '';
                    if (product.category) {
                        categoryName = product.category;
                    } else if (product.category_id) {
                        const categoryObj = categoriesData.find(cat => cat.id === product.category_id);
                        categoryName = categoryObj ? categoryObj.name : `åˆ†é¡ID: ${product.category_id}`;
                    } else {
                        categoryName = 'æœªåˆ†é¡';
                    }
                    
                    data.push([
                        product.barcode || '',
                        product.name || '',
                        product.price || 0,
                        product.stock || 0,
                        categoryName,
                        product.supplier || '',
                        product.description || '',
                        product.min_stock || 10,
                        product.cost || 0
                    ]);
                });
                
                if (format === 'csv') {
                    exportAsCSV(data);
                } else {
                    exportAsExcel(data);
                }
                
                document.getElementById('exportStatus').classList.add('hidden');
                showMessage(`å·²åŒ¯å‡º ${data.length - 1} ç­†å•†å“è³‡æ–™`, 'success');
                
            } catch (error) {
                console.error('åŒ¯å‡ºå•†å“è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                document.getElementById('exportStatus').classList.add('hidden');
                showMessage('åŒ¯å‡ºå•†å“è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

        // éæ¿¾å•†å“ï¼ˆæ–°ç‰ˆæœ¬ - è™•ç†å¯¦éš›è³‡æ–™ï¼‰
        function filterProductsFromData(productsData, range) {
            return productsData.filter(product => {
                switch(range) {
                    case 'all':
                        return true;
                    case 'inStock':
                        return (product.stock || 0) > 0;
                    case 'lowStock':
                        const stock = product.stock || 0;
                        const minStock = product.min_stock || 10;
                        return stock <= minStock && stock > 0;
                    case 'outOfStock':
                        return (product.stock || 0) === 0;
                    default:
                        return true;
                }
            });
        }

        // éæ¿¾å•†å“ï¼ˆèˆŠç‰ˆæœ¬ - ä¿ç•™ä»¥å‚™ç”¨ï¼‰
        function filterProducts(range) {
            const filtered = {};
            Object.entries(products).forEach(([barcode, product]) => {
                switch(range) {
                    case 'all':
                        filtered[barcode] = product;
                        break;
                    case 'inStock':
                        if (product.stock > 0) filtered[barcode] = product;
                        break;
                    case 'lowStock':
                        if (product.stock <= 5 && product.stock > 0) filtered[barcode] = product;
                        break;
                    case 'outOfStock':
                        if (product.stock === 0) filtered[barcode] = product;
                        break;
                }
            });
            return filtered;
        }

        // åŒ¯å‡ºç‚ºCSV
        function exportAsCSV(data) {
            // ä½¿ç”¨æ›´åš´æ ¼çš„CSVæ ¼å¼è™•ç†
            const csvContent = data
                .map(row => {
                    return row.map(field => {
                        // è™•ç†æ¬„ä½ä¸­çš„ç‰¹æ®Šå­—ç¬¦
                        const fieldStr = String(field || '');
                        // å¦‚æœæ¬„ä½åŒ…å«é€—è™Ÿã€å¼•è™Ÿæˆ–æ›è¡Œç¬¦ï¼Œéœ€è¦ç”¨å¼•è™ŸåŒ…åœä¸¦è½‰ç¾©å¼•è™Ÿ
                        if (fieldStr.includes(',') || fieldStr.includes('"') || fieldStr.includes('\n') || fieldStr.includes('\r')) {
                            return '"' + fieldStr.replace(/"/g, '""') + '"';
                        }
                        return fieldStr;
                    }).join(',');
                })
                .join('\r\n'); // ä½¿ç”¨Windowsæ¨™æº–çš„æ›è¡Œç¬¦
            
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `å•†å“è³‡æ–™_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // åŒ¯å‡ºç‚ºExcel (ç°¡åŒ–ç‰ˆ)
        function exportAsExcel(data) {
            // ä½¿ç”¨è£½è¡¨ç¬¦åˆ†éš”çš„æ ¼å¼ï¼Œç¢ºä¿Excelèƒ½æ­£ç¢ºè­˜åˆ¥æ¬„ä½
            const excelContent = data
                .map(row => {
                    return row.map(field => {
                        const fieldStr = String(field || '');
                        // Excelæ ¼å¼ï¼šå¦‚æœåŒ…å«è£½è¡¨ç¬¦æˆ–æ›è¡Œç¬¦ï¼Œéœ€è¦ç”¨å¼•è™ŸåŒ…åœ
                        if (fieldStr.includes('\t') || fieldStr.includes('\n') || fieldStr.includes('\r')) {
                            return '"' + fieldStr.replace(/"/g, '""') + '"';
                        }
                        return fieldStr;
                    }).join('\t');
                })
                .join('\r\n');
            
            const blob = new Blob(['\uFEFF' + excelContent], { type: 'application/vnd.ms-excel;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `å•†å“è³‡æ–™_${new Date().toISOString().split('T')[0]}.xls`;
            link.click();
        }

        // é¸æ“‡æª”æ¡ˆ
        function selectFile() {
            document.getElementById('fileInput').click();
        }

        // æª”æ¡ˆé¸æ“‡äº‹ä»¶
        document.getElementById('fileInput').addEventListener('change', function(e) {
            handleFile(e.target.files[0]);
        });

        // æ‹–æ”¾äº‹ä»¶
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

        // è™•ç†æª”æ¡ˆ
        function handleFile(file) {
            if (!file) return;
            
            const allowedTypes = [
                'text/csv',
                'application/vnd.ms-excel',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            ];
            
            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(csv|xlsx|xls)$/i)) {
                showMessage('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼Œè«‹é¸æ“‡CSVæˆ–Excelæª”æ¡ˆ', 'error');
                return;
            }
            
            selectedFile = file;
            
            // é¡¯ç¤ºæª”æ¡ˆè³‡è¨Š
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').classList.remove('hidden');
            
            // å•Ÿç”¨åŒ¯å…¥æŒ‰éˆ•
            const importBtn = document.getElementById('importBtn');
            importBtn.disabled = false;
            importBtn.className = 'w-full bg-[#17225e] text-white py-3 px-4 rounded-lg hover:bg-[#1a2a6e] transition-colors font-medium';
        }

        // æ ¼å¼åŒ–æª”æ¡ˆå¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ¸…é™¤æª”æ¡ˆ
        function clearFile() {
            console.log('ğŸ—‘ï¸ æ¸…é™¤æª”æ¡ˆå’Œè§£æè³‡æ–™');
            selectedFile = null;
            parsedData = null;
            memberSelectedFile = null;
            memberParsedData = null;
            
            // æ¸…é™¤å•†å“æª”æ¡ˆè³‡è¨Š
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            
            // æ¸…é™¤æœƒå“¡æª”æ¡ˆè³‡è¨Š
            document.getElementById('memberFileInfo').classList.add('hidden');
            document.getElementById('memberFileInput').value = '';
            
            // ç¦ç”¨åŒ¯å…¥æŒ‰éˆ•
            const importBtn = document.getElementById('importBtn');
            importBtn.disabled = true;
            importBtn.className = 'w-full bg-gray-400 text-white py-3 px-4 rounded-lg font-medium cursor-not-allowed';
            
            const memberImportBtn = document.getElementById('memberImportBtn');
            memberImportBtn.disabled = true;
            memberImportBtn.className = 'w-full bg-gray-400 text-white py-3 px-4 rounded-lg font-medium cursor-not-allowed';
            
            hideAreas(['previewArea', 'progressArea', 'resultArea']);
        }

        // åŒ¯å…¥å•†å“
        function importProducts() {
            if (!selectedFile) return;
            
            showProgressArea();
            updateProgress(10, 'è®€å–æª”æ¡ˆä¸­...');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    updateProgress(30, 'è§£æè³‡æ–™ä¸­...');
                    
                    setTimeout(() => {
                        if (selectedFile.name.toLowerCase().includes('.csv')) {
                            parsedData = parseCSV(data);
                        } else {
                            // ç°¡åŒ–çš„Excelè§£æï¼Œå¯¦éš›å°ˆæ¡ˆä¸­æ‡‰ä½¿ç”¨å°ˆé–€çš„åº«
                            parsedData = parseCSV(data);
                        }
                        
                        console.log('ğŸ“„ è§£æå®Œæˆï¼ŒparsedDataå·²æ›´æ–°:', parsedData);
                        
                        updateProgress(60, 'é©—è­‰è³‡æ–™ä¸­...');
                        
                        setTimeout(() => {
                            if (validateData(parsedData)) {
                                updateProgress(80, 'æº–å‚™é è¦½...');
                                setTimeout(() => {
                                    showPreview(parsedData);
                                    hideProgressArea();
                                    console.log('ğŸ“„ é è¦½å·²é¡¯ç¤ºï¼ŒparsedDataæº–å‚™å°±ç·’');
                                }, 1000);
                            } else {
                                hideProgressArea();
                                showMessage('è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹', 'error');
                            }
                        }, 1000);
                    }, 1000);
                } catch (error) {
                    hideProgressArea();
                    showMessage('æª”æ¡ˆè®€å–å¤±æ•—: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(selectedFile, 'UTF-8');
        }

        // è§£æCSV
        function parseCSV(text) {
            console.log('ğŸ“„ é–‹å§‹è§£æCSVæª”æ¡ˆ...');
            console.log('ğŸ“„ æª”æ¡ˆå…§å®¹å‰200å­—ç¬¦:', text.substring(0, 200));
            
            const lines = text.split('\n').filter(line => line.trim());
            console.log('ğŸ“„ ç¸½è¡Œæ•¸:', lines.length);
            
            const result = [];
            
            lines.forEach((line, index) => {
                const row = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                row.push(current.trim());
                result.push(row);
                
                // é¡¯ç¤ºå‰å¹¾è¡Œçš„è§£æçµæœ
                if (index < 3) {
                    console.log(`ğŸ“„ ç¬¬${index + 1}è¡Œè§£æçµæœ:`, row);
                }
            });
            
            console.log('ğŸ“„ CSVè§£æå®Œæˆï¼Œç¸½è¨ˆ', result.length, 'è¡Œ');
            console.log('ğŸ“„ è§£æçµæœ:', result);
            
            return result;
        }

        // é©—è­‰æœƒå“¡è³‡æ–™
        function validateMemberData(data) {
            console.log('ğŸ” é–‹å§‹é©—è­‰æœƒå“¡è³‡æ–™...');
            console.log('ğŸ” æœƒå“¡é©—è­‰è³‡æ–™:', data);
            
            if (!data || data.length < 2) {
                console.log('âŒ æœƒå“¡é©—è­‰å¤±æ•—: è³‡æ–™ç‚ºç©ºæˆ–è¡Œæ•¸ä¸è¶³');
                return false;
            }
            
            const headers = data[0];
            console.log('ğŸ” æœƒå“¡è¡¨é ­:', headers);
            
            const expectedHeaders = ['æœƒå“¡ç·¨è™Ÿ', 'å§“å', 'é›»è©±', 'é›»å­éƒµä»¶'];
            const optionalHeaders = ['ç”Ÿæ—¥', 'æœƒå“¡ç­‰ç´š', 'ç©åˆ†', 'ç‹€æ…‹', 'åœ°å€', 'å‚™è¨»'];
            
            // æª¢æŸ¥å¿…è¦æ¬„ä½
            const hasRequiredHeaders = expectedHeaders.every(header => 
                headers.some(h => h.includes(header) || header.includes(h))
            );
            
            if (!hasRequiredHeaders) {
                console.log('âŒ æœƒå“¡é©—è­‰å¤±æ•—: ç¼ºå°‘å¿…è¦æ¬„ä½');
                console.log('ç¼ºå°‘å¿…è¦æ¬„ä½:', expectedHeaders);
                console.log('å¯¦éš›æ¬„ä½:', headers);
                return false;
            }
            
            console.log('âœ… æœƒå“¡è¡¨é ­é©—è­‰é€šé');
            
            // æª¢æŸ¥è³‡æ–™è¡Œæ˜¯å¦æœ‰åŸºæœ¬å…§å®¹
            for (let i = 1; i < Math.min(data.length, 6); i++) {
                const row = data[i];
                console.log(`ğŸ” é©—è­‰æœƒå“¡ç¬¬${i}è¡Œ:`, row);
                
                if (!row || row.length < expectedHeaders.length) {
                    console.log(`âŒ æœƒå“¡é©—è­‰å¤±æ•—: ç¬¬${i}è¡Œè³‡æ–™ä¸å®Œæ•´`);
                    return false;
                }
                
                // æª¢æŸ¥æœƒå“¡ç·¨è™Ÿå’Œå§“å
                if (!row[0] || !row[1]) {
                    console.log(`âŒ æœƒå“¡é©—è­‰å¤±æ•—: ç¬¬${i}è¡Œç¼ºå°‘æœƒå“¡ç·¨è™Ÿæˆ–å§“å`);
                    return false;
                }
            }
            
            console.log('âœ… æœƒå“¡è³‡æ–™é©—è­‰é€šé');
            return true;
        }

        // é©—è­‰è³‡æ–™
        function validateData(data) {
            console.log('ğŸ” é–‹å§‹é©—è­‰è³‡æ–™...');
            console.log('ğŸ” é©—è­‰è³‡æ–™:', data);
            
            if (!data || data.length < 2) {
                console.log('âŒ é©—è­‰å¤±æ•—: è³‡æ–™ç‚ºç©ºæˆ–è¡Œæ•¸ä¸è¶³');
                return false;
            }
            
            const headers = data[0];
            console.log('ğŸ” è¡¨é ­:', headers);
            
            const expectedHeaders = ['æ¢ç¢¼', 'å•†å“åç¨±', 'åƒ¹æ ¼', 'åº«å­˜', 'åˆ†é¡', 'ä¾›æ‡‰å•†'];
            const optionalHeaders = ['æè¿°', 'æœ€ä½åº«å­˜', 'æˆæœ¬'];
            
            // æª¢æŸ¥å¿…è¦æ¬„ä½
            const hasRequiredHeaders = expectedHeaders.every(header => 
                headers.some(h => h.includes(header) || header.includes(h))
            );
            
            if (!hasRequiredHeaders) {
                console.log('âŒ é©—è­‰å¤±æ•—: ç¼ºå°‘å¿…è¦æ¬„ä½');
                console.log('ç¼ºå°‘å¿…è¦æ¬„ä½:', expectedHeaders);
                console.log('å¯¦éš›æ¬„ä½:', headers);
                return false;
            }
            
            console.log('âœ… è¡¨é ­é©—è­‰é€šé');
            
            // æª¢æŸ¥è³‡æ–™è¡Œæ˜¯å¦æœ‰åŸºæœ¬å…§å®¹
            for (let i = 1; i < Math.min(data.length, 6); i++) {
                const row = data[i];
                console.log(`ğŸ” é©—è­‰ç¬¬${i}è¡Œ:`, row);
                
                if (!row || row.length < expectedHeaders.length) {
                    console.log(`âŒ é©—è­‰å¤±æ•—: ç¬¬${i}è¡Œè³‡æ–™ä¸å®Œæ•´`);
                    return false;
                }
                
                // æª¢æŸ¥æ¢ç¢¼å’Œå•†å“åç¨±
                if (!row[0] || !row[1]) {
                    console.log(`âŒ é©—è­‰å¤±æ•—: ç¬¬${i}è¡Œç¼ºå°‘æ¢ç¢¼æˆ–å•†å“åç¨±`);
                    return false;
                }
            }
            
            console.log('âœ… è³‡æ–™é©—è­‰é€šé');
            return true;
        }

        // é¡¯ç¤ºé è¦½
        function showPreview(data) {
            const previewArea = document.getElementById('previewArea');
            const previewHeader = document.getElementById('previewHeader');
            const previewBody = document.getElementById('previewBody');
            
            // æ¸…ç©ºè¡¨æ ¼
            previewHeader.innerHTML = '';
            previewBody.innerHTML = '';
            
            // æ·»åŠ è¡¨é ­
            const headerRow = document.createElement('tr');
            data[0].forEach(header => {
                const th = document.createElement('th');
                th.className = 'border border-gray-300 px-4 py-2 bg-gray-50 font-medium text-left';
                th.textContent = header;
                headerRow.appendChild(th);
            });
            previewHeader.appendChild(headerRow);
            
            // æ·»åŠ è³‡æ–™è¡Œï¼ˆæœ€å¤š5è¡Œï¼‰
            const previewCount = Math.min(5, data.length - 1);
            for (let i = 1; i <= previewCount; i++) {
                const row = document.createElement('tr');
                data[i].forEach(cell => {
                    const td = document.createElement('td');
                    td.className = 'border border-gray-300 px-4 py-2';
                    td.textContent = cell;
                    row.appendChild(td);
                });
                previewBody.appendChild(row);
            }
            
            document.getElementById('previewCount').textContent = previewCount;
            previewArea.classList.remove('hidden');
        }

        // ç¢ºèªåŒ¯å…¥
        async function confirmImport() {
            // æª¢æŸ¥æ˜¯å•†å“åŒ¯å…¥é‚„æ˜¯æœƒå“¡åŒ¯å…¥
            const isMemberImport = memberParsedData && memberParsedData.length > 0;
            const isProductImport = parsedData && parsedData.length > 0;
            
            if (!isMemberImport && !isProductImport) {
                showMessage('æ²’æœ‰å¯åŒ¯å…¥çš„è³‡æ–™ï¼Œè«‹é‡æ–°é¸æ“‡æª”æ¡ˆ', 'error');
                return;
            }
            
            if (isMemberImport) {
                await confirmMemberImport();
            } else {
                await confirmProductImport();
            }
        }

        // ç¢ºèªå•†å“åŒ¯å…¥
        async function confirmProductImport() {
            const importMode = document.querySelector('input[name="importMode"]:checked').value;
            
            console.log('ğŸ“¥ é–‹å§‹ç¢ºèªå•†å“åŒ¯å…¥ï¼ŒåŒ¯å…¥æ¨¡å¼:', importMode);
            console.log('ğŸ“¥ parsedDataç‹€æ…‹:', parsedData ? `æœ‰è³‡æ–™ï¼Œ${parsedData.length}è¡Œ` : 'ç„¡è³‡æ–™');
            
            showProgressArea();
            hideAreas(['previewArea']);
            
            updateProgress(10, 'åˆå§‹åŒ–è³‡æ–™åº«é€£æ¥...');
            
            try {
                // åˆå§‹åŒ–è³‡æ–™åº«é€£æ¥
                await DatabaseManager.initialize();
                
                if (!DatabaseManager.isConnected()) {
                    throw new Error('ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
                }
                
                updateProgress(20, 'è¼‰å…¥åˆ†é¡è³‡æ–™...');
                
                // è¼‰å…¥åˆ†é¡è³‡æ–™ä»¥é€²è¡Œåç¨±åˆ°IDçš„æ˜ å°„
                let categoriesData = [];
                try {
                    categoriesData = await BusinessAPI.getCategories() || [];
                    console.log('è¼‰å…¥åˆ†é¡è³‡æ–™ç”¨æ–¼åŒ¯å…¥:', categoriesData.length, 'ç­†');
                } catch (error) {
                    console.error('è¼‰å…¥åˆ†é¡è³‡æ–™å¤±æ•—:', error);
                    showMessage('è¼‰å…¥åˆ†é¡è³‡æ–™å¤±æ•—ï¼Œå°‡ä½¿ç”¨é è¨­åˆ†é¡', 'warning');
                }
                
                // è¼‰å…¥ç¾æœ‰å•†å“è³‡æ–™ï¼ˆç”¨æ–¼æª¢æŸ¥é‡è¤‡ï¼‰
                let existingProducts = [];
                try {
                    existingProducts = await BusinessAPI.getProducts() || [];
                    console.log('è¼‰å…¥ç¾æœ‰å•†å“è³‡æ–™:', existingProducts.length, 'ç­†');
                } catch (error) {
                    console.error('è¼‰å…¥ç¾æœ‰å•†å“è³‡æ–™å¤±æ•—:', error);
                    if (importMode === 'add') {
                        showMessage('ç„¡æ³•æª¢æŸ¥ç¾æœ‰å•†å“ï¼Œå¯èƒ½å°è‡´é‡è¤‡åŒ¯å…¥', 'warning');
                    }
                }
                
                // è¼‰å…¥ä¾›æ‡‰å•†è³‡æ–™ï¼ˆç”¨æ–¼æª¢æŸ¥å¤–éµç´„æŸï¼‰
                let suppliersData = [];
                try {
                    suppliersData = await BusinessAPI.getSuppliers() || [];
                    console.log('è¼‰å…¥ä¾›æ‡‰å•†è³‡æ–™:', suppliersData.length, 'ç­†');
                } catch (error) {
                    console.error('è¼‰å…¥ä¾›æ‡‰å•†è³‡æ–™å¤±æ•—:', error);
                    showMessage('è¼‰å…¥ä¾›æ‡‰å•†è³‡æ–™å¤±æ•—ï¼Œå°‡è·³éä¾›æ‡‰å•†é©—è­‰', 'warning');
                }
                
                updateProgress(30, 'é–‹å§‹åŒ¯å…¥å•†å“è³‡æ–™...');
                
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                // è·³éè¡¨é ­ï¼Œè™•ç†æ¯ä¸€è¡Œè³‡æ–™
                for (let i = 1; i < parsedData.length; i++) {
                    const row = parsedData[i];
                    const [barcode, name, price, stock, categoryName, supplier, description, minStock, cost] = row;
                    
                    try {
                        // é©—è­‰å¿…è¦æ¬„ä½
                        if (!barcode || !name) {
                            errors.push(`ç¬¬${i}è¡Œ: æ¢ç¢¼å’Œå•†å“åç¨±ç‚ºå¿…å¡«æ¬„ä½`);
                            errorCount++;
                            continue;
                        }
                        
                        // æ ¹æ“šåˆ†é¡åç¨±æŸ¥æ‰¾å°æ‡‰çš„ category_id
                        let categoryId = null;
                        if (categoryName && categoryName.trim()) {
                            const categoryObj = categoriesData.find(cat => 
                                cat.name === categoryName.trim() || 
                                cat.name.includes(categoryName.trim()) ||
                                categoryName.trim().includes(cat.name)
                            );
                            categoryId = categoryObj ? categoryObj.id : null;
                            
                            if (!categoryId) {
                                console.warn(`æ‰¾ä¸åˆ°åˆ†é¡ "${categoryName}"ï¼Œå°‡ä½¿ç”¨é è¨­åˆ†é¡`);
                            }
                        }
                        
                        // æª¢æŸ¥ä¾›æ‡‰å•†æ˜¯å¦å­˜åœ¨æ–¼ suppliers è¡¨ä¸­
                        let validSupplier = '';
                        if (supplier && supplier.trim()) {
                            const supplierObj = suppliersData.find(sup => 
                                sup.name === supplier.trim() || 
                                sup.name.includes(supplier.trim()) ||
                                supplier.trim().includes(sup.name)
                            );
                            
                            if (supplierObj) {
                                validSupplier = supplierObj.name;
                            } else {
                                // å¦‚æœä¾›æ‡‰å•†ä¸å­˜åœ¨ï¼Œå˜—è©¦å‰µå»ºæ–°çš„ä¾›æ‡‰å•†
                                console.log(`ä¾›æ‡‰å•† "${supplier}" ä¸å­˜åœ¨ï¼Œå˜—è©¦å‰µå»ºæ–°ä¾›æ‡‰å•†`);
                                try {
                                    const newSupplier = await BusinessAPI.addSupplier({
                                        name: supplier.trim(),
                                        contact: '',
                                        phone: '',
                                        email: '',
                                        address: '',
                                        notes: 'ç”±å•†å“åŒ¯å…¥åŠŸèƒ½è‡ªå‹•å‰µå»º'
                                    });
                                    
                                    if (newSupplier) {
                                        validSupplier = supplier.trim();
                                        // æ›´æ–°æœ¬åœ°ä¾›æ‡‰å•†åˆ—è¡¨
                                        suppliersData.push({
                                            id: newSupplier,
                                            name: supplier.trim(),
                                            contact: '',
                                            phone: '',
                                            email: '',
                                            address: '',
                                            notes: 'ç”±å•†å“åŒ¯å…¥åŠŸèƒ½è‡ªå‹•å‰µå»º'
                                        });
                                        console.log(`æˆåŠŸå‰µå»ºæ–°ä¾›æ‡‰å•†: ${supplier}`);
                                    } else {
                                        console.warn(`ç„¡æ³•å‰µå»ºä¾›æ‡‰å•† "${supplier}"ï¼Œå°‡è·³éä¾›æ‡‰å•†æ¬„ä½`);
                                        validSupplier = '';
                                    }
                                } catch (error) {
                                    console.error(`å‰µå»ºä¾›æ‡‰å•† "${supplier}" å¤±æ•—:`, error);
                                    validSupplier = '';
                                }
                            }
                        }
                        
                        const productData = {
                            name: name.trim(),
                            price: parseFloat(price) || 0,
                            stock: parseInt(stock) || 0,
                            category_id: categoryId,
                            supplier: validSupplier, // ä½¿ç”¨é©—è­‰éçš„ä¾›æ‡‰å•†åç¨±
                            barcode: barcode.trim(),
                            description: description ? description.trim() : '',
                            min_stock: parseInt(minStock) || 10,
                            cost: parseFloat(cost) || 0
                        };
                        
                        // æª¢æŸ¥æ˜¯å¦ç‚ºæ›´æ–°æ¨¡å¼ä¸”å•†å“å·²å­˜åœ¨
                        let existingProduct = existingProducts.find(p => p.barcode === barcode);
                        
                        if (importMode === 'add' && existingProduct) {
                            errors.push(`ç¬¬${i}è¡Œ: æ¢ç¢¼ ${barcode} å·²å­˜åœ¨`);
                            errorCount++;
                        } else if (importMode === 'update' && existingProduct) {
                            // æ›´æ–°ç¾æœ‰å•†å“
                            console.log(`æ›´æ–°å•†å“: ${name} (æ¢ç¢¼: ${barcode})`);
                            const updated = await BusinessAPI.updateProduct(existingProduct.id, productData);
                            if (updated) {
                                successCount++;
                                console.log(`å•†å“æ›´æ–°æˆåŠŸ: ${name}`);
                            } else {
                                errors.push(`ç¬¬${i}è¡Œ: æ›´æ–°å•†å“å¤±æ•— - ${name}`);
                                errorCount++;
                            }
                        } else {
                            // æ–°å¢å•†å“
                            console.log(`æ–°å¢å•†å“: ${name} (æ¢ç¢¼: ${barcode})`);
                            console.log('å•†å“è³‡æ–™:', productData);
                            
                            const added = await BusinessAPI.addProduct(productData);
                            console.log('æ–°å¢çµæœ:', added);
                            
                            if (added) {
                                successCount++;
                                console.log(`å•†å“æ–°å¢æˆåŠŸ: ${name}, ID: ${added}`);
                                // æ›´æ–°ç¾æœ‰å•†å“åˆ—è¡¨ä»¥é¿å…é‡è¤‡æª¢æŸ¥
                                existingProducts.push({ ...productData, id: added, barcode: barcode });
                            } else {
                                errors.push(`ç¬¬${i}è¡Œ: æ–°å¢å•†å“å¤±æ•— - ${name} (è«‹æª¢æŸ¥æ§åˆ¶å°æ—¥èªŒ)`);
                                errorCount++;
                            }
                        }
                        
                        updateProgress(30 + (i / parsedData.length) * 60, `è™•ç†ç¬¬ ${i}/${parsedData.length - 1} ç­†è³‡æ–™...`);
                    } catch (error) {
                        console.error(`è™•ç†ç¬¬${i}è¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
                        errors.push(`ç¬¬${i}è¡Œ: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                        errorCount++;
                    }
                }
                
                updateProgress(100, 'åŒ¯å…¥å®Œæˆ');
                
                setTimeout(() => {
                    hideProgressArea();
                    showResult(successCount, errorCount, errors);
                }, 1000);
                
            } catch (error) {
                console.error('åŒ¯å…¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
                hideProgressArea();
                showMessage('åŒ¯å…¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
            }
        }

        // ç¢ºèªæœƒå“¡åŒ¯å…¥
        async function confirmMemberImport() {
            const importMode = document.querySelector('input[name="memberImportMode"]:checked').value;
            
            console.log('ğŸ‘¥ é–‹å§‹ç¢ºèªæœƒå“¡åŒ¯å…¥ï¼ŒåŒ¯å…¥æ¨¡å¼:', importMode);
            console.log('ğŸ‘¥ memberParsedDataç‹€æ…‹:', memberParsedData ? `æœ‰è³‡æ–™ï¼Œ${memberParsedData.length}è¡Œ` : 'ç„¡è³‡æ–™');
            
            showProgressArea();
            hideAreas(['previewArea']);
            
            updateProgress(10, 'åˆå§‹åŒ–è³‡æ–™åº«é€£æ¥...');
            
            try {
                // åˆå§‹åŒ–è³‡æ–™åº«é€£æ¥
                await DatabaseManager.initialize();
                
                if (!DatabaseManager.isConnected()) {
                    throw new Error('ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
                }
                
                updateProgress(20, 'è¼‰å…¥ç¾æœ‰æœƒå“¡è³‡æ–™...');
                
                // è¼‰å…¥ç¾æœ‰æœƒå“¡è³‡æ–™ï¼ˆç”¨æ–¼æª¢æŸ¥é‡è¤‡ï¼‰
                let existingMembers = [];
                try {
                    existingMembers = await BusinessAPI.getMembers() || [];
                    console.log('è¼‰å…¥ç¾æœ‰æœƒå“¡è³‡æ–™:', existingMembers.length, 'ç­†');
                } catch (error) {
                    console.error('è¼‰å…¥ç¾æœ‰æœƒå“¡è³‡æ–™å¤±æ•—:', error);
                    if (importMode === 'add') {
                        showMessage('ç„¡æ³•æª¢æŸ¥ç¾æœ‰æœƒå“¡ï¼Œå¯èƒ½å°è‡´é‡è¤‡åŒ¯å…¥', 'warning');
                    }
                }
                
                updateProgress(30, 'é–‹å§‹åŒ¯å…¥æœƒå“¡è³‡æ–™...');
                
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                // è·³éè¡¨é ­ï¼Œè™•ç†æ¯ä¸€è¡Œè³‡æ–™
                for (let i = 1; i < memberParsedData.length; i++) {
                    const row = memberParsedData[i];
                    const [memberId, name, phone, email, birthday, level, points, status, address, notes] = row;
                    
                    try {
                        // é©—è­‰å¿…è¦æ¬„ä½
                        if (!memberId || !name) {
                            errors.push(`ç¬¬${i}è¡Œ: æœƒå“¡ç·¨è™Ÿå’Œå§“åç‚ºå¿…å¡«æ¬„ä½`);
                            errorCount++;
                            continue;
                        }
                        
                        const memberData = {
                            id: memberId.trim(),
                            name: name.trim(),
                            phone: phone ? phone.trim() : '',
                            email: email ? email.trim() : '',
                            birth_date: birthday ? birthday.trim() : '', // ä½¿ç”¨ birth_date è€Œä¸æ˜¯ birthday
                            level: level ? level.trim() : 'ä¸€èˆ¬',
                            points: parseInt(points) || 0,
                            status: status ? status.trim() : 'active',
                            address: address ? address.trim() : '',
                            notes: notes ? notes.trim() : ''
                        };
                        
                        // æª¢æŸ¥æ˜¯å¦ç‚ºæ›´æ–°æ¨¡å¼ä¸”æœƒå“¡å·²å­˜åœ¨
                        let existingMember = existingMembers.find(m => m.id === memberId.trim());
                        
                        if (importMode === 'add' && existingMember) {
                            errors.push(`ç¬¬${i}è¡Œ: æœƒå“¡ç·¨è™Ÿ ${memberId} å·²å­˜åœ¨`);
                            errorCount++;
                        } else if (importMode === 'update' && existingMember) {
                            // æ›´æ–°ç¾æœ‰æœƒå“¡
                            console.log(`æ›´æ–°æœƒå“¡: ${name} (ç·¨è™Ÿ: ${memberId})`);
                            const updated = await BusinessAPI.updateMember(existingMember.id, memberData);
                            if (updated) {
                                successCount++;
                                console.log(`æœƒå“¡æ›´æ–°æˆåŠŸ: ${name}`);
                            } else {
                                errors.push(`ç¬¬${i}è¡Œ: æ›´æ–°æœƒå“¡å¤±æ•— - ${name}`);
                                errorCount++;
                            }
                        } else {
                            // æ–°å¢æœƒå“¡
                            console.log(`æ–°å¢æœƒå“¡: ${name} (ç·¨è™Ÿ: ${memberId})`);
                            console.log('æœƒå“¡è³‡æ–™:', memberData);
                            
                            const added = await BusinessAPI.addMember(memberData);
                            console.log('æ–°å¢çµæœ:', added);
                            
                            if (added) {
                                successCount++;
                                console.log(`æœƒå“¡æ–°å¢æˆåŠŸ: ${name}, ID: ${added}`);
                                // æ›´æ–°ç¾æœ‰æœƒå“¡åˆ—è¡¨ä»¥é¿å…é‡è¤‡æª¢æŸ¥
                                existingMembers.push({ ...memberData, id: memberId });
                            } else {
                                errors.push(`ç¬¬${i}è¡Œ: æ–°å¢æœƒå“¡å¤±æ•— - ${name} (è«‹æª¢æŸ¥æ§åˆ¶å°æ—¥èªŒ)`);
                                errorCount++;
                            }
                        }
                        
                        updateProgress(30 + (i / memberParsedData.length) * 60, `è™•ç†ç¬¬ ${i}/${memberParsedData.length - 1} ç­†æœƒå“¡è³‡æ–™...`);
                    } catch (error) {
                        console.error(`è™•ç†æœƒå“¡ç¬¬${i}è¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
                        errors.push(`ç¬¬${i}è¡Œ: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                        errorCount++;
                    }
                }
                
                updateProgress(100, 'æœƒå“¡åŒ¯å…¥å®Œæˆ');
                
                setTimeout(() => {
                    hideProgressArea();
                    showResult(successCount, errorCount, errors);
                }, 1000);
                
            } catch (error) {
                console.error('æœƒå“¡åŒ¯å…¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
                hideProgressArea();
                showMessage('æœƒå“¡åŒ¯å…¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
            }
        }

        // å–æ¶ˆåŒ¯å…¥
        function cancelImport() {
            console.log('âŒ ç”¨æˆ¶å–æ¶ˆåŒ¯å…¥');
            hideAreas(['previewArea']);
            // ä¸èª¿ç”¨ clearFile()ï¼Œä¿ç•™ parsedData å’Œ memberParsedData ä»¥ä¾¿é‡æ–°åŒ¯å…¥
            document.getElementById('previewArea').classList.add('hidden');
        }

        // é¡¯ç¤ºçµæœ
        function showResult(successCount, errorCount, errors) {
            const resultArea = document.getElementById('resultArea');
            const resultIcon = document.getElementById('resultIcon');
            const resultTitle = document.getElementById('resultTitle');
            const resultContent = document.getElementById('resultContent');
            
            if (errorCount === 0) {
                resultIcon.className = 'fas fa-check-circle mr-2 text-[#17225e]';
                resultTitle.textContent = 'åŒ¯å…¥æˆåŠŸ';
            } else {
                resultIcon.className = 'fas fa-exclamation-triangle mr-2 text-gray-500';
                resultTitle.textContent = 'éƒ¨åˆ†åŒ¯å…¥æˆåŠŸ';
            }
            
            let content = `
                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="bg-gray-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-[#17225e]">${successCount}</div>
                    <div class="text-sm text-gray-700">æˆåŠŸåŒ¯å…¥</div>
                </div>
                    <div class="bg-red-50 rounded-lg p-3">
                        <div class="text-2xl font-bold text-red-600">${errorCount}</div>
                        <div class="text-sm text-red-700">å¤±æ•—ç­†æ•¸</div>
                    </div>
                </div>
            `;
            
            if (errors.length > 0) {
                content += `
                                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                    <h4 class="font-medium text-gray-800 mb-2">éŒ¯èª¤è©³æƒ…ï¼š</h4>
                    <ul class="text-sm text-gray-700 list-disc list-inside space-y-1">
                            ${errors.slice(0, 5).map(error => `<li>${error}</li>`).join('')}
                            ${errors.length > 5 ? `<li>é‚„æœ‰ ${errors.length - 5} å€‹éŒ¯èª¤...</li>` : ''}
                        </ul>
                    </div>
                `;
            }
            
            resultContent.innerHTML = content;
            resultArea.classList.remove('hidden');
            
            // æ¸…ç†ï¼ˆå»¶é²3ç§’å¾Œæ¸…é™¤ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°çµæœï¼‰
            setTimeout(() => {
                console.log('ğŸ§¹ åŒ¯å…¥å®Œæˆï¼Œæ¸…ç†æª”æ¡ˆå’Œè³‡æ–™');
                clearFile();
            }, 3000);
        }

        // å·¥å…·å‡½æ•¸
        function showProgressArea() {
            document.getElementById('progressArea').classList.remove('hidden');
        }

        function hideProgressArea() {
            document.getElementById('progressArea').classList.add('hidden');
        }

        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        function hideAreas(areas) {
            areas.forEach(area => {
                document.getElementById(area).classList.add('hidden');
            });
        }

        function showMessage(message, type = 'info') {
            const alertClass = {
                'success': 'bg-gray-100 border-[#17225e] text-gray-700',
                'error': 'bg-red-100 border-red-500 text-red-700',
                'warning': 'bg-gray-100 border-gray-500 text-gray-700',
                'info': 'bg-gray-100 border-[#17225e] text-gray-700'
            }[type];
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 z-50 border-l-4 p-4 rounded shadow-lg ${alertClass}`;
            messageDiv.innerHTML = `
                <div class="flex">
                    <div class="flex-1">${message}</div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // æœƒå“¡åŒ¯å…¥åŒ¯å‡ºåŠŸèƒ½

        // é¸æ“‡æœƒå“¡æª”æ¡ˆ
        function selectMemberFile() {
            document.getElementById('memberFileInput').click();
        }

        // æ¸…é™¤æœƒå“¡æª”æ¡ˆ
        function clearMemberFile() {
            console.log('ğŸ—‘ï¸ æ¸…é™¤æœƒå“¡æª”æ¡ˆå’Œè§£æè³‡æ–™');
            memberSelectedFile = null;
            memberParsedData = null;
            document.getElementById('memberFileInput').value = '';
            document.getElementById('memberFileInfo').classList.add('hidden');
            document.getElementById('memberImportBtn').disabled = true;
            document.getElementById('memberImportBtn').className = 'w-full bg-gray-400 text-white py-3 px-4 rounded-lg font-medium cursor-not-allowed';
            hideAreas(['previewArea', 'progressArea', 'resultArea']);
        }

        // æœƒå“¡æª”æ¡ˆè™•ç†
        document.getElementById('memberFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                memberSelectedFile = file;
                document.getElementById('memberFileName').textContent = file.name;
                document.getElementById('memberFileSize').textContent = formatFileSize(file.size);
                document.getElementById('memberFileInfo').classList.remove('hidden');
                document.getElementById('memberImportBtn').disabled = false;
                document.getElementById('memberImportBtn').className = 'w-full bg-[#17225e] text-white py-3 px-4 rounded-lg hover:bg-[#1a2a6e] transition-colors font-medium';
            }
        });

        // åŒ¯å‡ºæœƒå“¡è³‡æ–™
        async function exportMembers() {
            const format = document.querySelector('input[name="memberExportFormat"]:checked').value;
            const range = document.querySelector('input[name="memberExportRange"]:checked').value;
            
            showMessage('æ­£åœ¨è¼‰å…¥æœƒå“¡è³‡æ–™...', 'info');
            
            try {
                // åˆå§‹åŒ–è³‡æ–™åº«é€£æ¥
                await DatabaseManager.initialize();
                
                let membersData = [];
                
                if (DatabaseManager.isConnected()) {
                    // å¾ Supabase ç²å–æœƒå“¡è³‡æ–™
                    console.log('å¾ Supabase è¼‰å…¥æœƒå“¡è³‡æ–™...');
                    const data = await BusinessAPI.getMembers();
                    if (data && data.length > 0) {
                        membersData = data;
                        console.log('æˆåŠŸè¼‰å…¥', membersData.length, 'ç­†æœƒå“¡è³‡æ–™');
                    } else {
                        console.log('Supabase ä¸­ç„¡æœƒå“¡è³‡æ–™ï¼Œå˜—è©¦æœ¬åœ°è³‡æ–™');
                        const savedMembers = localStorage.getItem('membersData');
                        membersData = savedMembers ? JSON.parse(savedMembers) : [];
                    }
                } else {
                    console.log('è³‡æ–™åº«æœªé€£æ¥ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™');
                    const savedMembers = localStorage.getItem('membersData');
                    membersData = savedMembers ? JSON.parse(savedMembers) : [];
                }
                
                if (membersData.length === 0) {
                    showMessage('ç„¡æœƒå“¡è³‡æ–™å¯åŒ¯å‡º', 'warning');
                    return;
                }
                
                // æ ¹æ“šç¯„åœéæ¿¾æœƒå“¡
                let filteredMembers = membersData;
                switch(range) {
                    case 'active':
                        filteredMembers = membersData.filter(m => m.status === 'active' || !m.status);
                        break;
                    case 'vip':
                        filteredMembers = membersData.filter(m => m.level && ['é‡‘å¡', 'ç™½é‡‘', 'é‘½çŸ³', 'VIP', 'Gold', 'Platinum', 'Diamond'].includes(m.level));
                        break;
                }
                
                const headers = ['æœƒå“¡ç·¨è™Ÿ', 'å§“å', 'é›»è©±', 'é›»å­éƒµä»¶', 'ç”Ÿæ—¥', 'æœƒå“¡ç­‰ç´š', 'ç©åˆ†', 'ç‹€æ…‹', 'åœ°å€', 'å‚™è¨»', 'è¨»å†Šæ—¥æœŸ'];
                const data = [headers];
                
                filteredMembers.forEach(member => {
                    data.push([
                        member.id || '',
                        member.name || '',
                        member.phone || '',
                        member.email || '',
                        member.birth_date || member.birthday || '', // å„ªå…ˆä½¿ç”¨ birth_date
                        member.level || member.member_level || 'ä¸€èˆ¬',
                        member.points || member.loyalty_points || '0',
                        member.status || 'active',
                        member.address || '',
                        member.notes || '',
                        member.created_at ? new Date(member.created_at).toLocaleDateString() : ''
                    ]);
                });
                
                if (format === 'csv') {
                    exportMembersAsCSV(data);
                } else {
                    exportMembersAsExcel(data);
                }
                
                showMessage(`å·²åŒ¯å‡º ${data.length - 1} ç­†æœƒå“¡è³‡æ–™`, 'success');
                
            } catch (error) {
                console.error('åŒ¯å‡ºæœƒå“¡è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showMessage('åŒ¯å‡ºæœƒå“¡è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

        // åŒ¯å‡ºæœƒå“¡ç‚ºCSV
        function exportMembersAsCSV(data) {
            // ä½¿ç”¨èˆ‡å•†å“åŒ¯å‡ºç›¸åŒçš„åš´æ ¼CSVæ ¼å¼
            const csvContent = data
                .map(row => {
                    return row.map(field => {
                        const fieldStr = String(field || '');
                        if (fieldStr.includes(',') || fieldStr.includes('"') || fieldStr.includes('\n') || fieldStr.includes('\r')) {
                            return '"' + fieldStr.replace(/"/g, '""') + '"';
                        }
                        return fieldStr;
                    }).join(',');
                })
                .join('\r\n');
            
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `æœƒå“¡è³‡æ–™_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // åŒ¯å‡ºæœƒå“¡ç‚ºExcel (ç°¡åŒ–ç‰ˆ)
        function exportMembersAsExcel(data) {
            const excelContent = data
                .map(row => {
                    return row.map(field => {
                        const fieldStr = String(field || '');
                        if (fieldStr.includes('\t') || fieldStr.includes('\n') || fieldStr.includes('\r')) {
                            return '"' + fieldStr.replace(/"/g, '""') + '"';
                        }
                        return fieldStr;
                    }).join('\t');
                })
                .join('\r\n');
            
            const blob = new Blob(['\uFEFF' + excelContent], { type: 'application/vnd.ms-excel;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `æœƒå“¡è³‡æ–™_${new Date().toISOString().split('T')[0]}.xls`;
            link.click();
        }

        // åŒ¯å…¥æœƒå“¡è³‡æ–™
        function importMembers() {
            const file = document.getElementById('memberFileInput').files[0];
            if (!file) {
                showMessage('è«‹é¸æ“‡è¦åŒ¯å…¥çš„æª”æ¡ˆ', 'error');
                return;
            }
            
            memberSelectedFile = file;
            showProgressArea();
            updateProgress(10, 'è®€å–æœƒå“¡æª”æ¡ˆä¸­...');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    updateProgress(30, 'è§£ææœƒå“¡è³‡æ–™ä¸­...');
                    
                    setTimeout(() => {
                        if (memberSelectedFile.name.toLowerCase().includes('.csv')) {
                            memberParsedData = parseCSV(data);
                        } else {
                            memberParsedData = parseCSV(data);
                        }
                        
                        console.log('ğŸ‘¥ æœƒå“¡è³‡æ–™è§£æå®Œæˆï¼ŒmemberParsedDataå·²æ›´æ–°:', memberParsedData);
                        
                        updateProgress(60, 'é©—è­‰æœƒå“¡è³‡æ–™ä¸­...');
                        
                        setTimeout(() => {
                            if (validateMemberData(memberParsedData)) {
                                updateProgress(80, 'æº–å‚™æœƒå“¡é è¦½...');
                                setTimeout(() => {
                                    showMemberPreview(memberParsedData);
                                    hideProgressArea();
                                    console.log('ğŸ‘¥ æœƒå“¡é è¦½å·²é¡¯ç¤ºï¼ŒmemberParsedDataæº–å‚™å°±ç·’');
                                }, 1000);
                            } else {
                                hideProgressArea();
                                showMessage('æœƒå“¡è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹', 'error');
                            }
                        }, 1000);
                    }, 1000);
                } catch (error) {
                    hideProgressArea();
                    showMessage('æœƒå“¡æª”æ¡ˆè®€å–å¤±æ•—: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        // é¡¯ç¤ºæœƒå“¡é è¦½
        function showMemberPreview(data) {
            const previewArea = document.getElementById('previewArea');
            const previewHeader = document.getElementById('previewHeader');
            const previewBody = document.getElementById('previewBody');
            
            previewHeader.innerHTML = '';
            previewBody.innerHTML = '';
            
            // æ·»åŠ è¡¨é ­
            const headerRow = document.createElement('tr');
            data[0].forEach(header => {
                const th = document.createElement('th');
                th.className = 'border border-gray-300 px-4 py-2 bg-gray-50 font-medium text-left';
                th.textContent = header;
                headerRow.appendChild(th);
            });
            previewHeader.appendChild(headerRow);
            
            // æ·»åŠ è³‡æ–™è¡Œï¼ˆæœ€å¤š5è¡Œï¼‰
            const previewCount = Math.min(5, data.length - 1);
            for (let i = 1; i <= previewCount; i++) {
                const row = document.createElement('tr');
                data[i].forEach(cell => {
                    const td = document.createElement('td');
                    td.className = 'border border-gray-300 px-4 py-2';
                    td.textContent = cell;
                    row.appendChild(td);
                });
                previewBody.appendChild(row);
            }
            
            document.getElementById('previewCount').textContent = previewCount;
            previewArea.classList.remove('hidden');
        }

        // æ ¼å¼åŒ–æª”æ¡ˆå¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // èª¿è©¦æª”æ¡ˆåŒ¯å…¥
        async function debugFileImport() {
            console.log('ğŸ”§ é–‹å§‹èª¿è©¦æª”æ¡ˆåŒ¯å…¥...');
            
            if (!selectedFile) {
                showMessage('è«‹å…ˆé¸æ“‡è¦åŒ¯å…¥çš„æª”æ¡ˆ', 'error');
                return;
            }
            
            console.log('ğŸ”§ é¸æ“‡çš„æª”æ¡ˆ:', selectedFile.name, selectedFile.size, 'bytes');
            
            try {
                // è®€å–æª”æ¡ˆå…§å®¹
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = e.target.result;
                    console.log('ğŸ”§ æª”æ¡ˆå…§å®¹å‰500å­—ç¬¦:', data.substring(0, 500));
                    
                    // è§£æCSV
                    const parsedData = parseCSV(data);
                    console.log('ğŸ”§ è§£æå¾Œçš„è³‡æ–™:', parsedData);
                    
                    // é©—è­‰è³‡æ–™
                    const isValid = validateData(parsedData);
                    console.log('ğŸ”§ è³‡æ–™é©—è­‰çµæœ:', isValid);
                    
                        if (isValid) {
                        console.log('ğŸ”§ è³‡æ–™é©—è­‰é€šéï¼Œå¯ä»¥é€²è¡ŒåŒ¯å…¥');
                        showMessage('æª”æ¡ˆæ ¼å¼æ­£ç¢ºï¼Œå¯ä»¥é€²è¡ŒåŒ¯å…¥', 'success');
                        
                        // é¡¯ç¤ºå‰å¹¾è¡Œè³‡æ–™çš„è©³ç´°è³‡è¨Š
                        console.log('ğŸ”§ è©³ç´°è³‡æ–™åˆ†æ:');
                        for (let i = 0; i < Math.min(3, parsedData.length); i++) {
                            const row = parsedData[i];
                            console.log(`ğŸ”§ ç¬¬${i + 1}è¡Œ:`, {
                                æ¢ç¢¼: row[0],
                                å•†å“åç¨±: row[1],
                                åƒ¹æ ¼: row[2],
                                åº«å­˜: row[3],
                                åˆ†é¡: row[4],
                                ä¾›æ‡‰å•†: row[5],
                                æè¿°: row[6],
                                æœ€ä½åº«å­˜: row[7],
                                æˆæœ¬: row[8]
                            });
                        }
                        
                        // è©¢å•æ˜¯å¦è¦æ¸¬è©¦åŒ¯å…¥ç¬¬ä¸€è¡Œè³‡æ–™
                        if (parsedData.length > 1) {
                            const testFirstRow = confirm('æª”æ¡ˆæ ¼å¼æ­£ç¢ºï¼æ˜¯å¦è¦æ¸¬è©¦åŒ¯å…¥ç¬¬ä¸€è¡Œè³‡æ–™ï¼Ÿ');
                            if (testFirstRow) {
                                // è©¢å•åŒ¯å…¥æ¨¡å¼
                                const importMode = prompt('è«‹é¸æ“‡åŒ¯å…¥æ¨¡å¼ï¼š\n1. æ–°å¢æ¨¡å¼ï¼ˆè·³éå·²å­˜åœ¨çš„å•†å“ï¼‰\n2. æ›´æ–°æ¨¡å¼ï¼ˆæ›´æ–°å·²å­˜åœ¨çš„å•†å“ï¼‰\n3. æ··åˆæ¨¡å¼ï¼ˆè©¢å•æ¯å€‹é‡è¤‡å•†å“ï¼‰\n\nè«‹è¼¸å…¥ 1ã€2 æˆ– 3ï¼š');
                                
                                let mode = 'add'; // é è¨­ç‚ºæ–°å¢æ¨¡å¼
                                if (importMode === '2') {
                                    mode = 'update';
                                } else if (importMode === '3') {
                                    mode = 'mixed';
                                }
                                
                                testImportFirstRow(parsedData[1], mode);
                            }
                        }
                    } else {
                        console.log('ğŸ”§ è³‡æ–™é©—è­‰å¤±æ•—');
                        showMessage('æª”æ¡ˆæ ¼å¼æœ‰å•é¡Œï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°æ—¥èªŒ', 'error');
                    }
                };
                
                reader.onerror = function() {
                    console.error('ğŸ”§ æª”æ¡ˆè®€å–å¤±æ•—');
                    showMessage('æª”æ¡ˆè®€å–å¤±æ•—', 'error');
                };
                
                reader.readAsText(selectedFile, 'UTF-8');
                
            } catch (error) {
                console.error('ğŸ”§ èª¿è©¦æª”æ¡ˆåŒ¯å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showMessage('èª¿è©¦å¤±æ•—: ' + error.message, 'error');
            }
        }

        // æ¸¬è©¦åŒ¯å…¥ç¬¬ä¸€è¡Œè³‡æ–™
        async function testImportFirstRow(rowData, importMode = 'mixed') {
            console.log('ğŸ§ª é–‹å§‹æ¸¬è©¦åŒ¯å…¥ç¬¬ä¸€è¡Œè³‡æ–™:', rowData);
            console.log('ğŸ§ª åŒ¯å…¥æ¨¡å¼:', importMode);
            
            try {
                // åˆå§‹åŒ–è³‡æ–™åº«é€£æ¥
                await DatabaseManager.initialize();
                
                if (!DatabaseManager.isConnected()) {
                    throw new Error('ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«');
                }
                
                const [barcode, name, price, stock, categoryName, supplier, description, minStock, cost] = rowData;
                
                // è¼‰å…¥åˆ†é¡è³‡æ–™
                const categoriesData = await BusinessAPI.getCategories() || [];
                console.log('ğŸ§ª è¼‰å…¥åˆ†é¡è³‡æ–™:', categoriesData.length, 'ç­†');
                
                // è¼‰å…¥ä¾›æ‡‰å•†è³‡æ–™
                const suppliersData = await BusinessAPI.getSuppliers() || [];
                console.log('ğŸ§ª è¼‰å…¥ä¾›æ‡‰å•†è³‡æ–™:', suppliersData.length, 'ç­†');
                
                // è¼‰å…¥ç¾æœ‰å•†å“è³‡æ–™ï¼ˆæª¢æŸ¥é‡è¤‡ï¼‰
                const existingProducts = await BusinessAPI.getProducts() || [];
                console.log('ğŸ§ª è¼‰å…¥ç¾æœ‰å•†å“è³‡æ–™:', existingProducts.length, 'ç­†');
                
                // æª¢æŸ¥å•†å“æ˜¯å¦å·²å­˜åœ¨
                const existingProduct = existingProducts.find(p => p.barcode === barcode.trim());
                if (existingProduct) {
                    console.log('ğŸ§ª å•†å“å·²å­˜åœ¨:', existingProduct);
                    
                    if (importMode === 'add') {
                        console.log('ğŸ§ª æ–°å¢æ¨¡å¼ï¼šè·³éé‡è¤‡å•†å“');
                        showMessage(`å•†å“ "${name}" (æ¢ç¢¼: ${barcode}) å·²å­˜åœ¨ï¼Œå·²è·³é`, 'info');
                        return;
                    } else if (importMode === 'update') {
                        console.log('ğŸ§ª æ›´æ–°æ¨¡å¼ï¼šå°‡æ›´æ–°ç¾æœ‰å•†å“');
                    } else if (importMode === 'mixed') {
                        const updateConfirm = confirm(`å•†å“ "${name}" (æ¢ç¢¼: ${barcode}) å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦æ›´æ–°ç¾æœ‰å•†å“ï¼Ÿ`);
                        if (updateConfirm) {
                            console.log('ğŸ§ª ç”¨æˆ¶é¸æ“‡æ›´æ–°ç¾æœ‰å•†å“');
                        } else {
                            console.log('ğŸ§ª ç”¨æˆ¶å–æ¶ˆï¼Œè·³éæ­¤å•†å“');
                            showMessage('å·²è·³éé‡è¤‡å•†å“', 'info');
                            return;
                        }
                    }
                }
                
                // æ ¹æ“šåˆ†é¡åç¨±æŸ¥æ‰¾å°æ‡‰çš„ category_id
                let categoryId = null;
                if (categoryName && categoryName.trim()) {
                    const categoryObj = categoriesData.find(cat => 
                        cat.name === categoryName.trim() || 
                        cat.name.includes(categoryName.trim()) ||
                        categoryName.trim().includes(cat.name)
                    );
                    categoryId = categoryObj ? categoryObj.id : null;
                    console.log('ğŸ§ª åˆ†é¡æ˜ å°„:', categoryName, '->', categoryId);
                }
                
                // æª¢æŸ¥ä¾›æ‡‰å•†æ˜¯å¦å­˜åœ¨
                let validSupplier = '';
                if (supplier && supplier.trim()) {
                    const supplierObj = suppliersData.find(sup => 
                        sup.name === supplier.trim() || 
                        sup.name.includes(supplier.trim()) ||
                        supplier.trim().includes(sup.name)
                    );
                    
                    if (supplierObj) {
                        validSupplier = supplierObj.name;
                        console.log('ğŸ§ª æ‰¾åˆ°ç¾æœ‰ä¾›æ‡‰å•†:', validSupplier);
                    } else {
                        // å˜—è©¦å‰µå»ºæ–°ä¾›æ‡‰å•†
                        console.log('ğŸ§ª ä¾›æ‡‰å•†ä¸å­˜åœ¨ï¼Œå˜—è©¦å‰µå»º:', supplier);
                        const newSupplier = await BusinessAPI.addSupplier({
                            name: supplier.trim(),
                            contact: '',
                            phone: '',
                            email: '',
                            address: '',
                            notes: 'ç”±å•†å“åŒ¯å…¥åŠŸèƒ½è‡ªå‹•å‰µå»º'
                        });
                        
                        if (newSupplier) {
                            validSupplier = supplier.trim();
                            console.log('ğŸ§ª æˆåŠŸå‰µå»ºä¾›æ‡‰å•†:', validSupplier);
                        } else {
                            console.log('ğŸ§ª ç„¡æ³•å‰µå»ºä¾›æ‡‰å•†ï¼Œå°‡è·³éä¾›æ‡‰å•†æ¬„ä½');
                        }
                    }
                }
                
                const productData = {
                    name: name.trim(),
                    price: parseFloat(price) || 0,
                    stock: parseInt(stock) || 0,
                    category_id: categoryId,
                    supplier: validSupplier,
                    barcode: barcode.trim(),
                    description: description ? description.trim() : '',
                    min_stock: parseInt(minStock) || 10,
                    cost: parseFloat(cost) || 0
                };
                
                console.log('ğŸ§ª æº–å‚™è™•ç†å•†å“è³‡æ–™:', productData);
                
                let result;
                if (existingProduct) {
                    // æ›´æ–°ç¾æœ‰å•†å“
                    console.log('ğŸ§ª æ›´æ–°ç¾æœ‰å•†å“ï¼ŒID:', existingProduct.id);
                    result = await BusinessAPI.updateProduct(existingProduct.id, productData);
                    console.log('ğŸ§ª æ›´æ–°çµæœ:', result);
                    
                    if (result) {
                        showMessage(`æ¸¬è©¦åŒ¯å…¥æˆåŠŸï¼å•†å“ "${name}" å·²æ›´æ–°`, 'success');
                        console.log('âœ… ç¬¬ä¸€è¡Œè³‡æ–™æ›´æ–°æ¸¬è©¦æˆåŠŸ');
                    } else {
                        showMessage('æ¸¬è©¦æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°æ—¥èªŒ', 'error');
                        console.log('âŒ ç¬¬ä¸€è¡Œè³‡æ–™æ›´æ–°æ¸¬è©¦å¤±æ•—');
                    }
                } else {
                    // æ–°å¢æ–°å•†å“
                    console.log('ğŸ§ª æ–°å¢æ–°å•†å“');
                    result = await BusinessAPI.addProduct(productData);
                    console.log('ğŸ§ª æ–°å¢çµæœ:', result);
                    
                    if (result) {
                        showMessage(`æ¸¬è©¦åŒ¯å…¥æˆåŠŸï¼å•†å“ "${name}" å·²æ–°å¢ï¼ŒID: ${result}`, 'success');
                        console.log('âœ… ç¬¬ä¸€è¡Œè³‡æ–™åŒ¯å…¥æ¸¬è©¦æˆåŠŸ');
                    } else {
                        showMessage('æ¸¬è©¦åŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°æ—¥èªŒ', 'error');
                        console.log('âŒ ç¬¬ä¸€è¡Œè³‡æ–™åŒ¯å…¥æ¸¬è©¦å¤±æ•—');
                    }
                }
                
            } catch (error) {
                console.error('ğŸ§ª æ¸¬è©¦åŒ¯å…¥ç¬¬ä¸€è¡Œè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showMessage('æ¸¬è©¦åŒ¯å…¥å¤±æ•—: ' + error.message, 'error');
            }
        }

        // æ¸…ç†é‡è¤‡å•†å“
        async function cleanDuplicateProducts() {
            console.log('ğŸ§¹ é–‹å§‹æ¸…ç†é‡è¤‡å•†å“...');
            
            const confirmClean = confirm('âš ï¸ è­¦å‘Šï¼šæ­¤åŠŸèƒ½å°‡åˆªé™¤é‡è¤‡çš„å•†å“è¨˜éŒ„ï¼\n\nç³»çµ±æœƒä¿ç•™æ¯çµ„é‡è¤‡å•†å“ä¸­çš„ç¬¬ä¸€å€‹ï¼Œåˆªé™¤å…¶é¤˜é‡è¤‡é …ã€‚\n\næ˜¯å¦ç¢ºå®šè¦ç¹¼çºŒï¼Ÿ');
            
            if (!confirmClean) {
                console.log('ğŸ§¹ ç”¨æˆ¶å–æ¶ˆæ¸…ç†æ“ä½œ');
                return;
            }
            
            try {
                // åˆå§‹åŒ–è³‡æ–™åº«é€£æ¥
                await DatabaseManager.initialize();
                
                if (!DatabaseManager.isConnected()) {
                    throw new Error('ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«');
                }
                
                // è¼‰å…¥æ‰€æœ‰å•†å“
                const products = await BusinessAPI.getProducts();
                console.log('ğŸ§¹ è¼‰å…¥å•†å“è³‡æ–™:', products.length, 'ç­†');
                
                if (!products || products.length === 0) {
                    showMessage('æ²’æœ‰å•†å“è³‡æ–™å¯æ¸…ç†', 'info');
                    return;
                }
                
                // æ‰¾å‡ºé‡è¤‡çš„å•†å“ï¼ˆåŸºæ–¼æ¢ç¢¼ï¼‰
                const duplicates = {};
                products.forEach(product => {
                    const barcode = product.barcode;
                    if (!duplicates[barcode]) {
                        duplicates[barcode] = [];
                    }
                    duplicates[barcode].push(product);
                });
                
                // ç¯©é¸å‡ºçœŸæ­£çš„é‡è¤‡é …ï¼ˆæ¢ç¢¼ç›¸åŒä¸”æœ‰å¤šå€‹è¨˜éŒ„ï¼‰
                const duplicateGroups = Object.entries(duplicates).filter(([barcode, items]) => items.length > 1);
                
                console.log('ğŸ§¹ ç™¼ç¾é‡è¤‡å•†å“çµ„:', duplicateGroups.length, 'çµ„');
                
                if (duplicateGroups.length === 0) {
                    showMessage('æ²’æœ‰ç™¼ç¾é‡è¤‡å•†å“', 'info');
                    return;
                }
                
                let deletedCount = 0;
                const deletedProducts = [];
                
                // è™•ç†æ¯å€‹é‡è¤‡çµ„
                for (const [barcode, items] of duplicateGroups) {
                    console.log(`ğŸ§¹ è™•ç†é‡è¤‡å•†å“çµ„ - æ¢ç¢¼: ${barcode}, æ•¸é‡: ${items.length}`);
                    
                    // ä¿ç•™ç¬¬ä¸€å€‹ï¼Œåˆªé™¤å…¶é¤˜çš„
                    const toKeep = items[0];
                    const toDelete = items.slice(1);
                    
                    console.log(`ğŸ§¹ ä¿ç•™å•†å“ ID: ${toKeep.id}, åç¨±: ${toKeep.name}`);
                    
                    for (const product of toDelete) {
                        console.log(`ğŸ§¹ åˆªé™¤å•†å“ ID: ${product.id}, åç¨±: ${product.name}`);
                        
                        const deleted = await BusinessAPI.deleteProduct(product.id);
                        if (deleted) {
                            deletedCount++;
                            deletedProducts.push(product);
                            console.log(`âœ… æˆåŠŸåˆªé™¤å•†å“ ID: ${product.id}`);
                        } else {
                            console.error(`âŒ åˆªé™¤å•†å“ ID: ${product.id} å¤±æ•—`);
                        }
                    }
                }
                
                // é¡¯ç¤ºæ¸…ç†çµæœ
                if (deletedCount > 0) {
                    showMessage(`æ¸…ç†å®Œæˆï¼å·²åˆªé™¤ ${deletedCount} å€‹é‡è¤‡å•†å“`, 'success');
                    console.log('ğŸ§¹ æ¸…ç†çµæœ:', {
                        é‡è¤‡çµ„æ•¸: duplicateGroups.length,
                        åˆªé™¤æ•¸é‡: deletedCount,
                        åˆªé™¤çš„å•†å“: deletedProducts.map(p => ({ id: p.id, name: p.name, barcode: p.barcode }))
                    });
                } else {
                    showMessage('æ¸…ç†å®Œæˆï¼Œä½†æ²’æœ‰æˆåŠŸåˆªé™¤ä»»ä½•å•†å“', 'warning');
                }
                
            } catch (error) {
                console.error('ğŸ§¹ æ¸…ç†é‡è¤‡å•†å“æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showMessage('æ¸…ç†å¤±æ•—: ' + error.message, 'error');
            }
        }

        // æ¸¬è©¦åŒ¯å…¥åŠŸèƒ½
        async function testImportFunction() {
            console.log('ğŸ§ª é–‹å§‹æ¸¬è©¦åŒ¯å…¥åŠŸèƒ½...');
            
            try {
                // åˆå§‹åŒ–è³‡æ–™åº«é€£æ¥
                await DatabaseManager.initialize();
                console.log('âœ… è³‡æ–™åº«é€£æ¥ç‹€æ…‹:', DatabaseManager.isConnected());
                
                // æ¸¬è©¦è¼‰å…¥åˆ†é¡è³‡æ–™
                const categories = await BusinessAPI.getCategories();
                console.log('âœ… åˆ†é¡è³‡æ–™è¼‰å…¥:', categories ? categories.length : 0, 'ç­†');
                
                // æ¸¬è©¦è¼‰å…¥ç¾æœ‰å•†å“
                const products = await BusinessAPI.getProducts();
                console.log('âœ… ç¾æœ‰å•†å“è¼‰å…¥:', products ? products.length : 0, 'ç­†');
                
                // è¼‰å…¥ä¾›æ‡‰å•†è³‡æ–™
                const suppliers = await BusinessAPI.getSuppliers();
                console.log('âœ… ä¾›æ‡‰å•†è³‡æ–™è¼‰å…¥:', suppliers ? suppliers.length : 0, 'ç­†');
                
                // ä½¿ç”¨ç¾æœ‰çš„ä¾›æ‡‰å•†æˆ–å‰µå»ºæ¸¬è©¦ä¾›æ‡‰å•†
                let testSupplierName = '';
                if (suppliers && suppliers.length > 0) {
                    testSupplierName = suppliers[0].name; // ä½¿ç”¨ç¬¬ä¸€å€‹ç¾æœ‰ä¾›æ‡‰å•†
                } else {
                    // å¦‚æœæ²’æœ‰ä¾›æ‡‰å•†ï¼Œå˜—è©¦å‰µå»ºä¸€å€‹
                    console.log('æ²’æœ‰ç¾æœ‰ä¾›æ‡‰å•†ï¼Œå˜—è©¦å‰µå»ºæ¸¬è©¦ä¾›æ‡‰å•†');
                    const newSupplier = await BusinessAPI.addSupplier({
                        name: 'æ¸¬è©¦ä¾›æ‡‰å•†',
                        contact: 'æ¸¬è©¦è¯çµ¡äºº',
                        phone: '0912345678',
                        email: 'test@example.com',
                        address: 'æ¸¬è©¦åœ°å€',
                        notes: 'æ¸¬è©¦ç”¨ä¾›æ‡‰å•†'
                    });
                    
                    if (newSupplier) {
                        testSupplierName = 'æ¸¬è©¦ä¾›æ‡‰å•†';
                        console.log('âœ… æˆåŠŸå‰µå»ºæ¸¬è©¦ä¾›æ‡‰å•†');
                    } else {
                        console.log('âš ï¸ ç„¡æ³•å‰µå»ºæ¸¬è©¦ä¾›æ‡‰å•†ï¼Œå°‡è·³éä¾›æ‡‰å•†æ¬„ä½');
                        testSupplierName = '';
                    }
                }
                
                // æ¸¬è©¦æ–°å¢ä¸€å€‹ç°¡å–®å•†å“
                const testProduct = {
                    name: 'æ¸¬è©¦å•†å“',
                    price: 100,
                    stock: 10,
                    category_id: categories && categories.length > 0 ? categories[0].id : null,
                    supplier: testSupplierName,
                    barcode: 'TEST' + Date.now(),
                    description: 'é€™æ˜¯ä¸€å€‹æ¸¬è©¦å•†å“',
                    min_stock: 5,
                    cost: 80
                };
                
                console.log('ğŸ§ª æ¸¬è©¦å•†å“è³‡æ–™:', testProduct);
                
                const result = await BusinessAPI.addProduct(testProduct);
                console.log('âœ… æ¸¬è©¦æ–°å¢çµæœ:', result);
                
                if (result) {
                    showMessage('æ¸¬è©¦åŒ¯å…¥åŠŸèƒ½æˆåŠŸï¼', 'success');
                    console.log('âœ… æ¸¬è©¦å®Œæˆï¼šåŒ¯å…¥åŠŸèƒ½æ­£å¸¸');
                } else {
                    showMessage('æ¸¬è©¦åŒ¯å…¥åŠŸèƒ½å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°æ—¥èªŒ', 'error');
                    console.log('âŒ æ¸¬è©¦å¤±æ•—ï¼šæ–°å¢å•†å“è¿”å› false');
                }
                
            } catch (error) {
                console.error('âŒ æ¸¬è©¦åŒ¯å…¥åŠŸèƒ½æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showMessage('æ¸¬è©¦åŒ¯å…¥åŠŸèƒ½å¤±æ•—: ' + error.message, 'error');
            }
        }

        // é é¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // é€²è¡Œæ¬Šé™æª¢æŸ¥
            const isAuthenticated = await checkAuthentication();
            if (!isAuthenticated) {
                return; // å¦‚æœæœªé€šéèªè­‰ï¼Œå‡½æ•¸æœƒè‡ªå‹•é‡å®šå‘
            }
            
            // æª¢æŸ¥è³‡æ–™åŒ¯å‡º/å…¥æ¬Šé™
            const hasPermission = await checkPermission(['import-export']);
            if (!hasPermission) {
                return; // æ¬Šé™ä¸è¶³ï¼Œæœƒé¡¯ç¤ºéŒ¯èª¤ä¸¦é‡å®šå‘
            }
            
            // å•Ÿå‹•å¿ƒè·³æ©Ÿåˆ¶
            console.log('ğŸ”„ Import-Exporté é¢ï¼šå•Ÿå‹•å¿ƒè·³æ©Ÿåˆ¶');
            HeartbeatManager.checkAndStart();
            
            console.log('è³‡æ–™åŒ¯å‡º/å…¥åŠŸèƒ½å·²è¼‰å…¥');
        });
    </script>
</body>
</html> 