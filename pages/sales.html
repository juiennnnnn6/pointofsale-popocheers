<!DOCTYPE html>

<html lang="zh-TW">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>éŠ·å”®ä½œæ¥­</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="../employee-auth.js"></script>

    <script src="../database.js"></script>
    
    <script src="../heartbeat.js"></script>

    <script src="auth-check.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>


    <script>

        // ä½¿ç”¨å…¨åŸŸçš„ Supabase å®¢æˆ¶ç«¯ (ç”± database.js æä¾›)

        // ç°¡å–®çš„èªè­‰æª¢æŸ¥æ¸¬è©¦

        console.log('=== sales.html è…³æœ¬è¼‰å…¥æ¸¬è©¦ === ç‰ˆæœ¬å·²å›é€€ ' + new Date().toLocaleString());

        console.log('employee-auth.js æ˜¯å¦è¼‰å…¥:', typeof EmployeeAuth !== 'undefined');

        console.log('auth-check.js æ˜¯å¦è¼‰å…¥:', typeof checkAuthentication !== 'undefined');

        
        // å…¨åŸŸæ¢ç¢¼è™•ç†å‡½æ•¸ï¼ˆæ”¯æ´PCæ¢ç¢¼æƒæå™¨ï¼‰
        window.handleBarcodeInput = function(barcode) {
            const barcodeInput = document.getElementById('salesBarcodeInput');
            if (barcodeInput) {
                barcodeInput.value = barcode;
                // è§¸ç™¼æœå°‹
                searchAndAddProduct(barcode);
                // æ¸…ç©ºè¼¸å…¥æ¡†
                setTimeout(() => {
                    barcodeInput.value = '';
                }, 100);
            }
        };



        // éŸ³æ•ˆæ’­æ”¾å‡½æ•¸
        function playSound(soundType) {
            try {
                const audio = new Audio();
                if (soundType === 'success') {
                    audio.src = '../sounds/æ­£ç¢ºéŸ³æ•ˆ.mp3';
                } else if (soundType === 'error') {
                    audio.src = '../sounds/éŒ¯èª¤éŸ³æ•ˆ.mp3';
                } else if (soundType === 'select') {
                    audio.src = '../sounds/é¸æ“‡éŸ³æ•ˆ.mp3';
                }
                audio.play().catch(error => {
                    console.log('éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', error);
                });
            } catch (error) {
                console.log('éŸ³æ•ˆæ’­æ”¾éŒ¯èª¤:', error);
            }
        }

        // éŠ·å”®å¾Œæ›´æ–°åº«å­˜
        async function updateInventoryAfterSale(saleItems, receiptNumber) {
            try {
                // ä½¿ç”¨å…¨åŸŸçš„ window.supabase
                const supabaseClient = window.supabase;
                if (!supabaseClient) {
                    console.error('Supabase å®¢æˆ¶ç«¯ä¸å¯ç”¨');
                        return false;
                }

                console.log('é–‹å§‹æ›´æ–°åº«å­˜ï¼ŒéŠ·å”®é …ç›®:', saleItems);

                for (const item of saleItems) {
                    // æª¢æŸ¥å¿…è¦æ¬„ä½
                    if (!item.id) {
                        console.error('éŠ·å”®é …ç›®ç¼ºå°‘å•†å“ID:', item);
                        continue;
                    }
                    
                    // è™•ç†å•†å“è¦æ ¼
                    let productId = item.id;
                    let variantName = item.variant;
                    
                    // å¦‚æœIDåŒ…å«è¦æ ¼ä¿¡æ¯ï¼Œæå–åŸå§‹å•†å“ID
                    if (typeof item.id === 'string' && item.id.includes('-') && item.originalProductId) {
                        productId = item.originalProductId;
                    }
                    
                    // æŸ¥è©¢å•†å“çš„ç•¶å‰åº«å­˜
                    const { data: product, error: productError } = await supabase
                        .from('products')
                        .select('id, stock, barcode, name, variants')
                        .eq('id', productId)
                        .single();

                    if (productError) {
                        console.error(`æŸ¥è©¢å•†å“å¤±æ•— (å•†å“ID: ${productId}):`, productError);
                        continue;
                    }

                    if (!product) {
                        console.error(`æ‰¾ä¸åˆ°å•†å“ (å•†å“ID: ${productId})`);
                        continue;
                    }

                    // è™•ç†å•†å“è¦æ ¼åº«å­˜æ›´æ–°
                    let newStock;
                    let currentStock;
                    let updatedVariants = null;
                    
                    if (product.variants && variantName !== 'æ¨™æº–è¦æ ¼') {
                        // æ›´æ–°è¦æ ¼åº«å­˜
                        try {
                            const variants = JSON.parse(product.variants);
                            const variantIndex = variants.findIndex(v => v.name === variantName);
                            
                            if (variantIndex !== -1) {
                                const currentVariantStock = variants[variantIndex].stock || 0;
                                currentStock = currentVariantStock;
                                const newVariantStock = Math.max(0, currentVariantStock - item.quantity);
                                variants[variantIndex].stock = newVariantStock;
                                updatedVariants = JSON.stringify(variants);
                                newStock = newVariantStock;
                            } else {
                                // æ‰¾ä¸åˆ°è¦æ ¼ï¼Œä½¿ç”¨ä¸»å•†å“åº«å­˜
                                currentStock = product.stock;
                                newStock = Math.max(0, product.stock - item.quantity);
                            }
                        } catch (e) {
                            console.error('è§£æå•†å“è¦æ ¼å¤±æ•—:', e);
                            currentStock = product.stock;
                            newStock = Math.max(0, product.stock - item.quantity);
                        }
                    } else {
                        // æ›´æ–°ä¸»å•†å“åº«å­˜
                        currentStock = product.stock;
                        newStock = Math.max(0, product.stock - item.quantity);
                    }

                    // æ›´æ–°å•†å“åº«å­˜
                    const updateData = { 
                        updated_at: new Date().toISOString()
                    };
                    
                    if (updatedVariants) {
                        updateData.variants = updatedVariants;
                    } else {
                        updateData.stock = newStock;
                    }
                    
                    const { error: updateError } = await supabase
                        .from('products')
                        .update(updateData)
                        .eq('id', product.id);

                    if (updateError) {
                        console.error(`æ›´æ–°åº«å­˜å¤±æ•— (å•†å“ID: ${product.id}):`, updateError);
                        continue;
                    }

                    // è¨˜éŒ„åº«å­˜äº¤æ˜“ï¼ˆå¯é¸ï¼Œå¦‚æœè¡¨ä¸å­˜åœ¨å‰‡è·³éï¼‰
                    try {
                        const { error: transactionError } = await supabase
                            .from('inventory_transactions')
                            .insert([{
                                product_id: product.id,
                                transaction_type: 'sale',
                                quantity_change: -item.quantity,
                                previous_stock: currentStock,
                                new_stock: newStock,
                                reference_id: receiptNumber.toString(),
                                reference_type: 'sale',
                                notes: `éŠ·å”®æ¸›åº«å­˜ - ${item.name} (${item.variant})`,
                                created_by: getCurrentEmployeeName()
                            }]);

                        if (transactionError) {
                            console.warn(`è¨˜éŒ„åº«å­˜äº¤æ˜“å¤±æ•— (å•†å“ID: ${product.id}):`, transactionError);
                            // ä¸å½±éŸ¿ä¸»è¦æµç¨‹ï¼Œåªè¨˜éŒ„è­¦å‘Š
                        }
                    } catch (error) {
                        console.warn(`åº«å­˜äº¤æ˜“è¨˜éŒ„è¡¨ä¸å­˜åœ¨æˆ–ç„¡æ³•è¨ªå•:`, error);
                        // ä¸å½±éŸ¿ä¸»è¦æµç¨‹ï¼Œåªè¨˜éŒ„è­¦å‘Š
                    }

                    console.log(`æˆåŠŸæ›´æ–°åº«å­˜ - å•†å“: ${product.name} (${variantName}), éŠ·å”®æ•¸é‡: ${item.quantity}, æ–°åº«å­˜: ${newStock}`);

                    // æª¢æŸ¥åº«å­˜ä¸è¶³è­¦å‘Š
                    if (newStock <= 0) {
                        console.warn(`è­¦å‘Šï¼šå•†å“ "${product.name} (${variantName})" åº«å­˜ä¸è¶³æˆ–å·²å”®å®Œï¼ç•¶å‰åº«å­˜ï¼š${newStock}`);
                    } else if (newStock <= 10) { // å‡è¨­æœ€ä½åº«å­˜è­¦å‘Šç‚º10
                        console.warn(`è­¦å‘Šï¼šå•†å“ "${product.name} (${variantName})" åº«å­˜åä½ï¼ç•¶å‰åº«å­˜ï¼š${newStock}`);
                    }
                }

                return true;
            } catch (error) {
                console.error('æ›´æ–°åº«å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return false;
            }
        }

        // ç”Ÿæˆå”¯ä¸€æ”¶æ“šè™Ÿç¢¼
        async function generateUniqueReceiptNumber() {
            try {
                // å„ªå…ˆä½¿ç”¨é é¢ä¸Šå·²ç¶“ç”Ÿæˆçš„è¨‚å–®ç·¨è™Ÿ
                if (window.currentOrderNumber) {
                    console.log('ä½¿ç”¨é é¢è¨‚å–®ç·¨è™Ÿä½œç‚ºæ”¶æ“šç·¨è™Ÿ:', window.currentOrderNumber);
                    return window.currentOrderNumber;
                }
                
                if (!supabase) {
                    const initSuccess = await initSupabase();
                    if (!initSuccess) {
                        console.error('Supabase åˆå§‹åŒ–å¤±æ•—');
                        return null;
                    }
                }

                // æŸ¥è©¢æœ€å¤§çš„æ”¶æ“šè™Ÿç¢¼
                const { data: maxReceipt, error } = await supabase
                    .from('sales_history')
                    .select('receipt_number')
                    .order('receipt_number', { ascending: false })
                    .limit(1);

                if (error) {
                    console.error('æŸ¥è©¢æœ€å¤§æ”¶æ“šè™Ÿç¢¼å¤±æ•—:', error);
                    // å¦‚æœæŸ¥è©¢å¤±æ•—ï¼Œä½¿ç”¨ç•¶å‰æ™‚é–“æˆ³ä½œç‚ºåŸºç¤
                    return Date.now();
                }

                let nextNumber = 1000; // é è¨­èµ·å§‹è™Ÿç¢¼
                if (maxReceipt && maxReceipt.length > 0) {
                    const currentMax = parseInt(maxReceipt[0].receipt_number);
                    if (!isNaN(currentMax)) {
                        nextNumber = currentMax + 1;
                    } else {
                        // å¦‚æœç„¡æ³•è§£æç‚ºæ•¸å­—ï¼Œä½¿ç”¨æ™‚é–“æˆ³
                        nextNumber = Date.now();
                    }
                }

                console.log('ç”Ÿæˆçš„æ”¶æ“šè™Ÿç¢¼:', nextNumber);
                return nextNumber;
            } catch (error) {
                console.error('ç”Ÿæˆæ”¶æ“šè™Ÿç¢¼æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return Date.now(); // ä½¿ç”¨æ™‚é–“æˆ³ä½œç‚ºå‚™ç”¨
            }
        }




        
        
        // æª¢æŸ¥æƒæåŠŸèƒ½æ˜¯å¦è¼‰å…¥

        window.addEventListener('load', function() {

            setTimeout(function() {

                if (typeof window.quickScan !== 'function') {

                    window.quickScan = function(onSuccess, onError) {

                        const barcode = prompt('è«‹è¼¸å…¥æ¢ç¢¼è™Ÿç¢¼é€²è¡ŒéŠ·å”®');

                        if (barcode) {

                            onSuccess(barcode);

                        } else if (onError) {

                            onError(new Error('ç”¨æˆ¶å–æ¶ˆè¼¸å…¥'));

                        }

                    };

                }

            }, 1000);

        });

    </script>

            <style>
 
        .apple-card {
 
            background: rgba(255, 255, 255, 0.95);
 
            backdrop-filter: blur(10px);
 
            border: 1px solid rgba(255, 255, 255, 0.2);
 
        }
 
        .pos-display {
 
            background: linear-gradient(135deg, #17225e 0%, #1a2a6e 100%);
 
            color: white;
 
            font-family: 'Courier New', monospace;
 
        }
 
        .scan-display {
 
            background: linear-gradient(45deg, #17225e, #1a2a6e);
 
            position: relative;
 
            overflow: hidden;
 
        }
 
        /* æ”¶æ“šå°ˆç”¨æ¨£å¼ - 58mm æ”¶æ“šç´™å„ªåŒ– */
        .receipt-print {
            font-family: 'Courier New', 'Microsoft JhengHei', monospace;
            font-size: 16px;
            line-height: 1.5;
            width: 218px; /* 58mm = 218px */
            margin: 0 auto;
            padding: 12px;
            background: white;
            color: black;
            transform: scale(1.25); /* æ•´é«”æ”¾å¤§125% */
            transform-origin: top center;
            margin-bottom: 50px; /* ç‚ºæ”¾å¤§å¾Œçš„å…§å®¹ç•™å‡ºç©ºé–“ */
        }
        
        .receipt-print .header {
            text-align: center;
            margin-bottom: 18px;
            border-bottom: 3px solid #000;
            padding-bottom: 12px;
        }
        
        .receipt-print .header h2 {
            font-size: 20px;
            font-weight: bold;
            margin: 8px 0;
            letter-spacing: 1px;
        }
        
        .receipt-print .header p {
            font-size: 15px;
            margin: 5px 0;
            line-height: 1.4;
        }
        
        .receipt-print .line {
            border-bottom: 2px dashed #000;
            margin: 10px 0;
        }
        
        .receipt-print .row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin: 8px 0;
            font-size: 15px;
            line-height: 1.4;
        }
        
        .receipt-print .row.small {
            font-size: 14px;
            color: #333;
            margin: 4px 0;
            padding-left: 12px;
        }
        
        .receipt-print .total {
            font-weight: bold;
            font-size: 18px;
            border-top: 2px solid #000;
            padding-top: 10px;
            margin-top: 12px;
        }
        
        .receipt-print .item-name {
            font-size: 15px;
            font-weight: bold;
            line-height: 1.4;
            word-break: break-all;
            flex: 1;
            margin-right: 12px;
        }
        
        .receipt-print .item-price {
            font-size: 15px;
            text-align: right;
            white-space: nowrap;
        }
        
        .receipt-print .item-details {
            font-size: 13px;
            color: #555;
            margin-left: 18px;
            line-height: 1.3;
        }
        
        .receipt-print .footer {
            text-align: center;
            margin-top: 18px;
            font-size: 14px;
            color: #666;
            border-top: 2px dashed #000;
            padding-top: 12px;
        }
        
        /* é€€è²¨æ”¶æ“šç‰¹æ®Šæ¨£å¼ */
        .receipt-print .refund-title {
            color: #d32f2f !important;
            border: 3px solid #d32f2f;
            padding: 8px 12px;
            margin: 12px 0;
            border-radius: 8px;
            background: rgba(211, 47, 47, 0.1);
            font-size: 22px;
        }
        
        .receipt-print .refund-notice {
            background: #ffebee;
            border: 2px solid #d32f2f;
            padding: 10px;
            margin: 12px 0;
            border-radius: 8px;
            font-size: 16px;
            color: #d32f2f;
            text-align: center;
            font-weight: bold;
        }
        
        @media print {
            body {
                margin: 0;
                padding: 0;
                width: 58mm;
                background: white;
            }
            .receipt-print {
                width: 58mm;
                max-width: none;
                box-shadow: none;
                border: none;
                transform: scale(1.25); /* æ‰“å°æ™‚ä¹Ÿä¿æŒ125%ç¸®æ”¾ */
                transform-origin: top center;
            }
            .receipt-print * {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
 
        </style>

</head>

<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen p-4 pb-24">

    
    
    <!-- é ‚éƒ¨æ“ä½œå€ -->

    <div class="mb-6">

        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">

            <div>

                <h1 class="text-2xl font-bold text-gray-800">éŠ·å”®ä½œæ¥­</h1>

                <p class="text-gray-600">è¼¸å…¥æ¢ç¢¼é€²è¡Œå¿«é€ŸéŠ·å”®å’Œçµå¸³</p>

            </div>

            <div class="flex space-x-3">

                <button onclick="goBackToMenu()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">

                    <i class="fas fa-th-large mr-2"></i>å›é¸å–®

                </button>



                <button onclick="showSalesHistory()" class="bg-[#17225e] text-white px-4 py-2 rounded-lg text-sm hover:bg-[#1a2a6e] transition-colors">

                    <i class="fas fa-history mr-2"></i>éŠ·å”®è¨˜éŒ„

                </button>


            </div>

        </div>

    </div>



    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">

        
        
        <!-- å·¦å´ï¼šPOSé¡¯ç¤ºå™¨å’Œå¿«é€Ÿæ“ä½œ -->

        <div class="xl:col-span-1">

            
            
            <!-- POS é¡¯ç¤ºå™¨ -->

            <div class="pos-display rounded-xl p-6 mb-6 shadow-lg">

                <div class="text-center mb-4">

                    <h3 class="text-lg font-bold">æ³¢æ³¢ èš æ­æ´²å®¶å±…/æ³¢è˜­é™¶é£Ÿå™¨</h3>

                    <p class="text-sm opacity-90">æ­¡è¿å…‰è‡¨</p>

                </div>

                <div class="space-y-2 text-sm">

                    <div class="flex justify-between">

                        <span>è¨‚å–®ç·¨è™Ÿï¼š</span>

                        <span id="orderNumber">2024122401</span>

                    </div>

                    <div class="flex justify-between">

                        <span>æ”¶éŠ€å“¡ï¼š</span>

                        <span id="currentCashier">ç®¡ç†å“¡</span>

                    </div>

                    <div class="flex justify-between">

                        <span>æ™‚é–“ï¼š</span>

                        <span id="currentTime"></span>

                    </div>

                    <div id="currentMemberInfo" class="hidden">

                        <hr class="my-2 border-white border-opacity-30">

                        <div class="flex justify-between">

                            <span>æœƒå“¡ï¼š</span>

                            <span id="memberName"></span>

                        </div>



                        </div>

                    <hr class="my-4 border-white border-opacity-30">

                    <div class="flex justify-between text-lg font-bold">

                        <span>ç¸½è¨ˆï¼š</span>

                        <span id="totalAmount">NT$0</span>

                    </div>

                </div>

            </div>



                            <!-- æ¢ç¢¼åŠŸèƒ½å€ -->

            <div class="apple-card rounded-xl p-6 mb-6 shadow-lg">

                                    <h3 class="text-lg font-semibold text-gray-800 mb-4">æ¢ç¢¼åŠŸèƒ½</h3>



                <input type="text" id="salesBarcodeInput" placeholder="æ‰‹å‹•è¼¸å…¥æ¢ç¢¼æˆ–å•†å“åç¨±" 

                       class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">

                <p class="text-xs text-gray-600 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    æ‰‹å‹•è¼¸å…¥æ¢ç¢¼å¾ŒæŒ‰Enteréµæœå°‹ï¼ŒPCæ¢ç¢¼æƒæå™¨æœƒè‡ªå‹•è§¸ç™¼æœå°‹
                </p>
            </div>



            <!-- å¿«é€ŸåŠŸèƒ½ -->

            <div class="apple-card rounded-lg p-2 shadow-sm">

                <h3 class="text-lg font-semibold text-gray-800 mb-4">å¿«é€ŸåŠŸèƒ½</h3>

                <div class="grid grid-cols-3 gap-1">

                    <button id="couponBtn" class="flex flex-col items-center p-1 bg-gray-200 rounded cursor-not-allowed opacity-50" disabled>

                        <i class="fas fa-gift text-gray-400 text-xs mb-0.5"></i>

                        <span class="text-xs text-gray-500">å„ªæƒ åˆ¸</span>

                    </button>

                    <button id="memberBtn" class="flex flex-col items-center p-1 bg-gray-50 rounded hover:bg-gray-100 transition-colors relative">

                        <i class="fas fa-user text-[#17225e] text-xs mb-0.5"></i>

                        <span class="text-xs" id="memberBtnText">æœƒå“¡</span>

                        <div id="memberStatusDot" class="hidden absolute -top-0.5 -right-0.5 w-1.5 h-1.5 bg-[#17225e] rounded-full border border-white"></div>

                    </button>

                    <button id="refundBtn" class="flex flex-col items-center p-1 bg-red-50 rounded hover:bg-red-100 transition-colors">

                        <i class="fas fa-undo text-red-500 text-xs mb-0.5"></i>

                        <span class="text-xs">é€€è²¨</span>

                    </button>

                </div>

            </div>

        </div>



        <!-- å³å´ï¼šè³¼ç‰©è»Šå’Œå•†å“ -->

        <div class="xl:col-span-2">

            
            
            <!-- è³¼ç‰©è»Š -->

            <div id="cartContainer" class="apple-card rounded-xl p-6 mb-6 shadow-lg">
                <div class="flex items-center justify-between mb-4">

                    <h3 class="text-lg font-semibold text-gray-800">è³¼ç‰©è»Š</h3>

                    <span id="cartItemCount" class="text-sm text-gray-600">å…± 0 é …å•†å“</span>
                </div>



                <div id="cartItems" class="space-y-4">
                    <!-- è³¼ç‰©è»Šé …ç›®å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                    </div>



                <!-- å„ªæƒ åˆ¸è¼¸å…¥å€ -->

                <div class="mt-6 pt-6 border-t border-gray-200">

                    <div class="bg-gray-100 border border-gray-300 rounded-lg p-4 mb-4 opacity-60">

                        <div class="flex items-center mb-3">

                            <i class="fas fa-ticket-alt text-gray-400 mr-2"></i>

                            <span class="font-medium text-gray-500">å„ªæƒ åˆ¸ (åŠŸèƒ½æœªé–‹é€š)</span>

                        </div>

                        <div class="flex space-x-2">

                            <input type="text" id="couponInput" placeholder="å„ªæƒ åˆ¸åŠŸèƒ½æœªé–‹é€š" 

                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm bg-gray-50 text-gray-400 cursor-not-allowed" disabled>

                            <button class="px-4 py-2 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed text-sm" disabled>

                                <i class="fas fa-check mr-1"></i>

                                å¥—ç”¨

                            </button>

                            <button class="px-3 py-2 bg-gray-200 text-gray-400 rounded-lg cursor-not-allowed text-sm" disabled>

                                <i class="fas fa-qrcode"></i>

                            </button>

                        </div>

                        <div id="appliedCoupon" class="mt-3 hidden">

                            <div class="flex items-center justify-between bg-gray-50 border border-gray-200 rounded-lg p-3">

                                <div class="flex items-center">

                                    <i class="fas fa-check-circle text-[#17225e] mr-2"></i>

                                    <div>

                                        <span class="font-medium text-gray-800" id="appliedCouponName"></span>

                                        <p class="text-xs text-gray-600" id="appliedCouponDesc"></p>

                                    </div>

                                </div>

                                <button onclick="removeCoupon()" class="text-[#17225e] hover:text-[#1a2a6e]">

                                    <i class="fas fa-times"></i>

                                </button>

                            </div>

                        </div>

                    </div>

                    
                    
                    <!-- å„ªæƒ å’Œç¸½è¨ˆ -->

                    <div class="space-y-3">

                        <div class="flex justify-between text-sm">

                            <span class="text-gray-600">å°è¨ˆï¼š</span>

                            <span id="subtotalAmount">NT$0</span>

                        </div>

                        <div class="flex justify-between text-sm" id="couponDiscountRow" style="display: none;">

                            <span class="text-gray-600">å„ªæƒ åˆ¸æŠ˜æ‰£ï¼š</span>

                            <span class="text-[#17225e]" id="couponDiscountAmount">-NT$0</span>

                        </div>

                        <div class="flex justify-between text-sm" id="newDiscountRow" style="display: none;">

                            <span class="text-gray-600">æŠ˜æ‰£å„ªæƒ ï¼š</span>

                            <span class="text-[#17225e]" id="newDiscountAmount">-NT$0</span>

                        </div>
                        
                        <!-- æŠ˜æ‰£ç®¡ç†å€åŸŸ -->
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-gray-800 text-sm">æŠ˜æ‰£ç®¡ç†</h4>
                                <button onclick="showAddDiscountModal()" class="bg-blue-500 text-white px-3 py-1.5 rounded-lg hover:bg-blue-600 text-xs">
                                    <i class="fas fa-plus mr-1"></i>æ–°å¢æŠ˜æ‰£
                                </button>
                            </div>
                            
                            <!-- å·²å¥—ç”¨æŠ˜æ‰£åˆ—è¡¨ -->
                            <div id="appliedDiscounts" class="space-y-2">
                                <p class="text-gray-500 text-xs">ç›®å‰æ²’æœ‰å¥—ç”¨ä»»ä½•æŠ˜æ‰£</p>
                            </div>
                        </div>

                        <hr class="border-gray-200">

                        <div class="flex justify-between text-xl font-bold">

                            <span>ç¸½è¨ˆï¼š</span>

                            <span id="totalAmount" class="text-[#17225e]">NT$0</span>

                        </div>

                    </div>



                    <!-- å…¶ä»–æ“ä½œæŒ‰éˆ• -->

                    <div class="mt-3">

                        <button onclick="clearCart()" class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition-colors text-sm">

                            <i class="fas fa-trash mr-2"></i>æ¸…ç©ºè³¼ç‰©è»Š

                        </button>

                    </div>

                </div>

            </div>




        </div>

    </div>



    <!-- åº•éƒ¨çµå¸³æŒ‰éˆ•å€ -->

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 z-40">

        <div class="max-w-7xl mx-auto">

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">

                <button onclick="checkout('ç¾é‡‘')" class="bg-[#17225e] text-white py-4 rounded-lg hover:bg-[#1a2a6e] transition-colors font-semibold text-lg">

                    <i class="fas fa-money-bill mr-2"></i>ç¾é‡‘çµå¸³

                </button>

                <button onclick="checkout('ä¿¡ç”¨å¡')" class="bg-[#17225e] text-white py-4 rounded-lg hover:bg-[#1a2a6e] transition-colors font-semibold text-lg">

                    <i class="fas fa-credit-card mr-2"></i>ä¿¡ç”¨å¡çµå¸³

                </button>

                <button onclick="checkout('è¡Œå‹•æ”¯ä»˜')" class="bg-[#17225e] text-white py-4 rounded-lg hover:bg-[#1a2a6e] transition-colors font-semibold text-lg">

                    <i class="fas fa-mobile-alt mr-2"></i>è¡Œå‹•æ”¯ä»˜çµå¸³

                </button>

            </div>

        </div>

    </div>



    <!-- å•†å“é¸æ“‡å½ˆå‡ºè¦–çª— -->

    <div id="productSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">

        <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">

            <div class="flex items-center justify-between mb-4">

                <h3 class="text-xl font-bold text-gray-800">é¸æ“‡å•†å“å°é …</h3>

                <button onclick="closeProductSelectionModal()" class="text-gray-500 hover:text-gray-700">

                    <i class="fas fa-times text-xl"></i>

                </button>

            </div>
            
            
            
                            <div class="mb-4 p-3 bg-gray-50 border border-gray-200 rounded-lg">

                <div class="flex items-center">

                    <i class="fas fa-info-circle text-[#17225e] mr-2"></i>

                    <span class="text-sm text-gray-700">æ­¤æ¢ç¢¼å°æ‡‰å¤šå€‹å•†å“å°é …ï¼Œè«‹é¸æ“‡æ­£ç¢ºçš„å•†å“ï¼š</span>

                </div>

                <div class="mt-2 text-sm text-gray-600">

                    æ¢ç¢¼ï¼š<span id="modalBarcode" class="font-mono bg-gray-100 px-2 py-1 rounded"></span>

                </div>

            </div>

            
            
            <div id="productVariantsList" class="space-y-3 max-h-96 overflow-y-auto">

                <!-- å•†å“å°é …å°‡å‹•æ…‹æ·»åŠ åˆ°é€™è£¡ -->

            </div>

            
            
            <div class="mt-6 flex justify-end space-x-3">

                <button onclick="closeProductSelectionModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">

                    å–æ¶ˆ

                </button>

            </div>

        </div>

    </div>
    

    <!-- æ–°å¢æŠ˜æ‰£å½ˆçª— -->
    <div id="addDiscountModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">æ–°å¢æŠ˜æ‰£</h3>
                <button onclick="closeAddDiscountModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- æŠ˜æ‰£åç¨± -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">æŠ˜æ‰£åç¨±</label>
                <input type="text" id="discountName" placeholder="ä¾‹å¦‚ï¼šç»ç’ƒæ¯ä¹æŠ˜" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <!-- æŠ˜æ‰£é¡å‹ -->
            <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">æŠ˜æ‰£é¡å‹</label>
                <select id="newDiscountType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="percentage">ç™¾åˆ†æ¯”æŠ˜æ‰£</option>
                                <option value="fixed">å›ºå®šé‡‘é¡æŠ˜æ‰£</option>
                            </select>
                        </div>
                        
            <!-- æŠ˜æ‰£å€¼ -->
            <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">æŠ˜æ‰£å€¼</label>
                            <div class="flex items-center space-x-2">
                    <input type="number" id="newDiscountValue" min="0" step="0.01" 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <span id="newDiscountUnit" class="text-sm text-gray-600 w-8">%</span>
                            </div>
                        </div>
                        
            <!-- å¥—ç”¨ç¯„åœ -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">å¥—ç”¨ç¯„åœ</label>
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="radio" name="discountScope" value="all" checked class="mr-2 text-blue-500" onchange="toggleItemSelection()">
                        <span class="text-sm">æ•´ç­†æŠ˜æ‰£ï¼ˆå¥—ç”¨åˆ°æ‰€æœ‰å•†å“ï¼‰</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="discountScope" value="selected" class="mr-2 text-blue-500" onchange="toggleItemSelection()">
                        <span class="text-sm">æŒ‡å®šå“é …æŠ˜æ‰£ï¼ˆé¸æ“‡ç‰¹å®šå•†å“ï¼‰</span>
                    </label>
                        </div>
                    </div>
            
            <!-- å•†å“é¸æ“‡å€åŸŸï¼ˆåƒ…åœ¨æŒ‡å®šå“é …æ™‚é¡¯ç¤ºï¼‰ -->
            <div id="itemSelectionArea" class="mb-4 hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡å•†å“</label>
                <div id="cartItemsForNewDiscount" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-3 space-y-2">
                    <!-- è³¼ç‰©è»Šå•†å“å°‡å‹•æ…‹æ·»åŠ åˆ°é€™è£¡ -->
                </div>
            </div>
            
            <!-- æŒ‰éˆ• -->
            <div class="flex space-x-3">
                <button onclick="closeAddDiscountModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    å–æ¶ˆ
                </button>
                <button onclick="addDiscount()" class="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    æ–°å¢æŠ˜æ‰£
                </button>
            </div>
        </div>
    </div>
    
    
    <script>

        // æœƒå“¡æ•¸æ“šåº«ï¼ˆæ¨¡æ“¬ï¼‰

        const membersDatabase = {

            'M001': {

                id: 'M001',

                name: 'ç‹å°æ˜',

                phone: '0912-345-678',

                email: 'wang@example.com',

                level: 'é‡‘å¡',

                totalSpent: 45280,

                status: 'active'
            },

            'M002': {

                id: 'M002',

                name: 'æç¾è¯',

                phone: '0987-654-321',

                email: 'li@example.com',

                level: 'ç™½é‡‘',

                totalSpent: 78965,

                status: 'active'
            },

            'M003': {

                id: 'M003',

                name: 'å¼µå¿—å‰',

                phone: '0923-456-789',

                email: 'zhang@example.com',

                level: 'éŠ€å¡',

                totalSpent: 23400,

                status: 'active'
            },

            'M004': {

                id: 'M004',

                name: 'é™³é›…çª',

                phone: '0934-567-890',

                email: 'chen@example.com',

                level: 'é‘½çŸ³',

                totalSpent: 125000,

                status: 'active'
            },

            'M005': {

                id: 'M005',

                name: 'æ—å»ºè¯',

                phone: '0945-678-901',

                email: 'lin@example.com',

                level: 'æ™®é€š',

                totalSpent: 5600,

                status: 'active'
            }

        };



        // æ‰‹æ©Ÿè™Ÿç¢¼å°æ‡‰æœƒå“¡IDçš„æŸ¥è©¢è¡¨

        const phoneToMemberMap = {

            '0912-345-678': 'M001',

            '0912345678': 'M001',

            '0987-654-321': 'M002',

            '0987654321': 'M002',

            '0923-456-789': 'M003',

            '0923456789': 'M003',

            '0934-567-890': 'M004',

            '0934567890': 'M004',

            '0945-678-901': 'M005',

            '0945678901': 'M005'

        };



        // æ³¢æ³¢ èš æ­æ´²å®¶å±…/æ³¢è˜­é™¶é£Ÿå™¨å•†å“æ•¸æ“šåº«ï¼ˆæ”¯æ´åŒæ¢ç¢¼å¤šå•†å“å°é …ï¼‰

        const mockProducts = {

            '1234567890123': [  // æ­å¼éª¨ç“·é¤ç›¤ç³»åˆ—

                {

                    id: 'P001-01',

                    name: 'æ­å¼éª¨ç“·é¤ç›¤',

                    variant: '20cm ç™½è‰²ç¶“å…¸æ¬¾',

                    price: 890,

                    stock: 15,

                    category: 'é¤å…·',

                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',

                    status: 'normal',

                    description: 'ç´”ç™½éª¨ç“·ï¼Œç¶“å…¸æ­å¼è¨­è¨ˆ'

                },

                {

                    id: 'P001-02',

                    name: 'æ­å¼éª¨ç“·é¤ç›¤',

                    variant: '20cm è—èŠ±åœ–æ¡ˆæ¬¾',

                    price: 950,

                    stock: 8,

                    category: 'é¤å…·',

                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',

                    status: 'normal',

                    description: 'æ‰‹ç¹ªè—èŠ±åœ–æ¡ˆï¼Œç²¾ç·»å·¥è—'

                },

                {

                    id: 'P001-03',

                    name: 'æ­å¼éª¨ç“·é¤ç›¤',

                    variant: '20cm é‡‘é‚Šå¥¢è¯æ¬¾',

                    price: 1280,

                    stock: 5,

                    category: 'é¤å…·',

                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',

                    status: 'normal',

                    description: '24Ké‡‘é‚Šè£é£¾ï¼Œå¥¢è¯å…¸é›…'

                }

            ],

            '2345678901234': [  // æ°´æ™¶é…’æ¯ç³»åˆ—

                {

                    id: 'P002-01',

                    name: 'æ–½è¯æ´›ä¸–å¥‡æ°´æ™¶é…’æ¯',

                    variant: 'ç´…é…’æ¯ 300ml',

                    price: 2890,

                    stock: 12,

                    category: 'é…’å…·',

                    image: 'https://images.unsplash.com/photo-1509669803555-fd5c49448db3?w=60&h=60&fit=crop&crop=center',

                    status: 'normal',

                    description: 'å¥§åœ°åˆ©æ°´æ™¶ï¼Œå®Œç¾é…’æ¯å¼§åº¦'

                },

                {

                    id: 'P002-02',

                    name: 'æ–½è¯æ´›ä¸–å¥‡æ°´æ™¶é…’æ¯',

                    variant: 'é¦™æª³æ¯ 200ml',

                    price: 2590,

                    stock: 18,

                    category: 'é…’å…·',

                    image: 'https://images.unsplash.com/photo-1509669803555-fd5c49448db3?w=60&h=60&fit=crop&crop=center',

                    status: 'normal',

                    description: 'ç´°é•·æ¯èº«ï¼Œä¿æŒæ°£æ³¡å®Œç¾'

                }

            ],

            '3456789012345': [  // å®¶å±…æ“ºé£¾ç³»åˆ—

                {

                    id: 'P003-01',

                    name: 'åŒ—æ­é¢¨é™¶ç“·èŠ±ç“¶',

                    variant: 'å°è™Ÿ 15cm ç°è‰²',

                    price: 680,

                    stock: 25,

                    category: 'æ“ºé£¾',

                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',

                    status: 'normal',

                    description: 'ç°¡ç´„åŒ—æ­è¨­è¨ˆï¼Œå•å…‰è³ªæ„Ÿ'

                },

                {

                    id: 'P003-02',

                    name: 'åŒ—æ­é¢¨é™¶ç“·èŠ±ç“¶',

                    variant: 'ä¸­è™Ÿ 25cm ç™½è‰²',

                    price: 980,

                    stock: 15,

                    category: 'æ“ºé£¾',

                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',

                    status: 'normal',

                    description: 'ç´”ç™½é™¶ç“·ï¼Œä¸­æ€§ç™¾æ­'

                },

                {

                    id: 'P003-03',

                    name: 'åŒ—æ­é¢¨é™¶ç“·èŠ±ç“¶',

                    variant: 'å¤§è™Ÿ 35cm é»‘è‰²',

                    price: 1380,

                    stock: 8,

                    category: 'æ“ºé£¾',

                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',

                    status: 'normal',

                    description: 'é»‘è‰²å•å…‰ï¼Œç¾ä»£è—è¡“æ„Ÿ'

                }

            ],

            '4567890123456': [  // èŒ¶å…·ç³»åˆ—

                {

                    id: 'P004-01',

                    name: 'è‹±å¼éª¨ç“·èŒ¶æ¯çµ„',

                    variant: 'ç¶“å…¸ç«ç‘°åœ–æ¡ˆ',

                    price: 1590,

                    stock: 0,

                    category: 'èŒ¶å…·',

                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',

                    status: 'out',

                    description: 'å‚³çµ±è‹±å¼ä¸‹åˆèŒ¶èŒ¶æ¯'

                }

            ],

            '5678901234567': [  // é¤å…·å¥—è£

                {

                    id: 'P005-01',

                    name: 'æ³•å¼é¤å…·å¥—è£',

                    variant: '4äººä»½åŸºç¤æ¬¾',

                    price: 3890,

                    stock: 6,

                    category: 'é¤å…·',

                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',

                    status: 'normal',

                    description: 'åŒ…å«é¤ç›¤ã€æ¹¯ç¢—ã€èŒ¶æ¯'

                },

                {

                    id: 'P005-02',

                    name: 'æ³•å¼é¤å…·å¥—è£',

                    variant: '4äººä»½è±ªè¯æ¬¾',

                    price: 5890,

                    stock: 3,

                    category: 'é¤å…·',

                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',

                    status: 'low',

                    description: 'åŒ…å«é¤ç›¤ã€æ¹¯ç¢—ã€èŒ¶æ¯ã€ç”œé»ç›¤'

                }

            ],

            '6789012345678': [  // å»šæˆ¿ç”¨å“

                {

                    id: 'P006-01',

                    name: 'å¾·åœ‹ä¸é½é‹¼å»šå…·',

                    variant: 'åŸºç¤3ä»¶çµ„',

                    price: 2200,

                    stock: 12,

                    category: 'å»šå…·',

                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',

                    status: 'normal',

                    description: 'æ¹¯å‹ºã€æ¼å‹ºã€éŸå­'

                }

            ]

        };



        // è³¼ç‰©è»Š

        let cart = [];

        
        
        // ç•¶å‰ç™»å…¥æœƒå“¡

        let currentMember = null;

        
        
        // ç•¶å‰å„ªæƒ åˆ¸

        let currentCoupon = null;

        // æŠ˜æ‰£ç®¡ç†
        let appliedDiscounts = [];
        
        // æŠ˜æ‰£é¡åˆ¥
        class Discount {
            constructor(name, type, value, scope, appliedItems = []) {
                this.id = 'discount_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                this.name = name;
                this.type = type;           // 'percentage' æˆ– 'fixed'
                this.value = value;
                this.scope = scope;          // 'all' æˆ– 'selected'
                this.appliedItems = appliedItems;
                this.createdAt = new Date().toISOString();
            }
        }



        // æ›´æ–°ç•¶å‰æ™‚é–“

        function updateTime() {

            const now = new Date();

            document.getElementById('currentTime').textContent = now.toLocaleTimeString('zh-TW');

        }

        updateTime();

        setInterval(updateTime, 1000);



        // åˆå§‹åŒ–äº‹ä»¶ç›£è½

        document.addEventListener('DOMContentLoaded', async function() {

            // é€²è¡Œæ¬Šé™æª¢æŸ¥

            const isAuthenticated = await checkAuthentication();

            if (!isAuthenticated) {

                return; // å¦‚æœæœªé€šéèªè­‰ï¼Œå‡½æ•¸æœƒè‡ªå‹•é‡å®šå‘

            }
            
            // å•Ÿå‹•å¿ƒè·³æ©Ÿåˆ¶
            console.log('ğŸ”„ Salesé é¢ï¼šå•Ÿå‹•å¿ƒè·³æ©Ÿåˆ¶');
            HeartbeatManager.checkAndStart();
            
            // æª¢æŸ¥éŠ·å”®ä½œæ¥­æ¬Šé™
            const hasPermission = await checkPermission(['sales']);
            if (!hasPermission) {
                return; // æ¬Šé™ä¸è¶³ï¼Œæœƒé¡¯ç¤ºéŒ¯èª¤ä¸¦é‡å®šå‘
            }

            
            // åˆå§‹åŒ– Supabase å®¢æˆ¶ç«¯
            // ç­‰å¾… Supabase åˆå§‹åŒ–å®Œæˆ
            await DatabaseManager.initialize();
            
            
            const barcodeInput = document.getElementById('salesBarcodeInput');

            
            
            // è¼‰å…¥å„ªæƒ åˆ¸åŠŸèƒ½

            loadCouponFunctions();



            // æ‰‹å‹•è¼¸å…¥æ¢ç¢¼äº‹ä»¶ï¼ˆå·²æ•´åˆåˆ°keydownäº‹ä»¶ä¸­ï¼‰
            // ä¿ç•™æ­¤è™•ä»¥å‚™å°‡ä¾†æ“´å±•

            // æ¢ç¢¼è¼¸å…¥äº‹ä»¶è™•ç† - åªåœ¨æŒ‰ä¸‹Enteréµæ™‚æœå°‹
            barcodeInput.addEventListener('keydown', function(e) {
                // åªæœ‰æŒ‰ä¸‹Enteréµæ™‚æ‰è™•ç†æ¢ç¢¼æœå°‹
                if (e.key === 'Enter') {

                    e.preventDefault();
                    const barcode = this.value.trim();

                    if (barcode) {

                        searchAndAddProduct(barcode);

                        this.value = '';

                    }

                }

            });


            // æ”¯æ´PCæ¢ç¢¼æƒæå™¨çš„è‡ªå‹•è¼¸å…¥ï¼ˆæƒæå™¨é€šå¸¸æœƒè‡ªå‹•æŒ‰Enterï¼‰
            barcodeInput.addEventListener('paste', function(e) {
                // å»¶é²è™•ç†ï¼Œç¢ºä¿å‰ªè²¼ç°¿å…§å®¹å·²æ›´æ–°
                setTimeout(() => {
                    const barcode = this.value.trim();
                    if (barcode) {
                        // è‡ªå‹•è§¸ç™¼Enteréµäº‹ä»¶ä¾†æœå°‹
                        const enterEvent = new KeyboardEvent('keydown', {
                            key: 'Enter',
                            code: 'Enter',
                            keyCode: 13,
                            which: 13,
                            bubbles: true,
                            cancelable: true
                        });
                        this.dispatchEvent(enterEvent);
                    }
                }, 100);
            });


            // å¿«é€ŸåŠŸèƒ½äº‹ä»¶ç›£è½

            // document.getElementById('couponBtn').addEventListener('click', applyCoupon); // å„ªæƒ åˆ¸åŠŸèƒ½å·²ç¦ç”¨

            document.getElementById('memberBtn').addEventListener('click', () => manageMember());
            document.getElementById('refundBtn').addEventListener('click', () => processRefund());



            // åˆå§‹åŒ–è³¼ç‰©è»Šé¡¯ç¤º

            updateCartDisplay();

        });






        // å¾ Supabase æŸ¥è©¢å•†å“è³‡æ–™
        async function searchProductFromSupabase(barcode) {
            try {
                if (!supabase) {
                    const initSuccess = await initSupabase();
                    if (!initSuccess) {
                        throw new Error('Supabase åˆå§‹åŒ–å¤±æ•—');
                    }
                }

                const { data, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('barcode', barcode);

                if (error) {
                    console.error('Supabase æŸ¥è©¢éŒ¯èª¤:', error);
                    throw error;
                }

                console.log('Supabase æŸ¥è©¢çµæœ:', data);
                return data || [];
            } catch (error) {
                console.error('æŸ¥è©¢ Supabase å•†å“è³‡æ–™å¤±æ•—:', error);
                return [];
            }
        }

        // å°‡ Supabase å•†å“è³‡æ–™è½‰æ›ç‚ºæœ¬åœ°æ ¼å¼
        function convertSupabaseProductToLocal(supabaseProduct) {
            // è§£æå•†å“è¦æ ¼
            let variants = [];
            if (supabaseProduct.variants) {
                try {
                    variants = JSON.parse(supabaseProduct.variants);
                } catch (e) {
                    console.error('è§£æå•†å“è¦æ ¼å¤±æ•—:', e);
                }
            }
            
            // å¦‚æœæœ‰è¦æ ¼ï¼Œå‰µå»ºå¤šå€‹å•†å“é …ç›®
            if (variants.length > 0) {
                return variants.map(variant => ({
                    id: `${supabaseProduct.id}-${variant.name}`,
                    name: supabaseProduct.name,
                    variant: variant.name,
                    price: parseFloat(variant.price) || parseFloat(supabaseProduct.price) || 0,
                    stock: parseInt(variant.stock) || 0,
                    image: supabaseProduct.image_url || supabaseProduct.image || 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=200&h=200&fit=crop&crop=center',
                    description: supabaseProduct.description || '',
                    barcode: variant.barcode || supabaseProduct.barcode || '',
                    originalProductId: supabaseProduct.id
                }));
            } else {
                // æ²’æœ‰è¦æ ¼ï¼Œè¿”å›å–®ä¸€å•†å“
                return [{
                    id: supabaseProduct.id.toString(),
                    name: supabaseProduct.name || 'æœªçŸ¥å•†å“',
                    variant: supabaseProduct.variant || 'æ¨™æº–è¦æ ¼',
                    price: parseFloat(supabaseProduct.price) || 0,
                    stock: parseInt(supabaseProduct.stock) || 0,
                    image: supabaseProduct.image_url || supabaseProduct.image || 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=200&h=200&fit=crop&crop=center',
                    description: supabaseProduct.description || '',
                    barcode: supabaseProduct.barcode || '',
                    originalProductId: supabaseProduct.id
                }];
            }
        }


        // æŸ¥è©¢ä¸¦æ·»åŠ å•†å“åˆ°è³¼ç‰©è»Šï¼ˆæ”¯æ´å¤šå•†å“å°é …é¸æ“‡ï¼‰

        async function searchAndAddProduct(barcode) {
            console.log('æŸ¥è©¢å•†å“æ¢ç¢¼:', barcode);
            
            

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            const barcodeInput = document.getElementById('salesBarcodeInput');
            const originalPlaceholder = barcodeInput.placeholder;
            barcodeInput.placeholder = 'æ­£åœ¨æŸ¥è©¢å•†å“è³‡æ–™...';
            barcodeInput.disabled = true;
            
            try {
                // é¦–å…ˆå˜—è©¦å¾ Supabase æŸ¥è©¢
                const supabaseProducts = await searchProductFromSupabase(barcode);
            
            if (supabaseProducts && supabaseProducts.length > 0) {
                // å°‡ Supabase è³‡æ–™è½‰æ›ç‚ºæœ¬åœ°æ ¼å¼ï¼ˆå¯èƒ½åŒ…å«å¤šå€‹è¦æ ¼ï¼‰
                const allProducts = [];
                supabaseProducts.forEach(supabaseProduct => {
                    const convertedProducts = convertSupabaseProductToLocal(supabaseProduct);
                    allProducts.push(...convertedProducts);
                });
                
                // éæ¿¾å‡ºç¬¦åˆæ¢ç¢¼çš„å•†å“
                const products = allProducts.filter(product => 
                    product.barcode === barcode || 
                    product.barcode === `${barcode}-${product.variant}`
                );
                
                if (products.length === 1) {

                    // åªæœ‰ä¸€å€‹å•†å“ï¼Œç›´æ¥æ·»åŠ 

                    const product = products[0];

                    if (product.stock > 0) {

                        const addResult = addToCart(product, barcode);
                        
                        if (addResult) {
                            // æ·»åŠ æˆåŠŸï¼ŒéŸ³æ•ˆå·²åœ¨ addToCart ä¸­æ’­æ”¾
                    } else {
                            // æ·»åŠ å¤±æ•—ï¼ˆåº«å­˜ä¸è¶³ï¼‰ï¼Œæ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
                            playSound('error');
                        }

                    } else {

                        playSound('error'); // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ

                        setTimeout(() => {
                        alert(`${product.name} - ${product.variant} åº«å­˜ä¸è¶³ï¼Œç„¡æ³•éŠ·å”®`);
                        }, 300);

                    }

                } else {

                    // å¤šå€‹å•†å“ï¼Œå½ˆå‡ºé¸æ“‡è¦–çª—

                    playSound('select'); // æ’­æ”¾é¸æ“‡éŸ³æ•ˆï¼ˆéœ€è¦é¸æ“‡å•†å“ï¼‰

                    showProductSelectionModal(products, barcode);

                }

                return;
            }
            
            // å¦‚æœ Supabase æ²’æœ‰æ‰¾åˆ°ï¼Œå˜—è©¦å¾æœ¬åœ° mockProducts æŸ¥è©¢
            const localProducts = mockProducts[barcode];
            
            if (localProducts && localProducts.length > 0) {
                if (localProducts.length === 1) {
                    // åªæœ‰ä¸€å€‹å•†å“ï¼Œç›´æ¥æ·»åŠ 
                    const product = localProducts[0];
                    if (product.stock > 0) {
                        const addResult = addToCart(product, barcode);
                        
                        if (addResult) {
                            // æ·»åŠ æˆåŠŸï¼ŒéŸ³æ•ˆå·²åœ¨ addToCart ä¸­æ’­æ”¾
            } else {
                            // æ·»åŠ å¤±æ•—ï¼ˆåº«å­˜ä¸è¶³ï¼‰ï¼Œæ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
                            playSound('error');
                        }
            } else {
                        playSound('error'); // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
                        setTimeout(() => {
                            alert(`${product.name} - ${product.variant} åº«å­˜ä¸è¶³ï¼Œç„¡æ³•éŠ·å”®`);
                        }, 300);
                    }
                } else {
                    // å¤šå€‹å•†å“ï¼Œå½ˆå‡ºé¸æ“‡è¦–çª—
                    playSound('select'); // æ’­æ”¾é¸æ“‡éŸ³æ•ˆï¼ˆéœ€è¦é¸æ“‡å•†å“ï¼‰
                    showProductSelectionModal(localProducts, barcode);
                }
            } else {

                playSound('error'); // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ

                setTimeout(() => {
                alert(`æ¢ç¢¼ ${barcode} æ‰¾ä¸åˆ°å°æ‡‰å•†å“`);
                }, 300);

            }

            } catch (error) {
                console.error('æŸ¥è©¢å•†å“æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                playSound('error'); // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
                setTimeout(() => {
                    alert('æŸ¥è©¢å•†å“æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
                }, 300);
            } finally {
                // æ¢å¾©è¼¸å…¥æ¡†ç‹€æ…‹
                barcodeInput.placeholder = originalPlaceholder;
                barcodeInput.disabled = false;
                barcodeInput.focus();
            }
        }



        // é¡¯ç¤ºå•†å“é¸æ“‡å½ˆå‡ºè¦–çª—

        function showProductSelectionModal(products, barcode) {

            // å„²å­˜ç•¶å‰å•†å“è³‡æ–™åˆ°å…¨åŸŸè®Šæ•¸
            currentProductData[barcode] = products;
            
            document.getElementById('modalBarcode').textContent = barcode;

            const variantsList = document.getElementById('productVariantsList');

            
            
            variantsList.innerHTML = products.map((product, index) => {

                const stockStatus = product.stock > 0 ? 

                    (product.stock <= 5 ? `ä½åº«å­˜ ${product.stock} ä»¶` : `åº«å­˜ ${product.stock} ä»¶`) : 

                    'ç¼ºè²¨';

                const stockClass = product.stock > 0 ? 

                    (product.stock <= 5 ? 'text-orange-600' : 'text-green-600') : 

                    'text-red-600';
                
                
                
                const isAvailable = product.stock > 0;

                const buttonClass = isAvailable ? 

                    'bg-[#17225e] hover:bg-[#1a2a6e] text-white' : 

                    'bg-gray-300 text-gray-500 cursor-not-allowed';
                
                
                
                return `

                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors ${!isAvailable ? 'opacity-60' : ''}">

                        <div class="flex items-center space-x-4">

                            <img src="${product.image || 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=200&h=200&fit=crop&crop=center'}" alt="${product.name}" class="w-16 h-16 rounded-lg object-cover">

                            <div class="flex-1">

                                <h4 class="font-semibold text-gray-800">${product.name}</h4>

                                <p class="text-sm text-gray-600 mt-1">è¦æ ¼ï¼š${product.variant}</p>

                                <p class="text-xs text-gray-500 mt-1">${product.description}</p>

                                <div class="flex items-center justify-between mt-2">

                                    <span class="text-lg font-bold text-[#17225e]">NT$${product.price.toLocaleString()}</span>

                                    <span class="text-sm ${stockClass}">${stockStatus}</span>

                                </div>

                            </div>

                            <button onclick="selectProductVariant('${product.id}', '${barcode}')" 

                                    class="px-4 py-2 rounded-lg text-sm font-medium transition-colors ${buttonClass}"

                                    ${!isAvailable ? 'disabled' : ''}>

                                ${isAvailable ? 'é¸æ“‡æ­¤é …' : 'ç¼ºè²¨'}

                            </button>

                        </div>

                    </div>

                `;

            }).join('');

            
            
            document.getElementById('productSelectionModal').classList.remove('hidden');

        }



        // é—œé–‰å•†å“é¸æ“‡å½ˆå‡ºè¦–çª—

        function closeProductSelectionModal() {

            document.getElementById('productSelectionModal').classList.add('hidden');

        }



        // ==================== æ–°æŠ˜æ‰£ç®¡ç†ç³»çµ± ====================
        
        // é¡¯ç¤ºæ–°å¢æŠ˜æ‰£å½ˆçª—
        function showAddDiscountModal() {
            // é‡ç½®è¡¨å–®
            document.getElementById('discountName').value = '';
            document.getElementById('newDiscountType').value = 'percentage';
            document.getElementById('newDiscountValue').value = '';
            document.querySelector('input[name="discountScope"][value="all"]').checked = true;
            updateDiscountUnit();
            
            // éš±è—å•†å“é¸æ“‡å€åŸŸ
            document.getElementById('itemSelectionArea').classList.add('hidden');
            
            // é¡¯ç¤ºå½ˆçª—
            document.getElementById('addDiscountModal').classList.remove('hidden');
            
            // æ·»åŠ äº‹ä»¶ç›£è½å™¨
            document.getElementById('newDiscountType').addEventListener('change', updateDiscountUnit);
        }
        
        // é—œé–‰æ–°å¢æŠ˜æ‰£å½ˆçª—
        function closeAddDiscountModal() {
            document.getElementById('addDiscountModal').classList.add('hidden');
        }
        
        // æ›´æ–°æŠ˜æ‰£å–®ä½é¡¯ç¤º
        function updateDiscountUnit() {
            const type = document.getElementById('newDiscountType').value;
            const unit = document.getElementById('newDiscountUnit');
            unit.textContent = type === 'percentage' ? '%' : 'å…ƒ';
        }
        
        // åˆ‡æ›å•†å“é¸æ“‡å€åŸŸé¡¯ç¤º
        function toggleItemSelection() {
            const scope = document.querySelector('input[name="discountScope"]:checked').value;
            const itemSelectionArea = document.getElementById('itemSelectionArea');
            
            if (scope === 'selected') {
                itemSelectionArea.classList.remove('hidden');
                loadCartItemsForSelection();
            } else {
                itemSelectionArea.classList.add('hidden');
            }
        }
        
        // è¼‰å…¥è³¼ç‰©è»Šå•†å“åˆ°é¸æ“‡å€åŸŸ
        function loadCartItemsForSelection() {
            const container = document.getElementById('cartItemsForNewDiscount');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (cart.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">è³¼ç‰©è»Šä¸­æ²’æœ‰å•†å“</p>';
                return;
            }
            
            cart.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center space-x-3 p-2 border border-gray-200 rounded-lg hover:bg-gray-50';
                itemDiv.innerHTML = `
                    <input type="checkbox" id="new-item-${index}" class="new-item-checkbox w-4 h-4 text-blue-500 border-gray-300 rounded focus:ring-blue-500">
                    <img src="${item.image}" alt="${item.name}" class="w-10 h-10 rounded object-cover">
                        <div class="flex-1">
                        <h5 class="font-medium text-gray-800 text-sm">${item.name}</h5>
                        <p class="text-xs text-gray-600">è¦æ ¼ï¼š${item.variant}</p>
                        <p class="text-xs text-gray-500">æ•¸é‡ï¼š${item.quantity}</p>
                        </div>
                        <div class="text-right">
                        <p class="text-xs text-gray-600">NT$${item.price.toLocaleString()}</p>
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }
        
        // æ–°å¢æŠ˜æ‰£
        function addDiscount() {
            const name = document.getElementById('discountName').value.trim();
            const type = document.getElementById('newDiscountType').value;
            const value = parseFloat(document.getElementById('newDiscountValue').value) || 0;
            const scope = document.querySelector('input[name="discountScope"]:checked').value;
            
            // é©—è­‰è¼¸å…¥
            if (!name) {
                alert('è«‹è¼¸å…¥æŠ˜æ‰£åç¨±');
                return;
            }
            
            if (!value || value <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æŠ˜æ‰£å€¼');
                return;
            }
            
            if (type === 'percentage' && value >= 100) {
                alert('ç™¾åˆ†æ¯”æŠ˜æ‰£ä¸èƒ½è¶…é100%');
                return;
            }
            
            // è™•ç†æŒ‡å®šå“é …æŠ˜æ‰£
            let appliedItems = [];
            if (scope === 'selected') {
            // ç²å–é¸ä¸­çš„å•†å“
            const selectedItems = [];
                document.querySelectorAll('.new-item-checkbox:checked').forEach((checkbox) => {
                    const itemIndex = parseInt(checkbox.id.split('-')[2]);
                if (cart[itemIndex]) {
                        selectedItems.push(itemIndex);
                }
            });
            
            if (selectedItems.length === 0) {
                    alert('è«‹é¸æ“‡è¦å¥—ç”¨æŠ˜æ‰£çš„å•†å“');
                return;
            }
            
                appliedItems = selectedItems;
            }
            
            // å‰µå»ºæŠ˜æ‰£ç‰©ä»¶
            const discount = new Discount(name, type, value, scope, appliedItems);
            appliedDiscounts.push(discount);
            
            // æ›´æ–°é¡¯ç¤º
            updateDiscountDisplay();
            updateCartDisplay();
            closeAddDiscountModal();
            
            console.log('æ–°å¢æŠ˜æ‰£:', discount);
        }
        
        // é¡¯ç¤ºå•†å“é¸æ“‡å½ˆçª—ï¼ˆç”¨æ–¼æŒ‡å®šå“é …æŠ˜æ‰£ï¼‰
        function showItemSelectionForDiscount(discountName, discountType, discountValue) {
            // é—œé–‰æ–°å¢æŠ˜æ‰£å½ˆçª—
            closeAddDiscountModal();
            
            // å‰µå»ºè‡¨æ™‚è®Šæ•¸å­˜å„²æŠ˜æ‰£è³‡è¨Š
            window.tempDiscountInfo = { discountName, discountType, discountValue };
            
            // é¡¯ç¤ºå•†å“é¸æ“‡å½ˆçª—
            const modal = document.getElementById('itemDiscountModal');
            const itemsContainer = document.getElementById('cartItemsForDiscount');
            
            // æ¸…ç©ºå®¹å™¨
            itemsContainer.innerHTML = '';
            
            // æ·»åŠ è³¼ç‰©è»Šå•†å“
            cart.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors';
                itemDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" id="item-${index}" class="item-checkbox w-4 h-4 text-[#17225e] border-gray-300 rounded focus:ring-[#17225e]">
                        <img src="${item.image}" alt="${item.name}" class="w-12 h-12 rounded-lg object-cover">
                        <div class="flex-1">
                            <h5 class="font-semibold text-gray-800">${item.name}</h5>
                            <p class="text-sm text-gray-600">è¦æ ¼ï¼š${item.variant}</p>
                            <p class="text-sm text-gray-500">æ•¸é‡ï¼š${item.quantity}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">åŸåƒ¹ï¼šNT$${item.originalPrice ? item.originalPrice.toLocaleString() : item.price.toLocaleString()}</p>
                            <p class="font-bold text-[#17225e]">ç¾åƒ¹ï¼šNT$${item.price.toLocaleString()}</p>
                        </div>
                        </div>
                    `;
                itemsContainer.appendChild(itemDiv);
            });
            
            // æ›´æ–°å½ˆçª—æ¨™é¡Œ
            modal.querySelector('h3').textContent = `é¸æ“‡å•†å“ - ${discountName}`;
            
            // é¡¯ç¤ºå½ˆçª—
            modal.classList.remove('hidden');
        }
        
        // å¥—ç”¨æŒ‡å®šå“é …æŠ˜æ‰£
        function applySelectedItemDiscount() {
            if (!window.tempDiscountInfo) {
                alert('æŠ˜æ‰£è³‡è¨Šéºå¤±ï¼Œè«‹é‡æ–°æ“ä½œ');
                return;
            }
            
            const { discountName, discountType, discountValue } = window.tempDiscountInfo;
            
            // ç²å–é¸ä¸­çš„å•†å“
            const selectedItems = [];
            document.querySelectorAll('.item-checkbox:checked').forEach((checkbox) => {
                const itemIndex = parseInt(checkbox.id.split('-')[1]);
                if (cart[itemIndex]) {
                    selectedItems.push(itemIndex);
                }
            });
            
            if (selectedItems.length === 0) {
                alert('è«‹é¸æ“‡è¦å¥—ç”¨æŠ˜æ‰£çš„å•†å“');
                return;
            }
            
            // å‰µå»ºæŠ˜æ‰£ç‰©ä»¶
            const discount = new Discount(discountName, discountType, discountValue, 'selected', selectedItems);
            appliedDiscounts.push(discount);
            
            // æ›´æ–°é¡¯ç¤º
            updateDiscountDisplay();
            updateCartDisplay();
            closeItemDiscountModal();
            
            // æ¸…é™¤è‡¨æ™‚è®Šæ•¸
            window.tempDiscountInfo = null;
            
            console.log('æ–°å¢æŒ‡å®šå“é …æŠ˜æ‰£:', discount);
        }
        
        // ç§»é™¤æŠ˜æ‰£
        function removeDiscount(discountId) {
            if (confirm('ç¢ºå®šè¦ç§»é™¤é€™å€‹æŠ˜æ‰£å—ï¼Ÿ')) {
                appliedDiscounts = appliedDiscounts.filter(d => d.id !== discountId);
                updateDiscountDisplay();
                updateCartDisplay();
                console.log('ç§»é™¤æŠ˜æ‰£:', discountId);
            }
        }
        
        // æ›´æ–°æŠ˜æ‰£é¡¯ç¤º
        function updateDiscountDisplay() {
            const container = document.getElementById('appliedDiscounts');
            if (!container) return;
            
            if (appliedDiscounts.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-xs">ç›®å‰æ²’æœ‰å¥—ç”¨ä»»ä½•æŠ˜æ‰£</p>';
                return;
            }
            
            let html = '';
            appliedDiscounts.forEach(discount => {
                const discountText = discount.type === 'percentage' 
                    ? `${discount.value}%` 
                    : `NT$${discount.value.toLocaleString()}`;
                
                const scopeText = discount.scope === 'all' ? 'æ•´ç­†' : 'æŒ‡å®šå“é …';
                const scopeIcon = discount.scope === 'all' ? 'fas fa-shopping-cart' : 'fas fa-list';
                
                html += `
                    <div class="flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="flex items-center space-x-2">
                            <i class="${scopeIcon} text-blue-600 text-xs"></i>
                            <div>
                                <div class="font-medium text-blue-800 text-sm">${discount.name}</div>
                                <div class="text-xs text-blue-600">${scopeText} - ${discountText}</div>
                            </div>
                        </div>
                        <button onclick="removeDiscount('${discount.id}')" 
                                class="text-red-500 hover:text-red-700 text-sm">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // è¨ˆç®—ç¸½æŠ˜æ‰£é‡‘é¡
        function calculateTotalDiscounts() {
            let totalDiscount = 0;
            
            appliedDiscounts.forEach(discount => {
                if (discount.scope === 'all') {
                    // æ•´ç­†æŠ˜æ‰£ - åŸºæ–¼åŸå§‹åƒ¹æ ¼è¨ˆç®—
                    const originalSubtotal = cart.reduce((sum, item) => sum + (item.originalPrice || item.price) * item.quantity, 0);
                    if (discount.type === 'percentage') {
                        totalDiscount += originalSubtotal * (discount.value / 100);
                    } else {
                        totalDiscount += Math.min(discount.value, originalSubtotal);
                    }
                } else {
                    // æŒ‡å®šå“é …æŠ˜æ‰£ - åŸºæ–¼åŸå§‹åƒ¹æ ¼è¨ˆç®—
                    discount.appliedItems.forEach(itemIndex => {
                        const item = cart[itemIndex];
                        if (item) {
                            const itemOriginalTotal = (item.originalPrice || item.price) * item.quantity;
                            if (discount.type === 'percentage') {
                                totalDiscount += itemOriginalTotal * (discount.value / 100);
                            } else {
                                totalDiscount += Math.min(discount.value, itemOriginalTotal);
                            }
                        }
                    });
                }
            });
            
            return Math.floor(totalDiscount);
        }

        // å…¨åŸŸè®Šæ•¸ï¼šå„²å­˜ç•¶å‰æŸ¥è©¢çš„å•†å“è³‡æ–™
        let currentProductData = {};


        // é¸æ“‡å•†å“å°é …

        async function selectProductVariant(productId, barcode) {
            // ä½¿ç”¨å„²å­˜çš„å…¨åŸŸè®Šæ•¸ä¸­çš„å•†å“è³‡æ–™
            let products = currentProductData[barcode] || [];
            
            // å¦‚æœå…¨åŸŸè®Šæ•¸ä¸­æ²’æœ‰è³‡æ–™ï¼Œå˜—è©¦é‡æ–°æŸ¥è©¢
            if (products.length === 0) {
                const supabaseProducts = await searchProductFromSupabase(barcode);
                if (supabaseProducts && supabaseProducts.length > 0) {
                    products = supabaseProducts.map(convertSupabaseProductToLocal);
                } else {
                    products = mockProducts[barcode] || [];
                }
            }
            
            const selectedProduct = products.find(p => p.id === productId);

            
            
            if (selectedProduct && selectedProduct.stock > 0) {

                const addResult = addToCart(selectedProduct, barcode);
                
                if (addResult) {
                closeProductSelectionModal();
                    // éŸ³æ•ˆå·²åœ¨ addToCart ä¸­æ’­æ”¾
            } else {
                    // æ·»åŠ å¤±æ•—ï¼ˆåº«å­˜ä¸è¶³ï¼‰ï¼Œæ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
                    playSound('error');
                }

            } else {

                playSound('error'); // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ

                setTimeout(() => {
                alert('å•†å“åº«å­˜ä¸è¶³æˆ–ä¸å­˜åœ¨');
                }, 300);

            }

        }



        // æ·»åŠ å•†å“åˆ°è³¼ç‰©è»Šï¼ˆæ›´æ–°æ”¯æ´å•†å“å°é …ï¼‰

        function addToCart(product, barcode) {

            const existingItem = cart.find(item => item.id === product.id);

            
            
            if (existingItem) {

                if (existingItem.quantity < product.stock) {

                    existingItem.quantity++;

                    existingItem.total = existingItem.quantity * existingItem.price;

                    playSound('success'); // æ’­æ”¾æˆåŠŸéŸ³æ•ˆï¼ˆå¢åŠ æ•¸é‡ï¼‰

                } else {

                    // åº«å­˜ä¸è¶³ï¼Œä¸æ’­æ”¾éŸ³æ•ˆï¼ˆç”±èª¿ç”¨æ–¹è™•ç†ï¼‰

                    setTimeout(() => {
                    alert(`${product.name} - ${product.variant} åº«å­˜ä¸è¶³ï¼Œç„¡æ³•å†æ·»åŠ `);
                    }, 300);

                    return false; // è¿”å› false è¡¨ç¤ºæ·»åŠ å¤±æ•—

                }

            } else {

                cart.push({

                    ...product,

                    barcode: barcode,

                    quantity: 1,

                    originalPrice: product.price,

                    total: product.price * 1

                });

                playSound('success'); // æ’­æ”¾æˆåŠŸéŸ³æ•ˆï¼ˆæ–°å¢å•†å“ï¼‰

            }

            

            updateCartDisplay();

            updateCartItemCount();
            return true; // è¿”å› true è¡¨ç¤ºæ·»åŠ æˆåŠŸ
        }




        // æ›´æ”¹å•†å“æ•¸é‡

        function changeQuantity(index, delta) {

            const item = cart[index];

            const newQuantity = item.quantity + delta;

            
            
            if (newQuantity <= 0) {

                removeFromCart(index);

            } else if (newQuantity <= item.stock) {

                item.quantity = newQuantity;

                item.total = item.quantity * item.price;

                updateCartDisplay();

                updateCartItemCount();
            } else {

                alert(`${item.name} åº«å­˜ä¸è¶³ï¼Œæœ€å¤šåªèƒ½è³¼è²· ${item.stock} ä»¶`);

            }

        }



        // å¾è³¼ç‰©è»Šç§»é™¤å•†å“

        function removeFromCart(index) {

            cart.splice(index, 1);

            updateCartDisplay();

            updateCartItemCount();
        }



        // æ›´æ–°ç¸½è¨ˆ

        function updateTotals() {

            const subtotal = cart.reduce((sum, item) => sum + item.total, 0);
            
            
            
            // è¨ˆç®—å„ªæƒ åˆ¸æŠ˜æ‰£

            let couponDiscount = 0;

            if (currentCoupon) {

                couponDiscount = calculateCouponDiscount(currentCoupon, subtotal);
            }
            
            // è¨ˆç®—æ–°æŠ˜æ‰£ç³»çµ±çš„æŠ˜æ‰£
            let newDiscountAmount = 0;
            if (appliedDiscounts.length > 0) {
                newDiscountAmount = calculateTotalDiscounts();
            }

            
            
            // å•†å“å”®åƒ¹å·²åŒ…å«5%ç‡Ÿæ¥­ç¨…ï¼Œç„¡éœ€é¡å¤–è¨ˆç®—
            // è¨ˆç®—ç¸½æŠ˜æ‰£é‡‘é¡ï¼Œç¢ºä¿ä¸è¶…éå°è¨ˆ
            const totalDiscountAmount = couponDiscount + newDiscountAmount;
            const finalTotal = Math.max(0, subtotal - totalDiscountAmount);


            // æ›´æ–°é¡¯ç¤º

            const totalAmountElements = document.querySelectorAll('#totalAmount');

            totalAmountElements.forEach(element => {

                element.textContent = `NT$${finalTotal.toLocaleString()}`;

            });

            
            
            // æ›´æ–°å„é …é‡‘é¡é¡¯ç¤º

            const subtotalEl = document.getElementById('subtotalAmount');

            const couponDiscountEl = document.getElementById('couponDiscountAmount');

            const couponDiscountRow = document.getElementById('couponDiscountRow');

            
            
            if (subtotalEl) subtotalEl.textContent = `NT$${subtotal.toLocaleString()}`;
            
            
            
            // å„ªæƒ åˆ¸æŠ˜æ‰£é¡¯ç¤º

            if (couponDiscountEl && couponDiscountRow) {

                if (currentCoupon && couponDiscount > 0) {

                    couponDiscountEl.textContent = `-NT$${couponDiscount.toLocaleString()}`;

                    couponDiscountRow.style.display = 'flex';

                } else {

                    couponDiscountRow.style.display = 'none';

                }

            }
            
            // æ–°æŠ˜æ‰£ç³»çµ±é¡¯ç¤º
            const newDiscountEl = document.getElementById('newDiscountAmount');
            const newDiscountRow = document.getElementById('newDiscountRow');
            
            if (newDiscountEl && newDiscountRow) {
                if (appliedDiscounts.length > 0 && newDiscountAmount > 0) {
                    newDiscountEl.textContent = `-NT$${newDiscountAmount.toLocaleString()}`;
                    newDiscountRow.style.display = 'flex';
                } else {
                    newDiscountRow.style.display = 'none';
                }
            }
            
            

            return { subtotal, memberDiscount: 0, couponDiscount, newDiscountAmount, tax: 0, total: finalTotal };
        }



        // å„ªæƒ åˆ¸ç›¸é—œåŠŸèƒ½

        
        
        // è¼‰å…¥å„ªæƒ åˆ¸ç®¡ç†åŠŸèƒ½

        function loadCouponFunctions() {

            // å¾localStorageç²å–å„ªæƒ åˆ¸è³‡æ–™

            function getCouponsData() {

                const savedCoupons = localStorage.getItem('couponsData');

                return savedCoupons ? JSON.parse(savedCoupons) : [];

            }

            
            
            // é©—è­‰å„ªæƒ åˆ¸

            window.validateCoupon = function(code, orderAmount, memberLevel, categories) {

                const couponsData = getCouponsData();

                const coupon = couponsData.find(c => c.code.toUpperCase() === code.toUpperCase());

                
                
                if (!coupon) {

                    return { valid: false, message: 'å„ªæƒ åˆ¸ä¸å­˜åœ¨' };

                }



                if (coupon.status !== 'active') {

                    return { valid: false, message: 'å„ªæƒ åˆ¸å·²åœç”¨' };

                }



                const now = new Date();

                const startDate = new Date(coupon.startDate);

                const endDate = new Date(coupon.endDate);



                if (now < startDate) {

                    return { valid: false, message: 'å„ªæƒ åˆ¸å°šæœªç”Ÿæ•ˆ' };

                }



                if (now > endDate) {

                    return { valid: false, message: 'å„ªæƒ åˆ¸å·²éæœŸ' };

                }



                if (coupon.usedCount >= coupon.usageLimit) {

                    return { valid: false, message: 'å„ªæƒ åˆ¸ä½¿ç”¨æ¬¡æ•¸å·²é”ä¸Šé™' };

                }



                if (orderAmount < coupon.minAmount) {

                    return { valid: false, message: `æœ€ä½æ¶ˆè²»é‡‘é¡ç‚º NT$${coupon.minAmount}` };

                }



                if (coupon.type === 'member_only' && !memberLevel) {

                    return { valid: false, message: 'æ­¤å„ªæƒ åˆ¸åƒ…é™æœƒå“¡ä½¿ç”¨' };

                }



                // æª¢æŸ¥é©ç”¨åˆ†é¡

                if (!coupon.categories.includes('all')) {

                    const hasValidCategory = categories.some(cat => coupon.categories.includes(cat));

                    if (!hasValidCategory) {

                        return { valid: false, message: 'å„ªæƒ åˆ¸ä¸é©ç”¨æ–¼è³¼ç‰©è»Šä¸­çš„å•†å“' };

                    }

                }



                return { valid: true, coupon: coupon };

            };

            
            
            window.useCoupon = function(code) {

                const couponsData = getCouponsData();

                const coupon = couponsData.find(c => c.code.toUpperCase() === code.toUpperCase());

                if (coupon) {

                    coupon.usedCount++;

                    localStorage.setItem('couponsData', JSON.stringify(couponsData));

                }

            };

            
            
            window.getCouponsData = getCouponsData;

        }



        // è¨ˆç®—å„ªæƒ åˆ¸æŠ˜æ‰£

        function calculateCouponDiscount(coupon, amount) {

            switch (coupon.type) {

                case 'percentage':

                    return Math.floor(amount * (coupon.discountValue / 100));

                case 'fixed':

                    return Math.min(coupon.discountValue, amount);

                case 'buy_x_get_y':

                    // è²·Xé€Yçš„é‚è¼¯éœ€è¦æ ¹æ“šè³¼ç‰©è»Šå•†å“è¨ˆç®—

                    return calculateBuyXGetYDiscount(coupon);

                case 'member_only':

                    if (currentMember) {

                        return Math.floor(amount * (coupon.discountValue / 100));

                    }

                    return 0;

                default:

                    return 0;

            }

        }



        // è¨ˆç®—è²·Xé€Yçš„æŠ˜æ‰£

        function calculateBuyXGetYDiscount(coupon) {

            // ç°¡åŒ–å¯¦ç¾ï¼šå¦‚æœæœ‰ç¬¦åˆåˆ†é¡çš„å•†å“ä¸”æ•¸é‡â‰¥3ï¼Œå‰‡çµ¦äºˆæœ€ä¾¿å®œå•†å“çš„åƒ¹æ ¼ä½œç‚ºæŠ˜æ‰£

            const eligibleItems = cart.filter(item => 

                coupon.categories.includes('all') || 

                coupon.categories.some(cat => item.category === cat)

            );

            
            
            if (eligibleItems.length >= 3) {

                const cheapestItem = eligibleItems.reduce((min, item) => 

                    item.price < min.price ? item : min

                );

                return cheapestItem.price;

            }

            return 0;

        }



        // å¥—ç”¨å„ªæƒ åˆ¸

        function applyCoupon() {

            const couponCode = document.getElementById('couponInput').value.trim();

            if (!couponCode) {

                alert('è«‹è¼¸å…¥å„ªæƒ åˆ¸ä»£ç¢¼');

                return;

            }



            if (!window.validateCoupon) {

                alert('å„ªæƒ åˆ¸åŠŸèƒ½è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');

                return;

            }



            const subtotal = cart.reduce((sum, item) => sum + item.total, 0);

            const orderAmount = subtotal;
            
            
            // ç²å–è³¼ç‰©è»Šå•†å“åˆ†é¡

            const categories = [...new Set(cart.map(item => item.category))];

            
            
            const result = window.validateCoupon(

                couponCode, 

                orderAmount, 

                currentMember?.level, 

                categories

            );



            if (result.valid) {

                currentCoupon = result.coupon;

                showAppliedCoupon();

                updateTotals();

                alert(`å„ªæƒ åˆ¸å¥—ç”¨æˆåŠŸï¼${getDiscountText(currentCoupon)}`);

            } else {

                alert(`å„ªæƒ åˆ¸å¥—ç”¨å¤±æ•—ï¼š${result.message}`);

            }

        }



        // ç§»é™¤å„ªæƒ åˆ¸

        function removeCoupon() {

            currentCoupon = null;

            hideAppliedCoupon();

            updateTotals();

            document.getElementById('couponInput').value = '';

        }



        // é¡¯ç¤ºå·²å¥—ç”¨çš„å„ªæƒ åˆ¸

        function showAppliedCoupon() {

            const appliedCouponDiv = document.getElementById('appliedCoupon');

            if (appliedCouponDiv && currentCoupon) {

                document.getElementById('appliedCouponName').textContent = currentCoupon.name;

                document.getElementById('appliedCouponDesc').textContent = getDiscountText(currentCoupon);

                appliedCouponDiv.classList.remove('hidden');

                document.getElementById('couponInput').value = currentCoupon.code;

            }

        }



        // éš±è—å·²å¥—ç”¨çš„å„ªæƒ åˆ¸

        function hideAppliedCoupon() {

            const appliedCouponDiv = document.getElementById('appliedCoupon');

            if (appliedCouponDiv) {

                appliedCouponDiv.classList.add('hidden');

            }

        }



        // æƒæå„ªæƒ åˆ¸

        function scanCoupon() {

            if (typeof window.quickScan === 'function') {

                window.quickScan(

                    function(barcode) {

                        document.getElementById('couponInput').value = barcode;

                        applyCoupon();

                    },

                    function(error) {

                        alert('æƒæå¤±æ•—: ' + error.message);

                    }

                );

            } else {

                alert('æƒæåŠŸèƒ½å°šæœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢');

            }

        }



        // ç²å–å„ªæƒ åˆ¸æè¿°æ–‡å­—

        function getDiscountText(coupon) {

            switch (coupon.type) {

                case 'percentage':

                    return `${coupon.discountValue}% æŠ˜æ‰£`;

                case 'fixed':

                    return `NT$${coupon.discountValue} æŠ˜æ‰£`;

                case 'buy_x_get_y':

                    return 'è²·3é€1å„ªæƒ ';

                case 'member_only':

                    return `æœƒå“¡å°ˆå±¬ ${coupon.discountValue}% æŠ˜æ‰£`;

                default:

                    return 'ç‰¹æ®Šå„ªæƒ ';

            }

        }






        // å¿«é€ŸåŠŸèƒ½å¯¦ç¾













            const choice = prompt(optionsText + 'è«‹è¼¸å…¥æ•¸å­— (1-5):');



            if (selectedIndex >= 0 && selectedIndex < discountOptions.length) {

                const discount = discountOptions[selectedIndex];
                
                

                if (discount.type === 'all') {
                // å°æ‰€æœ‰å•†å“æ‡‰ç”¨æŠ˜æ‰£

                cart.forEach(item => {

                    // ç¢ºä¿æœ‰originalPriceå±¬æ€§

                    if (!item.originalPrice) {

                        item.originalPrice = item.price;

                    }

                    
                    
                    item.price = Math.floor(item.originalPrice * discount.value);

                    item.total = item.quantity * item.price;

                });



                updateCartDisplay();

                alert(`å·²æ‡‰ç”¨${discount.name}æŠ˜æ‰£`);

                } else if (discount.type === 'selected') {
                    // é–‹å•Ÿé¸å–å“é …æŠ˜æ‰£è¦–çª—
                    showItemDiscountModal();
            }
        }



        // 2. å„ªæƒ åˆ¸åŠŸèƒ½

        function applyCoupon() {

            const coupons = {

                'SAVE100': { type: 'fixed', value: 100, minAmount: 1000, description: 'æ»¿åƒæŠ˜ç™¾' },

                'SAVE10': { type: 'percent', value: 0.1, minAmount: 500, description: 'æ»¿äº”ç™¾æ‰“ä¹æŠ˜' },

                'MEMBER20': { type: 'percent', value: 0.2, minAmount: 2000, description: 'æœƒå“¡å°ˆäº«å…«æŠ˜' },

                'WELCOME': { type: 'fixed', value: 50, minAmount: 0, description: 'æ–°å®¢æˆ¶å„ªæƒ ' }

            };



            const couponCode = prompt('è«‹è¼¸å…¥å„ªæƒ åˆ¸ä»£ç¢¼ï¼š\n\nå¯ç”¨å„ªæƒ åˆ¸ï¼š\nSAVE100 - æ»¿åƒæŠ˜ç™¾\nSAVE10 - æ»¿äº”ç™¾æ‰“ä¹æŠ˜\nMEMBER20 - æœƒå“¡å°ˆäº«å…«æŠ˜\nWELCOME - æ–°å®¢æˆ¶å„ªæƒ ');



            if (!couponCode) return;



            const coupon = coupons[couponCode.toUpperCase()];

            if (!coupon) {

                alert('ç„¡æ•ˆçš„å„ªæƒ åˆ¸ä»£ç¢¼');

                return;

            }



            const subtotal = cart.reduce((sum, item) => sum + item.total, 0);

            if (subtotal < coupon.minAmount) {

                alert(`æ­¤å„ªæƒ åˆ¸éœ€è¦æ¶ˆè²»æ»¿ NT$${coupon.minAmount}`);

                return;

            }



            let discountAmount = 0;

            if (coupon.type === 'fixed') {

                discountAmount = coupon.value;

            } else {

                discountAmount = Math.floor(subtotal * coupon.value);

            }



            // æ¨¡æ“¬å„ªæƒ åˆ¸æ‡‰ç”¨ï¼ˆå¯¦éš›éœ€è¦ä¿®æ”¹çµå¸³é‚è¼¯ï¼‰

            alert(`å„ªæƒ åˆ¸ã€Œ${coupon.description}ã€å·²æ‡‰ç”¨\næŠ˜æ‰£é‡‘é¡ï¼šNT$${discountAmount}`);

        }



        // 3. æœƒå“¡åŠŸèƒ½

        async function manageMember() {
            const action = prompt('æœƒå“¡åŠŸèƒ½ï¼š\n1. æœƒå“¡æŸ¥è©¢\n2. æœƒå“¡ç™»å…¥\n3. æœƒå“¡ç™»å‡º\n4. å¿«é€Ÿæ–°å¢æœƒå“¡\n5. é–‹å•Ÿæœƒå“¡ç®¡ç†\n\nè«‹é¸æ“‡ (1-5):');



            switch(action) {

                case '1': // æœƒå“¡æŸ¥è©¢

                    await searchMember();
                    break;



                case '2': // æœƒå“¡ç™»å…¥

                    await loginMember();
                    break;



                case '3': // æœƒå“¡ç™»å‡º

                    logoutMember();

                    break;



                case '4': // å¿«é€Ÿæ–°å¢æœƒå“¡

                    quickAddMember();

                    break;



                case '5': // é–‹å•Ÿæœƒå“¡ç®¡ç†

                    navigateToPage('members');

                    break;



                default:

                    if (action !== null) {

                        alert('ç„¡æ•ˆé¸æ“‡');

                    }

            }

        }



        // å¿«é€Ÿæ–°å¢æœƒå“¡

        async function quickAddMember() {

            const name = prompt('è«‹è¼¸å…¥æœƒå“¡å§“åï¼š');

            if (!name) return;

            
            
            const phone = prompt('è«‹è¼¸å…¥æœƒå“¡æ‰‹æ©Ÿè™Ÿç¢¼ï¼š');

            if (!phone) return;

            
            
            // æª¢æŸ¥æ‰‹æ©Ÿè™Ÿç¢¼æ˜¯å¦å·²å­˜åœ¨

            if (phoneToMemberMap[phone]) {

                alert('æ­¤æ‰‹æ©Ÿè™Ÿç¢¼å·²è¨»å†Šç‚ºæœƒå“¡ï¼');

                return;

            }

            
            
            const email = prompt('è«‹è¼¸å…¥æœƒå“¡é›»å­éƒµä»¶ï¼ˆå¯é¸ï¼‰ï¼š') || '';
            
            
            
            try {
                // åˆå§‹åŒ– Supabase
                if (!supabase) {
                    const initSuccess = await initSupabase();
                    if (!initSuccess) {
                        alert('Supabase åˆå§‹åŒ–å¤±æ•—ï¼Œç„¡æ³•æ–°å¢æœƒå“¡');
                        return;
                    }
                }

                // æª¢æŸ¥ Supabase ä¸­æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ‰‹æ©Ÿè™Ÿç¢¼
                const { data: existingMembers, error: checkError } = await supabase
                    .from('members')
                    .select('*')
                    .eq('phone', phone);

                if (checkError) {
                    console.error('æª¢æŸ¥é‡è¤‡æœƒå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', checkError);
                    alert('æª¢æŸ¥é‡è¤‡æœƒå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦');
                    return;
                }

                if (existingMembers && existingMembers.length > 0) {
                    alert('æ­¤æ‰‹æ©Ÿè™Ÿç¢¼å·²åœ¨ Supabase ä¸­è¨»å†Šç‚ºæœƒå“¡ï¼');
                    return;
                }

                // æº–å‚™æ–°å¢åˆ° Supabase çš„è³‡æ–™ï¼ˆä¸åŒ…å« idï¼Œè®“ Supabase è‡ªå‹•è™•ç†ï¼‰
                const supabaseMemberData = {
                name: name,
                phone: phone,
                email: email,
                    total_spent: 0,
                    address: '' // å¯é¸æ¬„ä½
                };

                // æ–°å¢åˆ° Supabase
                const { data: newSupabaseMember, error: insertError } = await supabase
                    .from('members')
                    .insert([supabaseMemberData])
                    .select()
                    .single();

                if (insertError) {
                    console.error('æ–°å¢æœƒå“¡åˆ° Supabase å¤±æ•—:', insertError);
                    
                    // è™•ç†é‡è¤‡ä¸»éµéŒ¯èª¤
                    if (insertError.code === '23505') {
                        console.log('å˜—è©¦é‡è©¦æ–°å¢æœƒå“¡...');
                        
                        // é‡è©¦ä¸€æ¬¡ï¼Œä¸æŒ‡å®šä»»ä½• ID ç›¸é—œæ¬„ä½
                        const retryData = {
                            name: name,
                            phone: phone,
                            email: email,
                            total_spent: 0,
                            address: ''
                        };
                        
                        const { data: retryMember, error: retryError } = await supabase
                            .from('members')
                            .insert([retryData])
                            .select()
                            .single();
                            
                        if (retryError) {
                            console.error('é‡è©¦æ–°å¢æœƒå“¡å¤±æ•—:', retryError);
                            alert('æœƒå“¡æ–°å¢å¤±æ•—ï¼šè³‡æ–™åº«ä¸»éµè¡çªï¼Œè«‹è¯ç¹«ç®¡ç†å“¡');
                            return;
                        }
                        
                        // é‡è©¦æˆåŠŸ
                        newSupabaseMember = retryMember;
                    } else {
                        alert(`æ–°å¢æœƒå“¡å¤±æ•—: ${insertError.message}`);
                        return;
                    }
                }

                // ç”Ÿæˆæœ¬åœ°æœƒå“¡ç·¨è™Ÿï¼ˆç”¨æ–¼ç›¸å®¹æ€§ï¼‰
                const memberId = 'M' + Date.now().toString().slice(-8);

                // å‰µå»ºæœ¬åœ°æœƒå“¡ç‰©ä»¶ï¼ˆç”¨æ–¼ç›¸å®¹æ€§ï¼‰
                const newMember = {
                    id: newSupabaseMember.id, // ä½¿ç”¨ Supabase çš„ ID
                    name: newSupabaseMember.name,
                    phone: newSupabaseMember.phone,
                    email: newSupabaseMember.email || '',
                    totalSpent: parseFloat(newSupabaseMember.total_spent) || 0,
                    status: 'active', // é è¨­ç‚ºå•Ÿç”¨ç‹€æ…‹
                    joinDate: newSupabaseMember.created_at || new Date().toISOString(),
                    lastVisit: newSupabaseMember.updated_at || new Date().toISOString()
                };

                // æ›´æ–°æœ¬åœ°è¨˜æ†¶é«”ä¸­çš„æ•¸æ“šï¼ˆç”¨æ–¼ç›¸å®¹æ€§ï¼‰
            membersDatabase[memberId] = newMember;
            phoneToMemberMap[phone] = memberId;
            
                alert(`æœƒå“¡æ–°å¢æˆåŠŸï¼\n\næœƒå“¡ç·¨è™Ÿï¼š${newSupabaseMember.id}\nå§“åï¼š${name}\næ‰‹æ©Ÿï¼š${phone}\n\næ˜¯å¦è¦ç«‹å³ç™»å…¥æ­¤æœƒå“¡ï¼Ÿ`);
            
            const loginNow = confirm('æ˜¯å¦è¦ç«‹å³ç™»å…¥æ­¤æœƒå“¡ï¼Ÿ');

            if (loginNow) {
                currentMember = newMember;
                updateMemberDisplay();
                updateCartDisplay();
                    alert(`${name} å·²ç™»å…¥ï¼`);
                }

            } catch (error) {
                console.error('å¿«é€Ÿæ–°å¢æœƒå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                alert(`æ–°å¢æœƒå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
            }
        }

        // æ¨™æº–åŒ–é›»è©±è™Ÿç¢¼ï¼ˆç§»é™¤æ‰€æœ‰éæ•¸å­—å­—ç¬¦ï¼‰
        function normalizePhoneNumber(phone) {
            if (!phone) return '';
            return phone.replace(/\D/g, ''); // ç§»é™¤æ‰€æœ‰éæ•¸å­—å­—ç¬¦
        }

        // è¨ºæ–·æœƒå“¡æ¶ˆè²»é‡‘é¡å•é¡Œ
        async function diagnoseMemberSpentIssue() {
            try {
                if (!supabase) {
                    const initSuccess = await initSupabase();
                    if (!initSuccess) {
                        alert('Supabase åˆå§‹åŒ–å¤±æ•—');
                        return;
                    }
                }

                console.log('é–‹å§‹è¨ºæ–·æœƒå“¡æ¶ˆè²»é‡‘é¡å•é¡Œ...');

                // 1. æª¢æŸ¥ Supabase ä¸­çš„æœƒå“¡è³‡æ–™
                const { data: members, error } = await supabase
                    .from('members')
                    .select('id, name, phone, total_spent')
                    .order('id');

                if (error) {
                    console.error('æŸ¥è©¢æœƒå“¡è³‡æ–™å¤±æ•—:', error);
                    alert('æŸ¥è©¢æœƒå“¡è³‡æ–™å¤±æ•—: ' + error.message);
                    return;
                }

                console.log('Supabase ä¸­çš„æœƒå“¡è³‡æ–™:', members);

                let report = '=== æœƒå“¡æ¶ˆè²»é‡‘é¡è¨ºæ–·å ±å‘Š ===\n\n';
                
                if (members && members.length > 0) {
                    report += `æ‰¾åˆ° ${members.length} å€‹æœƒå“¡:\n\n`;
                    
                    members.forEach(member => {
                        report += `ID: ${member.id}\n`;
                        report += `å§“å: ${member.name}\n`;
                        report += `é›»è©±: ${member.phone}\n`;
                        report += `æ¶ˆè²»é‡‘é¡(åŸå§‹): ${member.total_spent}\n`;
                        report += `æ¶ˆè²»é‡‘é¡(è½‰æ›): ${parseFloat(member.total_spent) || 0}\n`;
                        report += `è³‡æ–™é¡å‹: ${typeof member.total_spent}\n`;
                        report += '---\n';
                    });
                } else {
                    report += 'æ²’æœ‰æ‰¾åˆ°ä»»ä½•æœƒå“¡è³‡æ–™\n';
                }

                // 2. æª¢æŸ¥éŠ·å”®è¨˜éŒ„ä¸­çš„æœƒå“¡æ¶ˆè²»
                const { data: sales, error: salesError } = await supabase
                    .from('sales_history')
                    .select('member_id, total')
                    .not('member_id', 'is', null)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (!salesError && sales && sales.length > 0) {
                    report += '\n=== æœ€è¿‘10ç­†æœ‰æœƒå“¡çš„éŠ·å”®è¨˜éŒ„ ===\n\n';
                    sales.forEach(sale => {
                        report += `æœƒå“¡ID: ${sale.member_id}, æ¶ˆè²»é‡‘é¡: ${sale.total}\n`;
                    });
                }

                console.log(report);
                alert(report);

            } catch (error) {
                console.error('è¨ºæ–·éç¨‹ç™¼ç”ŸéŒ¯èª¤:', error);
                alert('è¨ºæ–·éç¨‹ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
            }
        }

        // ç‚ºäº†æ–¹ä¾¿æ¸¬è©¦ï¼Œå°‡è¨ºæ–·å‡½æ•¸ç¶å®šåˆ° window ç‰©ä»¶
        window.diagnoseMemberSpentIssue = diagnoseMemberSpentIssue;

        // æ›´æ–°æœƒå“¡æ¶ˆè²»é‡‘é¡åˆ° Supabase
        async function updateMemberSpentInSupabase(memberId, additionalAmount) {
            try {
                if (!supabase) {
                    const initSuccess = await initSupabase();
                    if (!initSuccess) {
                        throw new Error('Supabase åˆå§‹åŒ–å¤±æ•—');
                    }
                }

                console.log('é–‹å§‹æ›´æ–°æœƒå“¡æ¶ˆè²»é‡‘é¡:', memberId, additionalAmount);

                // å…ˆç²å–ç•¶å‰æœƒå“¡çš„æ¶ˆè²»é‡‘é¡
                const { data: memberData, error: fetchError } = await supabase
                    .from('members')
                    .select('total_spent')
                    .eq('id', memberId)
                    .single();

                if (fetchError) {
                    console.error('ç²å–æœƒå“¡è³‡æ–™å¤±æ•—:', fetchError);
                    return false;
                }

                const currentTotal = parseFloat(memberData.total_spent) || 0;
                const newTotal = currentTotal + additionalAmount;

                console.log('ç•¶å‰æ¶ˆè²»é‡‘é¡:', currentTotal, 'æ–°å¢é‡‘é¡:', additionalAmount, 'æ›´æ–°å¾Œç¸½é¡:', newTotal);

                // æ›´æ–°æœƒå“¡çš„æ¶ˆè²»é‡‘é¡
                const { error: updateError } = await supabase
                    .from('members')
                    .update({ 
                        total_spent: newTotal,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', memberId);

                if (updateError) {
                    console.error('æ›´æ–°æœƒå“¡æ¶ˆè²»é‡‘é¡å¤±æ•—:', updateError);
                    return false;
                }

                console.log('æœƒå“¡æ¶ˆè²»é‡‘é¡æ›´æ–°æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('æ›´æ–°æœƒå“¡æ¶ˆè²»é‡‘é¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return false;
            }
        }

        // å¾ Supabase æŸ¥è©¢æœƒå“¡è³‡æ–™
        async function searchMemberFromSupabase(identifier) {
            try {
                if (!supabase) {
                    const initSuccess = await initSupabase();
                    if (!initSuccess) {
                        throw new Error('Supabase åˆå§‹åŒ–å¤±æ•—');
                    }
                }

                console.log('é–‹å§‹æŸ¥è©¢æœƒå“¡:', identifier);

                // æ¨™æº–åŒ–è¼¸å…¥çš„è­˜åˆ¥ç¢¼ï¼ˆå¦‚æœçœ‹èµ·ä¾†åƒé›»è©±è™Ÿç¢¼ï¼‰
                const normalizedInput = normalizePhoneNumber(identifier);
                
                // é¦–å…ˆå˜—è©¦ç”¨æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢ï¼ˆç²¾ç¢ºåŒ¹é…ï¼‰
                let { data: memberData, error: memberError } = await supabase
                    .from('members')
                    .select('id, name, phone, email, total_spent, created_at, updated_at')
                    .eq('phone', identifier);

                console.log('æ‰‹æ©Ÿè™Ÿç¢¼ç²¾ç¢ºæŸ¥è©¢çµæœ:', memberData, memberError);

                // å¦‚æœæ²’æ‰¾åˆ°ä¸”è¼¸å…¥çœ‹èµ·ä¾†åƒé›»è©±è™Ÿç¢¼ï¼Œå˜—è©¦æ¨¡ç³ŠåŒ¹é…é›»è©±è™Ÿç¢¼
                if ((!memberData || memberData.length === 0) && !memberError && normalizedInput.length >= 4) {
                    console.log('å˜—è©¦é›»è©±è™Ÿç¢¼æ¨¡ç³ŠæŸ¥è©¢:', normalizedInput);
                    
                    // ç²å–æ‰€æœ‰æœƒå“¡è³‡æ–™ï¼Œç„¶å¾Œåœ¨å®¢æˆ¶ç«¯é€²è¡Œæ¨¡ç³ŠåŒ¹é…
                    const { data: allMembers, error: allError } = await supabase
                        .from('members')
                        .select('id, name, phone, email, total_spent, created_at, updated_at');
                    
                    if (allMembers && !allError) {
                        // åœ¨å®¢æˆ¶ç«¯é€²è¡Œé›»è©±è™Ÿç¢¼æ¨¡ç³ŠåŒ¹é…
                        const matchedMembers = allMembers.filter(member => {
                            if (!member.phone) return false;
                            const normalizedMemberPhone = normalizePhoneNumber(member.phone);
                            // æª¢æŸ¥æ˜¯å¦åŒ…å«è¼¸å…¥çš„æ•¸å­—åºåˆ—
                            return normalizedMemberPhone.includes(normalizedInput);
                        });
                        
                        console.log('é›»è©±è™Ÿç¢¼æ¨¡ç³ŠæŸ¥è©¢çµæœ:', matchedMembers);
                        
                        if (matchedMembers.length > 0) {
                            memberData = matchedMembers;
                            
                            // å¦‚æœæ‰¾åˆ°å¤šå€‹åŒ¹é…ï¼Œå„ªå…ˆé¸æ“‡å®Œå…¨åŒ¹é…çš„
                            const exactMatch = matchedMembers.find(member => 
                                normalizePhoneNumber(member.phone) === normalizedInput
                            );
                            if (exactMatch) {
                                memberData = [exactMatch];
                            }
                        }
                    }
                }

                // å¦‚æœæ²’æ‰¾åˆ°ï¼Œå˜—è©¦ç”¨å§“åæŸ¥è©¢ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
                if ((!memberData || memberData.length === 0) && !memberError) {
                    console.log('å˜—è©¦ç”¨å§“åæ¨¡ç³ŠæŸ¥è©¢:', identifier);
                    const { data: nameData, error: nameError } = await supabase
                        .from('members')
                        .select('id, name, phone, email, total_spent, created_at, updated_at')
                        .ilike('name', `%${identifier}%`)
                        .limit(5);
                    
                    console.log('å§“åæŸ¥è©¢çµæœ:', nameData, nameError);
                    
                    if (nameData && nameData.length > 0) {
                        memberData = nameData;
                    }
                }

                // å¦‚æœé‚„æ˜¯æ²’æ‰¾åˆ°ï¼Œå˜—è©¦ç”¨ ID æŸ¥è©¢ï¼ˆä½†å…ˆæª¢æŸ¥æ˜¯å¦ç‚ºæ•¸å­—ï¼‰
                if ((!memberData || memberData.length === 0) && !memberError) {
                    // æª¢æŸ¥æ˜¯å¦ç‚ºç´”æ•¸å­— ID
                    if (/^\d+$/.test(identifier)) {
                        console.log('å˜—è©¦ç”¨æ•¸å­—IDæŸ¥è©¢:', identifier);
                        const { data: idData, error: idError } = await supabase
                            .from('members')
                            .select('id, name, phone, email, total_spent, created_at, updated_at')
                            .eq('id', parseInt(identifier));
                        
                        console.log('IDæŸ¥è©¢çµæœ:', idData, idError);
                        
                        if (idData && idData.length > 0) {
                            memberData = idData;
                        }
                    } else {
                        console.log('IDä¸æ˜¯ç´”æ•¸å­—ï¼Œè·³éIDæŸ¥è©¢:', identifier);
                    }
                }

                // å¦‚æœæ‰¾åˆ°äº†è³‡æ–™ï¼Œè™•ç†çµæœ
                if (memberData && memberData.length > 0) {
                    console.log('æ‰¾åˆ°æœƒå“¡è³‡æ–™:', memberData);
                    
                    let selectedMember = memberData[0]; // é è¨­é¸æ“‡ç¬¬ä¸€å€‹
                    
                    // å¦‚æœæ‰¾åˆ°å¤šå€‹æœƒå“¡ï¼Œè®“ç”¨æˆ¶é¸æ“‡
                    if (memberData.length > 1) {
                        let memberList = 'æ‰¾åˆ°å¤šå€‹åŒ¹é…çš„æœƒå“¡ï¼Œè«‹é¸æ“‡ï¼š\n\n';
                        memberData.forEach((member, index) => {
                            memberList += `${index + 1}. ${member.name} - ${member.phone}\n`;
                        });
                        memberList += '\nè«‹è¼¸å…¥è¦é¸æ“‡çš„æœƒå“¡ç·¨è™Ÿ (1-' + memberData.length + '):';
                        
                        const choice = prompt(memberList);
                        const choiceIndex = parseInt(choice) - 1;
                        
                        if (choiceIndex >= 0 && choiceIndex < memberData.length) {
                            selectedMember = memberData[choiceIndex];
                        } else {
                            alert('ç„¡æ•ˆçš„é¸æ“‡ï¼Œå°‡ä½¿ç”¨ç¬¬ä¸€å€‹åŒ¹é…çš„æœƒå“¡');
                        }
                    }
                    
                    // å°‡ Supabase æœƒå“¡è³‡æ–™è½‰æ›ç‚ºæœ¬åœ°æ ¼å¼
                    return {
                        id: selectedMember.id,
                        name: selectedMember.name || 'æœªçŸ¥æœƒå“¡',
                        phone: selectedMember.phone || '',
                        email: selectedMember.email || '',
                        totalSpent: parseFloat(selectedMember.total_spent) || 0,
                        status: 'active', // é è¨­ç‚ºå•Ÿç”¨ç‹€æ…‹
                        joinDate: selectedMember.created_at || new Date().toISOString(),
                        lastVisit: selectedMember.updated_at || new Date().toISOString()
                    };
                }

                console.log('æœªæ‰¾åˆ°æœƒå“¡è³‡æ–™');
                return null;
            } catch (error) {
                console.error('æŸ¥è©¢ Supabase æœƒå“¡è³‡æ–™å¤±æ•—:', error);
                return null;
            }

        }



        // æœå°‹æœƒå“¡

        async function searchMember() {
            const input = prompt('è«‹è¼¸å…¥æœƒå“¡æ‰‹æ©Ÿè™Ÿç¢¼æˆ–æœƒå“¡ç·¨è™Ÿï¼š');

            if (!input) return;



            let member = null;
            
            

            // é¦–å…ˆå˜—è©¦å¾ Supabase æŸ¥è©¢
            member = await searchMemberFromSupabase(input);
            
            // å¦‚æœ Supabase æ²’æœ‰æ‰¾åˆ°ï¼Œå˜—è©¦å¾æœ¬åœ°è³‡æ–™åº«æŸ¥è©¢
            if (!member) {
            // å…ˆå˜—è©¦ç”¨æœƒå“¡ç·¨è™Ÿæœå°‹

            if (membersDatabase[input]) {

                member = membersDatabase[input];

            } else {

                // ç”¨æ‰‹æ©Ÿè™Ÿç¢¼æœå°‹

                const memberId = phoneToMemberMap[input];

                if (memberId) {

                    member = membersDatabase[memberId];

                }
            }

            }



            if (member) {

                const memberInfo = `æœƒå“¡è³‡è¨Šï¼š\n` +

                    `ç·¨è™Ÿï¼š${member.id}\n` +

                    `å§“åï¼š${member.name}\n` +

                    `é›»è©±ï¼š${member.phone}\n` +



                    `ç´¯è¨ˆæ¶ˆè²»ï¼šNT$${member.totalSpent.toLocaleString()}\n` +

                    `ç‹€æ…‹ï¼š${member.status === 'active' ? 'å•Ÿç”¨' : 'åœç”¨'}`;
                
                
                
                const action = confirm(memberInfo + '\n\næ˜¯å¦è¦ç™»å…¥æ­¤æœƒå“¡ï¼Ÿ');

                if (action) {

                    currentMember = member;

                    updateMemberDisplay();

                    updateCartDisplay(); // é‡æ–°è¨ˆç®—æœƒå“¡åƒ¹æ ¼

                    alert(`${member.name} å·²ç™»å…¥ï¼`);
                }

            } else {

                alert('æŸ¥ç„¡æ­¤æœƒå“¡');

            }

        }



        // æœƒå“¡ç™»å…¥

        async function loginMember() {
            const input = prompt('è«‹è¼¸å…¥æœƒå“¡æ‰‹æ©Ÿè™Ÿç¢¼æˆ–æœƒå“¡ç·¨è™Ÿï¼š');

            if (!input) return;



            let member = null;
            
            

            // é¦–å…ˆå˜—è©¦å¾ Supabase æŸ¥è©¢
            member = await searchMemberFromSupabase(input);
            
            // å¦‚æœ Supabase æ²’æœ‰æ‰¾åˆ°ï¼Œå˜—è©¦å¾æœ¬åœ°è³‡æ–™åº«æŸ¥è©¢
            if (!member) {
            // å…ˆå˜—è©¦ç”¨æœƒå“¡ç·¨è™Ÿæœå°‹

            if (membersDatabase[input]) {

                member = membersDatabase[input];

            } else {

                // ç”¨æ‰‹æ©Ÿè™Ÿç¢¼æœå°‹

                const memberId = phoneToMemberMap[input];

                if (memberId) {

                    member = membersDatabase[memberId];

                }
            }

            }



            if (member) {

                if (member.status === 'active') {

                    currentMember = member;

                    updateMemberDisplay();

                    updateCartDisplay(); // é‡æ–°è¨ˆç®—æœƒå“¡åƒ¹æ ¼
                    
                    // é¡¯ç¤ºæœƒå“¡è©³ç´°è³‡è¨Šï¼ˆåŒ…å«æœ€æ–°çš„æ¶ˆè²»é‡‘é¡ï¼‰
                    let memberInfo = `æœƒå“¡ç™»å…¥æˆåŠŸï¼\n\n`;
                    memberInfo += `ç·¨è™Ÿï¼š${member.id}\n`;
                    memberInfo += `å§“åï¼š${member.name}\n`;
                    memberInfo += `é›»è©±ï¼š${member.phone}\n`;
                    memberInfo += `ç´¯è¨ˆæ¶ˆè²»ï¼šNT$${member.totalSpent.toLocaleString()}\n`;
                    memberInfo += `ç‹€æ…‹ï¼š${member.status === 'active' ? 'å•Ÿç”¨' : 'åœç”¨'}`;
                    
                    alert(memberInfo);
                } else {

                    alert('æ­¤æœƒå“¡å¸³è™Ÿå·²åœç”¨ï¼Œè«‹è¯ç¹«å®¢æœ');

                }

            } else {

                const register = confirm('æŸ¥ç„¡æ­¤æœƒå“¡ï¼Œæ˜¯å¦è¦å»ºç«‹æ–°æœƒå“¡ï¼Ÿ');

                if (register) {

                    navigateToPage('members');

                }

            }

        }



        // æœƒå“¡ç™»å‡º

        function logoutMember() {

            if (currentMember) {

                const confirm_logout = confirm(`ç¢ºå®šè¦è®“ ${currentMember.name} ç™»å‡ºå—ï¼Ÿ`);

                if (confirm_logout) {

                    currentMember = null;

                    updateMemberDisplay();

                    updateCartDisplay(); // ç§»é™¤æœƒå“¡åƒ¹æ ¼

                    alert('æœƒå“¡å·²ç™»å‡º');

                }

            } else {

                alert('ç›®å‰æ²’æœ‰æœƒå“¡ç™»å…¥');

            }

        }



        // éš±è—æœƒå“¡è³‡è¨Š
        function hideMemberInfo() {
            const memberInfo = document.getElementById('currentMemberInfo');
            if (memberInfo) {
                memberInfo.classList.add('hidden');
            }
        }

        // æ›´æ–°æœƒå“¡é¡¯ç¤º

        function updateMemberDisplay() {

            const memberInfo = document.getElementById('currentMemberInfo');

            const memberName = document.getElementById('memberName');

            const memberBtnText = document.getElementById('memberBtnText');

            const memberStatusDot = document.getElementById('memberStatusDot');



            if (currentMember) {

                // æ›´æ–°POSé¡¯ç¤ºå™¨ä¸­çš„æœƒå“¡è³‡è¨Š

                memberInfo.classList.remove('hidden');

                memberName.textContent = currentMember.name;

                
                
                // æ›´æ–°å¿«é€ŸåŠŸèƒ½æŒ‰éˆ•

                memberBtnText.textContent = currentMember.name.length > 4 ? 

                    currentMember.name.substring(0, 4) + '...' : currentMember.name;

                memberStatusDot.classList.remove('hidden');

            } else {

                // éš±è—æœƒå“¡è³‡è¨Š

                memberInfo.classList.add('hidden');

                
                
                // é‡ç½®å¿«é€ŸåŠŸèƒ½æŒ‰éˆ•

                memberBtnText.textContent = 'æœƒå“¡';

                memberStatusDot.classList.add('hidden');

            }

        }






        // 4. ä¸Šå‚³éŠ·å”®è¨˜éŒ„åˆ° Supabase
        async function uploadSalesRecordToSupabase(saleRecord) {
            try {
                if (!supabase) {
                    const initSuccess = await initSupabase();
                    if (!initSuccess) {
                        console.error('Supabase åˆå§‹åŒ–å¤±æ•—ï¼Œç„¡æ³•ä¸Šå‚³éŠ·å”®è¨˜éŒ„');
                        return false;
                    }
                }

                // æ’å…¥éŠ·å”®è¨˜éŒ„ä¸»è¡¨
                const { data: saleData, error: saleError } = await supabase
                    .from('sales_history')
                    .insert([{
                        receipt_number: saleRecord.receiptNumber.toString(),
                        sale_date: saleRecord.date,
                        subtotal: saleRecord.subtotal,
                        member_discount: saleRecord.memberDiscount,
                        coupon_discount: saleRecord.couponDiscount,
                        tax: saleRecord.tax,
                        total_amount: saleRecord.total,
                        total: saleRecord.total, // æ·»åŠ  total æ¬„ä½ï¼Œèˆ‡ total_amount ç›¸åŒ
                        payment_method: saleRecord.paymentMethod,
                        received_amount: saleRecord.receivedAmount,
                        change_amount: saleRecord.change,
                        cashier: saleRecord.cashier,
                        employee_id: getCurrentEmployeeId() || 'E001', // ä½¿ç”¨ç•¶å‰å“¡å·¥IDï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨é è¨­å€¼
                        member_id: saleRecord.member ? saleRecord.member.id : null,
                        coupon_id: saleRecord.coupon ? saleRecord.coupon.id : null,
                        items: JSON.stringify(saleRecord.items) // æ·»åŠ  items æ¬„ä½ï¼Œå°‡å•†å“é …ç›®è½‰æ›ç‚º JSON å­—ä¸²
                    }])
                    .select();

                if (saleError) {
                    console.error('æ’å…¥éŠ·å”®è¨˜éŒ„å¤±æ•—:', saleError);
                    
                    // æª¢æŸ¥æ˜¯å¦æ˜¯é‡è¤‡æ”¶æ“šè™Ÿç¢¼éŒ¯èª¤
                    if (saleError.code === '23505' && saleError.message.includes('receipt_number')) {
                        console.error('æ”¶æ“šè™Ÿç¢¼é‡è¤‡ï¼Œå˜—è©¦é‡æ–°ç”Ÿæˆ...');
                        // é‡æ–°ç”Ÿæˆæ”¶æ“šè™Ÿç¢¼ä¸¦é‡è©¦
                        const newReceiptNumber = Date.now();
                        saleRecord.receiptNumber = newReceiptNumber;
                        
                        // é‡è©¦æ’å…¥
                        const { data: retryData, error: retryError } = await supabase
                            .from('sales_history')
                            .insert([{
                                receipt_number: newReceiptNumber.toString(),
                                sale_date: saleRecord.date,
                                subtotal: saleRecord.subtotal,
                                member_discount: saleRecord.memberDiscount,
                                coupon_discount: saleRecord.couponDiscount,
                                tax: saleRecord.tax,
                                total_amount: saleRecord.total,
                                total: saleRecord.total,
                                payment_method: saleRecord.paymentMethod,
                                received_amount: saleRecord.receivedAmount,
                                change_amount: saleRecord.change,
                                cashier: saleRecord.cashier,
                                employee_id: getCurrentEmployeeId() || 'E001',
                                member_id: saleRecord.member ? saleRecord.member.id : null,
                                coupon_id: saleRecord.coupon ? saleRecord.coupon.id : null,
                                items: JSON.stringify(saleRecord.items)
                            }])
                            .select();
                        
                        if (retryError) {
                            console.error('é‡è©¦æ’å…¥éŠ·å”®è¨˜éŒ„å¤±æ•—:', retryError);
                            return false;
                        }
                        
                        console.log('ä½¿ç”¨æ–°æ”¶æ“šè™Ÿç¢¼æ’å…¥æˆåŠŸ:', newReceiptNumber);
                        const saleId = retryData[0].id;
                        
                        // ç¹¼çºŒæ’å…¥éŠ·å”®é …ç›®
                        const salesItems = saleRecord.items.map(item => ({
                            sale_id: saleId,
                            product_name: item.name,
                            product_variant: item.variant || null,
                            barcode: item.barcode || null,
                            unit_price: item.price,
                            quantity: item.quantity,
                            total_price: item.total,
                            discount_amount: item.discountAmount || 0,
                            discount_percentage: item.discountPercentage || 0
                        }));

                        const { error: itemsError } = await supabase
                            .from('sales_items')
                            .insert(salesItems);

                        if (itemsError) {
                            console.error('æ’å…¥éŠ·å”®é …ç›®å¤±æ•—:', itemsError);
                            return false;
                        }

                        console.log('éŠ·å”®è¨˜éŒ„æˆåŠŸä¸Šå‚³åˆ° Supabase (é‡è©¦)');
                        return true;
                    }
                    
                    return false;
                }

                const saleId = saleData[0].id;

                // æ’å…¥éŠ·å”®é …ç›®æ˜ç´°
                const salesItems = saleRecord.items.map(item => ({
                    sale_id: saleId,
                    product_name: item.name,
                    product_variant: item.variant || null,
                    barcode: item.barcode || null,
                    unit_price: item.price,
                    quantity: item.quantity,
                    total_price: item.total,
                    discount_amount: item.discountAmount || 0,
                    discount_percentage: item.discountPercentage || 0
                }));

                const { error: itemsError } = await supabase
                    .from('sales_items')
                    .insert(salesItems);

                if (itemsError) {
                    console.error('æ’å…¥éŠ·å”®é …ç›®å¤±æ•—:', itemsError);
                    return false;
                }

                console.log('éŠ·å”®è¨˜éŒ„æˆåŠŸä¸Šå‚³åˆ° Supabase');
                return true;
            } catch (error) {
                console.error('ä¸Šå‚³éŠ·å”®è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return false;
            }
        }

        // 5. å¾ Supabase æŸ¥è©¢éŠ·å”®è¨˜éŒ„
        async function searchSaleRecordFromSupabase(receiptNumber) {
            try {
                if (!supabase) {
                    const initSuccess = await initSupabase();
                    if (!initSuccess) {
                        console.error('Supabase åˆå§‹åŒ–å¤±æ•—ï¼Œç„¡æ³•æŸ¥è©¢éŠ·å”®è¨˜éŒ„');
                        return null;
                    }
                }

                // æŸ¥è©¢éŠ·å”®è¨˜éŒ„ä¸»è¡¨
                // å…ˆæŸ¥è©¢éŠ·å”®è¨˜éŒ„ä¸»è¡¨
                const { data: saleData, error: saleError } = await supabase
                    .from('sales_history')
                    .select('*')
                    .eq('receipt_number', receiptNumber)
                    .single();

                if (saleError) {
                    console.error('æŸ¥è©¢éŠ·å”®è¨˜éŒ„å¤±æ•—:', saleError);
                    return null;
                }

                if (!saleData) {
                    console.log('æ‰¾ä¸åˆ°å°æ‡‰çš„éŠ·å”®è¨˜éŒ„');
                    return null;
                }

                // æŸ¥è©¢éŠ·å”®é …ç›®
                const { data: salesItems, error: itemsError } = await supabase
                    .from('sales_items')
                    .select('*')
                    .eq('sale_id', saleData.id);

                if (itemsError) {
                    console.error('æŸ¥è©¢éŠ·å”®é …ç›®å¤±æ•—:', itemsError);
                    return null;
                }

                // æŸ¥è©¢æœƒå“¡è³‡è¨Šï¼ˆå¦‚æœæœ‰ï¼‰
                let memberData = null;
                if (saleData.member_id) {
                    const { data: member, error: memberError } = await supabase
                        .from('members')
                        .select('id, name, phone')
                        .eq('id', saleData.member_id)
                        .single();
                    
                    if (!memberError && member) {
                        memberData = member;
                    }
                }

                // æŸ¥è©¢å„ªæƒ åˆ¸è³‡è¨Šï¼ˆå¦‚æœæœ‰ï¼‰
                let couponData = null;
                if (saleData.coupon_id) {
                    const { data: coupon, error: couponError } = await supabase
                        .from('coupons')
                        .select('id, code, name')
                        .eq('id', saleData.coupon_id)
                        .single();
                    
                    if (!couponError && coupon) {
                        couponData = coupon;
                    }
                }

                // è½‰æ›ç‚ºæœ¬åœ°æ ¼å¼
                const saleRecord = {
                    id: saleData.id,
                    receiptNumber: saleData.receipt_number,
                    date: saleData.sale_date,
                    items: salesItems.map(item => ({
                        name: item.product_name,
                        variant: item.product_variant,
                        barcode: item.barcode,
                        price: parseFloat(item.unit_price),
                        quantity: item.quantity,
                        total: parseFloat(item.total_price),
                        discountAmount: parseFloat(item.discount_amount || 0),
                        discountPercentage: parseFloat(item.discount_percentage || 0)
                    })),
                    subtotal: parseFloat(saleData.subtotal),
                    memberDiscount: parseFloat(saleData.member_discount || 0),
                    couponDiscount: parseFloat(saleData.coupon_discount || 0),
                    tax: parseFloat(saleData.tax || 0),
                    total: parseFloat(saleData.total_amount),
                    paymentMethod: saleData.payment_method,
                    receivedAmount: parseFloat(saleData.received_amount),
                    change: parseFloat(saleData.change_amount),
                    cashier: saleData.cashier,
                    member: memberData ? {
                        id: memberData.id,
                        name: memberData.name,
                        phone: memberData.phone
                    } : null,
                    coupon: couponData ? {
                        id: couponData.id,
                        code: couponData.code,
                        name: couponData.name
                    } : null
                };

                return saleRecord;
            } catch (error) {
                console.error('æŸ¥è©¢éŠ·å”®è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return null;
            }
        }

                // 6. é€€è²¨åŠŸèƒ½

                async function processRefund() {
            const refundOptions = [
                'å•†å“ç‘•ç–µ',
                'å°ºå¯¸ä¸åˆ',
                'é¡è‰²ä¸ç¬¦',
                'å®¢æˆ¶ä¸æ»¿æ„',
                'å…¶ä»–åŸå› '
            ];

            let optionsText = 'é¸æ“‡é€€è²¨åŸå› ï¼š\n';
            refundOptions.forEach((reason, index) => {
                optionsText += `${index + 1}. ${reason}\n`;
            });

            const choice = prompt(optionsText + 'è«‹è¼¸å…¥æ•¸å­— (1-5):');

            if (selectedIndex >= 0 && selectedIndex < refundOptions.length) {
                const reason = refundOptions[selectedIndex];
                const receiptNumber = prompt('è«‹è¼¸å…¥æ”¶æ“šè™Ÿç¢¼ï¼š');
                
                if (receiptNumber) {
                    // å…ˆå¾ Supabase æŸ¥è©¢éŠ·å”®è¨˜éŒ„
                    const saleRecord = await searchSaleRecordFromSupabase(receiptNumber);
                    
                    if (saleRecord) {
                        // é¡¯ç¤ºéŠ·å”®è¨˜éŒ„è©³æƒ…ä¸¦ç¢ºèªé€€è²¨
                        const confirmed = await showRefundConfirmation(saleRecord, reason);
                        
                        if (confirmed) {
                            // è™•ç†é€€è²¨äº¤æ˜“
                            await processRefundTransaction(saleRecord, reason);
                    }
                } else {
                        // å¦‚æœ Supabase æŸ¥è©¢å¤±æ•—ï¼Œå˜—è©¦å¾æœ¬åœ°è¨˜éŒ„æŸ¥è©¢
                        const localRecord = salesHistory.find(record => record.receiptNumber.toString() === receiptNumber);
                        
                        if (localRecord) {
                            alert(`æ‰¾åˆ°æœ¬åœ°éŠ·å”®è¨˜éŒ„ï¼š\næ”¶æ“šè™Ÿç¢¼ï¼š${localRecord.receiptNumber}\nç¸½é‡‘é¡ï¼šNT$${localRecord.total}\n\næ³¨æ„ï¼šæ­¤è¨˜éŒ„åƒ…å­˜åœ¨æ–¼æœ¬åœ°ï¼Œå»ºè­°åŒæ­¥åˆ° Supabase`);
                        } else {
                            alert('æ‰¾ä¸åˆ°å°æ‡‰çš„éŠ·å”®è¨˜éŒ„ï¼Œè«‹ç¢ºèªæ”¶æ“šè™Ÿç¢¼æ˜¯å¦æ­£ç¢º');
                        }
                    }
                } else {
                    alert('è«‹æä¾›æ”¶æ“šè™Ÿç¢¼');
                }
            }
        }

        // é¡¯ç¤ºé€€è²¨ç¢ºèªå°è©±æ¡†
        async function showRefundConfirmation(saleRecord, reason) {
            let saleInfo = `éŠ·å”®è¨˜éŒ„è©³æƒ…ï¼š\n`;
                            saleInfo += `æ”¶æ“šè™Ÿç¢¼ï¼š${saleRecord.receiptNumber}\n`;
            saleInfo += `éŠ·å”®æ—¥æœŸï¼š${new Date(saleRecord.date).toLocaleString('zh-TW')}\n`;
            saleInfo += `ç¸½é‡‘é¡ï¼šNT$${(saleRecord.total || 0).toLocaleString()}\n`;
            saleInfo += `ä»˜æ¬¾æ–¹å¼ï¼š${saleRecord.paymentMethod}\n`;
            saleInfo += `æ”¶éŠ€å“¡ï¼š${saleRecord.cashier}\n\n`;
            
            saleInfo += `å•†å“æ˜ç´°ï¼š\n`;
            saleRecord.items.forEach((item, index) => {
                saleInfo += `${index + 1}. ${item.product_name || item.name} ${item.variant || ''} x${item.quantity} NT$${(item.total || 0).toLocaleString()}\n`;
            });
            
            if (saleRecord.member) {
                saleInfo += `\næœƒå“¡ï¼š${saleRecord.member.name}`;
                if (saleRecord.member.phone) {
                    saleInfo += ` (${saleRecord.member.phone})`;
                }
                saleInfo += `\n`;
            }
            
            if (saleRecord.coupon) {
                saleInfo += `å„ªæƒ åˆ¸ï¼š${saleRecord.coupon.name} (${saleRecord.coupon.code})\n`;
            }
            
            alert(saleInfo);
            
            // ç¢ºèªé€€è²¨
            const refundAmount = saleRecord.total;
            return confirm(`é€€è²¨è³‡è¨Šç¢ºèªï¼š\nåŸå› ï¼š${reason}\næ”¶æ“šè™Ÿç¢¼ï¼š${saleRecord.receiptNumber}\né€€æ¬¾é‡‘é¡ï¼šNT$${refundAmount.toLocaleString()}\n\nç¢ºèªè™•ç†é€€è²¨ï¼Ÿ`);
        }

        // æª¢æŸ¥éŠ·å”®è¨˜éŒ„æ˜¯å¦å·²ç¶“é€€è²¨
        async function checkRefundStatus(saleId) {
            try {
                if (!supabase) {
                    const initSuccess = await initSupabase();
                    if (!initSuccess) {
                        console.error('Supabase åˆå§‹åŒ–å¤±æ•—');
                        return null;
                    }
                }

                // æŸ¥è©¢è©²éŠ·å”®è¨˜éŒ„çš„é€€è²¨ç‹€æ…‹
                const { data: refunds, error } = await supabase
                    .from('refunds')
                    .select('*')
                    .eq('sale_id', saleId)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('æŸ¥è©¢é€€è²¨è¨˜éŒ„å¤±æ•—:', error);
                    return null;
                }

                return refunds;
            } catch (error) {
                console.error('æª¢æŸ¥é€€è²¨ç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return null;
            }
        }

        // è™•ç†é€€è²¨äº¤æ˜“
        async function processRefundTransaction(saleRecord, reason) {
            try {
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“é€€è²¨
                const existingRefunds = await checkRefundStatus(saleRecord.id);
                
                if (existingRefunds && existingRefunds.length > 0) {
                    // é¡¯ç¤ºå·²é€€è²¨çš„è¨˜éŒ„
                    let refundInfo = `æ­¤éŠ·å”®è¨˜éŒ„å·²ç¶“æœ‰é€€è²¨è¨˜éŒ„ï¼š\n\n`;
                    existingRefunds.forEach((refund, index) => {
                        refundInfo += `é€€è²¨è¨˜éŒ„ ${index + 1}ï¼š\n`;
                        refundInfo += `é€€è²¨å–®è™Ÿï¼š${refund.refund_number}\n`;
                        refundInfo += `é€€è²¨æ—¥æœŸï¼š${new Date(refund.refund_date).toLocaleString('zh-TW')}\n`;
                        refundInfo += `é€€è²¨åŸå› ï¼š${refund.refund_reason}\n`;
                        refundInfo += `é€€æ¬¾é‡‘é¡ï¼šNT$${refund.refund_amount.toLocaleString()}\n`;
                        refundInfo += `è™•ç†äººå“¡ï¼š${refund.processed_by}\n\n`;
                    });
                    
                    alert(refundInfo + 'æ­¤éŠ·å”®è¨˜éŒ„ç„¡æ³•é‡è¤‡é€€è²¨ã€‚');
                    return;
                }

                // è©¢å•æ˜¯å¦æ¢å¾©åº«å­˜
                const restoreInventory = confirm(`æ˜¯å¦å°‡é€€è²¨å•†å“åŠ å›åº«å­˜ï¼Ÿ\n\né¸æ“‡ã€Œç¢ºå®šã€: å•†å“å°‡åŠ å›åº«å­˜\né¸æ“‡ã€Œå–æ¶ˆã€: ä¸å½±éŸ¿åº«å­˜ï¼ˆé©ç”¨æ–¼ç‘•ç–µå“ç­‰æƒ…æ³ï¼‰`);
                
                // ç”Ÿæˆé€€è²¨å–®è™Ÿ
                const refundNumber = `R${Date.now()}`;
                
                // è§£æéŠ·å”®è¨˜éŒ„ä¸­çš„å•†å“é …ç›®
                let saleItems = [];
                try {
                    if (typeof saleRecord.items === 'string') {
                        saleItems = JSON.parse(saleRecord.items);
                    } else if (Array.isArray(saleRecord.items)) {
                        saleItems = saleRecord.items;
                    } else {
                        console.error('ç„¡æ³•è§£æéŠ·å”®è¨˜éŒ„ä¸­çš„å•†å“é …ç›®:', saleRecord.items);
                        alert('ç„¡æ³•è§£æéŠ·å”®è¨˜éŒ„ï¼Œé€€è²¨å¤±æ•—');
                        return;
                    }
                } catch (error) {
                    console.error('è§£æéŠ·å”®è¨˜éŒ„å•†å“é …ç›®å¤±æ•—:', error);
                    alert('è§£æéŠ·å”®è¨˜éŒ„å¤±æ•—ï¼Œé€€è²¨å¤±æ•—');
                    return;
                }
                
                console.log('è§£æå¾Œçš„éŠ·å”®å•†å“é …ç›®:', saleItems);
                
                // å‰µå»ºé€€è²¨è¨˜éŒ„
                const refundRecord = {
                    refundNumber: refundNumber,
                    originalReceiptNumber: saleRecord.receipt_number || saleRecord.receiptNumber,
                    refundDate: new Date().toISOString(),
                    reason: reason,
                    refundAmount: saleRecord.total,
                    restoreInventory: restoreInventory,
                    items: saleItems.map(item => {
                        // ç¢ºä¿é€€è²¨é …ç›®åŒ…å«æ‰€æœ‰å¿…è¦çš„å•†å“è³‡è¨Š
                        const refundItem = {
                            ...item,
                            id: item.id || item.product_id, // ç¢ºä¿æœ‰å•†å“ID
                            name: item.name || item.product_name,
                            variant: item.variant || item.product_variant || 'æ¨™æº–è¦æ ¼',
                            quantity: item.quantity || 1,
                            price: item.price || 0,
                            total: item.total || (item.price * item.quantity)
                        };
                        
                        // å¦‚æœæ˜¯è¦æ ¼å•†å“ï¼Œç¢ºä¿æœ‰åŸå§‹å•†å“ID
                        if (item.id && typeof item.id === 'string' && item.id.includes('-')) {
                            refundItem.originalProductId = item.originalProductId || item.id.split('-')[0];
                        }
                        
                        return refundItem;
                    }),
                    member: saleRecord.member,
                    processedBy: getCurrentEmployeeName(),
                    notes: `é€€è²¨åŸå› ï¼š${reason}${restoreInventory ? 'ï¼Œå·²æ¢å¾©åº«å­˜' : 'ï¼Œæœªæ¢å¾©åº«å­˜'}`
                };

                // ä¿å­˜é€€è²¨è¨˜éŒ„åˆ° Supabase
                const saveSuccess = await saveRefundRecord(refundRecord);
                
                if (saveSuccess) {
                    // å¦‚æœé¸æ“‡æ¢å¾©åº«å­˜ï¼Œæ›´æ–°å•†å“åº«å­˜
                    if (restoreInventory) {
                        const inventorySuccess = await restoreInventoryAfterRefund(saleItems, refundNumber);
                        if (!inventorySuccess) {
                            alert('é€€è²¨è¨˜éŒ„å·²ä¿å­˜ï¼Œä½†åº«å­˜æ¢å¾©å¤±æ•—ã€‚è«‹æ‰‹å‹•æª¢æŸ¥åº«å­˜ã€‚');
                        }
                    }
                    
                    // å¦‚æœåŸè¨‚å–®æœ‰æœƒå“¡ï¼Œå›æ»¾æœƒå“¡æ¶ˆè²»é‡‘é¡
                    if (saleRecord.member && saleRecord.member.id) {
                        try {
                            const memberUpdateSuccess = await updateMemberSpentInSupabase(saleRecord.member.id, -saleRecord.total);
                            if (memberUpdateSuccess) {
                                console.log('æœƒå“¡æ¶ˆè²»é‡‘é¡å·²å›æ»¾');
                            } else {
                                console.warn('æœƒå“¡æ¶ˆè²»é‡‘é¡å›æ»¾å¤±æ•—');
                                alert('é€€è²¨è™•ç†å®Œæˆï¼Œä½†æœƒå“¡æ¶ˆè²»é‡‘é¡å›æ»¾å¤±æ•—ã€‚è«‹æ‰‹å‹•æª¢æŸ¥æœƒå“¡è³‡æ–™ã€‚');
                            }
                        } catch (error) {
                            console.error('å›æ»¾æœƒå“¡æ¶ˆè²»é‡‘é¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                            alert('é€€è²¨è™•ç†å®Œæˆï¼Œä½†æœƒå“¡æ¶ˆè²»é‡‘é¡å›æ»¾æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚è«‹æ‰‹å‹•æª¢æŸ¥æœƒå“¡è³‡æ–™ã€‚');
                        }
                    }
                    
                    // ç”Ÿæˆä¸¦é¡¯ç¤ºé€€è²¨å–®
                    generateRefundReceipt(refundRecord);
                    
                    alert(`é€€è²¨è™•ç†å®Œæˆï¼\né€€è²¨å–®è™Ÿï¼š${refundNumber}\né€€æ¬¾é‡‘é¡ï¼šNT$${(saleRecord.total || 0).toLocaleString()}\n${restoreInventory ? 'åº«å­˜å·²æ¢å¾©' : 'åº«å­˜æœªè®Šå‹•'}${saleRecord.member ? '\næœƒå“¡æ¶ˆè²»é‡‘é¡å·²å›æ»¾' : ''}`);
                } else {
                    alert('é€€è²¨è¨˜éŒ„ä¿å­˜å¤±æ•—ï¼Œè«‹é‡è©¦æˆ–è¯ç¹«ç®¡ç†å“¡ã€‚');
                }
                
            } catch (error) {
                console.error('è™•ç†é€€è²¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                alert('è™•ç†é€€è²¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦æˆ–è¯ç¹«ç®¡ç†å“¡ã€‚');
            }
        }

        // ä¿å­˜é€€è²¨è¨˜éŒ„åˆ° Supabase
        async function saveRefundRecord(refundRecord) {
            try {
                // ä½¿ç”¨å…¨åŸŸçš„ window.supabase
                const supabaseClient = window.supabase;
                if (!supabaseClient) {
                    console.error('Supabase å®¢æˆ¶ç«¯ä¸å¯ç”¨');
                        return false;
                }

                // å…ˆæŸ¥è©¢åŸå§‹éŠ·å”®è¨˜éŒ„çš„ ID
                const { data: saleData, error: saleError } = await supabase
                    .from('sales_history')
                    .select('id')
                    .eq('receipt_number', refundRecord.originalReceiptNumber)
                    .single();

                if (saleError) {
                    console.error('æŸ¥è©¢åŸå§‹éŠ·å”®è¨˜éŒ„å¤±æ•—:', saleError);
                    return false;
                }

                if (!saleData) {
                    console.error('æ‰¾ä¸åˆ°åŸå§‹éŠ·å”®è¨˜éŒ„');
                    return false;
                }

                // ä¿å­˜é€€è²¨è¨˜éŒ„åˆ° refunds è¡¨
                const { data, error } = await supabase
                    .from('refunds')
                    .insert([{
                        sale_id: saleData.id, // æ·»åŠ åŸå§‹éŠ·å”®è¨˜éŒ„çš„ ID
                        refund_number: refundRecord.refundNumber,
                        original_receipt_number: refundRecord.originalReceiptNumber,
                        refund_date: refundRecord.refundDate,
                        refund_reason: refundRecord.reason, // åŸå§‹æ¬„ä½
                        reason: refundRecord.reason, // æ–°æ¬„ä½
                        refund_amount: refundRecord.refundAmount,
                        refund_method: 'ç¾é‡‘', // æ·»åŠ é€€æ¬¾æ–¹å¼ï¼ˆå¿…å¡«æ¬„ä½ï¼‰
                        restore_inventory: refundRecord.restoreInventory,
                        refund_items: JSON.stringify(refundRecord.items),
                        member_id: refundRecord.member ? refundRecord.member.id : null,
                        processed_by: refundRecord.processedBy,
                        notes: refundRecord.notes,
                        status: 'completed' // è¨­å®šç‹€æ…‹ç‚ºå·²å®Œæˆ
                    }]);

                if (error) {
                    console.error('ä¿å­˜é€€è²¨è¨˜éŒ„å¤±æ•—:', error);
                    return false;
                }

                console.log('é€€è²¨è¨˜éŒ„å·²æˆåŠŸä¿å­˜åˆ° Supabase');
                return true;
            } catch (error) {
                console.error('ä¿å­˜é€€è²¨è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return false;
            }
        }

        // é€€è²¨å¾Œæ¢å¾©åº«å­˜
        async function restoreInventoryAfterRefund(refundItems, refundNumber) {
            try {
                // ä½¿ç”¨å…¨åŸŸçš„ window.supabase
                const supabaseClient = window.supabase;
                if (!supabaseClient) {
                    console.error('Supabase å®¢æˆ¶ç«¯ä¸å¯ç”¨');
                        return false;
                }

                console.log('é–‹å§‹æ¢å¾©åº«å­˜ï¼Œé€€è²¨é …ç›®:', refundItems);

                for (const item of refundItems) {
                    console.log('è™•ç†é€€è²¨é …ç›®:', item);
                    
                    // æª¢æŸ¥å¿…è¦æ¬„ä½
                    if (!item.id && !item.barcode) {
                        console.error('é€€è²¨é …ç›®ç¼ºå°‘å•†å“IDå’Œæ¢ç¢¼:', item);
                        continue;
                    }
                    
                    // è™•ç†å•†å“è¦æ ¼
                    let productId = item.id;
                    let variantName = item.variant || item.product_variant || 'æ¨™æº–è¦æ ¼';
                    
                    console.log(`å•†å“ID: ${productId}, æ¢ç¢¼: ${item.barcode}, è¦æ ¼: ${variantName}`);
                    
                    // å¦‚æœæ²’æœ‰IDä½†æœ‰æ¢ç¢¼ï¼Œå…ˆé€šéæ¢ç¢¼æŸ¥æ‰¾å•†å“
                    if (!productId && item.barcode) {
                        console.log(`é€šéæ¢ç¢¼æŸ¥æ‰¾å•†å“: ${item.barcode}`);
                        const { data: productByBarcode, error: barcodeError } = await supabase
                            .from('products')
                            .select('id, name, variants')
                            .eq('barcode', item.barcode)
                            .single();
                        
                        if (barcodeError) {
                            console.error(`é€šéæ¢ç¢¼æŸ¥æ‰¾å•†å“å¤±æ•—: ${item.barcode}`, barcodeError);
                            // å˜—è©¦æ¨¡ç³ŠåŒ¹é…
                            const { data: fuzzyProducts, error: fuzzyError } = await supabase
                                .from('products')
                                .select('id, name, variants, barcode')
                                .ilike('barcode', `%${item.barcode}%`);
                            
                            if (fuzzyError || !fuzzyProducts || fuzzyProducts.length === 0) {
                                console.error(`æ¨¡ç³ŠåŒ¹é…ä¹Ÿæ‰¾ä¸åˆ°å•†å“: ${item.barcode}`, fuzzyError);
                                continue;
                            }
                            
                            console.log(`æ¨¡ç³ŠåŒ¹é…æ‰¾åˆ°å•†å“:`, fuzzyProducts);
                            productId = fuzzyProducts[0].id;
                        } else if (!productByBarcode) {
                            console.error(`é€šéæ¢ç¢¼æ‰¾ä¸åˆ°å•†å“: ${item.barcode}`);
                            continue;
                        } else {
                            productId = productByBarcode.id;
                        }
                        
                        console.log(`é€šéæ¢ç¢¼æ‰¾åˆ°å•†å“ID: ${productId}`);
                    }
                    
                    // å¦‚æœIDåŒ…å«è¦æ ¼ä¿¡æ¯ï¼Œæå–åŸå§‹å•†å“ID
                    if (productId && typeof productId === 'string' && productId.includes('-') && item.originalProductId) {
                        productId = item.originalProductId;
                        console.log(`æª¢æ¸¬åˆ°è¦æ ¼å•†å“ï¼ŒåŸå§‹å•†å“ID: ${productId}`);
                    }
                    
                    // æŸ¥è©¢å•†å“çš„ç•¶å‰åº«å­˜
                    const { data: product, error: productError } = await supabase
                        .from('products')
                        .select('id, stock, barcode, name, variants')
                        .eq('id', productId)
                        .single();

                    if (productError) {
                        console.error(`æŸ¥è©¢å•†å“å¤±æ•— (å•†å“ID: ${productId}):`, productError);
                        continue;
                    }

                    if (!product) {
                        console.error(`æ‰¾ä¸åˆ°å•†å“ (å•†å“ID: ${productId})`);
                        continue;
                    }

                    // è™•ç†å•†å“è¦æ ¼åº«å­˜æ¢å¾©
                    let newStock;
                    let currentStock;
                    let updatedVariants = null;
                    
                    if (product.variants && variantName && variantName !== 'æ¨™æº–è¦æ ¼') {
                        // æ¢å¾©è¦æ ¼åº«å­˜
                        try {
                            const variants = JSON.parse(product.variants);
                            const variantIndex = variants.findIndex(v => v.name === variantName);
                            
                            if (variantIndex !== -1) {
                                const currentVariantStock = variants[variantIndex].stock || 0;
                                currentStock = currentVariantStock;
                                const newVariantStock = currentVariantStock + item.quantity;
                                variants[variantIndex].stock = newVariantStock;
                                updatedVariants = JSON.stringify(variants);
                                newStock = newVariantStock;
                            } else {
                                // æ‰¾ä¸åˆ°è¦æ ¼ï¼Œæ¢å¾©ä¸»å•†å“åº«å­˜
                                currentStock = product.stock;
                                newStock = product.stock + item.quantity;
                            }
                        } catch (e) {
                            console.error('è§£æå•†å“è¦æ ¼å¤±æ•—:', e);
                            currentStock = product.stock;
                            newStock = product.stock + item.quantity;
                        }
                    } else {
                        // æ¢å¾©ä¸»å•†å“åº«å­˜
                        currentStock = product.stock;
                        newStock = product.stock + item.quantity;
                    }

                    // æ›´æ–°å•†å“åº«å­˜
                    const updateData = { 
                        updated_at: new Date().toISOString()
                    };
                    
                    if (updatedVariants) {
                        updateData.variants = updatedVariants;
                    } else {
                        updateData.stock = newStock;
                    }
                    
                    const { error: updateError } = await supabase
                        .from('products')
                        .update(updateData)
                        .eq('id', product.id);

                    if (updateError) {
                        console.error(`æ›´æ–°åº«å­˜å¤±æ•— (å•†å“ID: ${product.id}):`, updateError);
                        continue;
                    }

                    // è¨˜éŒ„åº«å­˜äº¤æ˜“ï¼ˆå¯é¸ï¼Œå¦‚æœè¡¨ä¸å­˜åœ¨å‰‡è·³éï¼‰
                    try {
                        const { error: transactionError } = await supabase
                            .from('inventory_transactions')
                            .insert([{
                                product_id: product.id,
                                transaction_type: 'refund',
                                quantity_change: item.quantity,
                                previous_stock: currentStock,
                                new_stock: newStock,
                                reference_id: refundNumber,
                                reference_type: 'refund',
                                notes: `é€€è²¨æ¢å¾©åº«å­˜ - ${item.product_name || item.name} (${item.variant || ''})`,
                                created_by: getCurrentEmployeeName()
                            }]);

                        if (transactionError) {
                            console.warn(`è¨˜éŒ„åº«å­˜äº¤æ˜“å¤±æ•— (å•†å“ID: ${product.id}):`, transactionError);
                            // ä¸å½±éŸ¿ä¸»è¦æµç¨‹ï¼Œåªè¨˜éŒ„è­¦å‘Š
                        }
                    } catch (error) {
                        console.warn(`åº«å­˜äº¤æ˜“è¨˜éŒ„è¡¨ä¸å­˜åœ¨æˆ–ç„¡æ³•è¨ªå•:`, error);
                        // ä¸å½±éŸ¿ä¸»è¦æµç¨‹ï¼Œåªè¨˜éŒ„è­¦å‘Š
                    }

                    console.log(`æˆåŠŸæ¢å¾©åº«å­˜ - å•†å“: ${product.name}, åŸåº«å­˜: ${currentStock}, é€€è²¨æ•¸é‡: ${item.quantity}, æ–°åº«å­˜: ${newStock}`);
                }

                return true;
            } catch (error) {
                console.error('æ¢å¾©åº«å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return false;
            }
        }

        // ç”Ÿæˆé€€è²¨å–®
        function generateRefundReceipt(refundRecord) {
            const refundContent = generateRefundReceiptContent(refundRecord);

            // å‰µå»ºé€€è²¨å–®è¦–çª—
            const refundWindow = window.open('', '_blank', 'width=400,height=600,scrollbars=yes');
            refundWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>é€€è²¨å–® #${refundRecord.refundNumber}</title>
                    <style>
                        body { 
                            font-family: 'Courier New', 'Microsoft JhengHei', monospace; 
                            font-size: 16px; 
                            line-height: 1.5;
                            margin: 20px; 
                            background: white;
                        }

                        .receipt-print { 
                            max-width: 300px; 
                            margin: 0 auto; 
                            padding: 12px;
                            transform: scale(1.25);
                            transform-origin: top center;
                            margin-bottom: 50px;
                        }

                        .receipt-print .header { 
                            text-align: center; 
                            margin-bottom: 18px; 
                            border-bottom: 3px solid #000; 
                            padding-bottom: 12px; 
                        }

                        .receipt-print .header h2 {
                            font-size: 20px;
                            font-weight: bold;
                            margin: 8px 0;
                            letter-spacing: 1px;
                        }

                        .receipt-print .header p {
                            font-size: 15px;
                            margin: 5px 0;
                            line-height: 1.4;
                        }

                        .receipt-print .line { 
                            border-bottom: 2px dashed #000; 
                            margin: 10px 0; 
                        }

                        .receipt-print .row { 
                            display: flex; 
                            justify-content: space-between; 
                            align-items: flex-start;
                            margin: 8px 0; 
                            font-size: 15px;
                            line-height: 1.4;
                        }

                        .receipt-print .row.small { 
                            font-size: 14px; 
                            color: #333; 
                            margin: 4px 0; 
                            padding-left: 12px; 
                        }

                        .receipt-print .total { 
                            font-weight: bold; 
                            font-size: 18px; 
                            border-top: 2px solid #000; 
                            padding-top: 10px; 
                            margin-top: 12px; 
                        }

                        .receipt-print .item-name {
                            font-size: 15px;
                            font-weight: bold;
                            line-height: 1.4;
                            word-break: break-all;
                            flex: 1;
                            margin-right: 12px;
                        }

                        .receipt-print .item-price {
                            font-size: 15px;
                            text-align: right;
                            white-space: nowrap;
                        }

                        .receipt-print .item-details {
                            font-size: 13px;
                            color: #555;
                            margin-left: 18px;
                            line-height: 1.3;
                        }

                        .receipt-print .footer {
                            text-align: center;
                            margin-top: 18px;
                            font-size: 14px;
                            color: #666;
                            border-top: 2px dashed #000;
                            padding-top: 12px;
                        }

                        .receipt-print .refund-title {
                            color: #d32f2f !important;
                            border: 3px solid #d32f2f;
                            padding: 8px 12px;
                            margin: 12px 0;
                            border-radius: 8px;
                            background: rgba(211, 47, 47, 0.1);
                            font-size: 22px;
                        }

                        .receipt-print .refund-notice {
                            background: #ffebee;
                            border: 2px solid #d32f2f;
                            padding: 10px;
                            margin: 12px 0;
                            border-radius: 8px;
                            font-size: 16px;
                            color: #d32f2f;
                            text-align: center;
                            font-weight: bold;
                        }

                        @media print { 
                            body { 
                                margin: 0; 
                                padding: 0;
                                width: 58mm;
                                background: white;
                            }
                            .receipt-print {
                                width: 58mm;
                                max-width: none;
                                box-shadow: none;
                                border: none;
                                transform: scale(1.25);
                                transform-origin: top center;
                            }
                            .receipt-print * {
                                -webkit-print-color-adjust: exact;
                                color-adjust: exact;
                            }
                        }

                    </style>
                </head>
                <body>
                    ${refundContent}
                    <div style="text-align: center; margin-top: 150px; padding: 30px; border-top: 1px solid #ccc;">
                        <button onclick="window.print()" style="margin: 0 10px; padding: 10px 20px; background: #17225e; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">åˆ—å°é€€è²¨å–®</button>
                        <button onclick="window.close()" style="margin: 0 10px; padding: 10px 20px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">é—œé–‰</button>
                    </div>
                </body>
                </html>
            `);
            refundWindow.document.close();
        }

        // ç”Ÿæˆé€€è²¨å–®å…§å®¹
        function generateRefundReceiptContent(refundRecord) {
            const refundDate = new Date(refundRecord.refundDate);
            
            let itemsHtml = '';
            // è™•ç†é€€è²¨å•†å“æ˜ç´°
            const items = Array.isArray(refundRecord.items) ? refundRecord.items : [];
            
            items.forEach(item => {
                itemsHtml += `
                    <div class="row">
                        <span class="item-name">${item.product_name || item.name}</span>
                        <span class="item-price">NT$${(item.total_price || item.total || 0).toLocaleString()}</span>
                    </div>
                    <div class="row small">
                        <span class="item-details">è¦æ ¼ï¼š${item.product_variant || item.variant || 'ç„¡'}</span>
                    </div>
                    <div class="row small">
                        <span class="item-details">ç·¨è™Ÿï¼š${item.barcode || item.id || 'ç„¡'}</span>
                    </div>
                    <div class="row small">
                        <span class="item-details">${item.quantity} x NT$${(item.unit_price || item.price || 0).toLocaleString()}</span>
                    </div>
                    <div class="line"></div>
                `;
            });

            return `
                <div class="receipt-print">
                    <div class="header">
                        <img src="../images/æ”¶æ“šLOGO.png" alt="æ³¢æ³¢ èš æ­æ´²å®¶å±…/æ³¢è˜­é™¶é£Ÿå™¨" style="max-width: 220px; height: auto; margin: 0 auto 15px; display: block; border-radius: 4px;">
                        <p>POPO CHEERS CO., LTD.</p>
                        <p>çµ±ä¸€ç·¨è™Ÿï¼š24708167</p>
                        <p>åœ°å€ï¼šé«˜é›„å¸‚å‰é®å€æ°¸è±è·¯9è™Ÿ1æ¨“</p>
                        <p>é›»è©±ï¼š07-717-0089</p>
                    </div>
                    
                    <div class="line"></div>
                    
                    <div class="refund-notice">
                        <strong>é€€è²¨å–®</strong>
                    </div>
                    
                    <div class="row">
                        <span class="item-name">é€€è²¨å–®è™Ÿï¼š${refundRecord.refundNumber}</span>
                    </div>
                    <div class="row">
                        <span class="item-name">åŸæ”¶æ“šè™Ÿï¼š${refundRecord.originalReceiptNumber}</span>
                    </div>
                    <div class="row">
                        <span class="item-name">é€€è²¨æ—¥æœŸï¼š${refundDate.toLocaleDateString('zh-TW')}</span>
                    </div>
                    <div class="row">
                        <span class="item-name">é€€è²¨æ™‚é–“ï¼š${refundDate.toLocaleTimeString('zh-TW')}</span>
                    </div>
                    <div class="row">
                        <span class="item-name">è™•ç†äººå“¡ï¼š${refundRecord.processedBy}</span>
                    </div>
                    <div class="row">
                        <span class="item-name">é€€è²¨åŸå› ï¼š${refundRecord.reason}</span>
                    </div>
                    <div class="row">
                        <span class="item-name">åº«å­˜ç‹€æ³ï¼š${refundRecord.restoreInventory ? 'å·²æ¢å¾©åº«å­˜' : 'æœªæ¢å¾©åº«å­˜'}</span>
                    </div>
                    
                    <div class="line"></div>
                    
                    ${itemsHtml}
                    
                    ${refundRecord.member ? `
                    <div class="line"></div>
                    <div class="row">
                        <span class="item-name">æœƒå“¡è³‡è¨Š</span>
                    </div>
                    <div class="row">
                        <span class="item-name">æœƒå“¡ï¼š${refundRecord.member.name}</span>
                    </div>
                    <div class="row">
                        <span class="item-name">æœƒå“¡ç·¨è™Ÿï¼š${refundRecord.member.id}</span>
                    </div>
                    <div class="line"></div>
                    ` : ''}
                    
                    <div class="line"></div>
                    
                    <div class="row total">
                        <span>é€€æ¬¾ç¸½é¡</span>
                        <span>NT$${refundRecord.refundAmount.toLocaleString()}</span>
                    </div>
                    
                    <div class="footer">
                        <p>é€€è²¨è™•ç†å®Œæˆ</p>
                    </div>
                </div>
            `;
        }



        // éŠ·å”®è¨˜éŒ„

        let salesHistory = [];
        let refundHistory = []; // æ–°å¢é€€è²¨è¨˜éŒ„é™£åˆ—
        let receiptNumber = parseInt(localStorage.getItem('lastReceiptNumber')) || 1000;

        // å¾ Supabase è¼‰å…¥é€€è²¨è¨˜éŒ„
        async function loadRefundHistoryFromSupabase() {
            try {
                if (!supabase) {
                    const initSuccess = await initSupabase();
                    if (!initSuccess) {
                        console.error('Supabase åˆå§‹åŒ–å¤±æ•—');
                        return;
                    }
                }

                console.log('å¾ Supabase è¼‰å…¥é€€è²¨è¨˜éŒ„...');

                // æŸ¥è©¢é€€è²¨è¨˜éŒ„
                const { data: refundData, error } = await supabase
                    .from('refunds')
                    .select('*')
                    .order('refund_date', { ascending: false })
                    .limit(50); // é™åˆ¶è¼‰å…¥æœ€è¿‘50ç­†è¨˜éŒ„

                if (error) {
                    console.error('è¼‰å…¥é€€è²¨è¨˜éŒ„å¤±æ•—:', error);
                    return;
                }

                // è½‰æ›è³‡æ–™æ ¼å¼
                refundHistory = refundData.map(refund => ({
                    id: refund.id,
                    refundNumber: refund.refund_number,
                    originalReceiptNumber: refund.original_receipt_number,
                    refundDate: refund.refund_date,
                    reason: refund.refund_reason,
                    refundAmount: parseFloat(refund.refund_amount),
                    processedBy: refund.processed_by,
                    restoreInventory: refund.restore_inventory,
                    member_id: refund.member_id,
                    sale_id: refund.sale_id,
                    member: null, // æš«æ™‚è¨­ç‚º nullï¼Œç¨å¾Œè¼‰å…¥
                    items: [] // æš«æ™‚è¨­ç‚ºç©ºé™£åˆ—ï¼Œç¨å¾Œè¼‰å…¥
                }));

                console.log(`æˆåŠŸè¼‰å…¥ ${refundHistory.length} ç­†é€€è²¨è¨˜éŒ„`);

            } catch (error) {
                console.error('è¼‰å…¥é€€è²¨è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // å¾ Supabase è¼‰å…¥éŠ·å”®è¨˜éŒ„
        async function loadSalesHistoryFromSupabase() {
            try {
                if (!supabase) {
                    const initSuccess = await initSupabase();
                    if (!initSuccess) {
                        console.error('Supabase åˆå§‹åŒ–å¤±æ•—');
                        return;
                    }
                }

                console.log('å¾ Supabase è¼‰å…¥éŠ·å”®è¨˜éŒ„...');

                // ç°¡å–®æŸ¥è©¢éŠ·å”®è¨˜éŒ„ï¼Œé¿å…è¤‡é›œé—œè¯
                const { data: salesData, error } = await supabase
                    .from('sales_history')
                    .select('*')
                    .order('sale_date', { ascending: false })
                    .limit(50); // é™åˆ¶è¼‰å…¥æœ€è¿‘50ç­†è¨˜éŒ„

                if (error) {
                    console.error('è¼‰å…¥éŠ·å”®è¨˜éŒ„å¤±æ•—:', error);
                    return;
                }

                // è½‰æ›è³‡æ–™æ ¼å¼
                salesHistory = salesData.map(sale => ({
                    id: sale.id, // æ·»åŠ  ID æ¬„ä½
                    receiptNumber: parseInt(sale.receipt_number),
                    date: sale.sale_date,
                    items: [], // æš«æ™‚è¨­ç‚ºç©ºé™£åˆ—ï¼Œç¨å¾Œè¼‰å…¥
                    subtotal: parseFloat(sale.subtotal),
                    memberDiscount: parseFloat(sale.member_discount),
                    couponDiscount: parseFloat(sale.coupon_discount),
                    tax: parseFloat(sale.tax),
                    total: parseFloat(sale.total_amount),
                    paymentMethod: sale.payment_method,
                    receivedAmount: parseFloat(sale.received_amount),
                    change: parseFloat(sale.change_amount),
                    cashier: sale.cashier,
                    member_id: sale.member_id, // æ·»åŠ æœƒå“¡ ID
                    coupon_id: sale.coupon_id, // æ·»åŠ å„ªæƒ åˆ¸ ID
                    member: null, // æš«æ™‚è¨­ç‚º nullï¼Œç¨å¾Œè¼‰å…¥
                    coupon: null  // æš«æ™‚è¨­ç‚º nullï¼Œç¨å¾Œè¼‰å…¥
                }));

                console.log(`æˆåŠŸè¼‰å…¥ ${salesHistory.length} ç­†éŠ·å”®è¨˜éŒ„`);
                
                // æ›´æ–°æ”¶æ“šè™Ÿç¢¼
                if (salesHistory.length > 0) {
                    const maxReceiptNumber = Math.max(...salesHistory.map(sale => sale.receiptNumber));
                    receiptNumber = maxReceiptNumber;
                    localStorage.setItem('lastReceiptNumber', receiptNumber.toString());
                }

            } catch (error) {
                console.error('è¼‰å…¥éŠ·å”®è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // è¼‰å…¥éŠ·å”®é …ç›®çš„è©³ç´°è³‡æ–™
        async function loadSalesItems(saleId) {
            try {
                if (!supabase) {
                    const initSuccess = await initSupabase();
                    if (!initSuccess) {
                        console.error('Supabase åˆå§‹åŒ–å¤±æ•—');
                        return [];
                    }
                }

                const { data: itemsData, error } = await supabase
                    .from('sales_items')
                    .select('*')
                    .eq('sale_id', saleId)
                    .order('id');

                if (error) {
                    console.error('è¼‰å…¥éŠ·å”®é …ç›®å¤±æ•—:', error);
                    return [];
                }

                return itemsData || [];
            } catch (error) {
                console.error('è¼‰å…¥éŠ·å”®é …ç›®æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return [];
            }
        }

        // è¼‰å…¥æœƒå“¡è³‡æ–™
        async function loadMemberData(memberId) {
            try {
                if (!memberId || !supabase) {
                    return null;
                }

                const { data: memberData, error } = await supabase
                    .from('members')
                    .select('id, name, phone, email, address')
                    .eq('id', memberId)
                    .single();

                if (error) {
                    console.error('è¼‰å…¥æœƒå“¡è³‡æ–™å¤±æ•—:', error);
                    return null;
                }



                return memberData;
            } catch (error) {
                console.error('è¼‰å…¥æœƒå“¡è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return null;
            }
        }

        // è¼‰å…¥å„ªæƒ åˆ¸è³‡æ–™
        async function loadCouponData(couponId) {
            try {
                if (!couponId || !supabase) {
                    return null;
                }

                const { data: couponData, error } = await supabase
                    .from('coupons')
                    .select('id, code, name, type, discount_value')
                    .eq('id', couponId)
                    .single();

                if (error) {
                    console.error('è¼‰å…¥å„ªæƒ åˆ¸è³‡æ–™å¤±æ•—:', error);
                    return null;
                }

                return couponData;
            } catch (error) {
                console.error('è¼‰å…¥å„ªæƒ åˆ¸è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return null;
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥éŠ·å”®è¨˜éŒ„
        document.addEventListener('DOMContentLoaded', function() {
            loadSalesHistoryFromSupabase();
        });






        // çµå¸³åŠŸèƒ½

        function checkout(paymentMethod) {

            if (cart.length === 0) {

                alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œè«‹å…ˆæ·»åŠ å•†å“');

                return;

            }



            // è¨ˆç®—ç¸½é¡

            const totals = updateTotals();

            const items = cart.reduce((sum, item) => sum + item.quantity, 0);

            
            
            // æº–å‚™çµå¸³ç¢ºèªè¨Šæ¯

            let confirmMessage = `ç¢ºèªçµå¸³å—ï¼Ÿ\n\n`;

            
            
            // å¦‚æœæœ‰æœƒå“¡ç™»å…¥ï¼Œé¡¯ç¤ºæœƒå“¡è³‡è¨Š

            if (currentMember) {

                confirmMessage += `æœƒå“¡ï¼š${currentMember.name}\n\n`;
            }

            
            
            confirmMessage += `å•†å“æ•¸é‡ï¼š${items} ä»¶\n` +

                `å°è¨ˆï¼šNT$${totals.subtotal.toLocaleString()}\n`;
                
            
            
            if (totals.couponDiscount > 0) {

                confirmMessage += `å„ªæƒ åˆ¸ï¼š-NT$${totals.couponDiscount.toLocaleString()}\n`;

            }

            
            
            confirmMessage += `ç¸½é‡‘é¡ï¼šNT$${totals.total.toLocaleString()}\n` +

                `ä»˜æ¬¾æ–¹å¼ï¼š${paymentMethod}`;



            if (confirm(confirmMessage)) {

                // è™•ç†ä»˜æ¬¾

                if (paymentMethod === 'ç¾é‡‘') {

                    processCashPayment(totals.total);

                } else {

                    processCardPayment(paymentMethod, totals.total);

                }

            }

        }



        // ç¾é‡‘ä»˜æ¬¾è™•ç†

        async function processCashPayment(total) {

            const receivedAmount = prompt(`ç¸½é‡‘é¡ï¼šNT$${total.toLocaleString()}\nè«‹è¼¸å…¥æ”¶åˆ°é‡‘é¡ï¼š`);

            
            
            if (receivedAmount === null) return; // ç”¨æˆ¶å–æ¶ˆ

            
            
            const received = parseFloat(receivedAmount);

            
            
            if (isNaN(received) || received < total) {

                alert('æ”¶åˆ°é‡‘é¡ä¸è¶³æˆ–æ ¼å¼éŒ¯èª¤');

                return;

            }

            
            
            const change = received - total;

            
            
            if (change > 0) {

                alert(`æ‰¾é›¶ï¼šNT$${change.toLocaleString()}`);

            }
            
            
            
            await completeSale('ç¾é‡‘', total, received, change);

        }



        // å¡ç‰‡/è¡Œå‹•æ”¯ä»˜è™•ç†

        async function processCardPayment(paymentMethod, total) {

            // æ¨¡æ“¬å¡ç‰‡è™•ç†

            const processing = confirm(`${paymentMethod}ä»˜æ¬¾\né‡‘é¡ï¼šNT$${total.toLocaleString()}\n\nè«‹é€²è¡Œä»˜æ¬¾æ“ä½œ`);

            
            
            if (processing) {

                // æ¨¡æ“¬è™•ç†æ™‚é–“

                setTimeout(async () => {

                    // ç§»é™¤éš¨æ©Ÿå¤±æ•—æ©Ÿåˆ¶ï¼Œç¢ºä¿ä»˜æ¬¾æˆåŠŸ

                    alert('çµå¸³å®Œæˆï¼');

                    await completeSale(paymentMethod, total, total, 0);

                }, 1000);

            }

        }



        // å®ŒæˆéŠ·å”®

        async function completeSale(paymentMethod, total, received, change) {

            // ç”Ÿæˆå”¯ä¸€çš„æ”¶æ“šè™Ÿç¢¼
            const uniqueReceiptNumber = await generateUniqueReceiptNumber();
            if (!uniqueReceiptNumber) {
                alert('ç„¡æ³•ç”Ÿæˆæ”¶æ“šè™Ÿç¢¼ï¼ŒéŠ·å”®å¤±æ•—');
                return;
            }
            
            // æ›´æ–°æœ¬åœ°æ”¶æ“šè™Ÿç¢¼
            receiptNumber = uniqueReceiptNumber;
            
            // è¨ˆç®—ç¸½é¡è©³æƒ…

            const totals = updateTotals();
            
            

            // æ›´æ–°æœƒå“¡æ¶ˆè²»è¨˜éŒ„
            let memberInfo = null;

            if (currentMember) {

                currentMember.totalSpent += total;
                memberInfo = {

                    id: currentMember.id,

                    name: currentMember.name

                };

                // åŒæ­¥æ›´æ–°åˆ° Supabase
                try {
                    const updateSuccess = await updateMemberSpentInSupabase(currentMember.id, total);
                    if (updateSuccess) {
                        console.log('æœƒå“¡æ¶ˆè²»é‡‘é¡å·²åŒæ­¥åˆ° Supabase');
                    } else {
                        console.warn('æœƒå“¡æ¶ˆè²»é‡‘é¡åŒæ­¥åˆ° Supabase å¤±æ•—');
                    }
                } catch (error) {
                    console.error('åŒæ­¥æœƒå“¡æ¶ˆè²»é‡‘é¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                }

            }

            
            
            // è™•ç†å„ªæƒ åˆ¸ä½¿ç”¨

            let couponInfo = null;

            if (currentCoupon) {

                couponInfo = {

                    id: currentCoupon.id,

                    code: currentCoupon.code,

                    name: currentCoupon.name,

                    type: currentCoupon.type,

                    discountValue: currentCoupon.discountValue,

                    discountAmount: totals.couponDiscount

                };

                
                
                // å¢åŠ å„ªæƒ åˆ¸ä½¿ç”¨æ¬¡æ•¸

                if (window.useCoupon) {

                    window.useCoupon(currentCoupon.code);

                }

            }



            // å‰µå»ºéŠ·å”®è¨˜éŒ„

            const saleRecord = {

                receiptNumber: receiptNumber,

                date: new Date().toISOString(),

                items: cart.map(item => ({...item})),

                subtotal: totals.subtotal,

                memberDiscount: 0,
                couponDiscount: totals.couponDiscount,

                tax: 0,

                total: total,

                paymentMethod: paymentMethod,

                receivedAmount: received,

                change: change,

                cashier: getCurrentEmployeeName(),
                employeeId: getCurrentEmployeeId(),

                member: memberInfo,

                coupon: couponInfo

            };



            // ä¿å­˜åˆ°æ­·å²è¨˜éŒ„

            salesHistory.unshift(saleRecord);

            
            
            // åªä¿ç•™æœ€è¿‘100ç­†è¨˜éŒ„

            if (salesHistory.length > 100) {

                salesHistory = salesHistory.slice(0, 100);

            }

            
            
            localStorage.setItem('salesHistory', JSON.stringify(salesHistory));

            localStorage.setItem('lastReceiptNumber', receiptNumber.toString());

            

            // ä¸Šå‚³éŠ·å”®è¨˜éŒ„åˆ° Supabase
            try {
                const uploadSuccess = await uploadSalesRecordToSupabase(saleRecord);
                if (uploadSuccess) {
                    console.log('éŠ·å”®è¨˜éŒ„å·²æˆåŠŸä¸Šå‚³åˆ° Supabase');
                    
                    // æ›´æ–°åº«å­˜
                    const inventoryUpdateSuccess = await updateInventoryAfterSale(saleRecord.items, saleRecord.receiptNumber);
                    if (inventoryUpdateSuccess) {
                        console.log('åº«å­˜å·²æˆåŠŸæ›´æ–°');
                    } else {
                        console.warn('åº«å­˜æ›´æ–°å¤±æ•—ï¼Œè«‹æ‰‹å‹•æª¢æŸ¥');
                        alert('éŠ·å”®å®Œæˆï¼Œä½†åº«å­˜æ›´æ–°å¤±æ•—ã€‚è«‹æª¢æŸ¥åº«å­˜ç‹€æ³ã€‚');
                    }
                    
                    // é‡æ–°è¼‰å…¥éŠ·å”®è¨˜éŒ„ä»¥é¡¯ç¤ºæœ€æ–°è³‡æ–™
                    await loadSalesHistoryFromSupabase();
                } else {
                    console.warn('éŠ·å”®è¨˜éŒ„ä¸Šå‚³åˆ° Supabase å¤±æ•—ï¼Œä½†æœ¬åœ°è¨˜éŒ„å·²ä¿å­˜');
                    alert('éŠ·å”®è¨˜éŒ„ä¸Šå‚³å¤±æ•—ï¼Œä½†æœ¬åœ°è¨˜éŒ„å·²ä¿å­˜ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚');
                }
            } catch (error) {
                console.error('ä¸Šå‚³éŠ·å”®è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                alert('éŠ·å”®è¨˜éŒ„ä¸Šå‚³æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œä½†æœ¬åœ°è¨˜éŒ„å·²ä¿å­˜ã€‚');
            }






            // é¡¯ç¤ºæ”¶æ“š

            showReceipt(saleRecord);

            
            
            // æ¸…ç©ºè³¼ç‰©è»Šå’Œå„ªæƒ åˆ¸

            cart = [];

            currentCoupon = null;

            hideAppliedCoupon();

            document.getElementById('couponInput').value = '';

            updateCartDisplay();

            updateCartItemCount();
            
            // è‡ªå‹•ç™»å‡ºæœƒå“¡
            if (currentMember) {
                console.log('çµå¸³å®Œæˆï¼Œè‡ªå‹•ç™»å‡ºæœƒå“¡:', currentMember.name);
                currentMember = null;
                updateMemberDisplay();
                updateCartDisplay(); // ç§»é™¤æœƒå“¡åƒ¹æ ¼
            }
        }



        // é¡¯ç¤ºæ”¶æ“š

        function showReceipt(saleRecord) {

            const receiptContent = generateReceiptContent(saleRecord);

            
            
            // å‰µå»ºæ”¶æ“šè¦–çª—

            const receiptWindow = window.open('', '_blank', 'width=400,height=600,scrollbars=yes');

            receiptWindow.document.write(`

                <!DOCTYPE html>

                <html>

                <head>

                    <title>æ”¶æ“š #${saleRecord.receiptNumber}</title>

                    <style>

                        body { 
                            font-family: 'Courier New', 'Microsoft JhengHei', monospace; 
                            font-size: 16px; 
                            line-height: 1.5;
                            margin: 20px; 
                            background: white;
                        }

                        .receipt-print { 
                            max-width: 300px; 
                            margin: 0 auto; 
                            padding: 12px;
                            transform: scale(1.25);
                            transform-origin: top center;
                            margin-bottom: 50px;
                        }

                        .receipt-print .header { 
                            text-align: center; 
                            margin-bottom: 18px; 
                            border-bottom: 3px solid #000; 
                            padding-bottom: 12px; 
                        }

                        .receipt-print .header h2 {
                            font-size: 20px;
                            font-weight: bold;
                            margin: 8px 0;
                            letter-spacing: 1px;
                        }

                        .receipt-print .header p {
                            font-size: 15px;
                            margin: 5px 0;
                            line-height: 1.4;
                        }

                        .receipt-print .line { 
                            border-bottom: 2px dashed #000; 
                            margin: 10px 0; 
                        }

                        .receipt-print .row { 
                            display: flex; 
                            justify-content: space-between; 
                            align-items: flex-start;
                            margin: 8px 0; 
                            font-size: 15px;
                            line-height: 1.4;
                        }

                        .receipt-print .row.small { 
                            font-size: 14px; 
                            color: #333; 
                            margin: 4px 0; 
                            padding-left: 12px; 
                        }

                        .receipt-print .total { 
                            font-weight: bold; 
                            font-size: 18px; 
                            border-top: 2px solid #000; 
                            padding-top: 10px; 
                            margin-top: 12px; 
                        }

                        .receipt-print .item-name {
                            font-size: 15px;
                            font-weight: bold;
                            line-height: 1.4;
                            word-break: break-all;
                            flex: 1;
                            margin-right: 12px;
                        }

                        .receipt-print .item-price {
                            font-size: 15px;
                            text-align: right;
                            white-space: nowrap;
                        }

                        .receipt-print .item-details {
                            font-size: 13px;
                            color: #555;
                            margin-left: 18px;
                            line-height: 1.3;
                        }

                        .receipt-print .footer {
                            text-align: center;
                            margin-top: 18px;
                            font-size: 14px;
                            color: #666;
                            border-top: 2px dashed #000;
                            padding-top: 12px;
                        }

                        .receipt-print .refund-title {
                            color: #d32f2f !important;
                            border: 3px solid #d32f2f;
                            padding: 8px 12px;
                            margin: 12px 0;
                            border-radius: 8px;
                            background: rgba(211, 47, 47, 0.1);
                            font-size: 22px;
                        }

                        .receipt-print .refund-notice {
                            background: #ffebee;
                            border: 2px solid #d32f2f;
                            padding: 10px;
                            margin: 12px 0;
                            border-radius: 8px;
                            font-size: 16px;
                            color: #d32f2f;
                            text-align: center;
                            font-weight: bold;
                        }

                        @media print { 
                            body { 
                                margin: 0; 
                                padding: 0;
                                width: 58mm;
                                background: white;
                            }
                            .receipt-print {
                                width: 58mm;
                                max-width: none;
                                box-shadow: none;
                                border: none;
                                transform: scale(1.25);
                                transform-origin: top center;
                            }
                            .receipt-print * {
                                -webkit-print-color-adjust: exact;
                                color-adjust: exact;
                            }
                        }

                    </style>

                </head>

                <body>

                    ${receiptContent}

                    <div style="text-align: center; margin-top: 150px; padding: 30px; border-top: 1px solid #ccc;">

                        <button onclick="window.print()" style="margin: 0 10px; padding: 10px 20px; background: #17225e; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">åˆ—å°æ”¶æ“š</button>

                        <button onclick="window.close()" style="margin: 0 10px; padding: 10px 20px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">é—œé–‰</button>

                    </div>

                </body>

                </html>

            `);

            receiptWindow.document.close();

        }



        // ç”Ÿæˆæ”¶æ“šå…§å®¹

        function generateReceiptContent(saleRecord) {

            const saleDate = new Date(saleRecord.date);

            
            
            let itemsHtml = '';

            // è™•ç†å¾ Supabase è¼‰å…¥çš„è³‡æ–™æ ¼å¼
            const items = Array.isArray(saleRecord.items) ? saleRecord.items : [];
            
            items.forEach(item => {

                itemsHtml += `

                    <div class="row">

                        <span class="item-name">${item.product_name || item.name}</span>

                        <span class="item-price">NT$${(item.total_price || item.total || 0).toLocaleString()}</span>

                    </div>

                    <div class="row small">

                        <span class="item-details">è¦æ ¼ï¼š${item.product_variant || item.variant || 'ç„¡'}</span>

                    </div>

                    <div class="row small">

                        <span class="item-details">ç·¨è™Ÿï¼š${item.barcode || item.id || 'ç„¡'}</span>

                    </div>

                    <div class="row small">

                        <span class="item-details">${item.quantity} x NT$${(item.unit_price || item.price || 0).toLocaleString()}</span>

                    </div>

                    <div class="line"></div>

                `;

            });



            return `

                <div class="receipt-print">

                    <div class="header">

                        <img src="../images/æ”¶æ“šLOGO.png" alt="æ³¢æ³¢ èš æ­æ´²å®¶å±…/æ³¢è˜­é™¶é£Ÿå™¨" style="max-width: 220px; height: auto; margin: 0 auto 15px; display: block; border-radius: 4px;">

                        <p>POPO CHEERS CO., LTD.</p>

                        <p>çµ±ä¸€ç·¨è™Ÿï¼š24708167</p>

                        <p>åœ°å€ï¼šé«˜é›„å¸‚å‰é®å€æ°¸è±è·¯9è™Ÿ1æ¨“</p>

                        <p>é›»è©±ï¼š07-717-0089</p>

                    </div>

                    
                    
                    <div class="line"></div>

                    
                    
                    <div class="row">

                        <span class="item-name">æ”¶æ“šç·¨è™Ÿï¼š${saleRecord.receiptNumber}</span>

                    </div>

                    <div class="row">

                        <span class="item-name">æ—¥æœŸï¼š${saleDate.toLocaleDateString('zh-TW')}</span>

                    </div>

                    <div class="row">

                        <span class="item-name">æ™‚é–“ï¼š${saleDate.toLocaleTimeString('zh-TW')}</span>

                    </div>

                    <div class="row">

                        <span class="item-name">æ”¶éŠ€å“¡ï¼š${saleRecord.cashier}</span>

                    </div>

                    
                    
                    <div class="line"></div>

                    
                    
                    ${itemsHtml}

                    
                    
                    <div class="row">

                        <span class="item-name">å°è¨ˆ</span>

                        <span class="item-price">NT$${(saleRecord.subtotal || 0).toLocaleString()}</span>

                    </div>

                    
                    
                    ${saleRecord.member ? `

                    <div class="line"></div>

                    <div class="row">

                        <span class="item-name">æœƒå“¡è³‡è¨Š</span>

                    </div>

                    <div class="row">

                        <span class="item-name">æœƒå“¡ï¼š${saleRecord.member.name}</span>

                    </div>

                    <div class="row">

                        <span class="item-name">æœƒå“¡ç·¨è™Ÿï¼š${saleRecord.member.id}</span>

                    </div>

                    <div class="line"></div>
                    
                    ` : ''}
                    
                    


                    
                    
                    ${saleRecord.coupon ? `

                    <div class="line"></div>

                    <div class="row">

                        <span class="item-name">å„ªæƒ åˆ¸è³‡è¨Š</span>

                    </div>
                    
                    <div class="row">

                        <span class="item-name">å„ªæƒ åˆ¸ï¼š${saleRecord.coupon.code} (${saleRecord.coupon.name})</span>

                    </div>

                    <div class="row">

                        <span class="item-name">æŠ˜æ‰£é‡‘é¡</span>

                        <span class="item-price">-NT$${(saleRecord.couponDiscount || 0).toLocaleString()}</span>

                    </div>

                    <div class="line"></div>
                    
                    ` : ''}

                    


                    

                    
                    <div class="line"></div>

                    
                    
                    <div class="row total">

                        <span>ç¸½è¨ˆ</span>

                        <span>NT$${(saleRecord.total || 0).toLocaleString()}</span>

                    </div>

                    
                    
                    <div class="row">

                        <span class="item-name">ä»˜æ¬¾æ–¹å¼</span>

                        <span class="item-price">${saleRecord.paymentMethod}</span>

                    </div>

                    
                    
                    ${saleRecord.paymentMethod === 'ç¾é‡‘' ? `

                    <div class="row">

                        <span class="item-name">æ”¶åˆ°é‡‘é¡</span>

                        <span class="item-price">NT$${(saleRecord.receivedAmount || 0).toLocaleString()}</span>

                    </div>

                    <div class="row">

                        <span class="item-name">æ‰¾é›¶</span>

                        <span class="item-price">NT$${(saleRecord.change || 0).toLocaleString()}</span>

                    </div>

                    ` : ''}

                    
                    
                    <div class="line"></div>

                    
                    
                    <div class="footer">

                        <p>è¬è¬å…‰è‡¨ï¼</p>

                        <p>æ­¡è¿å†æ¬¡è’è‡¨</p>

                    </div>

                </div>

            `;

        }



        // é¡¯ç¤ºéŠ·å”®è¨˜éŒ„

        async function showSalesHistory() {
            // é‡æ–°è¼‰å…¥éŠ·å”®å’Œé€€è²¨è¨˜éŒ„
            await loadSalesHistoryFromSupabase();
            await loadRefundHistoryFromSupabase();

            if (salesHistory.length === 0 && refundHistory.length === 0) {
                alert('ç›®å‰æ²’æœ‰äº¤æ˜“è¨˜éŒ„');
                return;
            }

            let historyHtml = '<h3>äº¤æ˜“è¨˜éŒ„</h3><table border="1" cellpadding="5" cellspacing="0">';
            historyHtml += '<tr><th>å–®æ“šè™Ÿ</th><th>é¡å‹</th><th>æ—¥æœŸ</th><th>é‡‘é¡</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr>';
            
            // åˆä½µéŠ·å”®å’Œé€€è²¨è¨˜éŒ„ï¼ŒæŒ‰æ—¥æœŸæ’åº
            let allRecords = [];
            
            // æ·»åŠ éŠ·å”®è¨˜éŒ„
            for (const record of salesHistory.slice(0, 20)) {
                // æª¢æŸ¥è©²éŠ·å”®è¨˜éŒ„æ˜¯å¦æœ‰é€€è²¨ï¼ˆæ·»åŠ éŒ¯èª¤è™•ç†ï¼‰
                let hasRefund = false;
                let refundCount = 0;
                
                try {
                    const existingRefunds = await checkRefundStatus(record.id);
                    hasRefund = existingRefunds && existingRefunds.length > 0;
                    refundCount = hasRefund ? existingRefunds.length : 0;
                } catch (refundError) {
                    console.error(`æª¢æŸ¥éŠ·å”®è¨˜éŒ„ ${record.receiptNumber} é€€è²¨ç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤:`, refundError);
                    // ä¸å½±éŸ¿ä¸»è¦æµç¨‹ï¼Œè¨­ç‚ºæœªé€€è²¨
                    hasRefund = false;
                    refundCount = 0;
                }
                
                allRecords.push({
                    ...record,
                    type: 'éŠ·å”®',
                    recordType: 'sale',
                    displayNumber: record.receiptNumber,
                    displayDate: record.date,
                    displayAmount: record.total,
                    displayStatus: hasRefund ? 'å·²é€€è²¨' : 'å®Œæˆ',
                    hasRefund: hasRefund,
                    refundCount: refundCount
                });
            }
            
            // æ·»åŠ é€€è²¨è¨˜éŒ„
            refundHistory.slice(0, 20).forEach(record => {
                allRecords.push({
                    ...record,
                    type: 'é€€è²¨',
                    recordType: 'refund',
                    displayNumber: record.refundNumber,
                    displayDate: record.refundDate,
                    displayAmount: record.refundAmount,
                    displayStatus: 'å®Œæˆ'
                });
            });
            
            // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            allRecords.sort((a, b) => new Date(b.displayDate) - new Date(a.displayDate));
            
            // é¡¯ç¤ºè¨˜éŒ„
            allRecords.slice(0, 30).forEach(record => {
                const date = new Date(record.displayDate).toLocaleDateString('zh-TW');
                const amountColor = record.type === 'é€€è²¨' ? 'color: #d32f2f;' : '';
                const typeColor = record.type === 'é€€è²¨' ? 'background-color: #ffebee;' : 'background-color: #e8f5e8;';
                
                // ç‚ºå·²é€€è²¨çš„éŠ·å”®è¨˜éŒ„æ·»åŠ ç‰¹æ®Šæ¨£å¼
                let rowStyle = '';
                let statusStyle = '';
                let statusText = record.displayStatus;
                
                if (record.type === 'éŠ·å”®' && record.hasRefund) {
                    rowStyle = 'background-color: #fff3cd; border-left: 4px solid #ffc107;';
                    statusStyle = 'color: #856404; font-weight: bold;';
                    statusText = `å·²é€€è²¨ (${record.refundCount}ç­†)`;
                } else if (record.type === 'é€€è²¨') {
                    statusStyle = 'color: #d32f2f; font-weight: bold;';
                }
                
                historyHtml += `<tr style="${rowStyle}">
                    <td>${record.displayNumber}</td>
                    <td style="${typeColor}">${record.type}</td>
                    <td>${date}</td>
                    <td style="${amountColor}">NT$${record.displayAmount.toLocaleString()}</td>
                    <td style="${statusStyle}">${statusText}</td>
                    <td><button onclick="window.opener.showTransactionDetail('${record.recordType}', '${record.displayNumber}')">æŸ¥çœ‹</button></td>
                </tr>`;
            });
            
            historyHtml += '</table>';
            
            const historyWindow = window.open('', '_blank', 'width=900,height=700,scrollbars=yes');
            historyWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>äº¤æ˜“è¨˜éŒ„</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th { background-color: #f0f0f0; padding: 8px; text-align: left; }
                        td { padding: 8px; text-align: left; border: 1px solid #ddd; }
                                button { background-color: #17225e; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #1a2a6e; }
                        .refund-row { background-color: #ffebee; }
                        .sale-row { background-color: #e8f5e8; }
                    </style>
                </head>
                <body>
                    ${historyHtml}
                    <div style="margin-top: 20px;">
                        <button onclick="window.close()">é—œé–‰</button>
                    </div>
                </body>
                </html>
            `);
            historyWindow.document.close();
        }



        // æŸ¥çœ‹äº¤æ˜“è©³æƒ…ï¼ˆéŠ·å”®æˆ–é€€è²¨ï¼‰
        async function showTransactionDetail(recordType, recordNumber) {
            if (recordType === 'sale') {
                await showReceiptDetail(recordNumber);
            } else if (recordType === 'refund') {
                await showRefundDetail(recordNumber);
            }
        }

        // æŸ¥çœ‹é€€è²¨è©³æƒ…
        async function showRefundDetail(refundNumber) {
            // é‡æ–°è¼‰å…¥é€€è²¨è¨˜éŒ„ä»¥ç¢ºä¿è³‡æ–™æœ€æ–°
            await loadRefundHistoryFromSupabase();

            const record = refundHistory.find(refund => refund.refundNumber === refundNumber);

            if (record) {
                // è¼‰å…¥è©³ç´°è³‡æ–™
                const refundId = record.id;
                
                // è§£æé€€è²¨å•†å“æ˜ç´°
                try {
                    if (record.refund_items) {
                        record.items = JSON.parse(record.refund_items);
                    } else {
                        record.items = [];
                    }
                } catch (error) {
                    console.error('è§£æé€€è²¨å•†å“æ˜ç´°å¤±æ•—:', error);
                    record.items = [];
                }

                // è¼‰å…¥æœƒå“¡è³‡æ–™
                if (record.member_id) {
                    record.member = await loadMemberData(record.member_id);
                }

                // ç”Ÿæˆé€€è²¨å–®
                generateRefundReceipt(record);

            } else {
                alert('æ‰¾ä¸åˆ°å°æ‡‰çš„é€€è²¨è¨˜éŒ„');
            }
        }

        // æŸ¥çœ‹æ”¶æ“šè©³æƒ…

        async function showReceiptDetail(receiptNumber) {
            try {
                // é‡æ–°è¼‰å…¥éŠ·å”®è¨˜éŒ„ä»¥ç¢ºä¿è³‡æ–™æœ€æ–°
                await loadSalesHistoryFromSupabase();

                // å°‡ receiptNumber è½‰æ›ç‚ºæ•¸å­—é€²è¡Œæ¯”è¼ƒ
                const receiptNumberInt = parseInt(receiptNumber);
                console.log('æŸ¥æ‰¾æ”¶æ“šè™Ÿç¢¼:', receiptNumber, 'è½‰æ›ç‚º:', receiptNumberInt);
                console.log('å¯ç”¨çš„éŠ·å”®è¨˜éŒ„:', salesHistory.map(sale => sale.receiptNumber));

                // ä½¿ç”¨æ›´éˆæ´»çš„æ¯”è¼ƒé‚è¼¯
                const record = salesHistory.find(sale => 
                    sale.receiptNumber === receiptNumberInt || 
                    sale.receiptNumber === parseInt(receiptNumber) ||
                    sale.receiptNumber.toString() === receiptNumber.toString()
                );

            if (record) {
                    console.log('æ‰¾åˆ°éŠ·å”®è¨˜éŒ„:', record);
                    // è¼‰å…¥è©³ç´°è³‡æ–™
                    const saleId = record.id || record.receiptNumber;
                    
                    // è¼‰å…¥éŠ·å”®é …ç›®
                    const items = await loadSalesItems(saleId);
                    record.items = items;

                    // è¼‰å…¥æœƒå“¡è³‡æ–™
                    if (record.member_id) {
                        record.member = await loadMemberData(record.member_id);
                    }

                    // è¼‰å…¥å„ªæƒ åˆ¸è³‡æ–™
                    if (record.coupon_id) {
                        record.coupon = await loadCouponData(record.coupon_id);
                    }

                    // æª¢æŸ¥æ˜¯å¦æœ‰é€€è²¨è¨˜éŒ„ï¼ˆæ·»åŠ éŒ¯èª¤è™•ç†ï¼‰
                    try {
                        const existingRefunds = await checkRefundStatus(record.id);
                        if (existingRefunds && existingRefunds.length > 0) {
                            record.hasRefund = true;
                            record.refunds = existingRefunds;
                        }
                    } catch (refundError) {
                        console.error('æª¢æŸ¥é€€è²¨ç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤:', refundError);
                        // ä¸å½±éŸ¿ä¸»è¦æµç¨‹ï¼Œç¹¼çºŒé¡¯ç¤ºéŠ·å”®æ”¶æ“š
                        record.hasRefund = false;
                        record.refunds = [];
                    }

                showReceipt(record);

                } else {
                    console.error('æ‰¾ä¸åˆ°éŠ·å”®è¨˜éŒ„ï¼Œè©³ç´°è³‡è¨Š:');
                    console.error('æŸ¥æ‰¾çš„æ”¶æ“šè™Ÿç¢¼:', receiptNumber, 'é¡å‹:', typeof receiptNumber);
                    console.error('è½‰æ›å¾Œçš„è™Ÿç¢¼:', receiptNumberInt, 'é¡å‹:', typeof receiptNumberInt);
                    console.error('æ‰€æœ‰å¯ç”¨çš„æ”¶æ“šè™Ÿç¢¼:', salesHistory.map(sale => ({ 
                        receiptNumber: sale.receiptNumber, 
                        type: typeof sale.receiptNumber 
                    })));
                    
                    // å˜—è©¦å‚™ç”¨æŸ¥æ‰¾æ–¹æ³•
                    const backupRecord = salesHistory.find(sale => 
                        sale.receiptNumber.toString() === receiptNumber.toString()
                    );
                    
                    if (backupRecord) {
                        console.log('ä½¿ç”¨å‚™ç”¨æ–¹æ³•æ‰¾åˆ°è¨˜éŒ„:', backupRecord);
                        // éæ­¸èª¿ç”¨ï¼Œä½†ä½¿ç”¨æ­£ç¢ºçš„æ•¸å­—æ ¼å¼
                        await showReceiptDetail(backupRecord.receiptNumber.toString());
                        return;
                    }
                    
                    alert('æ‰¾ä¸åˆ°å°æ‡‰çš„éŠ·å”®è¨˜éŒ„');
                }
            } catch (error) {
                console.error('é¡¯ç¤ºæ”¶æ“šè©³æƒ…æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                alert('é¡¯ç¤ºæ”¶æ“šè©³æƒ…æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦');
            }
        }



        // ä»Šæ—¥éŠ·å”®çµ±è¨ˆ

        function getTodayStatistics() {

            const today = new Date().toDateString();

            const todaySales = salesHistory.filter(sale => 

                new Date(sale.date).toDateString() === today

            );

            
            
            const todayTotal = todaySales.reduce((sum, sale) => sum + sale.total, 0);

            const todayCount = todaySales.length;

            
            
            return {

                count: todayCount,

                total: todayTotal,

                sales: todaySales

            };

        }



        // æ¸…ç©ºè³¼ç‰©è»Šï¼ˆæ”¹é€²ç‰ˆï¼‰

        function clearCart() {

            if (cart.length > 0) {

                if (confirm('ç¢ºå®šè¦æ¸…ç©ºè³¼ç‰©è»Šå—ï¼Ÿ')) {

                    cart = [];
                    
                    // æ¸…ç©ºæ‰€æœ‰æŠ˜æ‰£
                    appliedDiscounts = [];
                    updateDiscountDisplay();

                    updateCartDisplay();

                    updateCartItemCount();
                    alert('è³¼ç‰©è»Šå·²æ¸…ç©º');

                }

            } else {

                alert('è³¼ç‰©è»Šå·²ç¶“æ˜¯ç©ºçš„');

            }

        }



        // æ›´æ–°è³¼ç‰©è»Šå•†å“æ•¸é‡é¡¯ç¤º

        function updateCartItemCount() {

            const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);

            const cartItemCountElement = document.getElementById('cartItemCount');
            if (cartItemCountElement) {
                cartItemCountElement.textContent = `å…± ${itemCount} é …å•†å“`;
            }

        }



        // é‡å¯«æ›´æ–°è³¼ç‰©è»Šé¡¯ç¤ºåŠŸèƒ½

        function updateCartDisplay() {

            const cartContainer = document.getElementById('cartItems');
            if (!cartContainer) return;



            if (cart.length === 0) {

                cartContainer.innerHTML = `

                    <div class="text-center text-gray-500 py-8">

                        <i class="fas fa-shopping-cart text-4xl mb-2"></i>

                        <p>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>

                        <p class="text-sm">æƒæå•†å“æ¢ç¢¼æˆ–é¸æ“‡ç†±éŠ·å•†å“é–‹å§‹éŠ·å”®</p>

                    </div>

                `;

                updateTotals();

                updateCartItemCount();

                return;

            }



            cartContainer.innerHTML = cart.map((item, index) => {
                const hasDiscount = item.originalPrice && item.originalPrice > item.price;
                const discountAmount = hasDiscount ? item.originalPrice - item.price : 0;
                const discountPercentage = hasDiscount ? Math.round((discountAmount / item.originalPrice) * 100) : 0;
                
                return `
                    <div class="flex items-center space-x-4 p-4 border border-gray-200 rounded-lg ${hasDiscount ? 'bg-green-50 border-green-200' : ''}">
                    <img src="${item.image}" alt="${item.name}" class="w-16 h-16 rounded-lg object-cover">

                    <div class="flex-1">

                        <h4 class="font-semibold text-gray-800">${item.name}</h4>

                        <p class="text-sm text-[#17225e] font-medium">è¦æ ¼ï¼š${item.variant}</p>

                        <p class="text-sm text-gray-600">æ¢ç¢¼ï¼š${item.barcode}</p>

                        <p class="text-sm text-gray-500">å•†å“ç·¨è™Ÿï¼š${item.id}</p>

                        <p class="text-sm ${item.stock <= 10 ? 'text-red-500' : 'text-gray-500'}">

                            åº«å­˜ï¼š${item.stock} ä»¶${item.stock <= 10 ? 'ï¼ˆä½åº«å­˜ï¼‰' : ''}

                            </p>
                            ${hasDiscount ? `
                            <div class="mt-2 p-2 bg-green-100 rounded-lg">
                                <p class="text-sm text-green-800 font-medium">
                                    <i class="fas fa-tag mr-1"></i>æŠ˜æ‰£ ${discountPercentage}% (-NT$${discountAmount.toLocaleString()})
                        </p>

                    </div>
                            ` : ''}
                    </div>

                    <div class="flex items-center space-x-3">

                        <button class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200" onclick="changeQuantity(${index}, -1)">

                            <i class="fas fa-minus text-sm"></i>

                        </button>

                        <span class="font-semibold w-8 text-center">${item.quantity}</span>

                        <button class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200" onclick="changeQuantity(${index}, 1)">

                            <i class="fas fa-plus text-sm"></i>

                        </button>

                    </div>

                    <div class="text-right">

                            ${hasDiscount ? `
                            <p class="text-sm text-gray-500 line-through">åŸåƒ¹ï¼šNT$${item.originalPrice.toLocaleString()}</p>
                            <p class="text-sm text-green-600 font-medium">æŠ˜æ‰£åƒ¹ï¼šNT$${item.price.toLocaleString()}</p>
                            ` : `
                        <p class="text-sm text-gray-600">å–®åƒ¹ï¼šNT$${item.price.toLocaleString()}</p>

                            `}
                        <p class="font-bold text-orange-600">NT$${(item.total || 0).toLocaleString()}</p>

                    </div>

                    <button class="text-red-500 hover:text-red-700 p-2" onclick="removeFromCart(${index})">

                        <i class="fas fa-trash"></i>

                    </button>

                </div>

                `;
            }).join('');


            updateTotals();

            updateCartItemCount();

        }







        // æª¢æŸ¥ç•¶å‰å“¡å·¥

        function checkCurrentEmployee() {

            const savedEmployee = localStorage.getItem('currentEmployee');

            if (savedEmployee) {

                const employee = JSON.parse(savedEmployee);

                document.getElementById('currentCashier').textContent = employee.name;

                return employee;

            }

            return null;

        }

        // ç²å–ç•¶å‰å“¡å·¥å§“å

        function getCurrentEmployeeName() {

            const employee = checkCurrentEmployee();

            return employee ? employee.name : 'æœªç™»å…¥';

        }

        // ç²å–ç•¶å‰å“¡å·¥ID

        function getCurrentEmployeeId() {

            const employee = checkCurrentEmployee();

            return employee ? employee.id : null;

        }



        // é é¢åˆå§‹åŒ–

        document.addEventListener('DOMContentLoaded', function() {

            updateCartDisplay();

            updateCartItemCount();

            updateMemberDisplay();

            checkCurrentEmployee();

            
            
            // ç”Ÿæˆæ–°è¨‚å–®ç·¨è™Ÿ

            const now = new Date();

            const orderNum = now.getFullYear().toString() + 

                           (now.getMonth() + 1).toString().padStart(2, '0') + 

                           now.getDate().toString().padStart(2, '0') + 

                           Math.floor(Math.random() * 100).toString().padStart(2, '0');

            document.getElementById('orderNumber').textContent = orderNum;
            
            // å°‡è¨‚å–®ç·¨è™Ÿå­˜å„²åˆ°å…¨å±€è®Šé‡ï¼Œä¾›æ”¶æ“šç”Ÿæˆä½¿ç”¨
            window.currentOrderNumber = orderNum;

            



            

            

        });



        // çµ±ä¸€å°èˆªå‡½æ•¸

        function navigateToPage(page) {

            try {

                // å˜—è©¦èˆ‡çˆ¶é é¢é€šä¿¡åˆ‡æ›iframe

                if (window.parent && window.parent !== window) {

                    window.parent.postMessage({

                        type: 'navigate',

                        page: page

                    }, '*');

                } else {

                    // å¦‚æœä¸åœ¨iframeä¸­ï¼Œç›´æ¥è·³è½‰

                    window.location.href = `${page}.html`;

                }

            } catch (error) {

                // å‚™ç”¨æ–¹æ¡ˆï¼šåœ¨æ–°åˆ†é ä¸­é–‹å•Ÿ

                window.open(`${page}.html`, '_blank');

            }

        }



        



        // å›åˆ°ä¸»é é¢

        function goBackToMenu() {

            window.location.href = '../index.html';

        }

        // æ¸¬è©¦çµå¸³ä¸Šå‚³åŠŸèƒ½
        async function testCheckoutUpload() {
            try {
                if (!supabase) {
                    const initSuccess = await initSupabase();
                    if (!initSuccess) {
                        alert('Supabase åˆå§‹åŒ–å¤±æ•—');
                        return;
                    }
                }

                console.log('é–‹å§‹æ¸¬è©¦çµå¸³ä¸Šå‚³åŠŸèƒ½...');

                // æ¨¡æ“¬è³¼ç‰©è»Šè³‡æ–™
                const testCart = [
                    {
                        name: 'æ¸¬è©¦å•†å“1',
                        variant: 'ç´…è‰²',
                        barcode: 'TEST001',
                        price: 100,
                        quantity: 2,
                        total: 200,
                        discountAmount: 0,
                        discountPercentage: 0
                    },
                    {
                        name: 'æ¸¬è©¦å•†å“2',
                        variant: 'è—è‰²',
                        barcode: 'TEST002',
                        price: 150,
                        quantity: 1,
                        total: 150,
                        discountAmount: 0,
                        discountPercentage: 0
                    }
                ];

                // ç”Ÿæˆå”¯ä¸€æ”¶æ“šè™Ÿç¢¼
                const uniqueReceiptNumber = await generateUniqueReceiptNumber();
                if (!uniqueReceiptNumber) {
                    alert('ç„¡æ³•ç”Ÿæˆæ”¶æ“šè™Ÿç¢¼ï¼Œæ¸¬è©¦å¤±æ•—');
                    return;
                }

                // å‰µå»ºæ¸¬è©¦éŠ·å”®è¨˜éŒ„
                const testSaleRecord = {
                    receiptNumber: uniqueReceiptNumber,
                    date: new Date().toISOString(),
                    items: testCart,
                    subtotal: 350,
                    memberDiscount: 0,
                    couponDiscount: 0,
                    tax: 0,
                    total: 350,
                    paymentMethod: 'ç¾é‡‘',
                    receivedAmount: 400,
                    change: 50,
                    cashier: getCurrentEmployeeName(),
                    member: null,
                    coupon: null
                };

                console.log('æ¸¬è©¦éŠ·å”®è¨˜éŒ„:', testSaleRecord);

                // ä¸Šå‚³æ¸¬è©¦è¨˜éŒ„
                const success = await uploadSalesRecordToSupabase(testSaleRecord);
                
                if (success) {
                    alert(`æ¸¬è©¦çµå¸³ä¸Šå‚³æˆåŠŸï¼\næ”¶æ“šè™Ÿç¢¼ï¼š${uniqueReceiptNumber}\nç¸½é‡‘é¡ï¼šNT$${testSaleRecord.total}\nè«‹æª¢æŸ¥ Supabase è³‡æ–™åº«ç¢ºèªè¨˜éŒ„å·²å»ºç«‹ã€‚`);
                    
                    // é‡æ–°è¼‰å…¥éŠ·å”®è¨˜éŒ„
                    await loadSalesHistoryFromSupabase();
                    console.log('éŠ·å”®è¨˜éŒ„å·²é‡æ–°è¼‰å…¥');
                } else {
                    alert('æ¸¬è©¦çµå¸³ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤è¨Šæ¯ã€‚');
                }
            } catch (error) {
                console.error('æ¸¬è©¦çµå¸³ä¸Šå‚³æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                alert(`æ¸¬è©¦çµå¸³ä¸Šå‚³æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
            }
        }

        // åŸºæœ¬æœƒå“¡æŸ¥è©¢æ¸¬è©¦
        async function testBasicMemberQuery() {
            try {
                if (!supabase) {
                    const initSuccess = await initSupabase();
                    if (!initSuccess) {
                        alert('Supabase åˆå§‹åŒ–å¤±æ•—');
                        return;
                    }
                }

                console.log('é–‹å§‹æ¸¬è©¦æœƒå“¡æŸ¥è©¢...');

                // æ¸¬è©¦æŸ¥è©¢æœƒå“¡è³‡æ–™è¡¨
                const { data: members, error } = await supabase
                    .from('members')
                    .select('*')
                    .limit(5);

                console.log('æœƒå“¡æŸ¥è©¢çµæœ:', members, error);

                if (error) {
                    console.error('æœƒå“¡æŸ¥è©¢éŒ¯èª¤:', error);
                    alert(`æœƒå“¡æŸ¥è©¢æ¸¬è©¦å¤±æ•—: ${error.message}\n\néŒ¯èª¤è©³æƒ…: ${JSON.stringify(error, null, 2)}`);
                } else {
                    if (members && members.length > 0) {
                        let memberList = 'æ‰¾åˆ°ä»¥ä¸‹æœƒå“¡ï¼š\n\n';
                        members.forEach((member, index) => {
                            memberList += `${index + 1}. ID: ${member.id} (é¡å‹: ${typeof member.id})\n   å§“å: ${member.name}\n   é›»è©±: ${member.phone}\n   é›»å­éƒµä»¶: ${member.email || 'ç„¡'}\n   åœ°å€: ${member.address || 'ç„¡'}\n\n`;
                        });
                        alert(memberList);
                    } else {
                        alert('æœƒå“¡è³‡æ–™è¡¨ä¸­æ²’æœ‰è³‡æ–™ï¼Œè«‹å…ˆåœ¨æœƒå“¡ç®¡ç†é é¢æ–°å¢æœƒå“¡ã€‚');
                    }
                }
            } catch (error) {
                console.error('æ¸¬è©¦æœƒå“¡æŸ¥è©¢æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                alert(`æ¸¬è©¦æœƒå“¡æŸ¥è©¢æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}\n\néŒ¯èª¤è©³æƒ…: ${JSON.stringify(error, null, 2)}`);
            }
        }

    </script>

</body>

</html> 