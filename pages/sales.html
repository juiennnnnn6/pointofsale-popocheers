<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>銷售作業</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../employee-auth.js"></script>
    <script src="auth-check.js"></script>

    <script>
        // 簡單的認證檢查測試
        console.log('=== sales.html 腳本載入測試 ===');
        console.log('employee-auth.js 是否載入:', typeof EmployeeAuth !== 'undefined');
        console.log('auth-check.js 是否載入:', typeof checkAuthentication !== 'undefined');
        
        // 檢查掃描功能是否載入
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (typeof window.quickScan !== 'function') {
                    window.quickScan = function(onSuccess, onError) {
                        const barcode = prompt('請輸入條碼號碼進行銷售');
                        if (barcode) {
                            onSuccess(barcode);
                        } else if (onError) {
                            onError(new Error('用戶取消輸入'));
                        }
                    };
                }
            }, 1000);
        });
    </script>
    <style>
        .apple-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .pos-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-family: 'Courier New', monospace;
        }
        .scan-display {
            background: linear-gradient(45deg, #f59e0b, #d97706);
            position: relative;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-red-100 min-h-screen p-4 pb-24">
    
    <!-- 頂部操作區 -->
    <div class="mb-6">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">銷售作業</h1>
                <p class="text-gray-600">輸入條碼進行快速銷售和結帳（已移除攝像頭，使用純手動輸入）</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="goBackToMenu()" class="bg-purple-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-600 transition-colors">
                    <i class="fas fa-th-large mr-2"></i>回選單
                </button>
                <button class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-600 transition-colors">
                    <i class="fas fa-credit-card mr-2"></i>結帳
                </button>
                <button onclick="clearCart()" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600 transition-colors">
                    <i class="fas fa-times mr-2"></i>清空
                </button>
                <button onclick="showSalesHistory()" class="bg-gray-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-600 transition-colors">
                    <i class="fas fa-history mr-2"></i>銷售記錄
                </button>
                <button onclick="printSalesReceipt()" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-colors">
                    <i class="fas fa-print mr-2"></i>列印明細
                </button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
        
        <!-- 左側：POS顯示器和快速操作 -->
        <div class="xl:col-span-1">
            
            <!-- POS 顯示器 -->
            <div class="pos-display rounded-xl p-6 mb-6 shadow-lg">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-bold">零售POS系統</h3>
                    <p class="text-sm opacity-90">歡迎光臨</p>
                </div>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>訂單編號：</span>
                        <span id="orderNumber">2024122401</span>
                    </div>
                    <div class="flex justify-between">
                        <span>收銀員：</span>
                        <span id="currentCashier">管理員</span>
                    </div>
                    <div class="flex justify-between">
                        <span>時間：</span>
                        <span id="currentTime"></span>
                    </div>
                    <div id="currentMemberInfo" class="hidden">
                        <hr class="my-2 border-white border-opacity-30">
                        <div class="flex justify-between">
                            <span>會員：</span>
                            <span id="memberName"></span>
                        </div>
                        <div class="flex justify-between">
                            <span>等級：</span>
                            <span id="memberLevel"></span>
                        </div>
                        <div class="flex justify-between">
                            <span>積分：</span>
                            <span id="memberPoints"></span>
                        </div>
                    </div>
                    <hr class="my-4 border-white border-opacity-30">
                    <div class="flex justify-between text-lg font-bold">
                        <span>總計：</span>
                        <span id="totalAmount">NT$0</span>
                    </div>
                </div>
            </div>

                            <!-- 條碼功能區 -->
            <div class="apple-card rounded-xl p-6 mb-6 shadow-lg">
                                    <h3 class="text-lg font-semibold text-gray-800 mb-4">條碼功能</h3>
                <div class="scan-display rounded-lg h-40 flex items-center justify-center text-white mb-4">
                    <div class="text-center">
                        <i class="fas fa-barcode text-3xl mb-2"></i>
                        <p class="font-medium">條碼掃描功能</p>
                    </div>
                </div>
                <input type="text" id="salesBarcodeInput" placeholder="手動輸入條碼或商品名稱" 
                       class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
            </div>

            <!-- 快速功能 -->
            <div class="apple-card rounded-xl p-6 shadow-lg">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">快速功能</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button id="discountBtn" class="flex flex-col items-center p-3 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">
                        <i class="fas fa-percentage text-blue-500 mb-1"></i>
                        <span class="text-xs">折扣</span>
                    </button>
                    <button id="couponBtn" class="flex flex-col items-center p-3 bg-green-50 rounded-lg hover:bg-green-100 transition-colors">
                        <i class="fas fa-gift text-green-500 mb-1"></i>
                        <span class="text-xs">優惠券</span>
                    </button>
                    <button id="memberBtn" class="flex flex-col items-center p-3 bg-purple-50 rounded-lg hover:bg-purple-100 transition-colors relative">
                        <i class="fas fa-user text-purple-500 mb-1"></i>
                        <span class="text-xs" id="memberBtnText">會員</span>
                        <div id="memberStatusDot" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                    </button>
                    <button id="refundBtn" class="flex flex-col items-center p-3 bg-red-50 rounded-lg hover:bg-red-100 transition-colors">
                        <i class="fas fa-undo text-red-500 mb-1"></i>
                        <span class="text-xs">退貨</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 右側：購物車和商品 -->
        <div class="xl:col-span-2">
            
            <!-- 購物車 -->
            <div class="apple-card rounded-xl p-6 mb-6 shadow-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">購物車</h3>
                    <span class="text-sm text-gray-600">共 3 項商品</span>
                </div>

                <div class="space-y-4">
                    
                    <!-- 購物車項目 1 -->
                    <div class="flex items-center space-x-4 p-4 border border-gray-200 rounded-lg">
                        <img src="https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=60&h=60&fit=crop&crop=center" 
                             alt="Nike Air Max" class="w-16 h-16 rounded-lg object-cover">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">Nike Air Max 270</h4>
                            <p class="text-sm text-gray-600">條碼：1234567890123</p>
                            <p class="text-sm text-gray-500">庫存：48 件</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200">
                                <i class="fas fa-minus text-sm"></i>
                            </button>
                            <span class="font-semibold w-8 text-center">2</span>
                            <button class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200">
                                <i class="fas fa-plus text-sm"></i>
                            </button>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">單價：NT$3,200</p>
                            <p class="font-bold text-orange-600">NT$6,400</p>
                        </div>
                        <button class="text-red-500 hover:text-red-700 p-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>

                    <!-- 購物車項目 2 -->
                    <div class="flex items-center space-x-4 p-4 border border-gray-200 rounded-lg">
                        <img src="https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=60&h=60&fit=crop&crop=center" 
                             alt="Apple Watch" class="w-16 h-16 rounded-lg object-cover">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">Apple Watch Series 9</h4>
                            <p class="text-sm text-gray-600">條碼：2345678901234</p>
                            <p class="text-sm text-red-500">庫存：3 件（低庫存）</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200">
                                <i class="fas fa-minus text-sm"></i>
                            </button>
                            <span class="font-semibold w-8 text-center">1</span>
                            <button class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200">
                                <i class="fas fa-plus text-sm"></i>
                            </button>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">單價：NT$12,900</p>
                            <p class="font-bold text-orange-600">NT$12,900</p>
                        </div>
                        <button class="text-red-500 hover:text-red-700 p-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>

                    <!-- 購物車項目 3 -->
                    <div class="flex items-center space-x-4 p-4 border border-gray-200 rounded-lg">
                        <img src="https://images.unsplash.com/photo-1572635196237-14b3f281503f?w=60&h=60&fit=crop&crop=center" 
                             alt="Ray-Ban" class="w-16 h-16 rounded-lg object-cover">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">Ray-Ban 太陽眼鏡</h4>
                            <p class="text-sm text-gray-600">條碼：6789012345678</p>
                            <p class="text-sm text-gray-500">庫存：12 件</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200">
                                <i class="fas fa-minus text-sm"></i>
                            </button>
                            <span class="font-semibold w-8 text-center">1</span>
                            <button class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200">
                                <i class="fas fa-plus text-sm"></i>
                            </button>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">單價：NT$5,200</p>
                            <p class="font-bold text-orange-600">NT$5,200</p>
                        </div>
                        <button class="text-red-500 hover:text-red-700 p-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>

                <!-- 優惠券輸入區 -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center mb-3">
                            <i class="fas fa-ticket-alt text-yellow-600 mr-2"></i>
                            <span class="font-medium text-gray-800">優惠券</span>
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="couponInput" placeholder="輸入優惠券代碼" 
                                   class="flex-1 px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-sm">
                            <button onclick="applyCoupon()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors text-sm">
                                <i class="fas fa-check mr-1"></i>
                                套用
                            </button>
                            <button onclick="scanCoupon()" class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                                <i class="fas fa-qrcode"></i>
                            </button>
                        </div>
                        <div id="appliedCoupon" class="mt-3 hidden">
                            <div class="flex items-center justify-between bg-green-50 border border-green-200 rounded-lg p-3">
                                <div class="flex items-center">
                                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                    <div>
                                        <span class="font-medium text-green-800" id="appliedCouponName"></span>
                                        <p class="text-xs text-green-600" id="appliedCouponDesc"></p>
                                    </div>
                                </div>
                                <button onclick="removeCoupon()" class="text-green-600 hover:text-green-800">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 優惠和總計 -->
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">小計：</span>
                            <span id="subtotalAmount">NT$0</span>
                        </div>
                        <div class="flex justify-between text-sm" id="memberDiscountRow" style="display: none;">
                            <span class="text-gray-600">會員折扣：</span>
                            <span class="text-green-600" id="memberDiscountAmount">-NT$0</span>
                        </div>
                        <div class="flex justify-between text-sm" id="couponDiscountRow" style="display: none;">
                            <span class="text-gray-600">優惠券折扣：</span>
                            <span class="text-orange-600" id="couponDiscountAmount">-NT$0</span>
                        </div>

                        <hr class="border-gray-200">
                        <div class="flex justify-between text-xl font-bold">
                            <span>總計：</span>
                            <span id="totalAmount" class="text-orange-600">NT$0</span>
                        </div>
                    </div>

                    <!-- 其他操作按鈕 -->
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <button onclick="clearCart()" class="bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition-colors text-sm">
                            <i class="fas fa-trash mr-2"></i>清空購物車
                        </button>
                        <button onclick="showSalesHistory()" class="bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600 transition-colors text-sm">
                            <i class="fas fa-history mr-2"></i>銷售記錄
                        </button>
                    </div>
                </div>
            </div>

            <!-- 熱銷商品快捷選擇 -->
            <div class="apple-card rounded-xl p-6 shadow-lg">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">熱銷商品</h3>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    
                    <button onclick="addHotProduct('1234567890123')" class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left">
                        <img src="https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=80&h=60&fit=crop&crop=center" 
                             alt="Nike" class="w-full h-16 object-cover rounded mb-2">
                        <p class="text-sm font-medium text-gray-800">Nike Air Max</p>
                        <p class="text-xs text-gray-600">NT$3,200</p>
                    </button>

                    <button onclick="addHotProduct('2345678901234')" class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left">
                        <img src="https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=80&h=60&fit=crop&crop=center" 
                             alt="Apple Watch" class="w-full h-16 object-cover rounded mb-2">
                        <p class="text-sm font-medium text-gray-800">Apple Watch</p>
                        <p class="text-xs text-gray-600">NT$12,900</p>
                    </button>

                    <button onclick="addHotProduct('3456789012345')" class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left">
                        <img src="https://images.unsplash.com/photo-1434056886845-dac89ffe9b56?w=80&h=60&fit=crop&crop=center" 
                             alt="Samsung" class="w-full h-16 object-cover rounded mb-2">
                        <p class="text-sm font-medium text-gray-800">Samsung Galaxy</p>
                        <p class="text-xs text-gray-600">NT$28,900</p>
                    </button>

                    <button class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left">
                        <img src="https://images.unsplash.com/photo-1572635196237-14b3f281503f?w=80&h=60&fit=crop&crop=center" 
                             alt="Ray-Ban" class="w-full h-16 object-cover rounded mb-2">
                        <p class="text-sm font-medium text-gray-800">Ray-Ban</p>
                        <p class="text-xs text-gray-600">NT$5,200</p>
                    </button>
                </div>
                        </div>
        </div>
    </div>

    <!-- 底部結帳按鈕區 -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 z-40">
        <div class="max-w-7xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <button onclick="checkout('現金')" class="bg-green-500 text-white py-4 rounded-lg hover:bg-green-600 transition-colors font-semibold text-lg">
                    <i class="fas fa-money-bill mr-2"></i>現金結帳
                </button>
                <button onclick="checkout('信用卡')" class="bg-blue-500 text-white py-4 rounded-lg hover:bg-blue-600 transition-colors font-semibold text-lg">
                    <i class="fas fa-credit-card mr-2"></i>信用卡結帳
                </button>
                <button onclick="checkout('行動支付')" class="bg-purple-500 text-white py-4 rounded-lg hover:bg-purple-600 transition-colors font-semibold text-lg">
                    <i class="fas fa-mobile-alt mr-2"></i>行動支付結帳
                </button>
            </div>
        </div>
    </div>

    <!-- 商品選擇彈出視窗 -->
    <div id="productSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">選擇商品小項</h3>
                <button onclick="closeProductSelectionModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-info-circle text-yellow-600 mr-2"></i>
                    <span class="text-sm text-yellow-800">此條碼對應多個商品小項，請選擇正確的商品：</span>
                </div>
                <div class="mt-2 text-sm text-gray-600">
                    條碼：<span id="modalBarcode" class="font-mono bg-gray-100 px-2 py-1 rounded"></span>
                </div>
            </div>
            
            <div id="productVariantsList" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- 商品小項將動態添加到這裡 -->
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeProductSelectionModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                    取消
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // 會員數據庫（模擬）
        const membersDatabase = {
            'M001': {
                id: 'M001',
                name: '王小明',
                phone: '0912-345-678',
                email: 'wang@example.com',
                level: '金卡',
                points: 2850,
                totalSpent: 45280,
                status: 'active',
                discount: 0.1 // 10% 折扣
            },
            'M002': {
                id: 'M002',
                name: '李美華',
                phone: '0987-654-321',
                email: 'li@example.com',
                level: '白金',
                points: 5420,
                totalSpent: 78965,
                status: 'active',
                discount: 0.15 // 15% 折扣
            },
            'M003': {
                id: 'M003',
                name: '張志偉',
                phone: '0923-456-789',
                email: 'zhang@example.com',
                level: '銀卡',
                points: 1250,
                totalSpent: 23400,
                status: 'active',
                discount: 0.05 // 5% 折扣
            },
            'M004': {
                id: 'M004',
                name: '陳雅琪',
                phone: '0934-567-890',
                email: 'chen@example.com',
                level: '鑽石',
                points: 8750,
                totalSpent: 125000,
                status: 'active',
                discount: 0.2 // 20% 折扣
            },
            'M005': {
                id: 'M005',
                name: '林建華',
                phone: '0945-678-901',
                email: 'lin@example.com',
                level: '普通',
                points: 380,
                totalSpent: 5600,
                status: 'active',
                discount: 0.02 // 2% 折扣
            }
        };

        // 手機號碼對應會員ID的查詢表
        const phoneToMemberMap = {
            '0912-345-678': 'M001',
            '0912345678': 'M001',
            '0987-654-321': 'M002',
            '0987654321': 'M002',
            '0923-456-789': 'M003',
            '0923456789': 'M003',
            '0934-567-890': 'M004',
            '0934567890': 'M004',
            '0945-678-901': 'M005',
            '0945678901': 'M005'
        };

        // 波波 聚 歐洲家居/波蘭陶食器商品數據庫（支援同條碼多商品小項）
        const mockProducts = {
            '1234567890123': [  // 歐式骨瓷餐盤系列
                {
                    id: 'P001-01',
                    name: '歐式骨瓷餐盤',
                    variant: '20cm 白色經典款',
                    price: 890,
                    stock: 15,
                    category: '餐具',
                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',
                    status: 'normal',
                    description: '純白骨瓷，經典歐式設計'
                },
                {
                    id: 'P001-02',
                    name: '歐式骨瓷餐盤',
                    variant: '20cm 藍花圖案款',
                    price: 950,
                    stock: 8,
                    category: '餐具',
                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',
                    status: 'normal',
                    description: '手繪藍花圖案，精緻工藝'
                },
                {
                    id: 'P001-03',
                    name: '歐式骨瓷餐盤',
                    variant: '20cm 金邊奢華款',
                    price: 1280,
                    stock: 5,
                    category: '餐具',
                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',
                    status: 'normal',
                    description: '24K金邊裝飾，奢華典雅'
                }
            ],
            '2345678901234': [  // 水晶酒杯系列
                {
                    id: 'P002-01',
                    name: '施華洛世奇水晶酒杯',
                    variant: '紅酒杯 300ml',
                    price: 2890,
                    stock: 12,
                    category: '酒具',
                    image: 'https://images.unsplash.com/photo-1509669803555-fd5c49448db3?w=60&h=60&fit=crop&crop=center',
                    status: 'normal',
                    description: '奧地利水晶，完美酒杯弧度'
                },
                {
                    id: 'P002-02',
                    name: '施華洛世奇水晶酒杯',
                    variant: '香檳杯 200ml',
                    price: 2590,
                    stock: 18,
                    category: '酒具',
                    image: 'https://images.unsplash.com/photo-1509669803555-fd5c49448db3?w=60&h=60&fit=crop&crop=center',
                    status: 'normal',
                    description: '細長杯身，保持氣泡完美'
                }
            ],
            '3456789012345': [  // 家居擺飾系列
                {
                    id: 'P003-01',
                    name: '北歐風陶瓷花瓶',
                    variant: '小號 15cm 灰色',
                    price: 680,
                    stock: 25,
                    category: '擺飾',
                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',
                    status: 'normal',
                    description: '簡約北歐設計，啞光質感'
                },
                {
                    id: 'P003-02',
                    name: '北歐風陶瓷花瓶',
                    variant: '中號 25cm 白色',
                    price: 980,
                    stock: 15,
                    category: '擺飾',
                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',
                    status: 'normal',
                    description: '純白陶瓷，中性百搭'
                },
                {
                    id: 'P003-03',
                    name: '北歐風陶瓷花瓶',
                    variant: '大號 35cm 黑色',
                    price: 1380,
                    stock: 8,
                    category: '擺飾',
                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',
                    status: 'normal',
                    description: '黑色啞光，現代藝術感'
                }
            ],
            '4567890123456': [  // 茶具系列
                {
                    id: 'P004-01',
                    name: '英式骨瓷茶杯組',
                    variant: '經典玫瑰圖案',
                    price: 1590,
                    stock: 0,
                    category: '茶具',
                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',
                    status: 'out',
                    description: '傳統英式下午茶茶杯'
                }
            ],
            '5678901234567': [  // 餐具套裝
                {
                    id: 'P005-01',
                    name: '法式餐具套裝',
                    variant: '4人份基礎款',
                    price: 3890,
                    stock: 6,
                    category: '餐具',
                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',
                    status: 'normal',
                    description: '包含餐盤、湯碗、茶杯'
                },
                {
                    id: 'P005-02',
                    name: '法式餐具套裝',
                    variant: '4人份豪華款',
                    price: 5890,
                    stock: 3,
                    category: '餐具',
                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',
                    status: 'low',
                    description: '包含餐盤、湯碗、茶杯、甜點盤'
                }
            ],
            '6789012345678': [  // 廚房用品
                {
                    id: 'P006-01',
                    name: '德國不鏽鋼廚具',
                    variant: '基礎3件組',
                    price: 2200,
                    stock: 12,
                    category: '廚具',
                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=60&h=60&fit=crop&crop=center',
                    status: 'normal',
                    description: '湯勺、漏勺、鏟子'
                }
            ]
        };

        // 購物車
        let cart = [];
        
        // 當前登入會員
        let currentMember = null;
        
        // 當前優惠券
        let currentCoupon = null;

        // 更新當前時間
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('zh-TW');
        }
        updateTime();
        setInterval(updateTime, 1000);

        // 初始化事件監聽
        document.addEventListener('DOMContentLoaded', function() {
            const barcodeInput = document.getElementById('salesBarcodeInput');
            
            // 載入優惠券功能
            loadCouponFunctions();

            // 手動輸入條碼事件
            barcodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const barcode = this.value.trim();
                    if (barcode) {
                        searchAndAddProduct(barcode);
                        this.value = '';
                    }
                }
            });

            // 快速功能事件監聽
            document.getElementById('discountBtn').addEventListener('click', applyDiscount);
            document.getElementById('couponBtn').addEventListener('click', applyCoupon);
            document.getElementById('memberBtn').addEventListener('click', manageMember);
            document.getElementById('refundBtn').addEventListener('click', processRefund);

            // 初始化購物車顯示
            updateCartDisplay();
        });



        // 查詢並添加商品到購物車（支援多商品小項選擇）
        function searchAndAddProduct(barcode) {
            console.log('查詢商品條碼:', barcode);
            
            const products = mockProducts[barcode];
            
            if (products && products.length > 0) {
                if (products.length === 1) {
                    // 只有一個商品，直接添加
                    const product = products[0];
                    if (product.stock > 0) {
                        addToCart(product, barcode);
                        alert(`已添加: ${product.name} - ${product.variant}`);
                    } else {
                        alert(`${product.name} - ${product.variant} 庫存不足，無法銷售`);
                    }
                } else {
                    // 多個商品，彈出選擇視窗
                    showProductSelectionModal(products, barcode);
                }
            } else {
                alert(`條碼 ${barcode} 找不到對應商品`);
            }
        }

        // 顯示商品選擇彈出視窗
        function showProductSelectionModal(products, barcode) {
            document.getElementById('modalBarcode').textContent = barcode;
            const variantsList = document.getElementById('productVariantsList');
            
            variantsList.innerHTML = products.map((product, index) => {
                const stockStatus = product.stock > 0 ? 
                    (product.stock <= 5 ? `低庫存 ${product.stock} 件` : `庫存 ${product.stock} 件`) : 
                    '缺貨';
                const stockClass = product.stock > 0 ? 
                    (product.stock <= 5 ? 'text-orange-600' : 'text-green-600') : 
                    'text-red-600';
                
                const isAvailable = product.stock > 0;
                const buttonClass = isAvailable ? 
                    'bg-blue-500 hover:bg-blue-600 text-white' : 
                    'bg-gray-300 text-gray-500 cursor-not-allowed';
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors ${!isAvailable ? 'opacity-60' : ''}">
                        <div class="flex items-center space-x-4">
                            <img src="${product.image}" alt="${product.name}" class="w-16 h-16 rounded-lg object-cover">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">${product.name}</h4>
                                <p class="text-sm text-gray-600 mt-1">規格：${product.variant}</p>
                                <p class="text-xs text-gray-500 mt-1">${product.description}</p>
                                <div class="flex items-center justify-between mt-2">
                                    <span class="text-lg font-bold text-orange-600">NT$${product.price.toLocaleString()}</span>
                                    <span class="text-sm ${stockClass}">${stockStatus}</span>
                                </div>
                            </div>
                            <button onclick="selectProductVariant('${product.id}', '${barcode}')" 
                                    class="px-4 py-2 rounded-lg text-sm font-medium transition-colors ${buttonClass}"
                                    ${!isAvailable ? 'disabled' : ''}>
                                ${isAvailable ? '選擇此項' : '缺貨'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('productSelectionModal').classList.remove('hidden');
        }

        // 關閉商品選擇彈出視窗
        function closeProductSelectionModal() {
            document.getElementById('productSelectionModal').classList.add('hidden');
        }

        // 選擇商品小項
        function selectProductVariant(productId, barcode) {
            const products = mockProducts[barcode];
            const selectedProduct = products.find(p => p.id === productId);
            
            if (selectedProduct && selectedProduct.stock > 0) {
                addToCart(selectedProduct, barcode);
                closeProductSelectionModal();
                alert(`已添加: ${selectedProduct.name} - ${selectedProduct.variant}`);
            } else {
                alert('商品庫存不足或不存在');
            }
        }

        // 添加商品到購物車（更新支援商品小項）
        function addToCart(product, barcode) {
            const existingItem = cart.find(item => item.id === product.id);
            
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity++;
                    existingItem.total = existingItem.quantity * existingItem.price;
                } else {
                    alert(`${product.name} - ${product.variant} 庫存不足，無法再添加`);
                    return;
                }
            } else {
                cart.push({
                    ...product,
                    barcode: barcode,
                    quantity: 1,
                    originalPrice: product.price,
                    total: product.price * 1
                });
            }
            
            updateCartDisplay();
        }

        // 更新購物車顯示
        function updateCartDisplay() {
            const cartContainer = document.querySelector('.apple-card .space-y-4');
            if (!cartContainer) return;

            if (cart.length === 0) {
                cartContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-shopping-cart text-4xl mb-2"></i>
                        <p>購物車是空的</p>
                        <p class="text-sm">掃描商品條碼開始銷售</p>
                    </div>
                `;
                updateTotals();
                return;
            }

            cartContainer.innerHTML = cart.map((item, index) => `
                <div class="flex items-center space-x-4 p-4 border border-gray-200 rounded-lg">
                    <img src="${item.image}" alt="${item.name}" class="w-16 h-16 rounded-lg object-cover">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800">${item.name}</h4>
                        <p class="text-sm text-gray-600">條碼：${item.barcode}</p>
                        <p class="text-sm ${item.stock <= 10 ? 'text-red-500' : 'text-gray-500'}">庫存：${item.stock} 件</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200" onclick="changeQuantity(${index}, -1)">
                            <i class="fas fa-minus text-sm"></i>
                        </button>
                        <span class="font-semibold w-8 text-center">${item.quantity}</span>
                        <button class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200" onclick="changeQuantity(${index}, 1)">
                            <i class="fas fa-plus text-sm"></i>
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">單價：NT$${item.price.toLocaleString()}</p>
                        <p class="font-bold text-orange-600">NT$${item.total.toLocaleString()}</p>
                    </div>
                    <button class="text-red-500 hover:text-red-700 p-2" onclick="removeFromCart(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');

            updateTotals();
        }

        // 更改商品數量
        function changeQuantity(index, delta) {
            const item = cart[index];
            const newQuantity = item.quantity + delta;
            
            if (newQuantity <= 0) {
                removeFromCart(index);
            } else if (newQuantity <= item.stock) {
                item.quantity = newQuantity;
                item.total = item.quantity * item.price;
                updateCartDisplay();
            } else {
                alert(`${item.name} 庫存不足，最多只能購買 ${item.stock} 件`);
            }
        }

        // 從購物車移除商品
        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartDisplay();
        }

        // 更新總計
        function updateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + item.total, 0);
            
            // 計算會員折扣
            let memberDiscount = 0;
            if (currentMember) {
                memberDiscount = Math.floor(subtotal * currentMember.discount);
            }
            
            // 計算優惠券折扣
            let couponDiscount = 0;
            if (currentCoupon) {
                couponDiscount = calculateCouponDiscount(currentCoupon, subtotal - memberDiscount);
            }
            
            // 商品售價已包含5%營業稅，無需額外計算
            const total = subtotal - memberDiscount - couponDiscount;

            // 更新顯示
            const totalAmountElements = document.querySelectorAll('#totalAmount');
            totalAmountElements.forEach(element => {
                element.textContent = `NT$${total.toLocaleString()}`;
            });
            
            // 更新各項金額顯示
            const subtotalEl = document.getElementById('subtotalAmount');
            const memberDiscountEl = document.getElementById('memberDiscountAmount');
            const memberDiscountRow = document.getElementById('memberDiscountRow');
            const couponDiscountEl = document.getElementById('couponDiscountAmount');
            const couponDiscountRow = document.getElementById('couponDiscountRow');
            
            if (subtotalEl) subtotalEl.textContent = `NT$${subtotal.toLocaleString()}`;
            
            // 會員折扣顯示
            if (memberDiscountEl && memberDiscountRow) {
                if (currentMember && memberDiscount > 0) {
                    memberDiscountEl.textContent = `-NT$${memberDiscount.toLocaleString()}`;
                    memberDiscountRow.style.display = 'flex';
                } else {
                    memberDiscountRow.style.display = 'none';
                }
            }
            
            // 優惠券折扣顯示
            if (couponDiscountEl && couponDiscountRow) {
                if (currentCoupon && couponDiscount > 0) {
                    couponDiscountEl.textContent = `-NT$${couponDiscount.toLocaleString()}`;
                    couponDiscountRow.style.display = 'flex';
                } else {
                    couponDiscountRow.style.display = 'none';
                }
            }
            
            return { subtotal, memberDiscount, couponDiscount, tax: 0, total };
        }

        // 優惠券相關功能
        
        // 載入優惠券管理功能
        function loadCouponFunctions() {
            // 從localStorage獲取優惠券資料
            function getCouponsData() {
                const savedCoupons = localStorage.getItem('couponsData');
                return savedCoupons ? JSON.parse(savedCoupons) : [];
            }
            
            // 驗證優惠券
            window.validateCoupon = function(code, orderAmount, memberLevel, categories) {
                const couponsData = getCouponsData();
                const coupon = couponsData.find(c => c.code.toUpperCase() === code.toUpperCase());
                
                if (!coupon) {
                    return { valid: false, message: '優惠券不存在' };
                }

                if (coupon.status !== 'active') {
                    return { valid: false, message: '優惠券已停用' };
                }

                const now = new Date();
                const startDate = new Date(coupon.startDate);
                const endDate = new Date(coupon.endDate);

                if (now < startDate) {
                    return { valid: false, message: '優惠券尚未生效' };
                }

                if (now > endDate) {
                    return { valid: false, message: '優惠券已過期' };
                }

                if (coupon.usedCount >= coupon.usageLimit) {
                    return { valid: false, message: '優惠券使用次數已達上限' };
                }

                if (orderAmount < coupon.minAmount) {
                    return { valid: false, message: `最低消費金額為 NT$${coupon.minAmount}` };
                }

                if (coupon.type === 'member_only' && !memberLevel) {
                    return { valid: false, message: '此優惠券僅限會員使用' };
                }

                // 檢查適用分類
                if (!coupon.categories.includes('all')) {
                    const hasValidCategory = categories.some(cat => coupon.categories.includes(cat));
                    if (!hasValidCategory) {
                        return { valid: false, message: '優惠券不適用於購物車中的商品' };
                    }
                }

                return { valid: true, coupon: coupon };
            };
            
            window.useCoupon = function(code) {
                const couponsData = getCouponsData();
                const coupon = couponsData.find(c => c.code.toUpperCase() === code.toUpperCase());
                if (coupon) {
                    coupon.usedCount++;
                    localStorage.setItem('couponsData', JSON.stringify(couponsData));
                }
            };
            
            window.getCouponsData = getCouponsData;
        }

        // 計算優惠券折扣
        function calculateCouponDiscount(coupon, amount) {
            switch (coupon.type) {
                case 'percentage':
                    return Math.floor(amount * (coupon.discountValue / 100));
                case 'fixed':
                    return Math.min(coupon.discountValue, amount);
                case 'buy_x_get_y':
                    // 買X送Y的邏輯需要根據購物車商品計算
                    return calculateBuyXGetYDiscount(coupon);
                case 'member_only':
                    if (currentMember) {
                        return Math.floor(amount * (coupon.discountValue / 100));
                    }
                    return 0;
                default:
                    return 0;
            }
        }

        // 計算買X送Y的折扣
        function calculateBuyXGetYDiscount(coupon) {
            // 簡化實現：如果有符合分類的商品且數量≥3，則給予最便宜商品的價格作為折扣
            const eligibleItems = cart.filter(item => 
                coupon.categories.includes('all') || 
                coupon.categories.some(cat => item.category === cat)
            );
            
            if (eligibleItems.length >= 3) {
                const cheapestItem = eligibleItems.reduce((min, item) => 
                    item.price < min.price ? item : min
                );
                return cheapestItem.price;
            }
            return 0;
        }

        // 套用優惠券
        function applyCoupon() {
            const couponCode = document.getElementById('couponInput').value.trim();
            if (!couponCode) {
                alert('請輸入優惠券代碼');
                return;
            }

            if (!window.validateCoupon) {
                alert('優惠券功能載入中，請稍後再試');
                return;
            }

            const subtotal = cart.reduce((sum, item) => sum + item.total, 0);
            const memberDiscountAmount = currentMember ? Math.floor(subtotal * currentMember.discount) : 0;
            const orderAmount = subtotal - memberDiscountAmount;
            
            // 獲取購物車商品分類
            const categories = [...new Set(cart.map(item => item.category))];
            
            const result = window.validateCoupon(
                couponCode, 
                orderAmount, 
                currentMember?.level, 
                categories
            );

            if (result.valid) {
                currentCoupon = result.coupon;
                showAppliedCoupon();
                updateTotals();
                alert(`優惠券套用成功！${getDiscountText(currentCoupon)}`);
            } else {
                alert(`優惠券套用失敗：${result.message}`);
            }
        }

        // 移除優惠券
        function removeCoupon() {
            currentCoupon = null;
            hideAppliedCoupon();
            updateTotals();
            document.getElementById('couponInput').value = '';
        }

        // 顯示已套用的優惠券
        function showAppliedCoupon() {
            const appliedCouponDiv = document.getElementById('appliedCoupon');
            if (appliedCouponDiv && currentCoupon) {
                document.getElementById('appliedCouponName').textContent = currentCoupon.name;
                document.getElementById('appliedCouponDesc').textContent = getDiscountText(currentCoupon);
                appliedCouponDiv.classList.remove('hidden');
                document.getElementById('couponInput').value = currentCoupon.code;
            }
        }

        // 隱藏已套用的優惠券
        function hideAppliedCoupon() {
            const appliedCouponDiv = document.getElementById('appliedCoupon');
            if (appliedCouponDiv) {
                appliedCouponDiv.classList.add('hidden');
            }
        }

        // 掃描優惠券
        function scanCoupon() {
            if (typeof window.quickScan === 'function') {
                window.quickScan(
                    function(barcode) {
                        document.getElementById('couponInput').value = barcode;
                        applyCoupon();
                    },
                    function(error) {
                        alert('掃描失敗: ' + error.message);
                    }
                );
            } else {
                alert('掃描功能尚未載入，請重新整理頁面');
            }
        }

        // 獲取優惠券描述文字
        function getDiscountText(coupon) {
            switch (coupon.type) {
                case 'percentage':
                    return `${coupon.discountValue}% 折扣`;
                case 'fixed':
                    return `NT$${coupon.discountValue} 折扣`;
                case 'buy_x_get_y':
                    return '買3送1優惠';
                case 'member_only':
                    return `會員專屬 ${coupon.discountValue}% 折扣`;
                default:
                    return '特殊優惠';
            }
        }

        // 清空購物車
        function clearCart() {
            if (cart.length > 0 && confirm('確定要清空購物車嗎？')) {
                cart = [];
                updateCartDisplay();
            }
        }

        // 快速功能實現

        // 1. 折扣功能
        function applyDiscount() {
            if (cart.length === 0) {
                alert('購物車為空，請先添加商品');
                return;
            }

            const discountOptions = [
                { name: '9折', value: 0.9 },
                { name: '8折', value: 0.8 },
                { name: '7折', value: 0.7 },
                { name: '5折', value: 0.5 }
            ];

            let optionsText = '選擇折扣：\n';
            discountOptions.forEach((option, index) => {
                optionsText += `${index + 1}. ${option.name}\n`;
            });

            const choice = prompt(optionsText + '請輸入數字 (1-4):');
            const selectedIndex = parseInt(choice) - 1;

            if (selectedIndex >= 0 && selectedIndex < discountOptions.length) {
                const discount = discountOptions[selectedIndex];
                
                // 對所有商品應用折扣
                cart.forEach(item => {
                    // 確保有originalPrice屬性
                    if (!item.originalPrice) {
                        item.originalPrice = item.price;
                    }
                    
                    item.price = Math.floor(item.originalPrice * discount.value);
                    item.total = item.quantity * item.price;
                });

                updateCartDisplay();
                alert(`已應用${discount.name}折扣`);
            }
        }

        // 2. 優惠券功能
        function applyCoupon() {
            const coupons = {
                'SAVE100': { type: 'fixed', value: 100, minAmount: 1000, description: '滿千折百' },
                'SAVE10': { type: 'percent', value: 0.1, minAmount: 500, description: '滿五百打九折' },
                'MEMBER20': { type: 'percent', value: 0.2, minAmount: 2000, description: '會員專享八折' },
                'WELCOME': { type: 'fixed', value: 50, minAmount: 0, description: '新客戶優惠' }
            };

            const couponCode = prompt('請輸入優惠券代碼：\n\n可用優惠券：\nSAVE100 - 滿千折百\nSAVE10 - 滿五百打九折\nMEMBER20 - 會員專享八折\nWELCOME - 新客戶優惠');

            if (!couponCode) return;

            const coupon = coupons[couponCode.toUpperCase()];
            if (!coupon) {
                alert('無效的優惠券代碼');
                return;
            }

            const subtotal = cart.reduce((sum, item) => sum + item.total, 0);
            if (subtotal < coupon.minAmount) {
                alert(`此優惠券需要消費滿 NT$${coupon.minAmount}`);
                return;
            }

            let discountAmount = 0;
            if (coupon.type === 'fixed') {
                discountAmount = coupon.value;
            } else {
                discountAmount = Math.floor(subtotal * coupon.value);
            }

            // 模擬優惠券應用（實際需要修改結帳邏輯）
            alert(`優惠券「${coupon.description}」已應用\n折扣金額：NT$${discountAmount}`);
        }

        // 3. 會員功能
        function manageMember() {
            const action = prompt('會員功能：\n1. 會員查詢\n2. 會員登入\n3. 會員登出\n4. 快速新增會員\n5. 開啟會員管理\n\n請選擇 (1-5):');

            switch(action) {
                case '1': // 會員查詢
                    searchMember();
                    break;

                case '2': // 會員登入
                    loginMember();
                    break;

                case '3': // 會員登出
                    logoutMember();
                    break;

                case '4': // 快速新增會員
                    quickAddMember();
                    break;

                case '5': // 開啟會員管理
                    navigateToPage('members');
                    break;

                default:
                    if (action !== null) {
                        alert('無效選擇');
                    }
            }
        }

        // 快速新增會員
        function quickAddMember() {
            const name = prompt('請輸入會員姓名：');
            if (!name) return;
            
            const phone = prompt('請輸入會員手機號碼：');
            if (!phone) return;
            
            // 檢查手機號碼是否已存在
            if (phoneToMemberMap[phone]) {
                alert('此手機號碼已註冊為會員！');
                return;
            }
            
            const email = prompt('請輸入會員電子郵件（可選）：') || '';
            
            // 生成會員編號
            const memberId = 'M' + Date.now().toString().slice(-8);
            
            // 創建新會員
            const newMember = {
                id: memberId,
                name: name,
                phone: phone,
                email: email,
                level: '一般會員',
                points: 0,
                totalSpent: 0,
                discount: 0.05, // 5% 折扣
                status: 'active',
                joinDate: new Date().toISOString(),
                lastVisit: new Date().toISOString()
            };
            
            // 保存到本地存儲
            let members = JSON.parse(localStorage.getItem('members') || '{}');
            members[memberId] = newMember;
            localStorage.setItem('members', JSON.stringify(members));
            
            // 更新記憶體中的數據
            membersDatabase[memberId] = newMember;
            phoneToMemberMap[phone] = memberId;
            
            alert(`會員新增成功！\n\n會員編號：${memberId}\n姓名：${name}\n手機：${phone}\n\n是否要立即登入此會員？`);
            
            const loginNow = confirm('是否要立即登入此會員？');
            if (loginNow) {
                currentMember = newMember;
                updateMemberDisplay();
                updateCartDisplay();
                alert(`${name} 已登入！\n享有 5% 會員折扣`);
            }
        }

        // 搜尋會員
        function searchMember() {
            const input = prompt('請輸入會員手機號碼或會員編號：');
            if (!input) return;

            let member = null;
            
            // 先嘗試用會員編號搜尋
            if (membersDatabase[input]) {
                member = membersDatabase[input];
            } else {
                // 用手機號碼搜尋
                const memberId = phoneToMemberMap[input];
                if (memberId) {
                    member = membersDatabase[memberId];
                }
            }

            if (member) {
                const memberInfo = `會員資訊：\n` +
                    `編號：${member.id}\n` +
                    `姓名：${member.name}\n` +
                    `電話：${member.phone}\n` +
                    `等級：${member.level}\n` +
                    `積分：${member.points.toLocaleString()}\n` +
                    `累計消費：NT$${member.totalSpent.toLocaleString()}\n` +
                    `會員折扣：${(member.discount * 100).toFixed(0)}%\n` +
                    `狀態：${member.status === 'active' ? '啟用' : '停用'}`;
                
                const action = confirm(memberInfo + '\n\n是否要登入此會員？');
                if (action) {
                    currentMember = member;
                    updateMemberDisplay();
                    updateCartDisplay(); // 重新計算會員價格
                    alert(`${member.name} 已登入！\n享有 ${(member.discount * 100).toFixed(0)}% 會員折扣`);
                }
            } else {
                alert('查無此會員');
            }
        }

        // 會員登入
        function loginMember() {
            const input = prompt('請輸入會員手機號碼或會員編號：');
            if (!input) return;

            let member = null;
            
            // 先嘗試用會員編號搜尋
            if (membersDatabase[input]) {
                member = membersDatabase[input];
            } else {
                // 用手機號碼搜尋
                const memberId = phoneToMemberMap[input];
                if (memberId) {
                    member = membersDatabase[memberId];
                }
            }

            if (member) {
                if (member.status === 'active') {
                    currentMember = member;
                    updateMemberDisplay();
                    updateCartDisplay(); // 重新計算會員價格
                    
                    alert(`歡迎 ${member.name}！\n` +
                        `會員等級：${member.level}\n` +
                        `當前積分：${member.points.toLocaleString()}\n` +
                        `享有 ${(member.discount * 100).toFixed(0)}% 會員折扣`);
                } else {
                    alert('此會員帳號已停用，請聯繫客服');
                }
            } else {
                const register = confirm('查無此會員，是否要建立新會員？');
                if (register) {
                    navigateToPage('members');
                }
            }
        }

        // 會員登出
        function logoutMember() {
            if (currentMember) {
                const confirm_logout = confirm(`確定要讓 ${currentMember.name} 登出嗎？`);
                if (confirm_logout) {
                    currentMember = null;
                    updateMemberDisplay();
                    updateCartDisplay(); // 移除會員價格
                    alert('會員已登出');
                }
            } else {
                alert('目前沒有會員登入');
            }
        }

        // 更新會員顯示
        function updateMemberDisplay() {
            const memberInfo = document.getElementById('currentMemberInfo');
            const memberName = document.getElementById('memberName');
            const memberLevel = document.getElementById('memberLevel');
            const memberPoints = document.getElementById('memberPoints');
            const memberBtnText = document.getElementById('memberBtnText');
            const memberStatusDot = document.getElementById('memberStatusDot');

            if (currentMember) {
                // 更新POS顯示器中的會員資訊
                memberInfo.classList.remove('hidden');
                memberName.textContent = currentMember.name;
                memberLevel.textContent = currentMember.level;
                memberPoints.textContent = currentMember.points.toLocaleString();
                
                // 更新快速功能按鈕
                memberBtnText.textContent = currentMember.name.length > 4 ? 
                    currentMember.name.substring(0, 4) + '...' : currentMember.name;
                memberStatusDot.classList.remove('hidden');
            } else {
                // 隱藏會員資訊
                memberInfo.classList.add('hidden');
                
                // 重置快速功能按鈕
                memberBtnText.textContent = '會員';
                memberStatusDot.classList.add('hidden');
            }
        }

        // 計算會員積分獲得
        function calculateEarnedPoints(amount) {
            // 每消費NT$100得1點
            return Math.floor(amount / 100);
        }

        // 更新會員積分和消費記錄
        function updateMemberPoints(amount) {
            if (currentMember) {
                const earnedPoints = calculateEarnedPoints(amount);
                currentMember.points += earnedPoints;
                currentMember.totalSpent += amount;
                updateMemberDisplay();
                return earnedPoints;
            }
            return 0;
        }

        // 4. 退貨功能
        function processRefund() {
            const refundOptions = [
                '商品瑕疵',
                '尺寸不合',
                '顏色不符',
                '客戶不滿意',
                '其他原因'
            ];

            let optionsText = '選擇退貨原因：\n';
            refundOptions.forEach((reason, index) => {
                optionsText += `${index + 1}. ${reason}\n`;
            });

            const choice = prompt(optionsText + '請輸入數字 (1-5):');
            const selectedIndex = parseInt(choice) - 1;

            if (selectedIndex >= 0 && selectedIndex < refundOptions.length) {
                const reason = refundOptions[selectedIndex];
                const receiptNumber = prompt('請輸入發票號碼：');
                
                if (receiptNumber) {
                    const refundAmount = Math.floor(Math.random() * 5000) + 500; // 模擬退款金額
                    
                    if (confirm(`退貨資訊確認：\n原因：${reason}\n發票號碼：${receiptNumber}\n退款金額：NT$${refundAmount}\n\n確認處理退貨？`)) {
                        alert('退貨申請已受理\n預計3-5個工作天完成退款');
                    }
                } else {
                    alert('請提供發票號碼');
                }
            }
        }

        // 銷售記錄
        let salesHistory = JSON.parse(localStorage.getItem('salesHistory')) || [];
        let receiptNumber = parseInt(localStorage.getItem('lastReceiptNumber')) || 1000;

        // 如果沒有銷售記錄，添加一些測試資料
        if (salesHistory.length === 0) {
            console.log('沒有銷售記錄，添加測試資料');
            const testSales = [
                {
                    receiptNumber: 1001,
                    date: new Date(Date.now() - 86400000).toISOString(), // 昨天
                    items: [
                        { name: '波蘭陶杯', variant: '藍色', barcode: '123456789', price: 299, quantity: 2, total: 598 }
                    ],
                    subtotal: 598,
                    memberDiscount: 0,
                    couponDiscount: 0,
                    tax: 0,
                    total: 598,
                    paymentMethod: '現金',
                    receivedAmount: 600,
                    change: 2,
                    cashier: '管理員',
                    member: null,
                    coupon: null
                },
                {
                    receiptNumber: 1002,
                    date: new Date(Date.now() - 172800000).toISOString(), // 前天
                    items: [
                        { name: '波蘭陶盤', variant: '白色', barcode: '987654321', price: 450, quantity: 1, total: 450 },
                        { name: '波蘭陶杯', variant: '紅色', barcode: '123456789', price: 299, quantity: 1, total: 299 }
                    ],
                    subtotal: 749,
                    memberDiscount: 37,
                    couponDiscount: 0,
                    tax: 0,
                    total: 712,
                    paymentMethod: '信用卡',
                    receivedAmount: 712,
                    change: 0,
                    cashier: '管理員',
                    member: { id: 'M001', name: '王小明', level: '金卡', earnedPoints: 7, totalPoints: 150 },
                    coupon: null
                }
            ];
            salesHistory = testSales;
            localStorage.setItem('salesHistory', JSON.stringify(salesHistory));
            localStorage.setItem('lastReceiptNumber', '1002');
            receiptNumber = 1002;
            console.log('測試銷售記錄已添加');
        }

        // 添加熱銷商品到購物車
        function addHotProduct(barcode) {
            searchAndAddProduct(barcode);
        }

        // 結帳功能
        function checkout(paymentMethod) {
            if (cart.length === 0) {
                alert('購物車是空的，請先添加商品');
                return;
            }

            // 計算總額
            const totals = updateTotals();
            const items = cart.reduce((sum, item) => sum + item.quantity, 0);
            
            // 準備結帳確認訊息
            let confirmMessage = `確認結帳嗎？\n\n`;
            
            // 如果有會員登入，顯示會員資訊
            if (currentMember) {
                const earnedPoints = calculateEarnedPoints(totals.total);
                confirmMessage += `會員：${currentMember.name} (${currentMember.level})\n`;
                confirmMessage += `本次可獲得：${earnedPoints} 積分\n\n`;
            }
            
            confirmMessage += `商品數量：${items} 件\n` +
                `小計：NT$${totals.subtotal.toLocaleString()}\n`;
                
            if (totals.memberDiscount > 0) {
                confirmMessage += `會員折扣 (${currentMember.level})：-NT$${totals.memberDiscount.toLocaleString()}\n`;
            }
            
            if (totals.couponDiscount > 0) {
                confirmMessage += `優惠券：-NT$${totals.couponDiscount.toLocaleString()}\n`;
            }
            
            confirmMessage += `總金額：NT$${totals.total.toLocaleString()}\n` +
                `付款方式：${paymentMethod}`;

            if (confirm(confirmMessage)) {
                // 處理付款
                if (paymentMethod === '現金') {
                    processCashPayment(totals.total);
                } else {
                    processCardPayment(paymentMethod, totals.total);
                }
            }
        }

        // 現金付款處理
        function processCashPayment(total) {
            const receivedAmount = prompt(`總金額：NT$${total.toLocaleString()}\n請輸入收到金額：`);
            
            if (receivedAmount === null) return; // 用戶取消
            
            const received = parseFloat(receivedAmount);
            
            if (isNaN(received) || received < total) {
                alert('收到金額不足或格式錯誤');
                return;
            }
            
            const change = received - total;
            
            if (change > 0) {
                alert(`找零：NT$${change.toLocaleString()}`);
            }
            
            completeSale('現金', total, received, change);
        }

        // 卡片/行動支付處理
        function processCardPayment(paymentMethod, total) {
            // 模擬卡片處理
            const processing = confirm(`${paymentMethod}付款\n金額：NT$${total.toLocaleString()}\n\n請客戶進行付款操作`);
            
            if (processing) {
                // 模擬處理時間
                setTimeout(() => {
                    const success = Math.random() > 0.1; // 90% 成功率
                    
                    if (success) {
                        alert('付款成功！');
                        completeSale(paymentMethod, total, total, 0);
                    } else {
                        alert('付款失敗，請重試或選擇其他付款方式');
                    }
                }, 1000);
            }
        }

        // 完成銷售
        function completeSale(paymentMethod, total, received, change) {
            receiptNumber++;
            
            // 計算總額詳情
            const totals = updateTotals();
            
            // 更新會員積分（在創建記錄前）
            let earnedPoints = 0;
            let memberInfo = null;
            if (currentMember) {
                earnedPoints = updateMemberPoints(total);
                memberInfo = {
                    id: currentMember.id,
                    name: currentMember.name,
                    level: currentMember.level,
                    earnedPoints: earnedPoints,
                    totalPoints: currentMember.points
                };
            }
            
            // 處理優惠券使用
            let couponInfo = null;
            if (currentCoupon) {
                couponInfo = {
                    id: currentCoupon.id,
                    code: currentCoupon.code,
                    name: currentCoupon.name,
                    type: currentCoupon.type,
                    discountValue: currentCoupon.discountValue,
                    discountAmount: totals.couponDiscount
                };
                
                // 增加優惠券使用次數
                if (window.useCoupon) {
                    window.useCoupon(currentCoupon.code);
                }
            }

            // 創建銷售記錄
            const saleRecord = {
                receiptNumber: receiptNumber,
                date: new Date().toISOString(),
                items: cart.map(item => ({...item})),
                subtotal: totals.subtotal,
                memberDiscount: totals.memberDiscount,
                couponDiscount: totals.couponDiscount,
                tax: 0,
                total: total,
                paymentMethod: paymentMethod,
                receivedAmount: received,
                change: change,
                cashier: '收銀員001',
                member: memberInfo,
                coupon: couponInfo
            };

            // 保存到歷史記錄
            salesHistory.unshift(saleRecord);
            
            // 只保留最近100筆記錄
            if (salesHistory.length > 100) {
                salesHistory = salesHistory.slice(0, 100);
            }
            
            localStorage.setItem('salesHistory', JSON.stringify(salesHistory));
            localStorage.setItem('lastReceiptNumber', receiptNumber.toString());

            // 顯示會員積分獲得提示
            if (currentMember && earnedPoints > 0) {
                alert(`🎉 會員積分獲得！\n\n` +
                    `會員：${currentMember.name}\n` +
                    `本次獲得：${earnedPoints} 點\n` +
                    `總積分：${currentMember.points.toLocaleString()} 點\n` +
                    `感謝您的惠顧！`);
            }

            // 顯示收據
            showReceipt(saleRecord);
            
            // 清空購物車和優惠券
            cart = [];
            currentCoupon = null;
            hideAppliedCoupon();
            document.getElementById('couponInput').value = '';
            updateCartDisplay();
        }

        // 顯示收據
        function showReceipt(saleRecord) {
            const receiptContent = generateReceiptContent(saleRecord);
            
            // 創建收據視窗
            const receiptWindow = window.open('', '_blank', 'width=400,height=600,scrollbars=yes');
            receiptWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>收據 #${saleRecord.receiptNumber}</title>
                    <style>
                        body { font-family: 'Courier New', monospace; font-size: 12px; margin: 20px; }
                        .receipt { max-width: 300px; margin: 0 auto; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .line { border-bottom: 1px dashed #000; margin: 10px 0; }
                        .row { display: flex; justify-content: space-between; margin: 5px 0; }
                        .row.small { font-size: 10px; color: #666; margin: 2px 0; }
                        .total { font-weight: bold; font-size: 14px; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    ${receiptContent}
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="window.print()">列印收據</button>
                        <button onclick="window.close()">關閉</button>
                    </div>
                </body>
                </html>
            `);
            receiptWindow.document.close();
        }

        // 生成收據內容
        function generateReceiptContent(saleRecord) {
            const saleDate = new Date(saleRecord.date);
            
            let itemsHtml = '';
            saleRecord.items.forEach(item => {
                itemsHtml += `
                    <div class="row">
                        <span>${item.name}</span>
                    </div>
                    <div class="row small">
                        <span>  規格：${item.variant}</span>
                    </div>
                    <div class="row small">
                        <span>  編號：${item.id}</span>
                    </div>
                    <div class="row">
                        <span>  ${item.quantity} x NT$${item.price.toLocaleString()}</span>
                        <span>NT$${item.total.toLocaleString()}</span>
                    </div>
                `;
            });

            return `
                <div class="receipt">
                    <div class="header">
                        <h2>歐洲家居瓷器精品店</h2>
                        <p>European Home & Porcelain</p>
                        <p>統一編號：28765432</p>
                        <p>地址：台北市大安區敦化南路一段187號</p>
                        <p>電話：02-2775-8899</p>
                    </div>
                    
                    <div class="line"></div>
                    
                    <div class="row">
                        <span>收據編號：${saleRecord.receiptNumber}</span>
                    </div>
                    <div class="row">
                        <span>日期：${saleDate.toLocaleDateString('zh-TW')}</span>
                    </div>
                    <div class="row">
                        <span>時間：${saleDate.toLocaleTimeString('zh-TW')}</span>
                    </div>
                    <div class="row">
                        <span>收銀員：${saleRecord.cashier}</span>
                    </div>
                    
                    <div class="line"></div>
                    
                    ${itemsHtml}
                    
                    <div class="line"></div>
                    
                    <div class="row">
                        <span>小計</span>
                        <span>NT$${saleRecord.subtotal.toLocaleString()}</span>
                    </div>
                    
                    ${saleRecord.member ? `
                    <div class="line"></div>
                    <div class="row">
                        <span>會員資訊</span>
                    </div>
                    <div class="row">
                        <span>會員：${saleRecord.member.name} (${saleRecord.member.level})</span>
                    </div>
                    <div class="row">
                        <span>會員編號：${saleRecord.member.id}</span>
                    </div>
                    ${saleRecord.member.earnedPoints > 0 ? `
                    <div class="row">
                        <span>本次獲得積分：${saleRecord.member.earnedPoints} 點</span>
                    </div>
                    <div class="row">
                        <span>目前總積分：${saleRecord.member.totalPoints.toLocaleString()} 點</span>
                    </div>
                    ` : ''}
                    <div class="line"></div>
                    ` : ''}
                    
                    ${saleRecord.memberDiscount > 0 ? `
                    <div class="row">
                        <span>會員折扣${saleRecord.member ? ` (${saleRecord.member.level})` : ''}</span>
                        <span>-NT$${saleRecord.memberDiscount.toLocaleString()}</span>
                    </div>
                    ` : ''}
                    
                    ${saleRecord.couponDiscount > 0 ? `
                    <div class="row">
                        <span>優惠券</span>
                        <span>-NT$${saleRecord.couponDiscount.toLocaleString()}</span>
                    </div>
                    ` : ''}
                    

                    
                    <div class="line"></div>
                    
                    <div class="row total">
                        <span>總計</span>
                        <span>NT$${saleRecord.total.toLocaleString()}</span>
                    </div>
                    
                    <div class="row">
                        <span>付款方式</span>
                        <span>${saleRecord.paymentMethod}</span>
                    </div>
                    
                    ${saleRecord.paymentMethod === '現金' ? `
                    <div class="row">
                        <span>收到金額</span>
                        <span>NT$${saleRecord.receivedAmount.toLocaleString()}</span>
                    </div>
                    <div class="row">
                        <span>找零</span>
                        <span>NT$${saleRecord.change.toLocaleString()}</span>
                    </div>
                    ` : ''}
                    
                    <div class="line"></div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <p>謝謝光臨！</p>
                        <p>歡迎再次蒞臨</p>
                    </div>
                </div>
            `;
        }

        // 顯示銷售記錄
        function showSalesHistory() {
            if (salesHistory.length === 0) {
                alert('目前沒有銷售記錄');
                return;
            }

            let historyHtml = '<h3>銷售記錄</h3><table border="1" cellpadding="5" cellspacing="0">';
            historyHtml += '<tr><th>收據號</th><th>日期</th><th>金額</th><th>付款方式</th><th>操作</th></tr>';
            
            salesHistory.slice(0, 20).forEach(record => {
                const date = new Date(record.date).toLocaleDateString('zh-TW');
                historyHtml += `
                    <tr>
                        <td>${record.receiptNumber}</td>
                        <td>${date}</td>
                        <td>NT$${record.total.toLocaleString()}</td>
                        <td>${record.paymentMethod}</td>
                        <td><button onclick="showReceiptDetail(${record.receiptNumber})">查看</button></td>
                    </tr>
                `;
            });
            
            historyHtml += '</table>';
            
            const historyWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            historyWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>銷售記錄</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th { background-color: #f0f0f0; }
                        th, td { padding: 8px; text-align: left; }
                        button { background-color: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
                        button:hover { background-color: #0056b3; }
                    </style>
                </head>
                <body>
                    ${historyHtml}
                    <div style="margin-top: 20px;">
                        <button onclick="window.close()">關閉</button>
                    </div>
                </body>
                </html>
            `);
            historyWindow.document.close();
        }

        // 查看收據詳情
        function showReceiptDetail(receiptNumber) {
            const record = salesHistory.find(sale => sale.receiptNumber === receiptNumber);
            if (record) {
                showReceipt(record);
            }
        }

        // 今日銷售統計
        function getTodayStatistics() {
            const today = new Date().toDateString();
            const todaySales = salesHistory.filter(sale => 
                new Date(sale.date).toDateString() === today
            );
            
            const todayTotal = todaySales.reduce((sum, sale) => sum + sale.total, 0);
            const todayCount = todaySales.length;
            
            return {
                count: todayCount,
                total: todayTotal,
                sales: todaySales
            };
        }

        // 清空購物車（改進版）
        function clearCart() {
            if (cart.length > 0) {
                if (confirm('確定要清空購物車嗎？')) {
                    cart = [];
                    updateCartDisplay();
                    alert('購物車已清空');
                }
            } else {
                alert('購物車已經是空的');
            }
        }

        // 更新購物車商品數量顯示
        function updateCartItemCount() {
            const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            const cartTitle = document.querySelector('.apple-card h3');
            if (cartTitle) {
                cartTitle.nextElementSibling.textContent = `共 ${itemCount} 項商品`;
            }
        }

        // 重寫更新購物車顯示功能
        function updateCartDisplay() {
            const cartContainer = document.querySelector('.apple-card .space-y-4');
            if (!cartContainer) return;

            if (cart.length === 0) {
                cartContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-shopping-cart text-4xl mb-2"></i>
                        <p>購物車是空的</p>
                        <p class="text-sm">掃描商品條碼或選擇熱銷商品開始銷售</p>
                    </div>
                `;
                updateTotals();
                updateCartItemCount();
                return;
            }

            cartContainer.innerHTML = cart.map((item, index) => `
                <div class="flex items-center space-x-4 p-4 border border-gray-200 rounded-lg">
                    <img src="${item.image}" alt="${item.name}" class="w-16 h-16 rounded-lg object-cover">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800">${item.name}</h4>
                        <p class="text-sm text-blue-600 font-medium">規格：${item.variant}</p>
                        <p class="text-sm text-gray-600">條碼：${item.barcode}</p>
                        <p class="text-sm text-gray-500">商品編號：${item.id}</p>
                        <p class="text-sm ${item.stock <= 10 ? 'text-red-500' : 'text-gray-500'}">
                            庫存：${item.stock} 件${item.stock <= 10 ? '（低庫存）' : ''}
                        </p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200" onclick="changeQuantity(${index}, -1)">
                            <i class="fas fa-minus text-sm"></i>
                        </button>
                        <span class="font-semibold w-8 text-center">${item.quantity}</span>
                        <button class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200" onclick="changeQuantity(${index}, 1)">
                            <i class="fas fa-plus text-sm"></i>
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">單價：NT$${item.price.toLocaleString()}</p>
                        <p class="font-bold text-orange-600">NT$${item.total.toLocaleString()}</p>
                    </div>
                    <button class="text-red-500 hover:text-red-700 p-2" onclick="removeFromCart(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');

            updateTotals();
            updateCartItemCount();
        }



        // 檢查當前員工
        function checkCurrentEmployee() {
            const savedEmployee = localStorage.getItem('currentEmployee');
            if (savedEmployee) {
                const employee = JSON.parse(savedEmployee);
                document.getElementById('currentCashier').textContent = employee.name;
                return employee;
            }
            return null;
        }

        // 頁面初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateCartDisplay();
            updateCartItemCount();
            updateMemberDisplay();
            checkCurrentEmployee();
            
            // 生成新訂單編號
            const now = new Date();
            const orderNum = now.getFullYear().toString() + 
                           (now.getMonth() + 1).toString().padStart(2, '0') + 
                           now.getDate().toString().padStart(2, '0') + 
                           Math.floor(Math.random() * 100).toString().padStart(2, '0');
            document.getElementById('orderNumber').textContent = orderNum;
            

            

        });

        // 統一導航函數
        function navigateToPage(page) {
            try {
                // 嘗試與父頁面通信切換iframe
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'navigate',
                        page: page
                    }, '*');
                } else {
                    // 如果不在iframe中，直接跳轉
                    window.location.href = `${page}.html`;
                }
            } catch (error) {
                // 備用方案：在新分頁中開啟
                window.open(`${page}.html`, '_blank');
            }
        }

        // 列印銷售明細
        function printSalesReceipt() {
            if (cart.length === 0) {
                alert('購物車是空的，無法列印明細');
                return;
            }

            const now = new Date();
            const orderNumber = document.getElementById('orderNumber').textContent;
            const cashier = document.getElementById('currentCashier').textContent;
            const memberInfo = document.getElementById('currentMemberInfo').classList.contains('hidden') ? null : {
                name: document.getElementById('memberName').textContent,
                level: document.getElementById('memberLevel').textContent,
                points: document.getElementById('memberPoints').textContent
            };

            // 計算總計
            const subtotal = cart.reduce((sum, item) => sum + item.total, 0);
            const discount = parseFloat(document.getElementById('discountAmount')?.textContent?.replace('NT$', '').replace(',', '') || 0);
            const couponDiscount = parseFloat(document.getElementById('couponDiscount')?.textContent?.replace('NT$', '').replace(',', '') || 0);
            const total = subtotal - discount - couponDiscount;

            // 生成列印內容
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>銷售明細 - ${orderNumber}</title>
                    <style>
                        @media print {
                            body { margin: 0; padding: 10px; font-family: 'Courier New', monospace; }
                            .no-print { display: none; }
                        }
                        body { 
                            font-family: 'Courier New', monospace; 
                            margin: 0; 
                            padding: 10px; 
                            font-size: 12px; 
                            line-height: 1.2;
                        }
                        .header { text-align: center; margin-bottom: 10px; }
                        .title { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
                        .subtitle { font-size: 12px; margin-bottom: 10px; }
                        .info { margin-bottom: 10px; }
                        .info-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
                        .divider { border-top: 1px dashed #000; margin: 5px 0; }
                        .item { margin-bottom: 3px; }
                        .item-name { font-weight: bold; }
                        .item-details { font-size: 10px; color: #666; }
                        .item-price { text-align: right; }
                        .total-section { margin-top: 10px; }
                        .total-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
                        .final-total { font-weight: bold; font-size: 14px; }
                        .footer { text-align: center; margin-top: 15px; font-size: 10px; }
                        .member-info { background: #f0f0f0; padding: 5px; margin: 5px 0; }
                        .print-button { 
                            position: fixed; 
                            top: 10px; 
                            right: 10px; 
                            background: #007bff; 
                            color: white; 
                            border: none; 
                            padding: 8px 16px; 
                            border-radius: 4px; 
                            cursor: pointer;
                        }
                        .print-button:hover { background: #0056b3; }
                    </style>
                </head>
                <body>
                    <button class="print-button no-print" onclick="window.print()">列印</button>
                    
                    <div class="header">
                        <div class="title">波波 聚 歐洲家居/波蘭陶食器</div>
                        <div class="subtitle">銷售明細</div>
                    </div>
                    
                    <div class="info">
                        <div class="info-row">
                            <span>訂單編號：</span>
                            <span>${orderNumber}</span>
                        </div>
                        <div class="info-row">
                            <span>日期：</span>
                            <span>${now.toLocaleDateString('zh-TW')}</span>
                        </div>
                        <div class="info-row">
                            <span>時間：</span>
                            <span>${now.toLocaleTimeString('zh-TW')}</span>
                        </div>
                        <div class="info-row">
                            <span>收銀員：</span>
                            <span>${cashier}</span>
                        </div>
                    </div>
                    
                    ${memberInfo ? `
                    <div class="member-info">
                        <div class="info-row">
                            <span>會員：</span>
                            <span>${memberInfo.name}</span>
                        </div>
                        <div class="info-row">
                            <span>等級：</span>
                            <span>${memberInfo.level}</span>
                        </div>
                        <div class="info-row">
                            <span>積分：</span>
                            <span>${memberInfo.points}</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="divider"></div>
                    
                    <div class="items">
                        ${cart.map(item => `
                            <div class="item">
                                <div class="item-name">${item.name}</div>
                                <div class="item-details">
                                    規格：${item.variant} | 條碼：${item.barcode} | 數量：${item.quantity}
                                </div>
                                <div class="item-price">
                                    單價：NT$${item.price.toLocaleString()} | 小計：NT$${item.total.toLocaleString()}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="total-section">
                        <div class="total-row">
                            <span>商品小計：</span>
                            <span>NT$${subtotal.toLocaleString()}</span>
                        </div>
                        ${discount > 0 ? `
                        <div class="total-row">
                            <span>折扣：</span>
                            <span>-NT$${discount.toLocaleString()}</span>
                        </div>
                        ` : ''}
                        ${couponDiscount > 0 ? `
                        <div class="total-row">
                            <span>優惠券折扣：</span>
                            <span>-NT$${couponDiscount.toLocaleString()}</span>
                        </div>
                        ` : ''}
                        <div class="total-row final-total">
                            <span>總計：</span>
                            <span>NT$${total.toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <div>謝謝光臨！</div>
                        <div>歡迎再次蒞臨</div>
                        <div>波波 聚 歐洲家居/波蘭陶食器</div>
                    </div>
                </body>
                </html>
            `;

            // 開啟新視窗並列印
            const printWindow = window.open('', '_blank', 'width=600,height=800');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // 等待內容載入後自動列印
            printWindow.onload = function() {
                printWindow.print();
            };
        }

        // 回到主頁面
        function goBackToMenu() {
            window.location.href = '../index.html';
        }
    </script>
</body>
</html> 