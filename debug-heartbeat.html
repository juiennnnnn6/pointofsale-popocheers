<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心跳機制診斷工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="database.js"></script>
    <script src="employee-auth.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">心跳機制診斷工具</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 診斷結果 -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">診斷結果</h2>
                <div id="diagnosticResults" class="space-y-2 text-sm">
                    <div class="text-gray-500">等待診斷...</div>
                </div>
            </div>
            
            <!-- 控制按鈕 -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">控制面板</h2>
                <div class="space-y-3">
                    <button onclick="runDiagnostic()" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        開始診斷
                    </button>
                    <button onclick="testHeartbeat()" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        測試心跳
                    </button>
                    <button onclick="clearResults()" class="w-full bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                        清除結果
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 詳細日誌 -->
        <div class="mt-6 bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">詳細日誌</h2>
            <div id="detailedLogs" class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm h-64 overflow-y-auto">
                等待診斷...
            </div>
        </div>
    </div>

    <script>
        let logs = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push(logEntry);
            
            const logsDiv = document.getElementById('detailedLogs');
            const colorClass = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-yellow-400';
            logsDiv.innerHTML += `<div class="${colorClass}">${logEntry}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function updateResults(message) {
            const resultsDiv = document.getElementById('diagnosticResults');
            resultsDiv.innerHTML += `<div class="p-2 bg-blue-50 rounded">${message}</div>`;
        }
        
        function clearResults() {
            document.getElementById('diagnosticResults').innerHTML = '<div class="text-gray-500">等待診斷...</div>';
            document.getElementById('detailedLogs').innerHTML = '等待診斷...';
            logs = [];
        }
        
        async function runDiagnostic() {
            clearResults();
            addLog('開始心跳機制診斷...');
            
            try {
                // 1. 檢查資料庫連接
                addLog('檢查資料庫連接...');
                await DatabaseManager.initialize();
                updateResults(`資料庫連接狀態: ${DatabaseManager.isConnected() ? '✅ 已連接' : '❌ 未連接'}`);
                
                // 2. 檢查 window.supabase
                addLog('檢查 window.supabase 客戶端...');
                const hasSupabase = !!window.supabase;
                const supabaseType = typeof window.supabase;
                const hasFromMethod = window.supabase && typeof window.supabase.from === 'function';
                
                updateResults(`window.supabase 存在: ${hasSupabase ? '✅ 是' : '❌ 否'}`);
                updateResults(`window.supabase 類型: ${supabaseType}`);
                updateResults(`from 方法可用: ${hasFromMethod ? '✅ 是' : '❌ 否'}`);
                
                if (!hasSupabase) {
                    addLog('❌ window.supabase 不存在', 'error');
                    return;
                }
                
                // 3. 檢查 localStorage 中的會話信息
                addLog('檢查 localStorage 會話信息...');
                const currentEmployee = localStorage.getItem('currentEmployee');
                const currentSessionId = localStorage.getItem('currentSessionId');
                
                updateResults(`currentEmployee: ${currentEmployee ? '✅ 存在' : '❌ 不存在'}`);
                updateResults(`currentSessionId: ${currentSessionId ? '✅ 存在' : '❌ 不存在'}`);
                
                if (currentEmployee) {
                    const employee = JSON.parse(currentEmployee);
                    updateResults(`員工ID: ${employee.id}`);
                    updateResults(`員工姓名: ${employee.name}`);
                }
                
                if (currentSessionId) {
                    updateResults(`會話ID: ${currentSessionId}`);
                }
                
                // 4. 檢查 employee_sessions 表結構
                addLog('檢查 employee_sessions 表結構...');
                const { data: tableData, error: tableError } = await window.supabase
                    .from('employee_sessions')
                    .select('*')
                    .limit(1);
                
                if (tableError) {
                    addLog(`❌ 查詢 employee_sessions 表失敗: ${tableError.message}`, 'error');
                    updateResults(`表查詢失敗: ❌ ${tableError.message}`);
                } else {
                    addLog('✅ employee_sessions 表查詢成功');
                    updateResults('employee_sessions 表: ✅ 可訪問');
                    
                    if (tableData && tableData.length > 0) {
                        const fields = Object.keys(tableData[0]);
                        updateResults(`表欄位: ${fields.join(', ')}`);
                        
                        const hasLastActivity = fields.includes('last_activity');
                        updateResults(`last_activity 欄位: ${hasLastActivity ? '✅ 存在' : '❌ 不存在'}`);
                        
                        if (!hasLastActivity) {
                            addLog('❌ last_activity 欄位不存在！', 'error');
                        }
                    }
                }
                
                // 5. 檢查活躍會話
                addLog('檢查活躍會話...');
                const { data: activeSessions, error: sessionError } = await window.supabase
                    .from('employee_sessions')
                    .select('*')
                    .eq('is_active', true);
                
                if (sessionError) {
                    addLog(`❌ 查詢活躍會話失敗: ${sessionError.message}`, 'error');
                    updateResults(`活躍會話查詢: ❌ ${sessionError.message}`);
                } else {
                    addLog(`✅ 找到 ${activeSessions.length} 個活躍會話`);
                    updateResults(`活躍會話數量: ${activeSessions.length}`);
                    
                    if (currentSessionId) {
                        const currentSession = activeSessions.find(s => s.session_id === currentSessionId);
                        if (currentSession) {
                            addLog('✅ 找到當前會話記錄');
                            updateResults('當前會話: ✅ 存在於資料庫');
                            updateResults(`會話狀態: ${currentSession.is_active ? '活躍' : '非活躍'}`);
                            updateResults(`最後活動: ${currentSession.last_activity || '無記錄'}`);
                        } else {
                            addLog('❌ 當前會話不存在於資料庫中', 'error');
                            updateResults('當前會話: ❌ 不存在於資料庫');
                        }
                    }
                }
                
                addLog('診斷完成！', 'success');
                
            } catch (error) {
                addLog(`診斷過程發生錯誤: ${error.message}`, 'error');
                updateResults(`診斷錯誤: ❌ ${error.message}`);
            }
        }
        
        async function testHeartbeat() {
            addLog('開始測試心跳更新...');
            
            try {
                const currentSessionId = localStorage.getItem('currentSessionId');
                if (!currentSessionId) {
                    addLog('❌ 沒有會話ID，無法測試心跳', 'error');
                    return;
                }
                
                const now = new Date().toLocaleString("sv-SE", {timeZone: "Asia/Taipei"}).replace(" ", "T") + "+08:00";
                addLog(`準備更新心跳，會話ID: ${currentSessionId}`);
                addLog(`更新時間: ${now}`);
                
                const { data, error } = await window.supabase
                    .from('employee_sessions')
                    .update({ 
                        last_activity: now
                    })
                    .eq('session_id', currentSessionId)
                    .eq('is_active', true)
                    .select();
                
                addLog(`Supabase回應: ${JSON.stringify({ data, error })}`);
                
                if (error) {
                    addLog(`❌ 心跳更新失敗: ${error.message}`, 'error');
                    addLog(`錯誤代碼: ${error.code}`, 'error');
                    addLog(`錯誤詳情: ${error.details}`, 'error');
                    addLog(`錯誤提示: ${error.hint}`, 'error');
                } else {
                    addLog(`✅ 心跳更新成功: ${now}`, 'success');
                    addLog(`更新的資料: ${JSON.stringify(data)}`, 'success');
                }
                
            } catch (error) {
                addLog(`心跳測試發生錯誤: ${error.message}`, 'error');
            }
        }
        
        // 頁面載入時自動診斷
        document.addEventListener('DOMContentLoaded', async function() {
            addLog('頁面載入完成，等待用戶操作...');
        });
    </script>
</body>
</html>
