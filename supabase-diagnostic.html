<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase 連接診斷工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .diagnostic-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .status-success { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .status-error { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .status-warning { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- 標題 -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-database text-blue-500 mr-3"></i>
                    Supabase 連接診斷工具
                </h1>
                <p class="text-gray-600">檢查您的 Supabase 連接設定和 API 金鑰</p>
            </div>

            <!-- 設定資訊 -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fas fa-cog text-blue-500 mr-2"></i>
                    目前設定
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Supabase URL</label>
                        <div class="bg-gray-50 p-3 rounded border font-mono text-sm break-all">
                            https://cgwhckykrlphnibmuvhz.supabase.co
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">API Key (前20字元)</label>
                        <div class="bg-gray-50 p-3 rounded border font-mono text-sm">
                            eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                        </div>
                    </div>
                </div>
            </div>

            <!-- 診斷按鈕 -->
            <div class="text-center mb-6">
                <button id="runDiagnostic" class="bg-blue-500 text-white px-8 py-3 rounded-lg hover:bg-blue-600 transition-colors text-lg font-semibold">
                    <i class="fas fa-play mr-2"></i>
                    開始診斷
                </button>
            </div>

            <!-- 診斷結果 -->
            <div id="diagnosticResults" class="space-y-4 hidden">
                <!-- 連接測試 -->
                <div id="connectionTest" class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-wifi text-blue-500 mr-2"></i>
                        連接測試
                    </h3>
                    <div id="connectionStatus" class="text-center py-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                        <p class="mt-2 text-gray-600">正在測試連接...</p>
                    </div>
                </div>

                <!-- API Key 驗證 -->
                <div id="apiKeyTest" class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-key text-blue-500 mr-2"></i>
                        API Key 驗證
                    </h3>
                    <div id="apiKeyStatus" class="text-center py-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                        <p class="mt-2 text-gray-600">正在驗證 API Key...</p>
                    </div>
                </div>

                <!-- 專案狀態 -->
                <div id="projectTest" class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-project-diagram text-blue-500 mr-2"></i>
                        專案狀態
                    </h3>
                    <div id="projectStatus" class="text-center py-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                        <p class="mt-2 text-gray-600">正在檢查專案狀態...</p>
                    </div>
                </div>

                <!-- 資料表檢查 -->
                <div id="tableTest" class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-table text-blue-500 mr-2"></i>
                        資料表檢查
                    </h3>
                    <div id="tableStatus" class="text-center py-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                        <p class="mt-2 text-gray-600">正在檢查資料表...</p>
                    </div>
                </div>
            </div>

            <!-- 解決方案 -->
            <div id="solutions" class="bg-white rounded-lg shadow-lg p-6 mt-6 hidden">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                    解決方案
                </h2>
                <div id="solutionContent" class="space-y-4">
                    <!-- 解決方案內容將在這裡動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Supabase 配置
        const SUPABASE_URL = 'https://cgwhckykrlphnibmuvhz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnd2hja3lrcmxwaG5pYm11dmh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMDA1ODMsImV4cCI6MjA2ODY3NjU4M30.LiIG69wjvcyrJhdNAk0Y171uKCU4f-ROIiejS7Xd7zY';

        let supabase;

        // 初始化 Supabase
        async function initSupabase() {
            try {
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                return true;
            } catch (error) {
                console.error('Supabase 初始化失敗:', error);
                return false;
            }
        }

        // 更新狀態顯示
        function updateStatus(elementId, status, message, details = '') {
            const element = document.getElementById(elementId);
            const statusClass = status === 'success' ? 'status-success' : 
                              status === 'error' ? 'status-error' : 'status-warning';
            
            element.innerHTML = `
                <div class="text-center py-4">
                    <div class="text-4xl mb-2">
                        ${status === 'success' ? '<i class="fas fa-check-circle text-green-500"></i>' :
                          status === 'error' ? '<i class="fas fa-times-circle text-red-500"></i>' :
                          '<i class="fas fa-exclamation-triangle text-yellow-500"></i>'}
                    </div>
                    <p class="text-lg font-semibold ${status === 'success' ? 'text-green-700' : 
                                                     status === 'error' ? 'text-red-700' : 'text-yellow-700'}">
                        ${message}
                    </p>
                    ${details ? `<p class="text-sm text-gray-600 mt-2">${details}</p>` : ''}
                </div>
            `;
        }

        // 連接測試
        async function testConnection() {
            try {
                const { data, error } = await supabase.from('products').select('count').limit(1);
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        updateStatus('connectionStatus', 'warning', '連接成功，但資料表不存在', 
                                   '這表示 API Key 正確，但需要創建資料表');
                    } else {
                        updateStatus('connectionStatus', 'error', '連接失敗', 
                                   `錯誤代碼: ${error.code}, 訊息: ${error.message}`);
                    }
                } else {
                    updateStatus('connectionStatus', 'success', '連接成功', 
                               '可以正常與 Supabase 通訊');
                }
            } catch (error) {
                updateStatus('connectionStatus', 'error', '連接測試失敗', 
                           `網路錯誤: ${error.message}`);
            }
        }

        // API Key 驗證
        async function testApiKey() {
            try {
                // 嘗試獲取專案資訊
                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    updateStatus('apiKeyStatus', 'error', 'API Key 無效', 
                               `錯誤: ${error.message}`);
                } else {
                    updateStatus('apiKeyStatus', 'success', 'API Key 有效', 
                               '可以正常使用此 API Key');
                }
            } catch (error) {
                updateStatus('apiKeyStatus', 'error', 'API Key 驗證失敗', 
                           `錯誤: ${error.message}`);
            }
        }

        // 專案狀態檢查
        async function testProject() {
            try {
                // 檢查是否可以獲取專案資訊
                const { data, error } = await supabase.from('information_schema.tables').select('table_name').limit(1);
                
                if (error) {
                    updateStatus('projectStatus', 'error', '專案存取失敗', 
                               `可能的原因：專案不存在或權限不足`);
                } else {
                    updateStatus('projectStatus', 'success', '專案狀態正常', 
                               '可以正常存取專案資源');
                }
            } catch (error) {
                updateStatus('projectStatus', 'error', '專案檢查失敗', 
                           `錯誤: ${error.message}`);
            }
        }

        // 資料表檢查
        async function testTables() {
            const tables = ['products', 'categories', 'members', 'employees', 'sales_history', 'coupons', 'suppliers'];
            let existingTables = [];
            let missingTables = [];

            for (const table of tables) {
                try {
                    const { data, error } = await supabase.from(table).select('count').limit(1);
                    if (!error) {
                        existingTables.push(table);
                    } else {
                        missingTables.push(table);
                    }
                } catch (error) {
                    missingTables.push(table);
                }
            }

            if (existingTables.length === tables.length) {
                updateStatus('tableStatus', 'success', '所有資料表都存在', 
                           `已找到: ${existingTables.join(', ')}`);
            } else if (existingTables.length > 0) {
                updateStatus('tableStatus', 'warning', '部分資料表存在', 
                           `存在: ${existingTables.join(', ')}\n缺少: ${missingTables.join(', ')}`);
            } else {
                updateStatus('tableStatus', 'error', '沒有找到任何資料表', 
                           `缺少: ${missingTables.join(', ')}`);
            }
        }

        // 生成解決方案
        function generateSolutions() {
            const solutions = [];
            
            // 檢查各個測試結果
            const connectionElement = document.getElementById('connectionStatus');
            const apiKeyElement = document.getElementById('apiKeyStatus');
            const projectElement = document.getElementById('projectStatus');
            const tableElement = document.getElementById('tableStatus');

            // API Key 問題
            if (apiKeyElement.innerHTML.includes('無效') || apiKeyElement.innerHTML.includes('失敗')) {
                solutions.push({
                    title: '重新生成 API Key',
                    description: '您的 API Key 可能已過期或被重置',
                    steps: [
                        '1. 登入 Supabase 控制台',
                        '2. 進入您的專案',
                        '3. 前往 Settings → API',
                        '4. 複製新的 anon public key',
                        '5. 更新 database.js 中的 SUPABASE_ANON_KEY'
                    ]
                });
            }

            // 資料表問題
            if (tableElement.innerHTML.includes('沒有找到') || tableElement.innerHTML.includes('缺少')) {
                solutions.push({
                    title: '創建資料表',
                    description: '需要執行 SQL 腳本來創建必要的資料表',
                    steps: [
                        '1. 在 Supabase 控制台進入 SQL Editor',
                        '2. 複製 supabase-setup.sql 的全部內容',
                        '3. 貼上並執行 SQL 腳本',
                        '4. 確認所有資料表創建成功'
                    ]
                });
            }

            // 權限問題
            if (connectionElement.innerHTML.includes('權限') || projectElement.innerHTML.includes('權限')) {
                solutions.push({
                    title: '設定資料庫權限',
                    description: '需要設定 Row Level Security (RLS) 政策',
                    steps: [
                        '1. 在 Supabase 控制台進入 Authentication → Policies',
                        '2. 為每個資料表啟用 RLS',
                        '3. 創建允許匿名讀寫的政策',
                        '4. 測試連接是否正常'
                    ]
                });
            }

            // 顯示解決方案
            const solutionContent = document.getElementById('solutionContent');
            if (solutions.length > 0) {
                solutionContent.innerHTML = solutions.map(solution => `
                    <div class="border-l-4 border-blue-500 pl-4 py-2">
                        <h3 class="font-semibold text-gray-800 mb-2">${solution.title}</h3>
                        <p class="text-gray-600 mb-3">${solution.description}</p>
                        <div class="bg-gray-50 p-3 rounded">
                            ${solution.steps.map(step => `<p class="text-sm">${step}</p>`).join('')}
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('solutions').classList.remove('hidden');
            }
        }

        // 執行完整診斷
        async function runFullDiagnostic() {
            document.getElementById('diagnosticResults').classList.remove('hidden');
            
            // 初始化 Supabase
            const initSuccess = await initSupabase();
            if (!initSuccess) {
                updateStatus('connectionStatus', 'error', 'Supabase 初始化失敗', 
                           '請檢查網路連接和 Supabase 服務狀態');
                return;
            }

            // 執行各項測試
            await testConnection();
            await testApiKey();
            await testProject();
            await testTables();

            // 生成解決方案
            setTimeout(generateSolutions, 1000);
        }

        // 綁定事件
        document.getElementById('runDiagnostic').addEventListener('click', runFullDiagnostic);
    </script>
</body>
</html> 